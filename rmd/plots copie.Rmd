---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup}
knitr::opts_chunk$set(echo=FALSE, warning = F)
```


```{r, include = FALSE}
library(dplyr)
library(tidyr)
library(modelsummary)
library(glue)
library(gt)
library(car)
library(dunn.test)
library(rcompanion)
library(rstatix)
library(purrr)
library(ggplot2)
library(patchwork)
library(psych)
library(performance)
library(lmtest)
library(readxl)
library(openxlsx)
library(pheatmap)
library(ggpubr)
library(exact2x2)
```

# Différences OMS2024 - SD

```{r}
data = read.csv("data/diags.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Anemie_SD)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.test(tbl, correct = correct, exact = TRUE)
    type <- "Test exact de McNemar"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "Test de McNemar (chi²)"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_SD)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_SD)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Proportions croisées anémie : OMS 2024 v.s. -1SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " = ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, Anemie_SD) %>%
  group_by(Anemie_SD) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = Anemie_SD, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = scales::percent(prop, accuracy = 1)), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "Anémie_OMS2024",
    y = "Anémie_SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
data = read.csv("data/diags.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Anemie_2SD)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.test(tbl, correct = correct, exact = TRUE)
    type <- "Test exact de McNemar"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "Test de McNemar (chi²)"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_2SD)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_2SD)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Proportions croisées anémie : OMS 2024 v.s. -2SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " = ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, Anemie_2SD) %>%
  group_by(Anemie_2SD) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = Anemie_2SD, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = scales::percent(prop, accuracy = 1)), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "Anémie_OMS2024",
    y = "Anemie_2SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
data = read.csv("data/diags.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Anemie_SD_Hbmass_kg)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.test(tbl, correct = correct, exact = TRUE)
    type <- "Test exact de McNemar"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "Test de McNemar (chi²)"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_SD_Hbmass_kg)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_SD_Hbmass_kg)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Proportions croisées anémie : OMS 2024 v.s. -1SD_Hbmass_kg\n",
  "n = ", n_total, " ; ", "pval ", methode, " = ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, Anemie_SD_Hbmass_kg) %>%
  group_by(Anemie_SD_Hbmass_kg) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = Anemie_SD_Hbmass_kg, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = scales::percent(prop, accuracy = 1)), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "Anémie_OMS2024",
    y = "Anemie_SD_Hbmass_kg",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
data = read.csv("data/diags.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Anemie_2SD_Hbmass_kg)

mcnemar_auto <- function(x, y, correct = FALSE) {
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  if (discordants < 25) {
    if (!requireNamespace("exact2x2", quietly = TRUE)) {
      stop("Le package 'exact2x2' est requis pour le test exact. Veuillez l'installer.")
    }
    res <- exact2x2::mcnemar.exact(tbl)
    type <- "Test exact de McNemar"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "Test de McNemar (chi²)"
  }

  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_2SD_Hbmass_kg)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_2SD_Hbmass_kg)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Proportions croisées anémie : OMS 2024 v.s. -2SD_Hbmass_kg\n",
  "n = ", n_total, " ; ", "pval ", methode, " = ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, Anemie_2SD_Hbmass_kg) %>%
  group_by(Anemie_2SD_Hbmass_kg) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = Anemie_2SD_Hbmass_kg, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = scales::percent(prop, accuracy = 1)), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "Anémie_OMS2024",
    y = "Anemie_2SD_Hbmass_kg",
    fill = "Proportion"
  ) +
  theme_minimal()
```





# HB HBMASS PVML

```{r}
# HB ~ HBMASS (g)
data <- read.csv("data/datafinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Altitude est un facteur ou une variable catégorielle
data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ Hb.mass..g., data = df),
      mod2 = lm(HB ~ PV.ml., data = df),
      mod3 = lm(HB ~ Hb.mass..g. + PV.ml., data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (Hbmass (g))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Altitude = modset$Altitude)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"


r2_labels <- coef_data %>%
  select(model, Altitude, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (Hbmass (g))`, `mod 2 (PV (ml))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HB ~ Hbmass (g) + PV (ml) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HB ~ HBMASS (g/kg)
data <- read.csv("data/datafinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Altitude est un facteur ou une variable catégorielle
data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ Hb.mass.kg..g...kg., data = df),
      mod2 = lm(HB ~ PV.ml., data = df),
      mod3 = lm(HB ~ Hb.mass.kg..g...kg. + PV.ml., data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (Hbmass (g/kg))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Altitude = modset$Altitude)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"


r2_labels <- coef_data %>%
  select(model, Altitude, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (Hbmass (g/kg))`, `mod 2 (PV (ml))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HB ~ Hbmass (g/kg) + PV (ml) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HB ~ RBCV
data <- read.csv("data/datafinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Altitude est un facteur ou une variable catégorielle
data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ RBCV..ml., data = df),
      mod2 = lm(HB ~ PV.ml., data = df),
      mod3 = lm(HB ~ RBCV..ml. + PV.ml., data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (RBCV (ml))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Altitude = modset$Altitude)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "RBCV..ml."] <- "RBCV (ml)"


r2_labels <- coef_data %>%
  select(model, Altitude, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (RBCV (ml))`, `mod 2 (PV (ml))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HB ~ RBCV (ml) + PV (ml) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HB ~ MCV
data <- read.csv("data/datafinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Altitude est un facteur ou une variable catégorielle
data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ MCV..fL., data = df),
      mod2 = lm(HB ~ PV.ml., data = df),
      mod3 = lm(HB ~ MCV..fL. + PV.ml., data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (MCV (fL))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Altitude = modset$Altitude)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "MCV..fL."] <- "MCV (fL)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "RBCV..ml."] <- "RBCV (ml)"


r2_labels <- coef_data %>%
  select(model, Altitude, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (MCV (fL))`, `mod 2 (PV (ml))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HB ~ MCV (fL) + PV (ml) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HCT.. ~ HBMASS (g)
data <- read.csv("data/datafinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Altitude est un facteur ou une variable catégorielle
data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HCT.. ~ Hb.mass..g., data = df),
      mod2 = lm(HCT.. ~ PV.ml., data = df),
      mod3 = lm(HCT.. ~ Hb.mass..g. + PV.ml., data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (Hbmass (g))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Altitude = modset$Altitude)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"


r2_labels <- coef_data %>%
  select(model, Altitude, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (Hbmass (g))`, `mod 2 (PV (ml))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HCT ~ Hbmass (g) + PV (ml) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HCT.. ~ HBMASS (g/kg)
data <- read.csv("data/datafinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Altitude est un facteur ou une variable catégorielle
data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HCT.. ~ Hb.mass.kg..g...kg., data = df),
      mod2 = lm(HCT.. ~ PV.ml., data = df),
      mod3 = lm(HCT.. ~ Hb.mass.kg..g...kg. + PV.ml., data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (Hbmass (g/kg))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Altitude = modset$Altitude)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"


r2_labels <- coef_data %>%
  select(model, Altitude, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (Hbmass (g/kg))`, `mod 2 (PV (ml))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HCT ~ Hbmass (g/kg) + PV (ml) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HCT ~ RBCV
data <- read.csv("data/datafinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Altitude est un facteur ou une variable catégorielle
data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HCT.. ~ RBCV..ml., data = df),
      mod2 = lm(HCT.. ~ PV.ml., data = df),
      mod3 = lm(HCT.. ~ RBCV..ml. + PV.ml., data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (RBCV (ml))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Altitude = modset$Altitude)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "RBCV..ml."] <- "RBCV (ml)"


r2_labels <- coef_data %>%
  select(model, Altitude, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (RBCV (ml))`, `mod 2 (PV (ml))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HCT ~ RBCV (ml) + PV (ml) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HCT ~ MCV
data <- read.csv("data/datafinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Altitude est un facteur ou une variable catégorielle
data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HCT.. ~ MCV..fL., data = df),
      mod2 = lm(HCT.. ~ PV.ml., data = df),
      mod3 = lm(HCT.. ~ MCV..fL. + PV.ml., data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (MCV (fL))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Altitude = modset$Altitude)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "MCV..fL."] <- "MCV (fL)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "RBCV..ml."] <- "RBCV (ml)"


r2_labels <- coef_data %>%
  select(model, Altitude, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (MCV (fL))`, `mod 2 (PV (ml))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HCT ~ MCV (fL) + PV (ml) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

# PVKG

```{r}
# HB ~ HBMASS (g)
data <- read.csv("data/datafinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Altitude est un facteur ou une variable catégorielle
data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ Hb.mass..g., data = df),
      mod2 = lm(HB ~ PV..kg..ml.kg., data = df),
      mod3 = lm(HB ~ Hb.mass..g. + PV..kg..ml.kg., data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (Hbmass (g))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml/kg))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Altitude = modset$Altitude)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"


r2_labels <- coef_data %>%
  select(model, Altitude, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (Hbmass (g))`, `mod 2 (PV (ml/kg))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HB ~ Hbmass (g) + PV (ml/kg) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HB ~ HBMASS (g/kg)
data <- read.csv("data/datafinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Altitude est un facteur ou une variable catégorielle
data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ Hb.mass.kg..g...kg., data = df),
      mod2 = lm(HB ~ PV..kg..ml.kg., data = df),
      mod3 = lm(HB ~ Hb.mass.kg..g...kg. + PV..kg..ml.kg., data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (Hbmass (g/kg))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml/kg))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Altitude = modset$Altitude)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"


r2_labels <- coef_data %>%
  select(model, Altitude, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (Hbmass (g/kg))`, `mod 2 (PV (ml/kg))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HB ~ Hbmass (g/kg) + PV (ml/kg) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HB ~ HBMASS (g)
data <- read.csv("data/datafinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Altitude est un facteur ou une variable catégorielle
data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ RBCV..ml., data = df),
      mod2 = lm(HB ~ PV..kg..ml.kg., data = df),
      mod3 = lm(HB ~ RBCV..ml. + PV..kg..ml.kg., data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (RBCV (ml))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml/kg))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Altitude = modset$Altitude)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "RBCV..ml."] <- "RBCV (ml)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"


r2_labels <- coef_data %>%
  select(model, Altitude, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (RBCV (ml))`, `mod 2 (PV (ml/kg))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HB ~ RBCV (ml) + PV (ml/kg) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HB ~ MCV
data <- read.csv("data/datafinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Altitude est un facteur ou une variable catégorielle
data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ MCV..fL., data = df),
      mod2 = lm(HB ~ PV..kg..ml.kg., data = df),
      mod3 = lm(HB ~ MCV..fL. + PV..kg..ml.kg., data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (MCV (fL))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml/kg))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Altitude = modset$Altitude)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "MCV..fL."] <- "MCV (fL)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"
coef_data$term[coef_data$term == "RBCV..ml."] <- "RBCV (ml)"


r2_labels <- coef_data %>%
  select(model, Altitude, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (MCV (fL))`, `mod 2 (PV (ml/kg))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HB ~ MCV (fL) + PV (ml/kg) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HCT.. ~ HBMASS (g)
data <- read.csv("data/datafinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Altitude est un facteur ou une variable catégorielle
data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HCT.. ~ Hb.mass..g., data = df),
      mod2 = lm(HCT.. ~ PV..kg..ml.kg., data = df),
      mod3 = lm(HCT.. ~ Hb.mass..g. + PV..kg..ml.kg., data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (Hbmass (g))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml/kg))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Altitude = modset$Altitude)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"

r2_labels <- coef_data %>%
  select(model, Altitude, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (Hbmass (g))`, `mod 2 (PV (ml/kg))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HCT ~ Hbmass (g) + PV (ml/kg) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HCT.. ~ HBMASS (g/kg)
data <- read.csv("data/datafinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Altitude est un facteur ou une variable catégorielle
data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HCT.. ~ Hb.mass.kg..g...kg., data = df),
      mod2 = lm(HCT.. ~ PV..kg..ml.kg., data = df),
      mod3 = lm(HCT.. ~ Hb.mass.kg..g...kg. + PV..kg..ml.kg., data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (Hbmass (g/kg))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml/kg))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Altitude = modset$Altitude)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"

r2_labels <- coef_data %>%
  select(model, Altitude, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (Hbmass (g/kg))`, `mod 2 (PV (ml/kg))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HCT ~ Hbmass (g/kg) + PV (ml/kg) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HB ~ HBMASS (g)
data <- read.csv("data/datafinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Altitude est un facteur ou une variable catégorielle
data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HCT.. ~ RBCV..ml., data = df),
      mod2 = lm(HCT.. ~ PV..kg..ml.kg., data = df),
      mod3 = lm(HCT.. ~ RBCV..ml. + PV..kg..ml.kg., data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (RBCV (ml))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml/kg))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Altitude = modset$Altitude)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "RBCV..ml."] <- "RBCV (ml)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"


r2_labels <- coef_data %>%
  select(model, Altitude, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (RBCV (ml))`, `mod 2 (PV (ml/kg))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HCT ~ RBCV (ml) + PV (ml/kg) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HCT ~ MCV
data <- read.csv("data/datafinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Altitude est un facteur ou une variable catégorielle
data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HCT.. ~ MCV..fL., data = df),
      mod2 = lm(HCT.. ~ PV..kg..ml.kg., data = df),
      mod3 = lm(HCT.. ~ MCV..fL. + PV..kg..ml.kg., data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (MCV (fL))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml/kg))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Altitude = modset$Altitude)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "MCV..fL."] <- "MCV (fL)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"
coef_data$term[coef_data$term == "RBCV..ml."] <- "RBCV (ml)"


r2_labels <- coef_data %>%
  select(model, Altitude, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (MCV (fL))`, `mod 2 (PV (ml/kg))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HCT ~ MCV (fL) + PV (ml/kg) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

# RANK
```{r}
data <- read.csv("data/datafinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Altitude est un facteur ou une variable catégorielle
data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

data$Rang_HB <- rank(data$HB)
data$Rang_HBMASS <- rank(data$Hb.mass.kg..g...kg.)


pvals_df <- data %>%
  group_by(Altitude) %>%
  summarise(
    p_value = wilcox.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired wilcoxon = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Altitude)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HB vs HBMASS (g/kg)) and paired Wilcoxon test \n for each city in 8-12 years old", x = "Rank HBMASS (g/kg)", y = "Rank HB", color = "City") +
  facet_wrap(~ Altitude)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```

```{r}
data$Rang_HB <- rank(data$HB)
data$Rang_HBMASS <- rank(data$Hb.mass..g.)


pvals_df <- data %>%
  group_by(Altitude) %>%
  summarise(
    p_value = wilcox.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired wilcoxon = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Altitude)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HB vs HBMASS (g)) and paired Wilcoxon test \n for each city in 8-12 years old", x = "Rank HBMASS (g)", y = "Rank HB", color = "City") +
  facet_wrap(~ Altitude)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```

```{r}
data$Rang_HB <- rank(data$HB)
data$Rang_HBMASS <- rank(data$RBCV..ml.)


pvals_df <- data %>%
  group_by(Altitude) %>%
  summarise(
    p_value = wilcox.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired wilcoxon = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Altitude)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HB vs RBCV (ml)) and paired Wilcoxon test \n for each city in 8-12 years old", x = "Rank RBCV (ml)", y = "Rank HB", color = "City") +
  facet_wrap(~ Altitude)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```

```{r}
data$Rang_HB <- rank(data$HB)
data$Rang_HBMASS <- rank(data$MCV..fL.)


pvals_df <- data %>%
  group_by(Altitude) %>%
  summarise(
    p_value = wilcox.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired wilcoxon = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Altitude)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HB vs MCV (fL)) and paired Wilcoxon test \n for each city in 8-12 years old", x = "Rank MCV (fL)", y = "Rank HB", color = "City") +
  facet_wrap(~ Altitude)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```

```{r}
data$Rang_HB <- rank(data$HCT..)
data$Rang_HBMASS <- rank(data$Hb.mass.kg..g...kg.)


pvals_df <- data %>%
  group_by(Altitude) %>%
  summarise(
    p_value = wilcox.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired wilcoxon = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Altitude)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HCT vs HBMASS (g/kg)) and paired Wilcoxon test \n for each city in 8-12 years old", x = "Rank HBMASS (g/kg)", y = "Rank HCT", color = "City") +
  facet_wrap(~ Altitude)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```

```{r}
data$Rang_HB <- rank(data$HCT..)
data$Rang_HBMASS <- rank(data$Hb.mass..g.)


pvals_df <- data %>%
  group_by(Altitude) %>%
  summarise(
    p_value = wilcox.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired wilcoxon = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Altitude)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HCT vs HBMASS (g) and paired Wilcoxon test \n for each city in 8-12 years old", x = "Rank HBMASS (g)", y = "Rank HCT", color = "City") +
  facet_wrap(~ Altitude)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```

```{r}
data$Rang_HB <- rank(data$HCT..)
data$Rang_HBMASS <- rank(data$RBCV..ml.)


pvals_df <- data %>%
  group_by(Altitude) %>%
  summarise(
    p_value = wilcox.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired wilcoxon = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Altitude)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HCT vs RBCV (ml) and paired Wilcoxon test \n for each city in 8-12 years old", x = "Rank RBCV (ml)", y = "Rank HCT", color = "City") +
  facet_wrap(~ Altitude)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```

```{r}
data$Rang_HB <- rank(data$HCT..)
data$Rang_HBMASS <- rank(data$MCV..fL.)


pvals_df <- data %>%
  group_by(Altitude) %>%
  summarise(
    p_value = wilcox.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired wilcoxon = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Altitude)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HCT vs MCV (fL)) and paired Wilcoxon test \n for each city in 8-12 years old", x = "Rank MCV (fL)", y = "Rank HCT", color = "City") +
  facet_wrap(~ Altitude)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```

```{r}
data = read.csv("data/datafinal.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]

mod1 = lm(HB ~ Hb.mass.kg..g...kg., data = data[data$Ville_eval == "Lima",])
mod2 = lm(HB ~ Hb.mass.kg..g...kg., data = data[data$Ville_eval == "Cusco",])
mod3 = lm(HB ~ Hb.mass.kg..g...kg., data = data[data$Ville_eval == "Juliaca",])
mod4 = lm(HB ~ Hb.mass.kg..g...kg., data = data[data$Ville_eval == "Rinconada",])

label_models_r2adj <- function(models) {
  model_names <- names(models)
  r2_labeled <- sapply(model_names, function(name) {
    r2_adj <- summary(models[[name]])$adj.r.squared
    sprintf("%s (R² adj = %.2f)", name, r2_adj)
  })
  names(models) <- r2_labeled
  return(models)
}

models <- list(
  "1 : Lima" = mod1,
  "2 : Cusco" = mod2,
  "3 : Juliaca" = mod3,
  "4 : La Rinconada" = mod4
)

models <- label_models_r2adj(models)

coef_data <- bind_rows(lapply(seq_along(models), function(i) {
  tidy(models[[i]], conf.int = TRUE) %>%
    mutate(model = names(models)[i])  # ✅ utilise les noms renommés
}))

term_order <- coef_data %>%
  group_by(term) %>%
  summarise(n_models = n_distinct(model)) %>%
  arrange(-n_models) %>%
  pull(term)

# Réordonner les termes selon la fréquence croissante
coef_data <- coef_data %>%
  mutate(term = factor(term, levels = term_order))

# Ajouter colonne de significativité (IC ne contenant pas 0)
coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%  # Enlever intercept si souhaité
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

# Tracer le graphique
ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Model", shape = "Significatif ?", title = "Evolution de HB en fonction de HBMASS (g/kg) par altitude") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
data = read.csv("data/datafinal.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]

mod1 = lm(HB ~ Hb.mass..g., data = data[data$Ville_eval == "Lima",])
mod2 = lm(HB ~ Hb.mass..g., data = data[data$Ville_eval == "Cusco",])
mod3 = lm(HB ~ Hb.mass..g., data = data[data$Ville_eval == "Juliaca",])
mod4 = lm(HB ~ Hb.mass..g., data = data[data$Ville_eval == "Rinconada",])

label_models_r2adj <- function(models) {
  model_names <- names(models)
  r2_labeled <- sapply(model_names, function(name) {
    r2_adj <- summary(models[[name]])$adj.r.squared
    sprintf("%s (R² adj = %.2f)", name, r2_adj)
  })
  names(models) <- r2_labeled
  return(models)
}

models <- list(
  "1 : Lima" = mod1,
  "2 : Cusco" = mod2,
  "3 : Juliaca" = mod3,
  "4 : La Rinconada" = mod4
)

models <- label_models_r2adj(models)

coef_data <- bind_rows(lapply(seq_along(models), function(i) {
  tidy(models[[i]], conf.int = TRUE) %>%
    mutate(model = names(models)[i])  # ✅ utilise les noms renommés
}))

term_order <- coef_data %>%
  group_by(term) %>%
  summarise(n_models = n_distinct(model)) %>%
  arrange(-n_models) %>%
  pull(term)

# Réordonner les termes selon la fréquence croissante
coef_data <- coef_data %>%
  mutate(term = factor(term, levels = term_order))

# Ajouter colonne de significativité (IC ne contenant pas 0)
coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%  # Enlever intercept si souhaité
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

# Tracer le graphique
ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Model", shape = "Significatif ?", title = "Evolution de HB en fonction de HBMASS (g) par altitude") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
data = read.csv("data/datafinal.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]

mod1 = lm(HCT.. ~ Hb.mass.kg..g...kg., data = data[data$Ville_eval == "Lima",])
mod2 = lm(HCT.. ~ Hb.mass.kg..g...kg., data = data[data$Ville_eval == "Cusco",])
mod3 = lm(HCT.. ~ Hb.mass.kg..g...kg., data = data[data$Ville_eval == "Juliaca",])
mod4 = lm(HCT.. ~ Hb.mass.kg..g...kg., data = data[data$Ville_eval == "Rinconada",])

label_models_r2adj <- function(models) {
  model_names <- names(models)
  r2_labeled <- sapply(model_names, function(name) {
    r2_adj <- summary(models[[name]])$adj.r.squared
    sprintf("%s (R² adj = %.2f)", name, r2_adj)
  })
  names(models) <- r2_labeled
  return(models)
}

models <- list(
  "1 : Lima" = mod1,
  "2 : Cusco" = mod2,
  "3 : Juliaca" = mod3,
  "4 : La Rinconada" = mod4
)

models <- label_models_r2adj(models)

coef_data <- bind_rows(lapply(seq_along(models), function(i) {
  tidy(models[[i]], conf.int = TRUE) %>%
    mutate(model = names(models)[i])  # ✅ utilise les noms renommés
}))

term_order <- coef_data %>%
  group_by(term) %>%
  summarise(n_models = n_distinct(model)) %>%
  arrange(-n_models) %>%
  pull(term)

# Réordonner les termes selon la fréquence croissante
coef_data <- coef_data %>%
  mutate(term = factor(term, levels = term_order))

# Ajouter colonne de significativité (IC ne contenant pas 0)
coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%  # Enlever intercept si souhaité
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

# Tracer le graphique
ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Model", shape = "Significatif ?", title = "Evolution de HCT en fonction de HBMASS (g/kg) par altitude") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
data = read.csv("data/datafinal.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]

mod1 = lm(HCT.. ~ Hb.mass..g., data = data[data$Ville_eval == "Lima",])
mod2 = lm(HCT.. ~ Hb.mass..g., data = data[data$Ville_eval == "Cusco",])
mod3 = lm(HCT.. ~ Hb.mass..g., data = data[data$Ville_eval == "Juliaca",])
mod4 = lm(HCT.. ~ Hb.mass..g., data = data[data$Ville_eval == "Rinconada",])

label_models_r2adj <- function(models) {
  model_names <- names(models)
  r2_labeled <- sapply(model_names, function(name) {
    r2_adj <- summary(models[[name]])$adj.r.squared
    sprintf("%s (R² adj = %.2f)", name, r2_adj)
  })
  names(models) <- r2_labeled
  return(models)
}

models <- list(
  "1 : Lima" = mod1,
  "2 : Cusco" = mod2,
  "3 : Juliaca" = mod3,
  "4 : La Rinconada" = mod4
)

models <- label_models_r2adj(models)

coef_data <- bind_rows(lapply(seq_along(models), function(i) {
  tidy(models[[i]], conf.int = TRUE) %>%
    mutate(model = names(models)[i])  # ✅ utilise les noms renommés
}))

term_order <- coef_data %>%
  group_by(term) %>%
  summarise(n_models = n_distinct(model)) %>%
  arrange(-n_models) %>%
  pull(term)

# Réordonner les termes selon la fréquence croissante
coef_data <- coef_data %>%
  mutate(term = factor(term, levels = term_order))

# Ajouter colonne de significativité (IC ne contenant pas 0)
coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%  # Enlever intercept si souhaité
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

# Tracer le graphique
ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Model", shape = "Significatif ?", title = "Evolution de HCT en fonction de HBMASS (g) par altitude") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
data = read.csv("data/datafinal.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]

mod1 = lm(HB ~ PV..kg..ml.kg., data = data[data$Ville_eval == "Lima",])
mod2 = lm(HB ~ PV..kg..ml.kg., data = data[data$Ville_eval == "Cusco",])
mod3 = lm(HB ~ PV..kg..ml.kg., data = data[data$Ville_eval == "Juliaca",])
mod4 = lm(HB ~ PV..kg..ml.kg., data = data[data$Ville_eval == "Rinconada",])

label_models_r2adj <- function(models) {
  model_names <- names(models)
  r2_labeled <- sapply(model_names, function(name) {
    r2_adj <- summary(models[[name]])$adj.r.squared
    sprintf("%s (R² adj = %.2f)", name, r2_adj)
  })
  names(models) <- r2_labeled
  return(models)
}

models <- list(
  "1 : Lima" = mod1,
  "2 : Cusco" = mod2,
  "3 : Juliaca" = mod3,
  "4 : La Rinconada" = mod4
)

models <- label_models_r2adj(models)

coef_data <- bind_rows(lapply(seq_along(models), function(i) {
  tidy(models[[i]], conf.int = TRUE) %>%
    mutate(model = names(models)[i])  # ✅ utilise les noms renommés
}))

term_order <- coef_data %>%
  group_by(term) %>%
  summarise(n_models = n_distinct(model)) %>%
  arrange(-n_models) %>%
  pull(term)

# Réordonner les termes selon la fréquence croissante
coef_data <- coef_data %>%
  mutate(term = factor(term, levels = term_order))

# Ajouter colonne de significativité (IC ne contenant pas 0)
coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%  # Enlever intercept si souhaité
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

# Tracer le graphique
ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Model", shape = "Significatif ?", title = "Evolution de HB en fonction de HBMASS (g) par altitude") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
data = read.csv("data/datafinal.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]

mod1 = lm(HCT.. ~ PV..kg..ml.kg., data = data[data$Ville_eval == "Lima",])
mod2 = lm(HCT.. ~ PV..kg..ml.kg., data = data[data$Ville_eval == "Cusco",])
mod3 = lm(HCT.. ~ PV..kg..ml.kg., data = data[data$Ville_eval == "Juliaca",])
mod4 = lm(HCT.. ~ PV..kg..ml.kg., data = data[data$Ville_eval == "Rinconada",])

label_models_r2adj <- function(models) {
  model_names <- names(models)
  r2_labeled <- sapply(model_names, function(name) {
    r2_adj <- summary(models[[name]])$adj.r.squared
    sprintf("%s (R² adj = %.2f)", name, r2_adj)
  })
  names(models) <- r2_labeled
  return(models)
}

models <- list(
  "1 : Lima" = mod1,
  "2 : Cusco" = mod2,
  "3 : Juliaca" = mod3,
  "4 : La Rinconada" = mod4
)

models <- label_models_r2adj(models)

coef_data <- bind_rows(lapply(seq_along(models), function(i) {
  tidy(models[[i]], conf.int = TRUE) %>%
    mutate(model = names(models)[i])  # ✅ utilise les noms renommés
}))

term_order <- coef_data %>%
  group_by(term) %>%
  summarise(n_models = n_distinct(model)) %>%
  arrange(-n_models) %>%
  pull(term)

# Réordonner les termes selon la fréquence croissante
coef_data <- coef_data %>%
  mutate(term = factor(term, levels = term_order))

# Ajouter colonne de significativité (IC ne contenant pas 0)
coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%  # Enlever intercept si souhaité
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

# Tracer le graphique
ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Model", shape = "Significatif ?", title = "Evolution de HB en fonction de HBMASS (g) par altitude") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  theme_minimal() +
  theme(legend.position = "bottom")
```



```{r}
# HB ~ HBMASS (g/kg) + PV
data <- read.csv("data/datafinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Altitude est un facteur ou une variable catégorielle
data$Altitude <- as.factor(data$Altitude)  # ou adapte si autre nom

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ Hb.mass.kg..g...kg., data = df),
      mod2 = lm(HB ~ Hb.mass.kg..g...kg. + PV.ml., data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "Modèle 1", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "Modèle 2", r2_adj = r2_mod2)
  ) %>%
    mutate(Altitude = modset$Altitude)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

r2_labels <- coef_data %>%
  select(model, Altitude, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - Modèle 1 : %.2f | Modèle 2 : %.2f",
                         `Modèle 1`, `Modèle 2`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Modèle", shape = "Significatif ?", title = "Modèles HB ~ Hbmass (g/kg) + PV par altitude") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HB ~ RBCV + PV
data <- read.csv("data/datafinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Altitude est un facteur ou une variable catégorielle
data$Altitude <- as.factor(data$Altitude)  # ou adapte si autre nom

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ RBCV..ml., data = df),
      mod2 = lm(HB ~ PV.ml., data = df),
      mod3 = lm(HB ~ RBCV..ml. + PV.ml., data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "Modèle 1", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "Modèle 2", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "Modèle 3", r2_adj = r2_mod3)
  ) %>%
    mutate(Altitude = modset$Altitude)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

r2_labels <- coef_data %>%
  select(model, Altitude, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - Modèle 1 : %.2f | Modèle 2 : %.2f | Modèle 3 : %.2f",
                         `Modèle 1`, `Modèle 2`, `Modèle 3`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Modèle", shape = "Significatif ?", title = "Modèles HB ~ RBCV + PV par altitude") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HB ~ RBCV + PV
data <- read.csv("data/datafinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Altitude est un facteur ou une variable catégorielle
data$Altitude <- as.factor(data$Altitude)  # ou adapte si autre nom

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ MCV..fL., data = df),
      mod2 = lm(HB ~ MCV..fL. + PV.ml., data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "Modèle 1", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "Modèle 2", r2_adj = r2_mod2)
  ) %>%
    mutate(Altitude = modset$Altitude)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

r2_labels <- coef_data %>%
  select(model, Altitude, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - Modèle 1 : %.2f | Modèle 2 : %.2f",
                         `Modèle 1`, `Modèle 2`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Modèle", shape = "Significatif ?", title = "Modèles HB ~ MCV + PV par altitude") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HCT ~ HBMASS (g/kg) + PV
data <- read.csv("data/datafinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Altitude est un facteur ou une variable catégorielle
data$Altitude <- as.factor(data$Altitude)  # ou adapte si autre nom

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HCT.. ~ Hb.mass.kg..g...kg., data = df),
      mod2 = lm(HCT.. ~ Hb.mass.kg..g...kg. + PV.ml., data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "Modèle 1", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "Modèle 2", r2_adj = r2_mod2)
  ) %>%
    mutate(Altitude = modset$Altitude)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

r2_labels <- coef_data %>%
  select(model, Altitude, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - Modèle 1 : %.2f | Modèle 2 : %.2f",
                         `Modèle 1`, `Modèle 2`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Modèle", shape = "Significatif ?", title = "Modèles HCT ~ Hbmass (g/kg) + PV par altitude") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HB ~ RBCV + PV
data <- read.csv("data/datafinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Altitude est un facteur ou une variable catégorielle
data$Altitude <- as.factor(data$Altitude)  # ou adapte si autre nom

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HCT.. ~ RBCV..ml., data = df),
      mod2 = lm(HCT.. ~ RBCV..ml. + PV.ml., data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "Modèle 1", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "Modèle 2", r2_adj = r2_mod2)
  ) %>%
    mutate(Altitude = modset$Altitude)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

r2_labels <- coef_data %>%
  select(model, Altitude, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - Modèle 1 : %.2f | Modèle 2 : %.2f",
                         `Modèle 1`, `Modèle 2`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Modèle", shape = "Significatif ?", title = "Modèles HCT ~ RBCV + PV par altitude") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HB ~ RBCV + PV
data <- read.csv("data/datafinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Altitude est un facteur ou une variable catégorielle
data$Altitude <- as.factor(data$Altitude)  # ou adapte si autre nom

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HCT.. ~ MCV..fL., data = df),
      mod2 = lm(HCT.. ~ MCV..fL. + PV.ml., data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "Modèle 1", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "Modèle 2", r2_adj = r2_mod2)
  ) %>%
    mutate(Altitude = modset$Altitude)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

r2_labels <- coef_data %>%
  select(model, Altitude, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - Modèle 1 : %.2f | Modèle 2 : %.2f",
                         `Modèle 1`, `Modèle 2`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Modèle", shape = "Significatif ?", title = "Modèles HCT ~ MCV + PV par altitude") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

# Prevalence par ville pour chaque methode
## Anemie

```{r}
data = read.csv("data/diags.csv")
data = data[data$Age_categorie_binaire == "0-3 ans", ]
data = data[, -c(10,11,12,13)]
data_long <- data %>%
  pivot_longer(
    cols = starts_with("Anemie_"),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Anémie"
  )

data_long$Ville_eval[data_long$Ville_eval == "Lima"] <- "Lima (150m)"
data_long$Ville_eval[data_long$Ville_eval == "Cusco"] <- "Cusco (3400m)"
data_long$Ville_eval[data_long$Ville_eval == "Juliaca"] <- "Juliaca (3800m)"
data_long$Ville_eval[data_long$Ville_eval == "Rinconada"] <- "La Rinconada \n (5100m - 5300m)"

data_long$Méthode <- gsub("Anemie_", "", data_long$Méthode)
data_long$Méthode <- gsub("_kg", "/kg)", data_long$Méthode)
data_long$Méthode <- gsub("_", " (", data_long$Méthode)
data_long$Méthode <- factor(data_long$Méthode, levels = c("OMS2011", "SD", "SD (Hbmass/kg)", "OMS2024" , "2SD", "2SD (Hbmass/kg)"))

global_tests <- data_long %>%
  group_by(Méthode) %>%
  summarise(
    p_global = {
      tbl <- table(Ville_eval, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

ville_pairs <- combn(unique(data_long$Ville_eval), 2, simplify = FALSE)

# Fonction pour calculer les p-values pour chaque paire de villes et chaque méthode
all_pvals <- lapply(ville_pairs, function(pair) {
  ville1 <- pair[1]
  ville2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Ville_eval %in% pair)
  
  data_sub %>%
    group_by(Méthode) %>%
    summarise(
      p = {
        tbl <- table(Ville_eval, Résultat_bin)
        if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
      },
      group1 = ville1,
      group2 = ville2,
      .groups = "drop"
    )
})

# Fusionner toutes les paires
p_values <- bind_rows(all_pvals)
p_values <- p_values %>%
  group_by(Méthode) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),  # méthode possible : "bonferroni", "holm", "BH", etc.
    p.signif.adj = case_when(
      p_adj < 0.01 ~ "***",
      p_adj < 0.05  ~ "**",
      p_adj < 0.1  ~ "*",
      TRUE          ~ "ns"
    )
  ) %>%
  ungroup()
p_values <- p_values %>%
  left_join(global_tests, by = "Méthode") %>%
  filter(p_global < 0.1)


# Ajouter des positions Y pour éviter le chevauchement des p-values
max_prev <- prevalence %>% group_by(Méthode) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Méthode") %>%
  group_by(Méthode) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

p_values_sig <- p_values %>% filter(p_adj < 0.1)

ggplot(data_long, aes(x = Ville_eval, y = Résultat_bin * 100, fill = Ville_eval)) +
  scale_x_discrete(limits = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada \n (5100m - 5300m)")) +
  scale_fill_manual(values = c(
    "Lima (150m)" = "#1b9e77",
    "Cusco (3400m)" = "#d95f02",
    "Juliaca (3800m)" = "#7570b3",
    "La Rinconada \n (5100m - 5300m)" = "#e7298a"
  )) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  stat_pvalue_manual(
    data = p_values_sig,
    label = "p.signif.adj",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  facet_wrap(~ Méthode, scales = "fixed") +
  labs(
    title = "Anemia prevalence in 0-3 year olds for each methods, by city",
    x = "City",
    y = "Prevalence (%) \n Anemia",
    fill = "City",
  caption = "* p < 0.1   ** p < 0.05   *** p < 0.01"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
data = read.csv("data/diags.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]
data = data[, -c(10,13)]
data_long <- data %>%
  pivot_longer(
    cols = starts_with("Anemie_"),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Anémie"
  )

data_long$Ville_eval[data_long$Ville_eval == "Lima"] <- "Lima (150m)"
data_long$Ville_eval[data_long$Ville_eval == "Cusco"] <- "Cusco (3400m)"
data_long$Ville_eval[data_long$Ville_eval == "Juliaca"] <- "Juliaca (3800m)"
data_long$Ville_eval[data_long$Ville_eval == "Rinconada"] <- "La Rinconada \n (5100m - 5300m)"

data_long$Méthode <- gsub("Anemie_", "", data_long$Méthode)
data_long$Méthode <- gsub("_kg", "/kg)", data_long$Méthode)
data_long$Méthode <- gsub("_", " (", data_long$Méthode)
data_long$Méthode <- factor(data_long$Méthode, levels = c("OMS2011", "SD", "SD (Hbmass/kg)", "OMS2024" , "2SD", "2SD (Hbmass/kg)"))


global_tests <- data_long %>%
  group_by(Méthode) %>%
  summarise(
    p_global = {
      tbl <- table(Ville_eval, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

ville_pairs <- combn(unique(data_long$Ville_eval), 2, simplify = FALSE)

# Fonction pour calculer les p-values pour chaque paire de villes et chaque méthode
all_pvals <- lapply(ville_pairs, function(pair) {
  ville1 <- pair[1]
  ville2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Ville_eval %in% pair)
  
  data_sub %>%
    group_by(Méthode) %>%
    summarise(
      p = {
        tbl <- table(Ville_eval, Résultat_bin)
        if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
      },
      group1 = ville1,
      group2 = ville2,
      .groups = "drop"
    )
})

# Fusionner toutes les paires
p_values <- bind_rows(all_pvals)
p_values <- p_values %>%
  group_by(Méthode) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),  # méthode possible : "bonferroni", "holm", "BH", etc.
    p.signif.adj = case_when(
      p_adj < 0.01 ~ "***",
      p_adj < 0.05  ~ "**",
      p_adj < 0.1  ~ "*",
      TRUE          ~ "ns"
    )
  ) %>%
  ungroup()
p_values <- p_values %>%
  left_join(global_tests, by = "Méthode") %>%
  filter(p_global < 0.1)


# Ajouter des positions Y pour éviter le chevauchement des p-values
max_prev <- prevalence %>% group_by(Méthode) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Méthode") %>%
  group_by(Méthode) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

p_values_sig <- p_values %>% filter(p_adj < 0.1)

ggplot(data_long, aes(x = Ville_eval, y = Résultat_bin * 100, fill = Ville_eval)) +
  scale_x_discrete(limits = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada \n (5100m - 5300m)")) +
  scale_fill_manual(values = c(
    "Lima (150m)" = "#1b9e77",
    "Cusco (3400m)" = "#d95f02",
    "Juliaca (3800m)" = "#7570b3",
    "La Rinconada \n (5100m - 5300m)" = "#e7298a"
  )) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  stat_pvalue_manual(
    data = p_values_sig,
    label = "p.signif.adj",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  facet_wrap(~ Méthode, scales = "fixed") +
labs(
    title = "Anemia prevalence in 8-12 year olds for each methods, by city",
    x = "City",
    y = "Prevalence (%) \n Anemia",
    fill = "City",
  caption = "* p < 0.1   ** p < 0.05   *** p < 0.01"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Polyglobulie

```{r}
data = read.csv("data/diags.csv")
data = data[data$Age_categorie_binaire == "0-3 ans", ]
data = data[, -c(18,19,20,21)]
data_long <- data %>%
  pivot_longer(
    cols = starts_with("Polyglobulie_"),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Polyglobulie"
  )

data_long$Ville_eval[data_long$Ville_eval == "Lima"] <- "Lima (150m)"
data_long$Ville_eval[data_long$Ville_eval == "Cusco"] <- "Cusco (3400m)"
data_long$Ville_eval[data_long$Ville_eval == "Juliaca"] <- "Juliaca (3800m)"
data_long$Ville_eval[data_long$Ville_eval == "Rinconada"] <- "La Rinconada \n (5100m - 5300m)"

data_long$Méthode <- gsub("Polyglobulie_", "", data_long$Méthode)
data_long$Méthode <- gsub("14.5_", "", data_long$Méthode)
data_long$Méthode <- gsub("_kg", "/kg)", data_long$Méthode)
data_long$Méthode <- gsub("_", " (", data_long$Méthode)
data_long$Méthode <- factor(data_long$Méthode, levels = c("OMS2011", "SD", "SD (Hbmass/kg)", "OMS2024" , "2SD", "2SD (Hbmass/kg)"))

levels(data_long$Ville_eval) <- c(
  "Lima (150m)",
  "Cusco (3400m)",
  "Juliaca (3800m)",
  "La Rinconada \n (5100m - 5300m)"
)

global_tests <- data_long %>%
  group_by(Méthode) %>%
  summarise(
    p_global = {
      tbl <- table(Ville_eval, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

ville_pairs <- combn(unique(data_long$Ville_eval), 2, simplify = FALSE)

# Fonction pour calculer les p-values pour chaque paire de villes et chaque méthode
all_pvals <- lapply(ville_pairs, function(pair) {
  ville1 <- pair[1]
  ville2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Ville_eval %in% pair)
  
  data_sub %>%
    group_by(Méthode) %>%
    summarise(
      p = {
        tbl <- table(Ville_eval, Résultat_bin)
        if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
      },
      group1 = ville1,
      group2 = ville2,
      .groups = "drop"
    )
})

# Fusionner toutes les paires
p_values <- bind_rows(all_pvals)
p_values <- p_values %>%
  group_by(Méthode) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),  # méthode possible : "bonferroni", "holm", "BH", etc.
    p.signif.adj = case_when(
      p_adj < 0.01 ~ "***",
      p_adj < 0.05  ~ "**",
      p_adj < 0.1  ~ "*",
      TRUE          ~ "ns"
    )
  ) %>%
  ungroup()
p_values <- p_values %>%
  left_join(global_tests, by = "Méthode") %>%
  filter(p_global < 0.1)


# Ajouter des positions Y pour éviter le chevauchement des p-values
max_prev <- prevalence %>% group_by(Méthode) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Méthode") %>%
  group_by(Méthode) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

p_values_sig <- p_values %>% filter(p_adj < 0.1)

ggplot(data_long, aes(x = Ville_eval, y = Résultat_bin * 100, fill = Ville_eval)) +
  scale_x_discrete(limits = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada \n (5100m - 5300m)")) +
  scale_fill_manual(values = c(
    "Lima (150m)" = "#1b9e77",
    "Cusco (3400m)" = "#d95f02",
    "Juliaca (3800m)" = "#7570b3",
    "La Rinconada \n (5100m - 5300m)" = "#e7298a"
  )) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  facet_wrap(~ Méthode, scales = "fixed") +
labs(
    title = "Polycythemia prevalence in 0-3 year olds for each methods, by city",
    x = "City",
    y = "Prevalence (%) \n polycythemia",
    fill = "City",
  caption = "* p < 0.1   ** p < 0.05   *** p < 0.01"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
data = read.csv("data/diags.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]
data = data[, -c(18,21)]
data_long <- data %>%
  pivot_longer(
    cols = starts_with("Polyglobulie_"),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Polyglobulie"
  )

data_long$Ville_eval <- factor(data_long$Ville_eval, levels = c("Lima", "Cusco", "Juliaca", "Rinconada"))
data_long$Méthode <- gsub("Polyglobulie_", "", data_long$Méthode)
data_long$Méthode <- gsub("14.5_", "", data_long$Méthode)
data_long$Méthode <- gsub("_kg", "/kg)", data_long$Méthode)
data_long$Méthode <- gsub("_", " (", data_long$Méthode)
data_long$Méthode <- factor(data_long$Méthode, levels = c("OMS2011", "SD", "SD (Hbmass/kg)", "OMS2024" , "2SD", "2SD (Hbmass/kg)"))

levels(data_long$Ville_eval) <- c(
  "Lima (150m)",
  "Cusco (3400m)",
  "Juliaca (3800m)",
  "La Rinconada \n (5100m - 5300m)"
)

global_tests <- data_long %>%
  group_by(Méthode) %>%
  summarise(
    p_global = {
      tbl <- table(Ville_eval, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

ville_pairs <- combn(unique(data_long$Ville_eval), 2, simplify = FALSE)

# Fonction pour calculer les p-values pour chaque paire de villes et chaque méthode
all_pvals <- lapply(ville_pairs, function(pair) {
  ville1 <- pair[1]
  ville2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Ville_eval %in% pair)
  
  data_sub %>%
    group_by(Méthode) %>%
    summarise(
      p = {
        tbl <- table(Ville_eval, Résultat_bin)
        if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
      },
      group1 = ville1,
      group2 = ville2,
      .groups = "drop"
    )
})

# Fusionner toutes les paires
p_values <- bind_rows(all_pvals)
p_values <- p_values %>%
  group_by(Méthode) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),  # méthode possible : "bonferroni", "holm", "BH", etc.
    p.signif.adj = case_when(
      p_adj < 0.01 ~ "***",
      p_adj < 0.05  ~ "**",
      p_adj < 0.1  ~ "*",
      TRUE          ~ "ns"
    )
  ) %>%
  ungroup()
p_values <- p_values %>%
  left_join(global_tests, by = "Méthode") %>%
  filter(p_global < 0.1)


# Ajouter des positions Y pour éviter le chevauchement des p-values
max_prev <- prevalence %>% group_by(Méthode) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Méthode") %>%
  group_by(Méthode) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

p_values_sig <- p_values %>% filter(p_adj < 0.1)

ggplot(data_long, aes(x = Ville_eval, y = Résultat_bin * 100, fill = Ville_eval)) +
  scale_fill_manual(values = c(
    "Lima (150m)" = "#1b9e77",
    "Cusco (3400m)" = "#d95f02",
    "Juliaca (3800m)" = "#7570b3",
    "La Rinconada \n (5100m - 5300m)" = "#e7298a"
  )) +  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  stat_pvalue_manual(
    data = p_values_sig,
    label = "p.signif.adj",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  facet_wrap(~ Méthode, scales = "fixed") +
labs(
    title = "Polycythemia prevalence in 8-12 year olds for each methods, by city",
    x = "City",
    y = "Prevalence (%) \n polycythemia",
    fill = "City",
  caption = "* p < 0.1   ** p < 0.05   *** p < 0.01"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Comparaison des différences entre méthodes pour chaque ville

## Anemie
```{r}
data <- read.csv("data/diags.csv")
data <- data[data$Age_categorie_binaire == "0-3 ans", ]
data <- data[, -c(10,11,12,13)]

data_long <- data %>%
  pivot_longer(
    cols = starts_with("Anemie_"),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Anémie"
  )

data_long$Ville_eval <- factor(data_long$Ville_eval, levels = c("Lima", "Cusco", "Juliaca", "Rinconada"))
data_long$Méthode <- factor(data_long$Méthode, levels = c("Anemie_OMS2011", "Anemie_OMS2024", "Anemie_SD", "Anemie_2SD"))
levels(data_long$Méthode) <- gsub("Anemie_", "", levels(data_long$Méthode))
levels(data_long$Ville_eval) <- c(
  "Lima (150m)",
  "Cusco (3400m)",
  "Juliaca (3800m)",
  "La Rinconada (5100m - 5300m)"
)

# Test global par ville
global_tests <- data_long %>%
  group_by(Ville_eval) %>%
  summarise(
    p_global = {
      tbl <- table(Méthode, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

# Prévalence par ville et méthode
prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

# Comparaisons entre méthodes dans chaque ville
method_pairs <- combn(unique(data_long$Méthode), 2, simplify = FALSE)

all_pvals <- lapply(method_pairs, function(pair) {
  m1 <- pair[1]
  m2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Méthode %in% pair)
  
  data_sub %>%
    group_by(Ville_eval) %>%
    summarise(
      p = {
        tbl <- table(Méthode, Résultat_bin)
        if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
      },
      group1 = m1,
      group2 = m2,
      .groups = "drop"
    )
})

p_values <- bind_rows(all_pvals) %>%
  group_by(Ville_eval) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),
    p.signif.adj = case_when(
      p_adj < 0.01 ~ "***",
      p_adj < 0.05 ~ "**",
      p_adj < 0.1 ~ "*",
      TRUE ~ "ns"
    )
  ) %>%
  ungroup()

p_values <- p_values %>%
  left_join(global_tests, by = "Ville_eval") %>%
  filter(p_global < 0.1)

# Ajouter positions Y pour affichage
max_prev <- prevalence %>% group_by(Ville_eval) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Ville_eval") %>%
  group_by(Ville_eval) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

p_values_sig <- p_values %>% filter(p_adj < 0.1)

# Graphique : chaque facette est une ville, comparaisons entre méthodes
ggplot(data_long, aes(x = Méthode, y = Résultat_bin * 100, fill = Méthode)) +
  scale_fill_manual(values = c(
    "OMS2011" = "#1b9e77",
    "OMS2024" = "#d95f02",
    "SD" = "#7570b3",
    "2SD" = "#e7298a"
  )) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  stat_pvalue_manual(
    data = p_values_sig,
    label = "p.signif.adj",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  facet_wrap(~ Ville_eval, scales = "fixed") +
  labs(
    title = "Comparison of anemia detection methods in 0-3 year olds, by city",
    x = "Methods",
    y = "Prevalence (%)",
    fill = "Methods (anemia)",
  caption = "* p < 0.1   ** p < 0.05   *** p < 0.01"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
data = read.csv("data/diags.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]
data = data[, -c(10,13)]

data_long <- data %>%
  pivot_longer(
    cols = starts_with("Anemie_"),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Anémie"
  )

data_long$Ville_eval <- factor(data_long$Ville_eval, levels = c("Lima", "Cusco", "Juliaca", "Rinconada"))
data_long$Méthode <- factor(data_long$Méthode)
data_long$Méthode <- gsub("Anemie_", "", data_long$Méthode)
data_long$Méthode <- gsub("_kg", "/kg)", data_long$Méthode)
data_long$Méthode <- gsub("_", " (", data_long$Méthode)

levels(data_long$Ville_eval) <- c(
  "Lima (150m)",
  "Cusco (3400m)",
  "Juliaca (3800m)",
  "La Rinconada (5100m - 5300m)"
)

# Test global par ville
global_tests <- data_long %>%
  group_by(Ville_eval) %>%
  summarise(
    p_global = {
      tbl <- table(Méthode, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl, simulate.p.value = TRUE)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

# Prévalence par ville et méthode
prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

# Comparaisons entre méthodes dans chaque ville
method_pairs <- combn(unique(data_long$Méthode), 2, simplify = FALSE)

all_pvals <- lapply(method_pairs, function(pair) {
  m1 <- pair[1]
  m2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Méthode %in% pair)
  
  data_sub %>%
    group_by(Ville_eval) %>%
    summarise(
      p = {
        tbl <- table(Méthode, Résultat_bin)
        if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
      },
      group1 = m1,
      group2 = m2,
      .groups = "drop"
    )
})

p_values <- bind_rows(all_pvals) %>%
  group_by(Ville_eval) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),
    p.signif.adj = case_when(
      p_adj < 0.01 ~ "***",
      p_adj < 0.05 ~ "**",
      p_adj < 0.1 ~ "*",
      TRUE ~ "ns"
    )
  ) %>%
  ungroup()

p_values <- p_values %>%
  left_join(global_tests, by = "Ville_eval") %>%
  filter(p_global < 0.1)

# Ajouter positions Y pour affichage
max_prev <- prevalence %>% group_by(Ville_eval) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Ville_eval") %>%
  group_by(Ville_eval) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

p_values_sig <- p_values %>% filter(p_adj < 0.1)

# Graphique : chaque facette est une ville, comparaisons entre méthodes
ggplot(data_long, aes(x = Méthode, y = Résultat_bin * 100, fill = Méthode)) +
  scale_x_discrete(limits = c("OMS2011", "OMS2024", "SD", "2SD", "SD (Hbmass/kg)", "2SD (Hbmass/kg)")) +
  scale_fill_manual(values = c(
    "OMS2011" = "#1b9e77",
    "OMS2024" = "#d95f02",
    "SD" = "#7570b3",
    "2SD" = "#e7298a",
    "SD (Hbmass/kg)" = "#66a61e",
    "2SD (Hbmass/kg)" = "#e6ab02"
  )) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  stat_pvalue_manual(
    data = p_values_sig,
    label = "p.signif.adj",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  facet_wrap(~ Ville_eval, scales = "fixed") +
  labs(
    title = "Comparison of anemia detection methods in 8-12 year olds, by city",
    x = "Methods",
    y = "Prevalence (%)",
    fill = "Methods (anemia)",
  caption = "* p < 0.1   ** p < 0.05   *** p < 0.01"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
## Polyglobulie
```{r}
data = read.csv("data/diags.csv")
data = data[data$Age_categorie_binaire == "0-3 ans", ]
data = data[, -c(18,19,20,21)]
data_long <- data %>%
  pivot_longer(
    cols = starts_with("Polyglobulie_"),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Polyglobulie"
  )

data_long$Ville_eval <- factor(data_long$Ville_eval, levels = c("Lima", "Cusco", "Juliaca", "Rinconada"))
data_long$Méthode <- gsub("Polyglobulie_", "", data_long$Méthode)
data_long$Méthode <- gsub("14.5_", "", data_long$Méthode)

levels(data_long$Ville_eval) <- c(
  "Lima (150m)",
  "Cusco (3400m)",
  "Juliaca (3800m)",
  "La Rinconada (5100m - 5300m)"
)

# Test global par ville
global_tests <- data_long %>%
  group_by(Ville_eval) %>%
  summarise(
    p_global = {
      tbl <- table(Méthode, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

# Prévalence par ville et méthode
prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

# Comparaisons entre méthodes dans chaque ville
method_pairs <- combn(unique(data_long$Méthode), 2, simplify = FALSE)

all_pvals <- lapply(method_pairs, function(pair) {
  m1 <- pair[1]
  m2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Méthode %in% pair)
  
  data_sub %>%
    group_by(Ville_eval) %>%
    summarise(
      p = {
        tbl <- table(Méthode, Résultat_bin)
        if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
      },
      group1 = m1,
      group2 = m2,
      .groups = "drop"
    )
})

p_values <- bind_rows(all_pvals) %>%
  group_by(Ville_eval) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),
    p.signif.adj = case_when(
      p_adj < 0.01 ~ "***",
      p_adj < 0.05 ~ "**",
      p_adj < 0.1 ~ "*",
      TRUE ~ "ns"
    )
  ) %>%
  ungroup()

p_values <- p_values %>%
  left_join(global_tests, by = "Ville_eval") %>%
  filter(p_global < 0.1)

# Ajouter positions Y pour affichage
max_prev <- prevalence %>% group_by(Ville_eval) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Ville_eval") %>%
  group_by(Ville_eval) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

p_values_sig <- p_values %>% filter(p_adj < 0.1)

# Graphique : chaque facette est une ville, comparaisons entre méthodes
ggplot(data_long, aes(x = Méthode, y = Résultat_bin * 100, fill = Méthode)) +
  scale_x_discrete(limits = c("OMS2011", "OMS2024", "SD", "2SD")) +
  scale_fill_manual(values = c(
    "OMS2011" = "#1b9e77",
    "OMS2024" = "#d95f02",
    "SD" = "#7570b3",
    "2SD" = "#e7298a"
  )) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  stat_pvalue_manual(
    data = p_values_sig,
    label = "p.signif.adj",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  facet_wrap(~ Ville_eval, scales = "fixed") +
  labs(
    title = "Comparison of polycythemia detection methods in 0-3 year olds, by city",
    x = "Methods",
    y = "Prevalence (%)",
    fill = "Methods (polycythemia)",
  caption = "* p < 0.1   ** p < 0.05   *** p < 0.01"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
data = read.csv("data/diags.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]
data = data[, -c(18,21)]
data_long <- data %>%
  pivot_longer(
    cols = starts_with("Polyglobulie_"),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Polyglobulie"
  )

data_long$Ville_eval <- factor(data_long$Ville_eval, levels = c("Lima", "Cusco", "Juliaca", "Rinconada"))
data_long$Méthode <- gsub("Polyglobulie_", "", data_long$Méthode)
data_long$Méthode <- gsub("14.5_", "", data_long$Méthode)
data_long$Méthode <- gsub("_kg", "/kg)", data_long$Méthode)
data_long$Méthode <- gsub("_", " (", data_long$Méthode)

levels(data_long$Ville_eval) <- c(
  "Lima (150m)",
  "Cusco (3400m)",
  "Juliaca (3800m)",
  "La Rinconada (5100m - 5300m)"
)

# Test global par ville
global_tests <- data_long %>%
  group_by(Ville_eval) %>%
  summarise(
    p_global = {
      tbl <- table(Méthode, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl, simulate.p.value = TRUE)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )


# Prévalence par ville et méthode
prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

# Comparaisons entre méthodes dans chaque ville
method_pairs <- combn(unique(data_long$Méthode), 2, simplify = FALSE)

all_pvals <- lapply(method_pairs, function(pair) {
  m1 <- pair[1]
  m2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Méthode %in% pair)
  
  data_sub %>%
    group_by(Ville_eval) %>%
    summarise(
      p = {
        tbl <- table(Méthode, Résultat_bin)
        if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
      },
      group1 = m1,
      group2 = m2,
      .groups = "drop"
    )
})

p_values <- bind_rows(all_pvals) %>%
  group_by(Ville_eval) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),
    p.signif.adj = case_when(
      p_adj < 0.01 ~ "***",
      p_adj < 0.05 ~ "**",
      p_adj < 0.1 ~ "*",
      TRUE ~ "ns"
    )
  ) %>%
  ungroup()

p_values <- p_values %>%
  left_join(global_tests, by = "Ville_eval") %>%
  filter(p_global < 0.1)

# Ajouter positions Y pour affichage
max_prev <- prevalence %>% group_by(Ville_eval) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Ville_eval") %>%
  group_by(Ville_eval) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

p_values_sig <- p_values %>% filter(p_adj < 0.1)

# Graphique : chaque facette est une ville, comparaisons entre méthodes
ggplot(data_long, aes(x = Méthode, y = Résultat_bin * 100, fill = Méthode)) +
  scale_x_discrete(limits = c("OMS2011", "OMS2024", "SD", "2SD", "SD (Hbmass/kg)", "2SD (Hbmass/kg)")) +
  scale_fill_manual(values = c(
    "OMS2011" = "#1b9e77",
    "OMS2024" = "#d95f02",
    "SD" = "#7570b3",
    "2SD" = "#e7298a",
    "SD (Hbmass/kg)" = "#66a61e",
    "2SD (Hbmass/kg)" = "#e6ab02"
  )) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  stat_pvalue_manual(
    data = p_values_sig,
    label = "p.signif.adj",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  facet_wrap(~ Ville_eval, scales = "fixed") +
  labs(
    title = "Comparison of polycythemia detection methods in 8-12 year olds, by city",
    x = "Methods",
    y = "Prevalence (%)",
    fill = "Methods (polycythemia)",
  caption = "* p < 0.1   ** p < 0.05   *** p < 0.01"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Nutrition

```{r}
# FULL 03
nutri = read.csv("data/nutri.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data <- data[data$Age_categorie_binaire == "0-3 ans",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ Pr..g. + L.g.+ G.g.+ Fibres + Calcium.....mg.+ Fer..mg.100.g.+ Zinc..mg.100.g.+ Vitamine.C..mg., data = df),
      mod2 = lm(HCT.. ~ Pr..g. + L.g.+ G.g.+ Fibres + Calcium.....mg.+ Fer..mg.100.g.+ Zinc..mg.100.g.+ Vitamine.C..mg., data = df),
      mod3 = lm(MCV..fL. ~ Pr..g. + L.g.+ G.g.+ Fibres + Calcium.....mg.+ Fer..mg.100.g.+ Zinc..mg.100.g.+ Vitamine.C..mg., data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod1, conf.int = TRUE) %>% mutate(model = "HB"),
    tidy(mods$mod2, conf.int = TRUE) %>% mutate(model = "HCT"),
    tidy(mods$mod3, conf.int = TRUE) %>% mutate(model = "MCV (fL)"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "Pr..g."] <- "Protein (g)"
coef_data$term[coef_data$term == "L.g."] <- "Lipids (g)"
coef_data$term[coef_data$term == "G.g."] <- "Carbohydrates (g)"
coef_data$term[coef_data$term == "Fibres"] <- "Fibers"
coef_data$term[coef_data$term == "Calcium.....mg."] <- "Calcium (mg)"
coef_data$term[coef_data$term == "Fer..mg.100.g."] <- "Iron (mg/100g)"
coef_data$term[coef_data$term == "Zinc..mg.100.g."] <- "Zinc (mg/100g)"
coef_data$term[coef_data$term == "Vitamine.C..mg."] <- "Vitamin C (mg)"

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
   "HB" = "#1b9e77",           # vert foncé
  "HCT" = "#e6ab02",          # orange
  "MCV (fL)" = "#7570b3"     # violet
  )) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "Multiple linear regressions (nutrition) for each blood indicator, by city for 0-3 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# FULL 12
nutri = read.csv("data/nutri.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data <- data[data$Age_categorie_binaire == "8-12 ans",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ Pr..g. + L.g.+ G.g.+ Fibres + Calcium.....mg.+ Fer..mg.100.g.+ Zinc..mg.100.g.+ Vitamine.C..mg., data = df),
      mod2 = lm(HCT.. ~ Pr..g. + L.g.+ G.g.+ Fibres + Calcium.....mg.+ Fer..mg.100.g.+ Zinc..mg.100.g.+ Vitamine.C..mg., data = df),
      mod3 = lm(MCV..fL. ~ Pr..g. + L.g.+ G.g.+ Fibres + Calcium.....mg.+ Fer..mg.100.g.+ Zinc..mg.100.g.+ Vitamine.C..mg., data = df),
      mod4 = lm(RBCV..ml. ~ Pr..g. + L.g.+ G.g.+ Fibres + Calcium.....mg.+ Fer..mg.100.g.+ Zinc..mg.100.g.+ Vitamine.C..mg., data = df),
      mod5 = lm(Hb.mass..g. ~ Pr..g. + L.g.+ G.g.+ Fibres + Calcium.....mg.+ Fer..mg.100.g.+ Zinc..mg.100.g.+ Vitamine.C..mg., data = df),
      mod6 = lm(Hb.mass.kg..g...kg. ~ Pr..g. + L.g.+ G.g.+ Fibres + Calcium.....mg.+ Fer..mg.100.g.+ Zinc..mg.100.g.+ Vitamine.C..mg., data = df),
      mod7 = lm(PV.ml. ~ Pr..g. + L.g.+ G.g.+ Fibres + Calcium.....mg.+ Fer..mg.100.g.+ Zinc..mg.100.g.+ Vitamine.C..mg., data = df),
      mod8 = lm(PV..kg..ml.kg. ~ Pr..g. + L.g.+ G.g.+ Fibres + Calcium.....mg.+ Fer..mg.100.g.+ Zinc..mg.100.g.+ Vitamine.C..mg., data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod1, conf.int = TRUE) %>% mutate(model = "HB"),
    tidy(mods$mod2, conf.int = TRUE) %>% mutate(model = "HCT"),
    tidy(mods$mod3, conf.int = TRUE) %>% mutate(model = "MCV (fL)"),
    tidy(mods$mod3, conf.int = TRUE) %>% mutate(model = "RBCV (ml)"),
    tidy(mods$mod3, conf.int = TRUE) %>% mutate(model = "Hbmass (g)"),
    tidy(mods$mod3, conf.int = TRUE) %>% mutate(model = "Hbmass (g/kg)"),
    tidy(mods$mod3, conf.int = TRUE) %>% mutate(model = "PV (ml)"),
    tidy(mods$mod3, conf.int = TRUE) %>% mutate(model = "PV (ml/kg)"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
  "HB" = "#1b9e77",           # vert foncé
  "HCT" = "#e6ab02",          # orange
  "MCV (fL)" = "#7570b3",     # violet
  "RBCV (ml)" = "#e7298a",    # rose fuchsia
  "Hbmass (g)" = "#66a61e",   # vert olive
  "Hbmass (g/kg)" = "#d95f02",# jaune foncé
  "PV (ml)" = "#a6761d",      # brun
  "PV (ml/kg)" = "#666666"    # gris foncé
)) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Explained variable", shape = "Significatif ?", title = "Multiple linear regressions (nutrition) for each blood indicator, by city for 8-12 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HB 03
nutri = read.csv("data/nutri.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data <- data[data$Age_categorie_binaire == "0-3 ans",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(HB ~ Pr..g., data = df),
  mod_Lipides   = lm(HB ~ L.g., data = df),
  mod_Glucides  = lm(HB ~ G.g., data = df),
  mod_Fibres    = lm(HB ~ Fibres, data = df),
  mod_Calcium   = lm(HB ~ Calcium.....mg., data = df),
  mod_Fer       = lm(HB ~ Fer..mg.100.g., data = df),
  mod_Zinc      = lm(HB ~ Zinc..mg.100.g., data = df),
  mod_VitC      = lm(HB ~ Vitamine.C..mg., data = df),
  Altitude      = unique(df$Altitude)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Protein"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Lipids"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Carbohydrates"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Fibers"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Calcium"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Iron"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vit.C"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "HB - Simple linear regressions (nutrition) by city for 0-3 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HB 12
nutri = read.csv("data/nutri.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data <- data[data$Age_categorie_binaire == "8-12 ans",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(HB ~ Pr..g., data = df),
  mod_Lipides   = lm(HB ~ L.g., data = df),
  mod_Glucides  = lm(HB ~ G.g., data = df),
  mod_Fibres    = lm(HB ~ Fibres, data = df),
  mod_Calcium   = lm(HB ~ Calcium.....mg., data = df),
  mod_Fer       = lm(HB ~ Fer..mg.100.g., data = df),
  mod_Zinc      = lm(HB ~ Zinc..mg.100.g., data = df),
  mod_VitC      = lm(HB ~ Vitamine.C..mg., data = df),
  Altitude      = unique(df$Altitude)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Protein"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Lipids"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Carbohydrates"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Fibers"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Calcium"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Iron"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vit.C"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "HB - Simple linear regressions (nutrition) by city for 8-12 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HCT 03
nutri = read.csv("data/nutri.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data <- data[data$Age_categorie_binaire == "0-3 ans",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(HCT.. ~ Pr..g., data = df),
  mod_Lipides   = lm(HCT.. ~ L.g., data = df),
  mod_Glucides  = lm(HCT.. ~ G.g., data = df),
  mod_Fibres    = lm(HCT.. ~ Fibres, data = df),
  mod_Calcium   = lm(HCT.. ~ Calcium.....mg., data = df),
  mod_Fer       = lm(HCT.. ~ Fer..mg.100.g., data = df),
  mod_Zinc      = lm(HCT.. ~ Zinc..mg.100.g., data = df),
  mod_VitC      = lm(HCT.. ~ Vitamine.C..mg., data = df),
  Altitude      = unique(df$Altitude)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Protein"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Lipids"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Carbohydrates"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Fibers"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Calcium"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Iron"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vit.C"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "HCT - Simple linear regressions (nutrition) by city for 0-3 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HCT 12
nutri = read.csv("data/nutri.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data <- data[data$Age_categorie_binaire == "8-12 ans",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(HCT.. ~ Pr..g., data = df),
  mod_Lipides   = lm(HCT.. ~ L.g., data = df),
  mod_Glucides  = lm(HCT.. ~ G.g., data = df),
  mod_Fibres    = lm(HCT.. ~ Fibres, data = df),
  mod_Calcium   = lm(HCT.. ~ Calcium.....mg., data = df),
  mod_Fer       = lm(HCT.. ~ Fer..mg.100.g., data = df),
  mod_Zinc      = lm(HCT.. ~ Zinc..mg.100.g., data = df),
  mod_VitC      = lm(HCT.. ~ Vitamine.C..mg., data = df),
  Altitude      = unique(df$Altitude)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Protein"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Lipids"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Carbohydrates"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Fibers"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Calcium"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Iron"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vit.C"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "HCT - Simple linear regressions (nutrition) by city for 8-12 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# MCV 03
nutri = read.csv("data/nutri.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data <- data[data$Age_categorie_binaire == "0-3 ans",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(MCV..fL. ~ Pr..g., data = df),
  mod_Lipides   = lm(MCV..fL. ~ L.g., data = df),
  mod_Glucides  = lm(MCV..fL. ~ G.g., data = df),
  mod_Fibres    = lm(MCV..fL. ~ Fibres, data = df),
  mod_Calcium   = lm(MCV..fL. ~ Calcium.....mg., data = df),
  mod_Fer       = lm(MCV..fL. ~ Fer..mg.100.g., data = df),
  mod_Zinc      = lm(MCV..fL. ~ Zinc..mg.100.g., data = df),
  mod_VitC      = lm(MCV..fL. ~ Vitamine.C..mg., data = df),
  Altitude      = unique(df$Altitude)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Protein"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Lipids"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Carbohydrates"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Fibers"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Calcium"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Iron"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vit.C"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "MCV (fL) - Simple linear regressions (nutrition) by city for 0-3 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# MCV 812
nutri = read.csv("data/nutri.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data$Age_categorie_binaire[data$Age_categorie_binaire == "8-12 ans"] <- "8-12"
data$Age_categorie_binaire[data$Age_categorie_binaire == "0-3 ans"] <- "0-3"
data <- data[data$Age_categorie_binaire == "8-12",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(MCV..fL. ~ Pr..g., data = df),
  mod_Lipides   = lm(MCV..fL. ~ L.g., data = df),
  mod_Glucides  = lm(MCV..fL. ~ G.g., data = df),
  mod_Fibres    = lm(MCV..fL. ~ Fibres, data = df),
  mod_Calcium   = lm(MCV..fL. ~ Calcium.....mg., data = df),
  mod_Fer       = lm(MCV..fL. ~ Fer..mg.100.g., data = df),
  mod_Zinc      = lm(MCV..fL. ~ Zinc..mg.100.g., data = df),
  mod_VitC      = lm(MCV..fL. ~ Vitamine.C..mg., data = df),
  Altitude      = unique(df$Altitude)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Protein"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Lipids"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Carbohydrates"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Fibers"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Calcium"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Iron"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vit.C"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = paste0("MCV (fL) - Simple linear regressions (nutrition) by city for ", unique(data$Age_categorie_binaire), " years old")) +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# RBCV 812
nutri = read.csv("data/nutri.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data$Age_categorie_binaire[data$Age_categorie_binaire == "8-12 ans"] <- "8-12"
data$Age_categorie_binaire[data$Age_categorie_binaire == "0-3 ans"] <- "0-3"
data <- data[data$Age_categorie_binaire == "8-12",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(RBCV..ml. ~ Pr..g., data = df),
  mod_Lipides   = lm(RBCV..ml. ~ L.g., data = df),
  mod_Glucides  = lm(RBCV..ml. ~ G.g., data = df),
  mod_Fibres    = lm(RBCV..ml. ~ Fibres, data = df),
  mod_Calcium   = lm(RBCV..ml. ~ Calcium.....mg., data = df),
  mod_Fer       = lm(RBCV..ml. ~ Fer..mg.100.g., data = df),
  mod_Zinc      = lm(RBCV..ml. ~ Zinc..mg.100.g., data = df),
  mod_VitC      = lm(RBCV..ml. ~ Vitamine.C..mg., data = df),
  Altitude      = unique(df$Altitude)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Protein"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Lipids"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Carbohydrates"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Fibers"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Calcium"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Iron"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vit.C"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = paste0("RBCV (ml) - Simple linear regressions (nutrition) by city for ", unique(data$Age_categorie_binaire), " years old")) +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HBMASS (g) 812
nutri = read.csv("data/nutri.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data$Age_categorie_binaire[data$Age_categorie_binaire == "8-12 ans"] <- "8-12"
data$Age_categorie_binaire[data$Age_categorie_binaire == "0-3 ans"] <- "0-3"
data <- data[data$Age_categorie_binaire == "8-12",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(Hb.mass..g. ~ Pr..g., data = df),
  mod_Lipides   = lm(Hb.mass..g. ~ L.g., data = df),
  mod_Glucides  = lm(Hb.mass..g. ~ G.g., data = df),
  mod_Fibres    = lm(Hb.mass..g. ~ Fibres, data = df),
  mod_Calcium   = lm(Hb.mass..g. ~ Calcium.....mg., data = df),
  mod_Fer       = lm(Hb.mass..g. ~ Fer..mg.100.g., data = df),
  mod_Zinc      = lm(Hb.mass..g. ~ Zinc..mg.100.g., data = df),
  mod_VitC      = lm(Hb.mass..g. ~ Vitamine.C..mg., data = df),
  Altitude      = unique(df$Altitude)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Protein"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Lipids"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Carbohydrates"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Fibers"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Calcium"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Iron"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vit.C"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = paste0("Hbmass (g) - Simple linear regressions (nutrition) by city for ", unique(data$Age_categorie_binaire), " years old")) +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HBMASS (g/kg) 812
nutri = read.csv("data/nutri.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data$Age_categorie_binaire[data$Age_categorie_binaire == "8-12 ans"] <- "8-12"
data$Age_categorie_binaire[data$Age_categorie_binaire == "0-3 ans"] <- "0-3"
data <- data[data$Age_categorie_binaire == "8-12",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(Hb.mass.kg..g...kg. ~ Pr..g., data = df),
  mod_Lipides   = lm(Hb.mass.kg..g...kg. ~ L.g., data = df),
  mod_Glucides  = lm(Hb.mass.kg..g...kg. ~ G.g., data = df),
  mod_Fibres    = lm(Hb.mass.kg..g...kg. ~ Fibres, data = df),
  mod_Calcium   = lm(Hb.mass.kg..g...kg. ~ Calcium.....mg., data = df),
  mod_Fer       = lm(Hb.mass.kg..g...kg. ~ Fer..mg.100.g., data = df),
  mod_Zinc      = lm(Hb.mass.kg..g...kg. ~ Zinc..mg.100.g., data = df),
  mod_VitC      = lm(Hb.mass.kg..g...kg. ~ Vitamine.C..mg., data = df),
  Altitude      = unique(df$Altitude)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Protein"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Lipids"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Carbohydrates"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Fibers"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Calcium"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Iron"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vit.C"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = paste0("Hbmass (g/kg) - Simple linear regressions (nutrition) by city for ", unique(data$Age_categorie_binaire), " years old")) +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# PVML 812
nutri = read.csv("data/nutri.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data$Age_categorie_binaire[data$Age_categorie_binaire == "8-12 ans"] <- "8-12"
data$Age_categorie_binaire[data$Age_categorie_binaire == "0-3 ans"] <- "0-3"
data <- data[data$Age_categorie_binaire == "8-12",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(PV.ml. ~ Pr..g., data = df),
  mod_Lipides   = lm(PV.ml. ~ L.g., data = df),
  mod_Glucides  = lm(PV.ml. ~ G.g., data = df),
  mod_Fibres    = lm(PV.ml. ~ Fibres, data = df),
  mod_Calcium   = lm(PV.ml. ~ Calcium.....mg., data = df),
  mod_Fer       = lm(PV.ml. ~ Fer..mg.100.g., data = df),
  mod_Zinc      = lm(PV.ml. ~ Zinc..mg.100.g., data = df),
  mod_VitC      = lm(PV.ml. ~ Vitamine.C..mg., data = df),
  Altitude      = unique(df$Altitude)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Protein"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Lipids"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Carbohydrates"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Fibers"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Calcium"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Iron"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vit.C"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = paste0("PV (ml) - Simple linear regressions (nutrition) by city for ", unique(data$Age_categorie_binaire), " years old")) +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# PVMLkg 812
nutri = read.csv("data/nutri.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data$Age_categorie_binaire[data$Age_categorie_binaire == "8-12 ans"] <- "8-12"
data$Age_categorie_binaire[data$Age_categorie_binaire == "0-3 ans"] <- "0-3"
data <- data[data$Age_categorie_binaire == "8-12",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(PV..kg..ml.kg. ~ Pr..g., data = df),
  mod_Lipides   = lm(PV..kg..ml.kg. ~ L.g., data = df),
  mod_Glucides  = lm(PV..kg..ml.kg. ~ G.g., data = df),
  mod_Fibres    = lm(PV..kg..ml.kg. ~ Fibres, data = df),
  mod_Calcium   = lm(PV..kg..ml.kg. ~ Calcium.....mg., data = df),
  mod_Fer       = lm(PV..kg..ml.kg. ~ Fer..mg.100.g., data = df),
  mod_Zinc      = lm(PV..kg..ml.kg. ~ Zinc..mg.100.g., data = df),
  mod_VitC      = lm(PV..kg..ml.kg. ~ Vitamine.C..mg., data = df),
  Altitude      = unique(df$Altitude)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Protein"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Lipids"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Carbohydrates"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Fibers"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Calcium"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Iron"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vit.C"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = paste0("PV (ml/kg) - Simple linear regressions (nutrition) by city for ", unique(data$Age_categorie_binaire), " years old")) +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

# NUTI RNP

```{r}
# FULL 03
nutri = read.csv("data/nutri_RNP.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data <- data[data$Age_categorie_binaire == "0-3 ans",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ X..ENERGIE.RNP + X..CALCIUM...RNP + statut.Fer.inf+ statut.Fer.sup + statut.Zinc.inf + statut.Zinc.sup, data = df),
      mod2 = lm(HCT.. ~ X..ENERGIE.RNP + X..CALCIUM...RNP + statut.Fer.inf+ statut.Fer.sup + statut.Zinc.inf + statut.Zinc.sup, data = df),
      mod3 = lm(MCV..fL. ~ X..ENERGIE.RNP + X..CALCIUM...RNP + statut.Fer.inf+ statut.Fer.sup + statut.Zinc.inf + statut.Zinc.sup, data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod1, conf.int = TRUE) %>% mutate(model = "HB"),
    tidy(mods$mod2, conf.int = TRUE) %>% mutate(model = "HCT"),
    tidy(mods$mod3, conf.int = TRUE) %>% mutate(model = "MCV (fL)"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
   "HB" = "#1b9e77",           # vert foncé
  "HCT" = "#e6ab02",          # orange
  "MCV (fL)" = "#7570b3"     # violet
  )) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "Multiple linear regressions (nutrition RNP) for each blood indicator, by city for 0-3 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# FULL 12
nutri = read.csv("data/Nutri_RNP.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data <- data[data$Age_categorie_binaire == "8-12 ans",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)
# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ X..ENERGIE.RNP + X..CALCIUM...RNP + statut.Fer.inf+ statut.Fer.sup + statut.Zinc.inf + statut.Zinc.sup, data = df),
      mod2 = lm(HCT.. ~ X..ENERGIE.RNP + X..CALCIUM...RNP + statut.Fer.inf+ statut.Fer.sup + statut.Zinc.inf + statut.Zinc.sup, data = df),
      mod3 = lm(MCV..fL. ~ X..ENERGIE.RNP + X..CALCIUM...RNP + statut.Fer.inf+ statut.Fer.sup + statut.Zinc.inf + statut.Zinc.sup, data = df),
      mod4 = lm(RBCV..ml. ~ X..ENERGIE.RNP + X..CALCIUM...RNP + statut.Fer.inf+ statut.Fer.sup + statut.Zinc.inf + statut.Zinc.sup, data = df),
      mod5 = lm(Hb.mass..g. ~ X..ENERGIE.RNP + X..CALCIUM...RNP + statut.Fer.inf+ statut.Fer.sup + statut.Zinc.inf + statut.Zinc.sup, data = df),
      mod6 = lm(Hb.mass.kg..g...kg. ~ X..ENERGIE.RNP + X..CALCIUM...RNP + statut.Fer.inf+ statut.Fer.sup + statut.Zinc.inf + statut.Zinc.sup, data = df),
      mod7 = lm(PV.ml. ~ X..ENERGIE.RNP + X..CALCIUM...RNP + statut.Fer.inf+ statut.Fer.sup + statut.Zinc.inf + statut.Zinc.sup, data = df),
      mod8 = lm(PV..kg..ml.kg. ~ X..ENERGIE.RNP + X..CALCIUM...RNP + statut.Fer.inf+ statut.Fer.sup + statut.Zinc.inf + statut.Zinc.sup, data = df),
      Altitude = unique(df$Altitude)
    )
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod1, conf.int = TRUE) %>% mutate(model = "HB"),
    tidy(mods$mod2, conf.int = TRUE) %>% mutate(model = "HCT"),
    tidy(mods$mod3, conf.int = TRUE) %>% mutate(model = "MCV (fL)"),
    tidy(mods$mod3, conf.int = TRUE) %>% mutate(model = "RBCV (ml)"),
    tidy(mods$mod3, conf.int = TRUE) %>% mutate(model = "Hbmass (g)"),
    tidy(mods$mod3, conf.int = TRUE) %>% mutate(model = "Hbmass (g/kg)"),
    tidy(mods$mod3, conf.int = TRUE) %>% mutate(model = "PV (ml)"),
    tidy(mods$mod3, conf.int = TRUE) %>% mutate(model = "PV (ml/kg)"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"
ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
  "HB" = "#1b9e77",           # vert foncé
  "HCT" = "#e6ab02",          # orange
  "MCV (fL)" = "#7570b3",     # violet
  "RBCV (ml)" = "#e7298a",    # rose fuchsia
  "Hbmass (g)" = "#66a61e",   # vert olive
  "Hbmass (g/kg)" = "#d95f02",# jaune foncé
  "PV (ml)" = "#a6761d",      # brun
  "PV (ml/kg)" = "#666666"    # gris foncé
)) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "Multiple linear regressions (nutrition RNP) for each blood indicator, by city for 8-12 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HB 03
nutri = read.csv("data/Nutri_RNP.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data <- data[data$Age_categorie_binaire == "0-3 ans",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)


# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(HB ~ X..ENERGIE.RNP, data = df),
  mod_Lipides   = lm(HB ~ X..CALCIUM...RNP, data = df),
  mod_Glucides  = lm(HB ~ statut.Fer.inf, data = df),
  mod_Fibres    = lm(HB ~ statut.Fer.sup, data = df),
  mod_Calcium   = lm(HB ~ statut.Zinc.inf, data = df),
  mod_Fer       = lm(HB ~ statut.Zinc.sup, data = df),
  Altitude      = unique(df$Altitude)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "% kCal RNP"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "% Calcium RNP"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Low Iron"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "High Iron"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Low Zinc"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "High Zinc"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "HB - Simple linear regressions (nutrition RNP) by city for 0-3 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HB 12
nutri = read.csv("data/Nutri_RNP.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data <- data[data$Age_categorie_binaire == "8-12 ans",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(HB ~ X..ENERGIE.RNP, data = df),
  mod_Lipides   = lm(HB ~ X..CALCIUM...RNP, data = df),
  mod_Glucides  = lm(HB ~ statut.Fer.inf, data = df),
  mod_Fibres    = lm(HB ~ statut.Fer.sup, data = df),
  mod_Calcium   = lm(HB ~ statut.Zinc.inf, data = df),
  mod_Fer       = lm(HB ~ statut.Zinc.sup, data = df),
  Altitude      = unique(df$Altitude)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "% kCal RNP"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "% Calcium RNP"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Low Iron"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "High Iron"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Low Zinc"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "High Zinc"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"
ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "HB - Simple linear regressions (nutrition RNP) by city for 8-12 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HCT 03
nutri = read.csv("data/Nutri_RNP.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data <- data[data$Age_categorie_binaire == "0-3 ans",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(HCT.. ~ X..ENERGIE.RNP, data = df),
  mod_Lipides   = lm(HCT.. ~ X..CALCIUM...RNP, data = df),
  mod_Glucides  = lm(HCT.. ~ statut.Fer.inf, data = df),
  mod_Fibres    = lm(HCT.. ~ statut.Fer.sup, data = df),
  mod_Calcium   = lm(HCT.. ~ statut.Zinc.inf, data = df),
  mod_Fer       = lm(HCT.. ~ statut.Zinc.sup, data = df),
  Altitude      = unique(df$Altitude)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "% kCal RNP"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "% Calcium RNP"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Low Iron"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "High Iron"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Low Zinc"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "High Zinc"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"
ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "HCT - Simple linear regressions (nutrition RNP) by city for 0-3 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HCT 12
nutri = read.csv("data/Nutri_RNP.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data <- data[data$Age_categorie_binaire == "8-12 ans",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(HCT.. ~ X..ENERGIE.RNP, data = df),
  mod_Lipides   = lm(HCT.. ~ X..CALCIUM...RNP, data = df),
  mod_Glucides  = lm(HCT.. ~ statut.Fer.inf, data = df),
  mod_Fibres    = lm(HCT.. ~ statut.Fer.sup, data = df),
  mod_Calcium   = lm(HCT.. ~ statut.Zinc.inf, data = df),
  mod_Fer       = lm(HCT.. ~ statut.Zinc.sup, data = df),
  Altitude      = unique(df$Altitude)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "% kCal RNP"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "% Calcium RNP"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Low Iron"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "High Iron"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Low Zinc"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "High Zinc"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"
ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "HCT - Simple linear regressions (nutrition RNP) by city for 8-12 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# MCV 03
nutri = read.csv("data/Nutri_RNP.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data <- data[data$Age_categorie_binaire == "0-3 ans",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(MCV..fL. ~ X..ENERGIE.RNP, data = df),
  mod_Lipides   = lm(MCV..fL. ~ X..CALCIUM...RNP, data = df),
  mod_Glucides  = lm(MCV..fL. ~ statut.Fer.inf, data = df),
  mod_Fibres    = lm(MCV..fL. ~ statut.Fer.sup, data = df),
  mod_Calcium   = lm(MCV..fL. ~ statut.Zinc.inf, data = df),
  mod_Fer       = lm(MCV..fL. ~ statut.Zinc.sup, data = df),
  Altitude      = unique(df$Altitude)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "% kCal RNP"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "% Calcium RNP"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Low Iron"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "High Iron"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Low Zinc"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "High Zinc"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"
ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "MCV (fL) - Simple linear regressions (nutrition RNP) by city for 0-3 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# MCV 812
nutri = read.csv("data/Nutri_RNP.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data <- data[data$Age_categorie_binaire == "8-12 ans",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(MCV..fL. ~ X..ENERGIE.RNP, data = df),
  mod_Lipides   = lm(MCV..fL. ~ X..CALCIUM...RNP, data = df),
  mod_Glucides  = lm(MCV..fL. ~ statut.Fer.inf, data = df),
  mod_Fibres    = lm(MCV..fL. ~ statut.Fer.sup, data = df),
  mod_Calcium   = lm(MCV..fL. ~ statut.Zinc.inf, data = df),
  mod_Fer       = lm(MCV..fL. ~ statut.Zinc.sup, data = df),
  Altitude      = unique(df$Altitude)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "% kCal RNP"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "% Calcium RNP"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Low Iron"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "High Iron"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Low Zinc"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "High Zinc"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"
ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = paste0("MCV (fL) - Simple linear regressions (nutrition RNP) by city for ", unique(data$Age_categorie_binaire), " years old")) +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# RBCV 812
nutri = read.csv("data/Nutri_RNP.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data <- data[data$Age_categorie_binaire == "8-12 ans",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(RBCV..ml. ~ X..ENERGIE.RNP, data = df),
  mod_Lipides   = lm(RBCV..ml. ~ X..CALCIUM...RNP, data = df),
  mod_Glucides  = lm(RBCV..ml. ~ statut.Fer.inf, data = df),
  mod_Fibres    = lm(RBCV..ml. ~ statut.Fer.sup, data = df),
  mod_Calcium   = lm(RBCV..ml. ~ statut.Zinc.inf, data = df),
  mod_Fer       = lm(RBCV..ml. ~ statut.Zinc.sup, data = df),
  Altitude      = unique(df$Altitude)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "% kCal RNP"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "% Calcium RNP"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Low Iron"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "High Iron"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Low Zinc"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "High Zinc"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"
ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = paste0("RBCV (ml) - Simple linear regressions (nutrition RNP) by city for ", unique(data$Age_categorie_binaire), " years old")) +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HBMASS (g) 812
nutri = read.csv("data/Nutri_RNP.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data <- data[data$Age_categorie_binaire == "8-12 ans",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(Hb.mass..g. ~ X..ENERGIE.RNP, data = df),
  mod_Lipides   = lm(Hb.mass..g. ~ X..CALCIUM...RNP, data = df),
  mod_Glucides  = lm(Hb.mass..g. ~ statut.Fer.inf, data = df),
  mod_Fibres    = lm(Hb.mass..g. ~ statut.Fer.sup, data = df),
  mod_Calcium   = lm(Hb.mass..g. ~ statut.Zinc.inf, data = df),
  mod_Fer       = lm(Hb.mass..g. ~ statut.Zinc.sup, data = df),
  Altitude      = unique(df$Altitude)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "% kCal RNP"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "% Calcium RNP"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Low Iron"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "High Iron"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Low Zinc"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "High Zinc"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"
ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = paste0("Hbmass (g) - Simple linear regressions (nutrition RNP) by city for ", unique(data$Age_categorie_binaire), " years old")) +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HBMASS (g/kg) 812
nutri = read.csv("data/Nutri_RNP.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data <- data[data$Age_categorie_binaire == "8-12 ans",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
list(
    mod_Protéines = lm(Hb.mass.kg..g...kg. ~ X..ENERGIE.RNP, data = df),
  mod_Lipides   = lm(Hb.mass.kg..g...kg. ~ X..CALCIUM...RNP, data = df),
  mod_Glucides  = lm(Hb.mass.kg..g...kg. ~ statut.Fer.inf, data = df),
  mod_Fibres    = lm(Hb.mass.kg..g...kg. ~ statut.Fer.sup, data = df),
  mod_Calcium   = lm(Hb.mass.kg..g...kg. ~ statut.Zinc.inf, data = df),
  mod_Fer       = lm(Hb.mass.kg..g...kg. ~ statut.Zinc.sup, data = df),
  Altitude      = unique(df$Altitude)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "% kCal RNP"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "% Calcium RNP"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Low Iron"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "High Iron"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Low Zinc"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "High Zinc"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"
ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = paste0("Hbmass (g/kg) - Simple linear regressions (nutrition RNP) by city for ", unique(data$Age_categorie_binaire), " years old")) +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# PVML 812
nutri = read.csv("data/Nutri_RNP.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data <- data[data$Age_categorie_binaire == "8-12 ans",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(PV.ml. ~ X..ENERGIE.RNP, data = df),
  mod_Lipides   = lm(PV.ml. ~ X..CALCIUM...RNP, data = df),
  mod_Glucides  = lm(PV.ml. ~ statut.Fer.inf, data = df),
  mod_Fibres    = lm(PV.ml. ~ statut.Fer.sup, data = df),
  mod_Calcium   = lm(PV.ml. ~ statut.Zinc.inf, data = df),
  mod_Fer       = lm(PV.ml. ~ statut.Zinc.sup, data = df),
  Altitude      = unique(df$Altitude)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "% kCal RNP"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "% Calcium RNP"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Low Iron"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "High Iron"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Low Zinc"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "High Zinc"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"
ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = paste0("PV (ml) - Simple linear regressions (nutrition RNP) by city for ", unique(data$Age_categorie_binaire), " years old")) +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# PVMLkg 812
nutri = read.csv("data/Nutri_RNP.csv")
full = read.csv("data/datafinal.csv")
data = left_join(full, nutri, by = c("Code_Sujet", "Age_categorie_binaire"))
data <- data[data$Age_categorie_binaire == "8-12 ans",]

data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m - 5300m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m - 5300m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Altitude) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(PV..kg..ml.kg. ~ X..ENERGIE.RNP, data = df),
  mod_Lipides   = lm(PV..kg..ml.kg. ~ X..CALCIUM...RNP, data = df),
  mod_Glucides  = lm(PV..kg..ml.kg. ~ statut.Fer.inf, data = df),
  mod_Fibres    = lm(PV..kg..ml.kg. ~ statut.Fer.sup, data = df),
  mod_Calcium   = lm(PV..kg..ml.kg. ~ statut.Zinc.inf, data = df),
  mod_Fer       = lm(PV..kg..ml.kg. ~ statut.Zinc.sup, data = df),
  Altitude      = unique(df$Altitude)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Altitude

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "% kCal RNP"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "% Calcium RNP"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Low Iron"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "High Iron"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Low Zinc"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "High Zinc"),
  ) %>% mutate(Altitude = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"
ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = paste0("PV (ml/kg) - Simple linear regressions (nutrition RNP) by city for ", unique(data$Age_categorie_binaire), " years old")) +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Altitude) +
  theme_minimal() +
  theme(legend.position = "bottom")
```