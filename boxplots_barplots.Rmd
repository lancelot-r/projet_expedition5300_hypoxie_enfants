---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r, include = FALSE}
library(dplyr)
library(tidyr)
library(modelsummary)
library(glue)
library(gt)
library(car)
library(dunn.test)
library(rcompanion)
library(rstatix)
library(purrr)
library(ggplot2)
library(patchwork)
library(psych)
library(performance)
library(lmtest)
library(readxl)
library(openxlsx)
library(pheatmap)
library(ggpubr)
library(exact2x2)
library(officer)
library(rvg)
```

```{r}
ppt <- read_pptx()
# Boxplots 8-12 ans
groupes_vars <- list(

  # Identification & Demographics
  ident_demographics1 = c("Age_mois"),
  
  # Anthropometry
  anthropometry1 = c("Age_mois", "Taille", "Poids", "IMC"),

  # Hemoglobin and Anemia
  hemoglobin1 = c("HB", "HCT.."),

  # Hbmass and derived anemia
  hbmass1 = c("Hb.mass..g.", "Hb.mass.kg..g...kg."),

  # Viscosity
  blood_viscosity1 = c("visco.0.3", "visco.1.5", "visco.3", "visco.6", "visco.12", "visco.30", "visco.30.2", "visco.12.2", "visco.6.2"),
  blood_viscosity2 = c("visco.3.2", "visco.1.5.2", "visco.0.3.2"),

  # Blood counts
  blood_counts1 = c("GB..103.µL.", "Neu..103.µL.", "Linf..103.µL.", "Mon..103.µL.", "Eos..103.µL.", "Bas..103.µL.", "IMG..103.µL.", "Neu....", "Linf...."),
  blood_counts2 = c("Mon....", "Eos....", "Bas....", "IMG....", "RBC..106.µL.", "HGB..g.dL.", "HCT....", "MCV..fL.", "MCH..pg."),
  blood_counts3 = c("MCHC..g.dL.", "RDW.CV....", "RDW.SD..fL.", "PLT..103.µL.", "MPV..fL.", "PDW", "IPF....", "RET..106.µL.", "RET...."),
  blood_counts4 = c("NRBC..103.µL.", "NRBC....", "PCT....", "P.LCC..109.L.", "P.LCR....", "IRF....", "LFR....", "MFR....", "HFR....","Ret.HE..pg."),

  # Echocardiography - Left heart
  echo_left_heart1 = c("SC", "PAS", "PAD", "PAM", "SIV", "DTDVG", "PP", "DTSVG", "VTDVG"),
  echo_left_heart2 = c("DTDVGi", "DTSVGi", "VTDVGi", "h.r", "RWT", "FEVG..teich.", "vol.ej..teich.", "masseVG", "masse.VG.ind"),
  echo_left_heart3 = c("GLS.VG", "FEVG.auto", "diam.OG", "ao.og", "surf.OG", "vol.OG", "surf.OG.ind", "vol.OG.ind", "E.mit"),
  echo_left_heart4 = c("TDM.Emit", "A.mit", "E.A.mit", "E..lat", "E.e..mit", "CCVG", "ITVSSAo", "FC", "DC"),
  echo_left_heart5 = c("IC", "vol.éj..CCVG."),

  # Echocardiography - Right heart
  echo_right_heart1 = c("STDVD", "STSVD", "STDVDi", "STSVDi", "FR.VD", "strain.VD", "onde.S.tric", "TAPSE", "surf.OD"),
  echo_right_heart2 = c("vol.OD", "surf.OD.ind", "vol.OD.ind", "E.tric", "TDM.Etric", "A.tric", "E.A.tric", "vitesse.IT", "PAPs"),
  echo_right_heart3 = c("PAPm", "TVR", "ITV.pulm", "Tacc.pulm"),

  # Birth & family info

  # Comportement (BRIEF2)
  brief_scores1 = c("Infrecuencia", "Incoherencia", "Negatividad", "Inhibicion", "Inhibicion_Nota_T", "Supervision_Si_Mismo", "Supervision_Si_Mismo_Nota_T", "Flexibilidad", "Flexibilidad_Nota_T"),
  brief_scores2 = c("Control_Emocional", "Control_Emocional_Nota_T", "Iniciativa", "Iniciativa_Nota_T", "Memoria_Trabajo", "Memoria_Trabajo_Nota_T", "Planificacion_Organizacion", "Planificacion_Organizacion_Nota_T", "Supervision_Tarea"),
  brief_scores3 = c("Supervision_Tarea_Nota_T", "Organizacion_Materiales", "Organizacion_Materiales_Nota_T", "BRIEF_IAI", "BRIEF_IAI_Nota_T", "BRIEF_IFL", "BRIEF_IFL_Nota_T", "BRIEF_IME", "BRIEF_IME_Nota_T"),
  brief_scores4 = c("BRIEF_IGFE", "BRIEF_IGFE_Nota_T", "BRIEF2_IRCN", "BRIEF2_IRCN_Nota_T", "BRIEF2_IREM", "BRIEF2_IREM_Nota_T", "BRIEF2_IRCG", "BRIEF2_IRCG_Nota_T", "BRIEF2_IGE"),
  brief_scores5 = c("BRIEF2_IGE_Nota_T"),

  # Cognition and motor skills
  cognition_motor1 = c("DS_Matrice", "QI_Matrice", "DS_Code", "QI_Code", "DS_Barrage_partie_1", "DS_Barrage_partie_2", "QI_Barrage", "DS_Labyrinthe", "QI_Labyrinthe"),
  cognition_motor2 = c("DS_Purdue_Main_Dominante", "MD_Z", "DS_Purdue_Main_Non_Dominante", "MND_Z", "DS_Purdue_Coordination", "Coordination_Z", "DS_Purdue_Assemblage", "Assemblage_Z"),

  # Nutrition & intake
  nutrition1 = c("X..ENERGIE.RNP", "Calcium.....mg.", "X..CALCIUM...RNP", "Fer..mg.100.g.","Zinc..mg.100.g.", "X..vit.C...RNP", "kCalHors.fibres", "Fibres"),

  # Blood volume & iron parameters
  blood_volume1 = c("RBCV..ml.", "PV.ml.", "BV..ml.", "Hct....", "X.Hb...g.L..ABL.80", "Hb.NFS", "PV..kg..ml.kg.", "BV..kg..ml.kg.", "FER..micromol.L."),
  blood_volume2 = c("FERRITINE..microg.L.", "TRANSFERINE..g.L.", "RECEPTEUR.TRANSFERINE..mg.L.", "Coef.Sat.Tf", "sTfR.logTf", "Body.iron"),

  # Hormones & vitamins
  hormones_vitamins = c("PROGESTERONE", "OESTRADIOL", "Vit.B9", "Vit.B12", "ERFE..ng.mL."),

  # Anemia with iron

  # Additional mineral data
  mineral_data1 = c("Calcium..mg.", "Zinc..mg.", "Fer..mg.", "L.g.", "G.g."),
  mineral_data2 = c("Pr..g.", "Vitamine.C..mg."),

  # Inflammation
  inflammation = c("CRP..mg.L.")
)

ages <- c("8-12 ans")

# === Chargement de la base
data_all <- read.csv("datafinalfinal.csv")
data_all$Ville_eval <- factor(data_all$Ville_eval,
  levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)")
)

# === Boucle principale
for (nom_groupe in names(groupes_vars)) {
  mes_vars <- groupes_vars[[nom_groupe]]

  for (categorie_age in ages) {
    message("Traitement : ", nom_groupe, " – ", categorie_age)

    data <- data_all %>% filter(Age_categorie_binaire == categorie_age)

    data_long <- data %>%
      select(all_of(mes_vars), Ville_eval) %>%
      pivot_longer(cols = all_of(mes_vars), names_to = "Variable", values_to = "Valeur")
if (nrow(data_long %>% filter(!is.na(Valeur))) == 0) {
  message("Aucune donnée exploitable pour ", nom_groupe, " – ", categorie_age)
  next
}
    comparaisons <- data_long %>%
      group_split(Variable) %>%
      map_df(function(df) {
        variable <- unique(df$Variable)

        groupes_valides <- df %>%
          group_by(Ville_eval) %>%
          summarise(n = sum(!is.na(Valeur)), .groups = "drop") %>%
          filter(n >= 2) %>%
          nrow()

        if (groupes_valides < 2) {
          return(tibble(
            group1 = NA,
            group2 = NA,
            p.adj = NA,
            p.signif = "FAIL",
            Variable = variable,
            test_fail = TRUE
          ))
        }

        tryCatch({
          df %>%
            pairwise_t_test(
              Valeur ~ Ville_eval,
              p.adjust.method = "BH"
            ) %>%
            mutate(
              Variable = variable,
              p.signif = case_when(
                p.adj < 0.001 ~ "***",
                p.adj < 0.01 ~ "**",
                p.adj < 0.05  ~ "*"
              ),
              test_fail = FALSE
            )
        }, error = function(e) {
          tibble(
            group1 = NA,
            group2 = NA,
            p.adj = NA,
            p.signif = "FAIL",
            Variable = variable,
            test_fail = TRUE
          )
        })
      })

    # Position des p-values
    positions_max <- data_long %>%
      group_by(Variable) %>%
      summarise(base_y = max(Valeur, na.rm = TRUE), .groups = "drop")

    comparaisons <- comparaisons %>%
      left_join(positions_max, by = "Variable") %>%
      group_by(Variable) %>%
      mutate(
        y.position = base_y + 0.1 * base_y + 0.05 * base_y * row_number(),
        group1 = if_else(test_fail, "Lima (150m)", group1),
        group2 = if_else(test_fail, "Cusco (3400m)", group2)
      ) %>%
      ungroup()

    # Plot
    p <- ggplot(data_long, aes(x = Ville_eval, y = Valeur, fill = Ville_eval)) +
  facet_wrap(~Variable, scales = "free_y", ncol = 3) +
  geom_boxplot(outliers = F) +
  stat_pvalue_manual(
    data = comparaisons,
    label = "p.signif",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  scale_fill_manual(values = c(
    "Lima (150m)" = "#1b9e77",
    "Cusco (3400m)" = "#d95f02",
    "Juliaca (3800m)" = "#7570b3",
    "La Rinconada (5100m)" = "#e7298a"
  )) +
  labs(
    title = paste("Boxplots for each cities –", nom_groupe, "(", categorie_age, ")"),
    x = "City",
    y = "Value",
    fill = "City"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Convertir en format vectoriel
dml_plot <- dml(ggobj = p)

# Ajouter au PowerPoint
ppt <- ppt %>%
  add_slide(layout = "Title and Content", master = "Office Theme") %>%
  ph_with(dml_plot, location = ph_location(left = 0.0, top = 0.5, width = 10, height = 6.5))

  }
}

groupes_vars_categoriel <- list(
  anemie = c("Anemie_OMS2011", "Anemie_OMS2024", "Anemie_SD", "Anemie_2SD", "Anemie_1.5SD"),
  polyglobulie = c("Polyglobulie_14.5_OMS2011", "Polyglobulie_14.5_OMS2024", "Polyglobulie_SD", "Polyglobulie_2SD", "Polyglobulie_1.5SD"),
  statut_micronutriments = c("statut.Fer", "statut.Zinc"),
  inflammation = c("CRP.high..20", "CRP.high..5"),
  fer_complexes = c("Iron.deficiency", "Coef.Sat.Tf.bas", "Anemie_OMS2024_FER", "Anemie_OMS2011_FER"),
  hemolyse = c("Indice.hémolyse")
)

for (nom_groupe in names(groupes_vars_categoriel)) {
  mes_vars <- groupes_vars_categoriel[[nom_groupe]]

  for (categorie_age in ages) {
    message("Barplot : ", nom_groupe, " – ", categorie_age)

    data <- data_all %>% filter(Age_categorie_binaire == categorie_age)

    data_long <- data %>%
      select(all_of(mes_vars), Ville_eval) %>%
      pivot_longer(cols = all_of(mes_vars), names_to = "Variable", values_to = "Valeur") %>%
      filter(!is.na(Valeur)) %>%
      mutate(Valeur = as.factor(Valeur))

    if (nrow(data_long) == 0) {
      message("Aucune donnée exploitable pour ", nom_groupe, " – ", categorie_age)
      next
    }

    # Test de significativité (Chi2 ou Fisher selon effectifs)
    tests <- data_long %>%
      group_split(Variable) %>%
      map_df(function(df) {
        variable <- unique(df$Variable)
        tbl <- table(df$Valeur, df$Ville_eval)

        if (any(tbl < 5)) {
          test <- fisher.test(tbl, simulate.p.value = TRUE)
          method <- "Fisher"
        } else {
          test <- chisq.test(tbl)
          method <- "Chi2"
        }

        tibble(
          Variable = variable,
          p = test$p.value,
          method = method,
          p.signif = case_when(
            test$p.value < 0.001 ~ "***",
            test$p.value < 0.01 ~ "**",
            test$p.value < 0.05 ~ "*",
            TRUE ~ "ns"
          )
        )
      })

    # Ajouter info p-value pour affichage
    data_plot <- data_long %>%
      group_by(Ville_eval, Variable, Valeur) %>%
      summarise(N = n(), .groups = "drop") %>%
      group_by(Variable, Ville_eval) %>%
      mutate(Prop = N / sum(N)) %>%
      ungroup()

    data_plot <- data_plot %>%
      left_join(tests, by = "Variable")

    # Plot
    p <- ggplot(data_plot, aes(x = Ville_eval, y = Prop, fill = Valeur)) +
      geom_bar(stat = "identity", position = "dodge", width = 0.7) +
      facet_wrap(~Variable, scales = "free_y", ncol = 3) +
      geom_text(data = distinct(data_plot, Variable, p.signif),
                aes(label = paste0("p: ", p.signif)), 
                x = 1.5, y = 1.05, inherit.aes = FALSE, size = 4, hjust = 0) +
      scale_y_continuous(labels = scales::percent_format()) +
      scale_fill_brewer(palette = "Set1") +
      labs(
        title = paste("Barplots (", nom_groupe, " – ", categorie_age, ")"),
        x = "Ville", y = "Pourcentage", fill = "Catégorie"
      ) +
      theme_minimal(base_size = 14) +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))

    dml_plot <- dml(ggobj = p)

    # Sauvegarde PNG
    file_path <- tempfile(fileext = ".png")
    ggsave(file_path, plot = p, width = 10, height = 6, dpi = 300)

    # Ajout à PowerPoint
    ppt <- ppt %>%
      add_slide(layout = "Title and Content", master = "Office Theme") %>%
      ph_with(dml_plot, location = ph_location(left = 0.0, top = 0.5, width = 10, height = 6.5))
  }
}

# Sauvegarde du PowerPoint final
print(ppt, target = "boxplots_8_12_ans.pptx")
```
```{r}
ppt <- read_pptx()
# Boxplots 0-3 ans
groupes_vars <- list(
  
  # Anthropometry
  anthropometry1 = c("Age_mois", "Taille", "Poids", "IMC"),

  # Hemoglobin and Anemia
  hemoglobin1 = c("HB", "HCT.."),

  # Hbmass and derived anemia
  hbmass1 = c("Hb.mass..g.", "Hb.mass.kg..g...kg."),

  # Viscosity
  blood_viscosity1 = c("visco.0.3", "visco.1.5", "visco.3", "visco.6", "visco.12", "visco.30", "visco.30.2", "visco.12.2", "visco.6.2"),
  blood_viscosity2 = c("visco.3.2", "visco.1.5.2", "visco.0.3.2"),

  # Blood counts
  blood_counts1 = c("GB..103.µL.", "Neu..103.µL.", "Linf..103.µL.", "Mon..103.µL.", "Eos..103.µL.", "Bas..103.µL.", "IMG..103.µL.", "Neu....", "Linf...."),
  blood_counts2 = c("Mon....", "Eos....", "Bas....", "IMG....", "RBC..106.µL.", "HGB..g.dL.", "HCT....", "MCV..fL.", "MCH..pg."),
  blood_counts3 = c("MCHC..g.dL.", "RDW.CV....", "RDW.SD..fL.", "PLT..103.µL.", "MPV..fL.", "PDW", "IPF....", "RET..106.µL.", "RET...."),
  blood_counts4 = c("NRBC..103.µL.", "NRBC....", "PCT....", "P.LCC..109.L.", "P.LCR....", "IRF....", "LFR....", "MFR....", "HFR....","Ret.HE..pg."),

  # Echocardiography - Left heart
  echo_left_heart1 = c("SC", "PAS", "PAD", "PAM", "SIV", "DTDVG", "PP", "DTSVG", "VTDVG"),
  echo_left_heart2 = c("DTDVGi", "DTSVGi", "VTDVGi", "h.r", "RWT", "FEVG..teich.", "vol.ej..teich.", "masseVG", "masse.VG.ind"),
  echo_left_heart3 = c("GLS.VG", "FEVG.auto", "diam.OG", "ao.og", "surf.OG", "vol.OG", "surf.OG.ind", "vol.OG.ind", "E.mit"),
  echo_left_heart4 = c("TDM.Emit", "A.mit", "E.A.mit", "E..lat", "E.e..mit", "CCVG", "ITVSSAo", "FC", "DC"),
  echo_left_heart5 = c("IC", "vol.éj..CCVG."),

  # Echocardiography - Right heart
  echo_right_heart1 = c("STDVD", "STSVD", "STDVDi", "STSVDi", "FR.VD", "strain.VD", "onde.S.tric", "TAPSE", "surf.OD"),
  echo_right_heart2 = c("vol.OD", "surf.OD.ind", "vol.OD.ind", "E.tric", "TDM.Etric", "A.tric", "E.A.tric", "vitesse.IT", "PAPs"),
  echo_right_heart3 = c("PAPm", "TVR", "ITV.pulm", "Tacc.pulm"),

  # Birth & family info

  # Comportement (BRIEF2)
  brief_scores1 = c("Incoherencia", "Negatividad", "Inhibicion", "Inhibicion_Nota_T", "Flexibilidad", "Flexibilidad_Nota_T"),
  brief_scores2 = c("Control_Emocional", "Control_Emocional_Nota_T", "Memoria_Trabajo", "Memoria_Trabajo_Nota_T", "Planificacion_Organizacion", "Planificacion_Organizacion_Nota_T"),
  brief_scores3 = c("BRIEF_IAI", "BRIEF_IAI_Nota_T", "BRIEF_IFL", "BRIEF_IFL_Nota_T", "BRIEF_IME", "BRIEF_IME_Nota_T","BRIEF_IGFE", "BRIEF_IGFE_Nota_T"),

  # Cognition and motor skills
  cognition_motor1 = c("DS_Matrice", "QI_Matrice", "DS_Code", "QI_Code", "DS_Barrage_partie_1", "DS_Barrage_partie_2", "QI_Barrage", "DS_Labyrinthe", "QI_Labyrinthe"),
  cognition_motor2 = c("DS_Purdue_Main_Dominante", "MD_Z", "DS_Purdue_Main_Non_Dominante", "MND_Z", "DS_Purdue_Coordination", "Coordination_Z", "DS_Purdue_Assemblage", "Assemblage_Z"),

  # Nutrition & intake
  nutrition1 = c("X..ENERGIE.RNP", "Calcium.....mg.", "X..CALCIUM...RNP", "Fer..mg.100.g.","Zinc..mg.100.g.", "X..vit.C...RNP", "kCalHors.fibres", "Fibres"),

  # Blood volume & iron parameters

  blood_volume2 = c("FER..micromol.L.", "FERRITINE..microg.L.", "TRANSFERINE..g.L.", "RECEPTEUR.TRANSFERINE..mg.L.", "Coef.Sat.Tf", "sTfR.logTf", "Body.iron"),

  # Hormones & vitamins
  hormones_vitamins = c("Vit.B9", "Vit.B12", "ERFE..ng.mL."),

  # Anemia with iron

  # Additional mineral data
  mineral_data1 = c("Calcium..mg.", "Zinc..mg.", "Fer..mg.", "L.g.", "G.g."),
  mineral_data2 = c("Pr..g.", "Vitamine.C..mg."),

  # Inflammation
  inflammation = c("CRP..mg.L.")
)

ages <- c("0-3 ans")

# === Chargement de la base
data_all <- read.csv("datafinalfinal.csv")
data_all$Ville_eval <- factor(data_all$Ville_eval,
  levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)")
)

# === Boucle principale
for (nom_groupe in names(groupes_vars)) {
  mes_vars <- groupes_vars[[nom_groupe]]

  for (categorie_age in ages) {
    message("Traitement : ", nom_groupe, " – ", categorie_age)

    data <- data_all %>% filter(Age_categorie_binaire == categorie_age)

    data_long <- data %>%
      select(all_of(mes_vars), Ville_eval) %>%
      pivot_longer(cols = all_of(mes_vars), names_to = "Variable", values_to = "Valeur")
if (nrow(data_long %>% filter(!is.na(Valeur))) == 0) {
  message("Aucune donnée exploitable pour ", nom_groupe, " – ", categorie_age)
  next
}
    comparaisons <- data_long %>%
      group_split(Variable) %>%
      map_df(function(df) {
        variable <- unique(df$Variable)

        groupes_valides <- df %>%
          group_by(Ville_eval) %>%
          summarise(n = sum(!is.na(Valeur)), .groups = "drop") %>%
          filter(n >= 2) %>%
          nrow()

        if (groupes_valides < 2) {
          return(tibble(
            group1 = NA,
            group2 = NA,
            p.adj = NA,
            p.signif = "FAIL",
            Variable = variable,
            test_fail = TRUE
          ))
        }

        tryCatch({
          df %>%
            pairwise_t_test(
              Valeur ~ Ville_eval,
              p.adjust.method = "BH"
            ) %>%
            mutate(
              Variable = variable,
              p.signif = case_when(
                p.adj < 0.001 ~ "***",
                p.adj < 0.01 ~ "**",
                p.adj < 0.05  ~ "*"
              ),
              test_fail = FALSE
            )
        }, error = function(e) {
          tibble(
            group1 = NA,
            group2 = NA,
            p.adj = NA,
            p.signif = "FAIL",
            Variable = variable,
            test_fail = TRUE
          )
        })
      })

    # Position des p-values
    positions_max <- data_long %>%
      group_by(Variable) %>%
      summarise(base_y = max(Valeur, na.rm = TRUE), .groups = "drop")

    comparaisons <- comparaisons %>%
      left_join(positions_max, by = "Variable") %>%
      group_by(Variable) %>%
      mutate(
        y.position = base_y + 0.1 * base_y + 0.05 * base_y * row_number(),
        group1 = if_else(test_fail, "Lima (150m)", group1),
        group2 = if_else(test_fail, "Cusco (3400m)", group2)
      ) %>%
      ungroup()

    # Plot    
    p <- ggplot(data_long, aes(x = Ville_eval, y = Valeur, fill = Ville_eval)) +
  facet_wrap(~Variable, scales = "free_y", ncol = 3) +
  geom_boxplot(outliers = F) +
  stat_pvalue_manual(
    data = comparaisons,
    label = "p.signif",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  scale_fill_manual(values = c(
    "Lima (150m)" = "#1b9e77",
    "Cusco (3400m)" = "#d95f02",
    "Juliaca (3800m)" = "#7570b3",
    "La Rinconada (5100m)" = "#e7298a"
  )) +
  labs(
    title = paste("Boxplots for each cities –", nom_groupe, "(", categorie_age, ")"),
    x = "City",
    y = "Value",
    fill = "City"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Convertir en format vectoriel
dml_plot <- dml(ggobj = p)

# Ajouter au PowerPoint
ppt <- ppt %>%
  add_slide(layout = "Title and Content", master = "Office Theme") %>%
  ph_with(dml_plot, location = ph_location(left = 0.0, top = 0.5, width = 10, height = 6.5))

  }
}
groupes_vars_categoriel <- list(
  anemie = c("Anemie_OMS2011", "Anemie_OMS2024", "Anemie_SD", "Anemie_2SD", "Anemie_1.5SD"),
  polyglobulie = c("Polyglobulie_14.5_OMS2011", "Polyglobulie_14.5_OMS2024", "Polyglobulie_SD", "Polyglobulie_2SD", "Polyglobulie_1.5SD"),
  statut_micronutriments = c("statut.Fer", "statut.Zinc"),
  inflammation = c("CRP.high..20", "CRP.high..5"),
  fer_complexes = c("Iron.deficiency", "Coef.Sat.Tf.bas", "Anemie_OMS2024_FER", "Anemie_OMS2011_FER"),
  hemolyse = c("Indice.hémolyse")
)

for (nom_groupe in names(groupes_vars_categoriel)) {
  mes_vars <- groupes_vars_categoriel[[nom_groupe]]

  for (categorie_age in ages) {
    message("Barplot : ", nom_groupe, " – ", categorie_age)

    data <- data_all %>% filter(Age_categorie_binaire == categorie_age)

    data_long <- data %>%
      select(all_of(mes_vars), Ville_eval) %>%
      pivot_longer(cols = all_of(mes_vars), names_to = "Variable", values_to = "Valeur") %>%
      filter(!is.na(Valeur)) %>%
      mutate(Valeur = as.factor(Valeur))

    if (nrow(data_long) == 0) {
      message("Aucune donnée exploitable pour ", nom_groupe, " – ", categorie_age)
      next
    }

    # Test de significativité (Chi2 ou Fisher selon effectifs)
    tests <- data_long %>%
      group_split(Variable) %>%
      map_df(function(df) {
        variable <- unique(df$Variable)
        tbl <- table(df$Valeur, df$Ville_eval)

        if (any(tbl < 5)) {
          test <- fisher.test(tbl, simulate.p.value = TRUE)
          method <- "Fisher"
        } else {
          test <- chisq.test(tbl)
          method <- "Chi2"
        }

        tibble(
          Variable = variable,
          p = test$p.value,
          method = method,
          p.signif = case_when(
            test$p.value < 0.001 ~ "***",
            test$p.value < 0.01 ~ "**",
            test$p.value < 0.05 ~ "*",
            TRUE ~ "ns"
          )
        )
      })

    # Ajouter info p-value pour affichage
    data_plot <- data_long %>%
      group_by(Ville_eval, Variable, Valeur) %>%
      summarise(N = n(), .groups = "drop") %>%
      group_by(Variable, Ville_eval) %>%
      mutate(Prop = N / sum(N)) %>%
      ungroup()

    data_plot <- data_plot %>%
      left_join(tests, by = "Variable")

    # Plot
    p <- ggplot(data_plot, aes(x = Ville_eval, y = Prop, fill = Valeur)) +
      geom_bar(stat = "identity", position = "dodge", width = 0.7) +
      facet_wrap(~Variable, scales = "free_y", ncol = 3) +
      geom_text(data = distinct(data_plot, Variable, p.signif),
                aes(label = paste0("p: ", p.signif)), 
                x = 1.5, y = 1.05, inherit.aes = FALSE, size = 4, hjust = 0) +
      scale_y_continuous(labels = scales::percent_format()) +
      scale_fill_brewer(palette = "Set1") +
      labs(
        title = paste("Barplots (", nom_groupe, " – ", categorie_age, ")"),
        x = "City", y = "Percentage", fill = "Category"
      ) +
      theme_minimal(base_size = 14) +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))

    dml_plot <- dml(ggobj = p)

    # Sauvegarde PNG
    file_path <- tempfile(fileext = ".png")
    ggsave(file_path, plot = p, width = 10, height = 6, dpi = 300)

    # Ajout à PowerPoint
    ppt <- ppt %>%
      add_slide(layout = "Title and Content", master = "Office Theme") %>%
      ph_with(dml_plot, location = ph_location(left = 0.0, top = 0.5, width = 10, height = 6.5))
  }
}

# Sauvegarde du PowerPoint final
print(ppt, target = "boxplots_0_3_ans.pptx")
```

