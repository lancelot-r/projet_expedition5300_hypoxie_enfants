---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r, include = FALSE}
library(dplyr)
library(tidyr)
library(modelsummary)
library(glue)
library(gt)
library(car)
library(dunn.test)
library(rcompanion)
library(rstatix)
library(purrr)
library(ggplot2)
library(patchwork)
library(psych)
library(performance)
library(lmtest)
library(readxl)
library(openxlsx)
library(pheatmap)
library(ggpubr)
library(exact2x2)
```

# Comparaison methodes anémie et polyglobulie

## Effet par villes
```{r}
# Anemia 0-3 ans ville
data = read.csv("datafinalfinal.csv")
data = data[data$Age_categorie_binaire == "0-3 ans", ]
data_long <- data %>%
  pivot_longer(
    cols = c(Anemie_OMS2011, Anemie_OMS2024, Anemie_Hb1SD, Anemie_HB1.5SD, Anemie_Hb2SD),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Anémie"
  )
data_long$Ville_eval <- factor(data_long$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))
data_long$Méthode <- factor(
  data_long$Méthode,
  levels = c("Anemie_OMS2011", "Anemie_Hb1SD", "Anemie_Hb2SD", "Anemie_OMS2024", "Anemie_HB1.5SD"),
  labels = c("WHO2011", "[Hb] -1SD", "[Hb] -2SD", "WHO2024", "[Hb] -1.5SD")
)

global_tests <- data_long %>%
  group_by(Méthode) %>%
  summarise(
    p_global = {
      tbl <- table(Ville_eval, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

ville_pairs <- combn(unique(data_long$Ville_eval), 2, simplify = FALSE)

# Fonction pour calculer les p-values pour chaque paire de villes et chaque méthode
all_pvals <- lapply(ville_pairs, function(pair) {
  ville1 <- pair[1]
  ville2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Ville_eval %in% pair)
  
  data_sub %>%
    group_by(Méthode) %>%
    summarise(
      p = {
        tbl <- table(Ville_eval, Résultat_bin)
        if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
      },
      group1 = ville1,
      group2 = ville2,
      .groups = "drop"
    )
})

# Fusionner toutes les paires
p_values <- bind_rows(all_pvals)
p_values <- p_values %>%
  group_by(Méthode) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),  # méthode possible : "bonferroni", "holm", "BH", etc.
    p.signif.adj = case_when(
      p_adj < 0.001 ~ "***",
      p_adj < 0.01  ~ "**",
      p_adj < 0.05  ~ "*",
      TRUE          ~ "ns"
    )
  ) %>%
  ungroup()
p_values <- p_values %>%
  left_join(global_tests, by = "Méthode") %>%
  filter(p_global < 0.05)

# Ajouter des positions Y pour éviter le chevauchement des p-values
max_prev <- prevalence %>% group_by(Méthode) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Méthode") %>%
  group_by(Méthode) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

ggplot(data_long, aes(x = Ville_eval, y = Résultat_bin * 100, fill = Ville_eval)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  stat_pvalue_manual(
    data = p_values %>% filter(p.signif.adj != "ns"),
    label = "p.signif.adj",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  facet_wrap(~ Méthode, scales = "free_y") +
  labs(
    title = "Anemia prevalence by city (0-3 years old)",
    x = "City",
    y = "Prevalence (%)",
    fill = "City"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
# Anemia 8-12 ans ville
data = read.csv("datafinalfinal.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]
data_long <- data %>%
  pivot_longer(
    cols = c(Anemie_OMS2011, Anemie_OMS2024, Anemie_Hb1SD, Anemie_HB1.5SD, Anemie_Hb2SD, Anemie_1SD_Hbmass.g.kg, Anemie_1.5SD_Hbmass.kg, Anemie_2SD_Hbmass.g.kg),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Anémie"
  )
data_long$Ville_eval <- factor(data_long$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))
data_long$Méthode <- factor(
  data_long$Méthode,
  levels = c("Anemie_Hb1SD", "Anemie_1SD_Hbmass.g.kg", "Anemie_OMS2011", "Anemie_HB1.5SD", 
             "Anemie_1.5SD_Hbmass.kg", "Anemie_OMS2024", "Anemie_Hb2SD", "Anemie_2SD_Hbmass.g.kg"),
  labels = c("[Hb] -1SD", "Hbmass/kg -1SD", "WHO2011", "[Hb] -1.5SD", 
             "Hbmass/kg -1.5SD", "WHO2024", "[Hb] -2SD", "Hbmass/kg -2SD")
)



global_tests <- data_long %>%
  group_by(Méthode) %>%
  summarise(
    p_global = {
      tbl <- table(Ville_eval, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

ville_pairs <- combn(unique(data_long$Ville_eval), 2, simplify = FALSE)

# Fonction pour calculer les p-values pour chaque paire de villes et chaque méthode
all_pvals <- lapply(ville_pairs, function(pair) {
  ville1 <- pair[1]
  ville2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Ville_eval %in% pair)
  
  data_sub %>%
    group_by(Méthode) %>%
summarise(
  p = {
    tbl <- table(Ville_eval, Résultat_bin)
    if (nrow(tbl) > 1 && ncol(tbl) > 1) {
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    } else {
      NA_real_
    }
  },
  group1 = ville1,
  group2 = ville2,
  .groups = "drop"
)

})

# Fusionner toutes les paires
p_values <- bind_rows(all_pvals)
p_values <- p_values %>%
  group_by(Méthode) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),  # méthode possible : "bonferroni", "holm", "BH", etc.
    p.signif.adj = case_when(
      p_adj < 0.001 ~ "***",
      p_adj < 0.01  ~ "**",
      p_adj < 0.05  ~ "*",
      TRUE          ~ "ns"
    )
  ) %>%
  ungroup()
p_values <- p_values %>%
  left_join(global_tests, by = "Méthode") %>%
  filter(p_global < 0.05)

# Ajouter des positions Y pour éviter le chevauchement des p-values
max_prev <- prevalence %>% group_by(Méthode) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Méthode") %>%
  group_by(Méthode) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

ggplot(data_long, aes(x = Ville_eval, y = Résultat_bin * 100, fill = Ville_eval)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  stat_pvalue_manual(
    data = p_values,
    label = "p.signif.adj",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  facet_wrap(~ Méthode, scales = "free_y") +
  labs(
    title = "Anemia prevalence by city (8-12 years old)",
    x = "City",
    y = "Prevalence (%)",
    fill = "City"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
# Polyglobulie 0-3 ans ville

data = read.csv("datafinalfinal.csv")
data = data[data$Age_categorie_binaire == "0-3 ans", ]
data_long <- data %>%
  pivot_longer(
    cols = c(Polyglobulie_14.5_OMS2011, Polyglobulie_14.5_OMS2024, Polyglobulie_SD, Polyglobulie_1.5SD, Polyglobulie_2SD),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Anémie"
  )
data_long$Ville_eval <- factor(data_long$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))
data_long$Méthode <- factor(
  data_long$Méthode,
  levels = c("Polyglobulie_14.5_OMS2011", "Polyglobulie_14.5_OMS2024", "Polyglobulie_SD", "Polyglobulie_1.5SD", "Polyglobulie_2SD"),
  labels = c("WHO2011", "[Hb] +1SD", "[Hb] +2SD", "WHO2024", "[Hb] +1.5SD")
)

global_tests <- data_long %>%
  group_by(Méthode) %>%
  summarise(
    p_global = {
      tbl <- table(Ville_eval, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

ville_pairs <- combn(unique(data_long$Ville_eval), 2, simplify = FALSE)

# Fonction pour calculer les p-values pour chaque paire de villes et chaque méthode
all_pvals <- lapply(ville_pairs, function(pair) {
  ville1 <- pair[1]
  ville2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Ville_eval %in% pair)
  
    data_sub %>%
    group_by(Méthode) %>%
summarise(
  p = {
    tbl <- table(Ville_eval, Résultat_bin)
    if (nrow(tbl) > 1 && ncol(tbl) > 1) {
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    } else {
      NA_real_
    }
  },
  group1 = ville1,
  group2 = ville2,
  .groups = "drop"
)

})

# Fusionner toutes les paires
p_values <- bind_rows(all_pvals)
p_values <- p_values %>%
  group_by(Méthode) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),  # méthode possible : "bonferroni", "holm", "BH", etc.
    p.signif.adj = case_when(
      p_adj < 0.001 ~ "***",
      p_adj < 0.01  ~ "**",
      p_adj < 0.05  ~ "*",
      TRUE          ~ "ns"
    )
  ) %>%
  ungroup()
p_values <- p_values %>%
  left_join(global_tests, by = "Méthode") %>%
  filter(p_global < 0.05)

# Ajouter des positions Y pour éviter le chevauchement des p-values
max_prev <- prevalence %>% group_by(Méthode) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Méthode") %>%
  group_by(Méthode) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

if (nrow(p_values) == 0) {
  # Pas de comparaisons à annoter -> plot simple sans stat_pvalue_manual
  ggplot(data_long, aes(x = Ville_eval, y = Résultat_bin * 100, fill = Ville_eval)) +
    stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
    facet_wrap(~ Méthode, scales = "free_y") +
    labs(
      title = "Polycythemia prevalence by city (0-3 years old)",
      x = "City",
      y = "Prevalence (%)",
      fill = "City"
    ) +
    theme_minimal(base_size = 14) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
} else {
  # Plot complet avec annotations de p-value
  ggplot(data_long, aes(x = Ville_eval, y = Résultat_bin * 100, fill = Ville_eval)) +
    stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
    stat_pvalue_manual(
      data = p_values,
      label = "p.signif.adj",
      y.position = "y.position",
      xmin = "group1",
      xmax = "group2",
      tip.length = 0.01,
      bracket.size = 0.6,
      inherit.aes = FALSE
    ) +
    facet_wrap(~ Méthode, scales = "free_y") +
    labs(
      title = "Polycythemia prevalence by city (0-3 years old)",
      x = "City",
      y = "Prevalence (%)",
      fill = "City"
    ) +
    theme_minimal(base_size = 14) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
}
```

```{r}
# Polyglobulie 8-12 ans ville

data = read.csv("datafinalfinal.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]
data_long <- data %>%
  pivot_longer(
    cols = c(Polyglobulie_14.5_OMS2011, Polyglobulie_14.5_OMS2024, Polyglobulie_SD, Polyglobulie_1.5SD, Polyglobulie_2SD, Polyglobulie_SD_Hbmass_kg, Polyglobulie_1.5SD_Hbmass_kg, Polyglobulie_2SD_Hbmass_kg),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Anémie"
  )
data_long$Ville_eval <- factor(data_long$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))
data_long$Méthode <- factor(
  data_long$Méthode,
  levels = c(
    "Polyglobulie_SD", "Polyglobulie_SD_Hbmass_kg",
    "Polyglobulie_14.5_OMS2011", "Polyglobulie_1.5SD", "Polyglobulie_1.5SD_Hbmass_kg",
    "Polyglobulie_14.5_OMS2024", "Polyglobulie_2SD", "Polyglobulie_2SD_Hbmass_kg"
  ),
  labels = c(
    "[Hb] +1SD", "Hbmass/kg +1SD",
    "WHO2011", "[Hb] +1.5SD", "Hbmass/kg +1.5SD",
    "WHO2024", "[Hb] +2SD", "Hbmass/kg +2SD"
  )
)
global_tests <- data_long %>%
  group_by(Méthode) %>%
  summarise(
    p_global = {
      tbl <- table(Ville_eval, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

ville_pairs <- combn(unique(data_long$Ville_eval), 2, simplify = FALSE)

# Fonction pour calculer les p-values pour chaque paire de villes et chaque méthode
all_pvals <- lapply(ville_pairs, function(pair) {
  ville1 <- pair[1]
  ville2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Ville_eval %in% pair)
  
    data_sub %>%
    group_by(Méthode) %>%
summarise(
  p = {
    tbl <- table(Ville_eval, Résultat_bin)
    if (nrow(tbl) > 1 && ncol(tbl) > 1) {
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    } else {
      NA_real_
    }
  },
  group1 = ville1,
  group2 = ville2,
  .groups = "drop"
)

})

# Fusionner toutes les paires
p_values <- bind_rows(all_pvals)
p_values <- p_values %>%
  group_by(Méthode) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),  # méthode possible : "bonferroni", "holm", "BH", etc.
    p.signif.adj = case_when(
      p_adj < 0.001 ~ "***",
      p_adj < 0.01  ~ "**",
      p_adj < 0.05  ~ "*",
      TRUE          ~ "ns"
    )
  ) %>%
  ungroup()
p_values <- p_values %>%
  left_join(global_tests, by = "Méthode") %>%
  filter(p_global < 0.05)

# Ajouter des positions Y pour éviter le chevauchement des p-values
max_prev <- prevalence %>% group_by(Méthode) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Méthode") %>%
  group_by(Méthode) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

if (nrow(p_values) == 0) {
  # Pas de comparaisons à annoter -> plot simple sans stat_pvalue_manual
  ggplot(data_long, aes(x = Ville_eval, y = Résultat_bin * 100, fill = Ville_eval)) +
    stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
    facet_wrap(~ Méthode, scales = "free_y") +
    labs(
      title = "Polycythemia prevalence by city (8-12 years old)",
      x = "City",
      y = "Prevalence (%)",
      fill = "City"
    ) +
    theme_minimal(base_size = 14) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
} else {
  # Plot complet avec annotations de p-value
  ggplot(data_long, aes(x = Ville_eval, y = Résultat_bin * 100, fill = Ville_eval)) +
    stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
    
    stat_pvalue_manual(
      data = p_values %>% filter(p.signif.adj != "ns"),
      label = "p.signif.adj",
      y.position = "y.position",
      xmin = "group1",
      xmax = "group2",
      tip.length = 0.01,
      bracket.size = 0.6,
      inherit.aes = FALSE
    ) +
    facet_wrap(~ Méthode, scales = "free_y") +
    labs(
      title = "Polycythemia prevalence by city (8-12 years old)",
      x = "City",
      y = "Prevalence (%)",
      fill = "City"
    ) +
    theme_minimal(base_size = 14) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
}
```

```{r}
data <- read.csv("datafinalfinal.csv")
data <- data[data$Age_categorie_binaire == "0-3 ans", ]

data_long <- data %>%
  pivot_longer(
    cols = c(Anemie_OMS2011, Anemie_OMS2024, Anemie_Hb1SD, Anemie_HB1.5SD, Anemie_Hb2SD),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Anémie"
  )

data_long$Ville_eval <- factor(data_long$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

data_long$Méthode <- factor(
  data_long$Méthode,
  levels = c("Anemie_OMS2011", "Anemie_OMS2024", "Anemie_Hb1SD", "Anemie_HB1.5SD", "Anemie_Hb2SD"),
  labels = c("WHO2011", "WHO2024", "[Hb] -1SD", "[Hb] -1.5SD", "[Hb] -2SD")
)

# Test global par ville
global_tests <- data_long %>%
  group_by(Ville_eval) %>%
  summarise(
    p_global = {
      tbl <- table(Méthode, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

# Prévalence par ville et méthode
prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

# Comparaisons entre méthodes dans chaque ville
method_pairs <- combn(unique(data_long$Méthode), 2, simplify = FALSE)

all_pvals <- lapply(method_pairs, function(pair) {
  m1 <- pair[1]
  m2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Méthode %in% pair)
  
  data_sub %>%
    group_by(Ville_eval) %>%
    summarise(
      p = {
        tbl <- table(Méthode, Résultat_bin)
        if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
      },
      group1 = m1,
      group2 = m2,
      .groups = "drop"
    )
})

p_values <- bind_rows(all_pvals) %>%
  group_by(Ville_eval) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),
    p.signif.adj = case_when(
      p_adj < 0.001 ~ "***",
      p_adj < 0.01 ~ "**",
      p_adj < 0.05 ~ "*",
      TRUE ~ "ns"
    )
  ) %>%
  ungroup()

p_values <- p_values %>%
  left_join(global_tests, by = "Ville_eval") %>%
  filter(p_global < 0.05)

# Ajouter positions Y pour affichage
max_prev <- prevalence %>% group_by(Ville_eval) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Ville_eval") %>%
  group_by(Ville_eval) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

p_values_sig <- p_values %>% filter(p_adj < 0.05)

# Graphique : chaque facette est une ville, comparaisons entre méthodes
ggplot(data_long, aes(x = Méthode, y = Résultat_bin * 100, fill = Méthode)) +
  scale_fill_manual(values = c(
  "[Hb] -1SD" = "#7570b3",
  "Hbmass/kg -1SD" = "#66a61e",
  "WHO2011" = "#1b9e77",
  "[Hb] -1.5SD" = "#e6ab02",
  "Hbmass/kg -1.5SD" = "#a6761d",
  "WHO2024" = "#d95f02",
  "[Hb] -2SD" = "#e7298a",
  "Hbmass/kg -2SD" = "#666666"
)) +
    stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  stat_pvalue_manual(
    data = p_values_sig,
    label = "p.signif.adj",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  facet_wrap(~ Ville_eval, scales = "fixed") +
  labs(
    title = "Comparison of anemia detection methods in 0-3 year olds, by city",
    x = "Methods",
    y = "Prevalence (%)",
    fill = "Methods",
  caption = "* p < 0.05   ** p < 0.01   *** p < 0.001"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
data <- read.csv("datafinalfinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

data_long <- data %>%
  pivot_longer(
    cols = c(Anemie_OMS2011, Anemie_OMS2024, Anemie_Hb1SD, Anemie_HB1.5SD, Anemie_Hb2SD, Anemie_1SD_Hbmass.g.kg, Anemie_1.5SD_Hbmass.kg, Anemie_2SD_Hbmass.g.kg),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Anémie"
  )

data_long$Ville_eval <- factor(data_long$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

data_long$Méthode <- factor(
  data_long$Méthode,
  levels = c("Anemie_OMS2011", "Anemie_OMS2024", "Anemie_Hb1SD", "Anemie_HB1.5SD", "Anemie_Hb2SD", "Anemie_1SD_Hbmass.g.kg", "Anemie_1.5SD_Hbmass.kg", "Anemie_2SD_Hbmass.g.kg"),
  labels = c("WHO2011", "WHO2024", "[Hb] -1SD", "[Hb] -1.5SD", "[Hb] -2SD", "Hbmass/kg -1SD","Hbmass/kg -1.5SD", "Hbmass/kg -2SD")
)

# Test global par ville
global_tests <- data_long %>%
  group_by(Ville_eval) %>%
  summarise(
    p_global = {
      tbl <- table(Méthode, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl, simulate.p.value = T)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

# Prévalence par ville et méthode
prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

# Comparaisons entre méthodes dans chaque ville
method_pairs <- combn(unique(data_long$Méthode), 2, simplify = FALSE)

all_pvals <- lapply(unique(data_long$Ville_eval), function(city) {
  data_city <- data_long %>% filter(Ville_eval == city)
  do.call(rbind, lapply(method_pairs, function(pair) {
    m1 <- pair[1]
    m2 <- pair[2]
    sub_data <- data_city %>% filter(Méthode %in% pair)
    tbl <- table(sub_data$Méthode, sub_data$Résultat_bin)
    print(paste("Ville:", city, "Méthode1:", m1, "Méthode2:", m2))
    print(tbl)
    if (nrow(tbl) > 1 && ncol(tbl) > 1) {
      p <- if (any(tbl < 5)) {
        tryCatch(fisher.test(tbl, simulate.p.value = TRUE)$p.value, error = function(e) NA_real_)
      } else {
        chisq.test(tbl)$p.value
      }
    } else {
      p <- NA_real_
    }
    data.frame(
      Ville_eval = city,
      group1 = m1,
      group2 = m2,
      p = p
    )
  }))
})

p_values <- bind_rows(all_pvals) %>%
  group_by(Ville_eval) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),
    p.signif.adj = case_when(
      p_adj < 0.001 ~ "***",
      p_adj < 0.01 ~ "**",
      p_adj < 0.05 ~ "*",
      TRUE ~ "ns"
    )
  ) %>%
  ungroup()

p_values <- p_values %>%
  left_join(global_tests, by = "Ville_eval") %>%
  filter(p_global < 0.05)

# Ajouter positions Y pour affichage
max_prev <- prevalence %>% group_by(Ville_eval) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Ville_eval") %>%
  group_by(Ville_eval) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

p_values_sig <- p_values %>% filter(p_adj < 0.05)

# Graphique : chaque facette est une ville, comparaisons entre méthodes
if (nrow(p_values_sig) == 0) {
  # Pas de comparaisons significatives : plot simple
  ggplot(data_long, aes(x = Méthode, y = Résultat_bin * 100, fill = Méthode)) +
    scale_fill_manual(values = c(
  "[Hb] -1SD" = "#7570b3",
  "Hbmass/kg -1SD" = "#66a61e",
  "WHO2011" = "#1b9e77",
  "[Hb] -1.5SD" = "#e6ab02",
  "Hbmass/kg -1.5SD" = "#a6761d",
  "WHO2024" = "#d95f02",
  "[Hb] -2SD" = "#e7298a",
  "Hbmass/kg -2SD" = "#666666"
)) +
    stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
    stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2, position = position_dodge(width = 0.8)) +
    facet_wrap(~ Ville_eval, scales = "fixed") +
    labs(
      title = "Comparison of anemia detection methods in 8-12 year olds, by city",
      subtitle = "No significant pairwise comparison between methods in any city (all p ≥ 0.05)",
      x = "Methods",
      y = "Prevalence (%)",
      fill = "Methods",
      caption = "* p < 0.05   ** p < 0.01   *** p < 0.001"
    ) +
    theme_minimal(base_size = 14) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
} else {
  # Avec annotations de p-value
  ggplot(data_long, aes(x = Méthode, y = Résultat_bin * 100, fill = Méthode)) +
    scale_fill_manual(values = c(
  "[Hb] -1SD" = "#7570b3",
  "Hbmass/kg -1SD" = "#66a61e",
  "WHO2011" = "#1b9e77",
  "[Hb] -1.5SD" = "#e6ab02",
  "Hbmass/kg -1.5SD" = "#a6761d",
  "WHO2024" = "#d95f02",
  "[Hb] -2SD" = "#e7298a",
  "Hbmass/kg -2SD" = "#666666"
)) +
    stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
    stat_pvalue_manual(
      data = p_values_sig,
      label = "p.signif.adj",
      y.position = "y.position",
      xmin = "group1",
      xmax = "group2",
      tip.length = 0.01,
      bracket.size = 0.6,
      inherit.aes = FALSE
    ) +
    facet_wrap(~ Ville_eval, scales = "fixed") +
    labs(
      title = "Comparison of anemia detection methods in 8-12 year olds, by city",
      x = "Methods",
      y = "Prevalence (%)",
      fill = "Methods",
      caption = "* p < 0.05   ** p < 0.01   *** p < 0.001"
    ) +
    theme_minimal(base_size = 14) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
}
```

```{r}
data <- read.csv("datafinalfinal.csv")
data <- data[data$Age_categorie_binaire == "0-3 ans", ]

data_long <- data %>%
  pivot_longer(
    cols = c(Polyglobulie_14.5_OMS2011, Polyglobulie_14.5_OMS2024, Polyglobulie_SD, Polyglobulie_1.5SD, Polyglobulie_2SD),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Anémie"
  )
data_long$Ville_eval <- factor(data_long$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

data_long$Méthode <- factor(
  data_long$Méthode,
  levels = c("Polyglobulie_14.5_OMS2011", "Polyglobulie_14.5_OMS2024", "Polyglobulie_SD", "Polyglobulie_1.5SD", "Polyglobulie_2SD"),
  labels = c("WHO2011", "WHO2024", "[Hb] +1SD", "[Hb] +1.5SD", "[Hb] +2SD")
)

# Test global par ville
global_tests <- data_long %>%
  group_by(Ville_eval) %>%
  summarise(
    p_global = {
      tbl <- table(Méthode, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

# Prévalence par ville et méthode
prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

# Comparaisons entre méthodes dans chaque ville
method_pairs <- combn(unique(data_long$Méthode), 2, simplify = FALSE)

all_pvals <- lapply(method_pairs, function(pair) {
  m1 <- pair[1]
  m2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Méthode %in% pair)
  
  data_sub %>%
    group_by(Ville_eval) %>%
    summarise(
  p = {
    tbl <- table(Méthode, Résultat_bin)
    if (nrow(tbl) > 1 && ncol(tbl) > 1) {
      if (any(tbl < 5)) {
        tryCatch(
          fisher.test(tbl, simulate.p.value = TRUE)$p.value,
          error = function(e) NA_real_
        )
      } else {
        chisq.test(tbl)$p.value
      }
    } else {
      NA_real_
    }
  },
  group1 = m1,
  group2 = m2,
  .groups = "drop"
)

})

p_values <- bind_rows(all_pvals) %>%
  group_by(Ville_eval) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),
    p.signif.adj = case_when(
      p_adj < 0.001 ~ "***",
      p_adj < 0.01 ~ "**",
      p_adj < 0.05 ~ "*",
      TRUE ~ "ns"
    )
  ) %>%
  ungroup()

p_values <- p_values %>%
  left_join(global_tests, by = "Ville_eval") %>%
  filter(p_global < 0.05)

# Ajouter positions Y pour affichage
max_prev <- prevalence %>% group_by(Ville_eval) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Ville_eval") %>%
  group_by(Ville_eval) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

p_values_sig <- p_values %>% filter(p_adj < 0.05)

# Graphique : chaque facette est une ville, comparaisons entre méthodes
ggplot(data_long, aes(x = Méthode, y = Résultat_bin * 100, fill = Méthode)) +
  scale_fill_manual(values = c(
  "[Hb] +1SD" = "#7570b3",
  "Hbmass/kg +1SD" = "#66a61e",
  "WHO2011" = "#1b9e77",
  "[Hb] +1.5SD" = "#e6ab02",
  "Hbmass/kg +1.5SD" = "#a6761d",
  "WHO2024" = "#d95f02",
  "[Hb] +2SD" = "#e7298a",
  "Hbmass/kg +2SD" = "#666666"
)) +
    stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  stat_pvalue_manual(
    data = p_values_sig,
    label = "p.signif.adj",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  facet_wrap(~ Ville_eval, scales = "fixed") +
  labs(
    title = "Comparison of polycythemia detection methods in 0-3 year olds, by city",
    x = "Methods",
    y = "Prevalence (%)",
    fill = "Methods",
  caption = "* p < 0.05   ** p < 0.01   *** p < 0.001"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
data <- read.csv("datafinalfinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

data_long <- data %>%
  pivot_longer(
    cols = c(Polyglobulie_14.5_OMS2011, Polyglobulie_14.5_OMS2024, Polyglobulie_SD, Polyglobulie_1.5SD, Polyglobulie_2SD, Polyglobulie_SD_Hbmass_kg, Polyglobulie_1.5SD_Hbmass_kg, Polyglobulie_2SD_Hbmass_kg),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Anémie"
  )

data_long$Ville_eval <- factor(data_long$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))
data_long$Méthode <- factor(
  data_long$Méthode,
  levels = c(
    "Polyglobulie_14.5_OMS2011", "Polyglobulie_14.5_OMS2024",
    "Polyglobulie_SD", "Polyglobulie_1.5SD", "Polyglobulie_2SD",
    "Polyglobulie_SD_Hbmass_kg", "Polyglobulie_1.5SD_Hbmass_kg", "Polyglobulie_2SD_Hbmass_kg"
  ),
  labels = c(
    "WHO2011", "WHO2024",
    "[Hb] +1SD", "[Hb] +1.5SD", "[Hb] +2SD",
    "Hbmass/kg +1SD", "Hbmass/kg +1.5SD", "Hbmass/kg +2SD"
  )
)

# Test global par ville
global_tests <- data_long %>%
  group_by(Ville_eval) %>%
  summarise(
    p_global = {
      tbl <- table(Méthode, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl, simulate.p.value = T)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

# Prévalence par ville et méthode
prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

# Comparaisons entre méthodes dans chaque ville
method_pairs <- combn(unique(data_long$Méthode), 2, simplify = FALSE)

all_pvals <- lapply(method_pairs, function(pair) {
  m1 <- pair[1]
  m2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Méthode %in% pair)
  
  data_sub %>%
    group_by(Ville_eval) %>%
    summarise(
  p = {
    tbl <- table(Méthode, Résultat_bin)
    if (nrow(tbl) > 1 && ncol(tbl) > 1) {
      if (any(tbl < 5)) {
        tryCatch(
          fisher.test(tbl, simulate.p.value = TRUE)$p.value,
          error = function(e) NA_real_
        )
      } else {
        chisq.test(tbl)$p.value
      }
    } else {
      NA_real_
    }
  },
  group1 = m1,
  group2 = m2,
  .groups = "drop"
)

})

p_values <- bind_rows(all_pvals) %>%
  group_by(Ville_eval) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),
    p.signif.adj = case_when(
      p_adj < 0.001 ~ "***",
      p_adj < 0.01 ~ "**",
      p_adj < 0.05 ~ "*",
      TRUE ~ "ns"
    )
  ) %>%
  ungroup()

p_values <- p_values %>%
  left_join(global_tests, by = "Ville_eval") %>%
  filter(p_global < 0.05)

# Ajouter positions Y pour affichage
max_prev <- prevalence %>% group_by(Ville_eval) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Ville_eval") %>%
  group_by(Ville_eval) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

p_values_sig <- p_values %>% filter(p_adj < 0.05)

# Graphique : chaque facette est une ville, comparaisons entre méthodes
ggplot(data_long, aes(x = Méthode, y = Résultat_bin * 100, fill = Méthode)) +
  scale_fill_manual(values = c(
  "[Hb] +1SD" = "#7570b3",
  "Hbmass/kg +1SD" = "#66a61e",
  "WHO2011" = "#1b9e77",
  "[Hb] +1.5SD" = "#e6ab02",
  "Hbmass/kg +1.5SD" = "#a6761d",
  "WHO2024" = "#d95f02",
  "[Hb] +2SD" = "#e7298a",
  "Hbmass/kg +2SD" = "#666666"
)) +
    stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  stat_pvalue_manual(
    data = p_values_sig,
    label = "p.signif.adj",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  facet_wrap(~ Ville_eval, scales = "fixed") +
  labs(
    title = "Comparison of erythrocythemia detection methods in 8-12 year olds, by city",
    x = "Methods",
    y = "Prevalence (%)",
    fill = "Methods",
  caption = "* p < 0.05   ** p < 0.01   *** p < 0.001"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


## Concordances

```{r}
# WHO 2024 2011
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Anemie_OMS2011)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_OMS2011)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_OMS2011)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (anemia) : WHO2024 v.s. WHO2011\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, Anemie_OMS2011) %>%
  group_by(Anemie_OMS2011) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = Anemie_OMS2011, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2024",
    y = "WHO2011",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
# WHO 2024 2011
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Polyglobulie_14.5_OMS2024, Polyglobulie_14.5_OMS2011)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2024, data_clean$Polyglobulie_14.5_OMS2011)$p.value
methode = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2024, data_clean$Polyglobulie_14.5_OMS2011)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (polycythemia) : WHO2024 v.s. WHO2011\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Polyglobulie_14.5_OMS2024, Polyglobulie_14.5_OMS2011) %>%
  group_by(Polyglobulie_14.5_OMS2011) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Polyglobulie_14.5_OMS2024, y = Polyglobulie_14.5_OMS2011, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2024",
    y = "WHO2011",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Anemie_Hb1SD)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_Hb1SD)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_Hb1SD)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (anemia) : WHO2024 v.s. [Hb] -1SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, Anemie_Hb1SD) %>%
  group_by(Anemie_Hb1SD) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = Anemie_Hb1SD, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2024",
    y = "[Hb] -1SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Anemie_HB1.5SD)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_HB1.5SD)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_HB1.5SD)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (anemia) : WHO2024 v.s. [Hb] -1.5SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, Anemie_HB1.5SD) %>%
  group_by(Anemie_HB1.5SD) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = Anemie_HB1.5SD, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2024",
    y = "[Hb] -1.5SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Anemie_Hb2SD)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_Hb2SD)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_Hb2SD)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (anemia) : WHO2024 v.s. [Hb] -2SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, Anemie_Hb2SD) %>%
  group_by(Anemie_Hb2SD) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = Anemie_Hb2SD, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2024",
    y = "[Hb] -2SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2011, Anemie_Hb1SD)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Anemie_Hb1SD)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Anemie_Hb1SD)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (anemia) : WHO2011 v.s. [Hb] -1SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2011, Anemie_Hb1SD) %>%
  group_by(Anemie_Hb1SD) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2011, y = Anemie_Hb1SD, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2011",
    y = "[Hb] -1SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2011, Anemie_HB1.5SD)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Anemie_HB1.5SD)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Anemie_HB1.5SD)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (anemia) : WHO2011 v.s. [Hb] -1.5SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2011, Anemie_HB1.5SD) %>%
  group_by(Anemie_HB1.5SD) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2011, y = Anemie_HB1.5SD, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2011",
    y = "[Hb] -1.5SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2011, Anemie_Hb2SD)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Anemie_Hb2SD)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Anemie_Hb2SD)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (anemia) : WHO2011 v.s. [Hb] -2SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, Anemie_Hb2SD) %>%
  group_by(Anemie_Hb2SD) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = Anemie_Hb2SD, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2011",
    y = "[Hb] -2SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Anemie_1SD_Hbmass.g.kg)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }
  
  # Table de contingence
  tbl <- table(x, y)
  
  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10
  
  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }
  
  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_1SD_Hbmass.g.kg)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_1SD_Hbmass.g.kg)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (anemia) : WHO2024 v.s. Hbmass/kg -1SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, Anemie_1SD_Hbmass.g.kg) %>%
  group_by(Anemie_1SD_Hbmass.g.kg) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = Anemie_1SD_Hbmass.g.kg, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2024",
    y = "Hbmass/kg -1SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Anemie_1.5SD_Hbmass.kg)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }
  
  # Table de contingence
  tbl <- table(x, y)
  
  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10
  
  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }
  
  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_1.5SD_Hbmass.kg)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_1.5SD_Hbmass.kg)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (anemia) : WHO2024 v.s. Hbmass/kg -1.5SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, Anemie_1.5SD_Hbmass.kg) %>%
  group_by(Anemie_1.5SD_Hbmass.kg) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = Anemie_1.5SD_Hbmass.kg, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2024",
    y = "Hbmass/kg -1.5SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Anemie_2SD_Hbmass.g.kg)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }
  
  # Table de contingence
  tbl <- table(x, y)
  
  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10
  
  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }
  
  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_2SD_Hbmass.g.kg)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_2SD_Hbmass.g.kg)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (anemia) : WHO2024 v.s. Hbmass/kg -2SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, Anemie_2SD_Hbmass.g.kg) %>%
  group_by(Anemie_2SD_Hbmass.g.kg) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = Anemie_2SD_Hbmass.g.kg, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2024",
    y = "Hbmass/kg -2SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2011, Anemie_1SD_Hbmass.g.kg)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }
  
  # Table de contingence
  tbl <- table(x, y)
  
  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10
  
  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }
  
  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Anemie_1SD_Hbmass.g.kg)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Anemie_1SD_Hbmass.g.kg)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (anemia) : WHO2011 v.s. Hbmass/kg -1SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2011, Anemie_1SD_Hbmass.g.kg) %>%
  group_by(Anemie_1SD_Hbmass.g.kg) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2011, y = Anemie_1SD_Hbmass.g.kg, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2011",
    y = "Hbmass/kg -1SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2011, Anemie_1.5SD_Hbmass.kg)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }
  
  # Table de contingence
  tbl <- table(x, y)
  
  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10
  
  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }
  
  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Anemie_1.5SD_Hbmass.kg)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Anemie_1.5SD_Hbmass.kg)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (anemia) : WHO2011 v.s. Hbmass/kg -1.5SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2011, Anemie_1.5SD_Hbmass.kg) %>%
  group_by(Anemie_1.5SD_Hbmass.kg) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2011, y = Anemie_1.5SD_Hbmass.kg, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2011",
    y = "Hbmass/kg -1.5SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2011, Anemie_2SD_Hbmass.g.kg)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }
  
  # Table de contingence
  tbl <- table(x, y)
  
  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10
  
  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }
  
  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Anemie_2SD_Hbmass.g.kg)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Anemie_2SD_Hbmass.g.kg)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (anemia) : WHO2011 v.s. Hbmass/kg -2SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, Anemie_2SD_Hbmass.g.kg) %>%
  group_by(Anemie_2SD_Hbmass.g.kg) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = Anemie_2SD_Hbmass.g.kg, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2011",
    y = "Hbmass/kg -2SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Polyglobulie_14.5_OMS2024, Polyglobulie_SD)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }
  
  # Table de contingence
  tbl <- table(x, y)
  
  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10
  
  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }
  
  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2024, data_clean$Polyglobulie_SD)$p.value
methode = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2024, data_clean$Polyglobulie_SD)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (polycythemia) : WHO2024 v.s. [Hb] +1SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Polyglobulie_14.5_OMS2024, Polyglobulie_SD) %>%
  group_by(Polyglobulie_SD) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Polyglobulie_14.5_OMS2024, y = Polyglobulie_SD, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2024",
    y = "[Hb] +1SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Polyglobulie_14.5_OMS2024, Polyglobulie_1.5SD)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }
  
  # Table de contingence
  tbl <- table(x, y)
  
  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10
  
  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }
  
  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2024, data_clean$Polyglobulie_1.5SD)$p.value
methode = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2024, data_clean$Polyglobulie_1.5SD)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (polycythemia) : WHO2024 v.s. [Hb] +1.5SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Polyglobulie_14.5_OMS2024, Polyglobulie_1.5SD) %>%
  group_by(Polyglobulie_1.5SD) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Polyglobulie_14.5_OMS2024, y = Polyglobulie_1.5SD, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2024",
    y = "[Hb] +1.5SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Polyglobulie_14.5_OMS2024, Polyglobulie_2SD)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }
  
  # Table de contingence
  tbl <- table(x, y)
  
  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10
  
  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }
  
  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2024, data_clean$Polyglobulie_2SD)$p.value
methode = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2024, data_clean$Polyglobulie_2SD)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (polycythemia) : WHO2024 v.s. [Hb] +2SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Polyglobulie_14.5_OMS2024, Polyglobulie_2SD) %>%
  group_by(Polyglobulie_2SD) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Polyglobulie_14.5_OMS2024, y = Polyglobulie_2SD, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2024",
    y = "[Hb] +2SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Polyglobulie_14.5_OMS2011, Polyglobulie_SD)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }
  
  # Table de contingence
  tbl <- table(x, y)
  
  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10
  
  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }
  
  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2011, data_clean$Polyglobulie_SD)$p.value
methode = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2011, data_clean$Polyglobulie_SD)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (polycythemia) : WHO2011 v.s. [Hb] +1SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Polyglobulie_14.5_OMS2011, Polyglobulie_SD) %>%
  group_by(Polyglobulie_SD) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Polyglobulie_14.5_OMS2011, y = Polyglobulie_SD, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2011",
    y = "[Hb] +1SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Polyglobulie_14.5_OMS2011, Polyglobulie_1.5SD)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }
  
  # Table de contingence
  tbl <- table(x, y)
  
  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10
  
  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }
  
  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2011, data_clean$Polyglobulie_1.5SD)$p.value
methode = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2011, data_clean$Polyglobulie_1.5SD)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (polycythemia) : WHO2011 v.s. [Hb] +1.5SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Polyglobulie_14.5_OMS2011, Polyglobulie_1.5SD) %>%
  group_by(Polyglobulie_1.5SD) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Polyglobulie_14.5_OMS2011, y = Polyglobulie_1.5SD, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2011",
    y = "[Hb] +1.5SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Polyglobulie_14.5_OMS2011, Polyglobulie_2SD)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }
  
  # Table de contingence
  tbl <- table(x, y)
  
  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10
  
  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }
  
  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2011, data_clean$Polyglobulie_2SD)$p.value
methode = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2011, data_clean$Polyglobulie_2SD)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (polycythemia) : WHO2011 v.s. [Hb] +2SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Polyglobulie_14.5_OMS2024, Polyglobulie_2SD) %>%
  group_by(Polyglobulie_2SD) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Polyglobulie_14.5_OMS2024, y = Polyglobulie_2SD, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2011",
    y = "[Hb] +2SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Polyglobulie_14.5_OMS2024, Polyglobulie_SD_Hbmass_kg)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }
  
  # Table de contingence
  tbl <- table(x, y)
  
  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10
  
  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }
  
  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2024, data_clean$Polyglobulie_SD_Hbmass_kg)$p.value
methode = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2024, data_clean$Polyglobulie_SD_Hbmass_kg)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (polycythemia) : WHO2024 v.s. Hbmass/kg +1SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Polyglobulie_14.5_OMS2024, Polyglobulie_SD_Hbmass_kg) %>%
  group_by(Polyglobulie_SD_Hbmass_kg) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Polyglobulie_14.5_OMS2024, y = Polyglobulie_SD_Hbmass_kg, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2024",
    y = "Hbmass/kg +1SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Polyglobulie_14.5_OMS2024, Polyglobulie_1.5SD_Hbmass_kg)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }
  
  # Table de contingence
  tbl <- table(x, y)
  
  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10
  
  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }
  
  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2024, data_clean$Polyglobulie_1.5SD_Hbmass_kg)$p.value
methode = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2024, data_clean$Polyglobulie_1.5SD_Hbmass_kg)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (polycythemia) : WHO2024 v.s. +1.5SD (Hbmass/kg)\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Polyglobulie_14.5_OMS2024, Polyglobulie_1.5SD_Hbmass_kg) %>%
  group_by(Polyglobulie_1.5SD_Hbmass_kg) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Polyglobulie_14.5_OMS2024, y = Polyglobulie_1.5SD_Hbmass_kg, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2024",
    y = "+1.5SD (Hbmass/kg)",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Polyglobulie_14.5_OMS2024, Polyglobulie_2SD_Hbmass_kg)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }
  
  # Table de contingence
  tbl <- table(x, y)
  
  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10
  
  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }
  
  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2024, data_clean$Polyglobulie_2SD_Hbmass_kg)$p.value
methode = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2024, data_clean$Polyglobulie_2SD_Hbmass_kg)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (polycythemia) : WHO2024 v.s. Hbmass/kg +2SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Polyglobulie_14.5_OMS2024, Polyglobulie_2SD_Hbmass_kg) %>%
  group_by(Polyglobulie_2SD_Hbmass_kg) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Polyglobulie_14.5_OMS2024, y = Polyglobulie_2SD_Hbmass_kg, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2024",
    y = "Hbmass/kg +2SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Polyglobulie_14.5_OMS2011, Polyglobulie_SD_Hbmass_kg)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }
  
  # Table de contingence
  tbl <- table(x, y)
  
  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10
  
  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }
  
  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2011, data_clean$Polyglobulie_SD_Hbmass_kg)$p.value
methode = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2011, data_clean$Polyglobulie_SD_Hbmass_kg)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (polycythemia) : WHO2011 v.s. +1SD (Hbmass/kg)\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Polyglobulie_14.5_OMS2011, Polyglobulie_SD_Hbmass_kg) %>%
  group_by(Polyglobulie_SD_Hbmass_kg) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Polyglobulie_14.5_OMS2011, y = Polyglobulie_SD_Hbmass_kg, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2011",
    y = "Hbmass/kg +1SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Polyglobulie_14.5_OMS2011, Polyglobulie_1.5SD_Hbmass_kg)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }
  
  # Table de contingence
  tbl <- table(x, y)
  
  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10
  
  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }
  
  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2011, data_clean$Polyglobulie_1.5SD_Hbmass_kg)$p.value
methode = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2011, data_clean$Polyglobulie_1.5SD_Hbmass_kg)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (polycythemia) : WHO2011 v.s. +1.5SD (Hbmass/kg)\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Polyglobulie_14.5_OMS2011, Polyglobulie_1.5SD_Hbmass_kg) %>%
  group_by(Polyglobulie_1.5SD_Hbmass_kg) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Polyglobulie_14.5_OMS2011, y = Polyglobulie_1.5SD_Hbmass_kg, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2011",
    y = "Hbmass/kg +1.5SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Polyglobulie_14.5_OMS2011, Polyglobulie_2SD_Hbmass_kg)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }
  
  # Table de contingence
  tbl <- table(x, y)
  
  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10
  
  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }
  
  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2011, data_clean$Polyglobulie_2SD_Hbmass_kg)$p.value
methode = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2011, data_clean$Polyglobulie_2SD_Hbmass_kg)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (polycythemia) : WHO2011 v.s. Hbmass/kg +2SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Polyglobulie_14.5_OMS2024, Polyglobulie_2SD_Hbmass_kg) %>%
  group_by(Polyglobulie_2SD_Hbmass_kg) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Polyglobulie_14.5_OMS2024, y = Polyglobulie_2SD_Hbmass_kg, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2011",
    y = "Hbmass/kg +2SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```



## Effet par ville et concordances (methodes iron OMS)

```{r}
# Anemia 0-3 ans ville
data = read.csv("datafinalfinal.csv")
data = data[data$Age_categorie_binaire == "0-3 ans", ]
data_long <- data %>%
  pivot_longer(
    cols = c(Anemie_OMS2011_FER, Anemie_OMS2024_FER),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Anémie"
  )
data_long$Ville_eval <- factor(data_long$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))
data_long$Méthode <- factor(
  data_long$Méthode,
  levels = c("Anemie_OMS2011_FER", "Anemie_OMS2024_FER"),
  labels = c("WHO2011", "WHO2024")
)

global_tests <- data_long %>%
  group_by(Méthode) %>%
  summarise(
    p_global = {
      tbl <- table(Ville_eval, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

ville_pairs <- combn(unique(data_long$Ville_eval), 2, simplify = FALSE)

# Fonction pour calculer les p-values pour chaque paire de villes et chaque méthode
all_pvals <- lapply(ville_pairs, function(pair) {
  ville1 <- pair[1]
  ville2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Ville_eval %in% pair)
  
  data_sub %>%
    group_by(Méthode) %>%
    summarise(
      p = {
        tbl <- table(Ville_eval, Résultat_bin)
        if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
      },
      group1 = ville1,
      group2 = ville2,
      .groups = "drop"
    )
})

# Fusionner toutes les paires
p_values <- bind_rows(all_pvals)
p_values <- p_values %>%
  group_by(Méthode) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),  # méthode possible : "bonferroni", "holm", "BH", etc.
    p.signif.adj = case_when(
      p_adj < 0.001 ~ "***",
      p_adj < 0.01 ~ "**",
      p_adj < 0.05 ~ "*",
      TRUE ~ "ns"
    )
  ) %>%
  ungroup()
p_values <- p_values %>%
  left_join(global_tests, by = "Méthode") %>%
  filter(p_global < 0.05)

# Ajouter des positions Y pour éviter le chevauchement des p-values
max_prev <- prevalence %>% group_by(Méthode) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Méthode") %>%
  group_by(Méthode) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

# Calcul du n global
n_global <- nrow(data_long)/2

# Plot avec n dans le titre
ggplot(data_long, aes(x = Ville_eval, y = Résultat_bin * 100, fill = Ville_eval)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  stat_pvalue_manual(
    data = p_values %>% filter(p.signif.adj != "ns"),
    label = "p.signif.adj",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  facet_wrap(~ Méthode, scales = "free_y") +
  labs(
    title = paste0(
      "Anemia prevalence by city for 0-3 years old\nwith low ferritin (n = ", 
      n_global, ")"
    ),
    x = "City",
    y = "Prevalence (%)",
    fill = "City"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
```{r}
# Anemia 8-12 ans ville
data = read.csv("datafinalfinal.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]
data_long <- data %>%
  pivot_longer(
    cols = c(Anemie_OMS2011_FER, Anemie_OMS2024_FER),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Anémie"
  )
data_long$Ville_eval <- factor(data_long$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))
data_long$Méthode <- factor(
  data_long$Méthode,
  levels = c("Anemie_OMS2011_FER", "Anemie_OMS2024_FER"),
  labels = c("WHO2011", "WHO2024")
)



global_tests <- data_long %>%
  group_by(Méthode) %>%
  summarise(
    p_global = {
      tbl <- table(Ville_eval, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

ville_pairs <- combn(unique(data_long$Ville_eval), 2, simplify = FALSE)

# Fonction pour calculer les p-values pour chaque paire de villes et chaque méthode
all_pvals <- lapply(ville_pairs, function(pair) {
  ville1 <- pair[1]
  ville2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Ville_eval %in% pair)
  
  data_sub %>%
    group_by(Méthode) %>%
summarise(
  p = {
    tbl <- table(Ville_eval, Résultat_bin)
    if (nrow(tbl) > 1 && ncol(tbl) > 1) {
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    } else {
      NA_real_
    }
  },
  group1 = ville1,
  group2 = ville2,
  .groups = "drop"
)

})

# Fusionner toutes les paires
p_values <- bind_rows(all_pvals)
p_values <- p_values %>%
  group_by(Méthode) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),  # méthode possible : "bonferroni", "holm", "BH", etc.
    p.signif.adj = case_when(
      p_adj < 0.001 ~ "***",
      p_adj < 0.01 ~ "**",
      p_adj < 0.05 ~ "*",
      TRUE ~ "ns"
    )
  ) %>%
  ungroup()

p_values <- p_values %>%
  left_join(global_tests, by = "Méthode") %>%
  filter(p_global < 0.05)

# Ajouter des positions Y pour éviter le chevauchement des p-values
max_prev <- prevalence %>% group_by(Méthode) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Méthode") %>%
  group_by(Méthode) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

n_global = nrow(data_long)/2
ggplot(data_long, aes(x = Ville_eval, y = Résultat_bin * 100, fill = Ville_eval)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  facet_wrap(~ Méthode, scales = "free_y") +
  labs(
    title = paste0(
      "Anemia prevalence by city for 8-12 years old\nwith low Ferritin (n=", 
      n_global, ")"
    ),
    x = "City",
    y = "Prevalence (%)",
    fill = "City"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
data <- read.csv("datafinalfinal.csv")
data <- data[data$Age_categorie_binaire == "0-3 ans", ]

data_long <- data %>%
  pivot_longer(
    cols = c(Anemie_OMS2011_FER, Anemie_OMS2024_FER),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Anémie"
  )

data_long$Ville_eval <- factor(data_long$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

data_long$Méthode <- factor(
  data_long$Méthode,
  levels = c("Anemie_OMS2011_FER", "Anemie_OMS2024_FER"),
  labels = c("WHO2011", "WHO2024")
)

# Test global par ville
global_tests <- data_long %>%
  group_by(Ville_eval) %>%
  summarise(
    p_global = {
      tbl <- table(Méthode, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

# Prévalence par ville et méthode
prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

# Comparaisons entre méthodes dans chaque ville
method_pairs <- combn(unique(data_long$Méthode), 2, simplify = FALSE)

all_pvals <- lapply(method_pairs, function(pair) {
  m1 <- pair[1]
  m2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Méthode %in% pair)
  
  data_sub %>%
    group_by(Ville_eval) %>%
    summarise(
      p = {
        tbl <- table(Méthode, Résultat_bin)
        if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
      },
      group1 = m1,
      group2 = m2,
      .groups = "drop"
    )
})

p_values <- bind_rows(all_pvals) %>%
  group_by(Ville_eval) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),
    p.signif.adj = case_when(
      p_adj < 0.001 ~ "***",
      p_adj < 0.01 ~ "**",
      p_adj < 0.05 ~ "*",
      TRUE ~ "ns"
    )
  ) %>%
  ungroup()

p_values <- p_values %>%
  left_join(global_tests, by = "Ville_eval") %>%
  filter(p_global < 0.05)

# Ajouter positions Y pour affichage
max_prev <- prevalence %>% group_by(Ville_eval) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Ville_eval") %>%
  group_by(Ville_eval) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

p_values_sig <- p_values %>% filter(p_adj < 0.05)

# Graphique : chaque facette est une ville, comparaisons entre méthodes
ggplot(data_long, aes(x = Méthode, y = Résultat_bin * 100, fill = Méthode)) +
  scale_fill_manual(values = c(
  "-1SD" = "#7570b3",
  "-1SD (Hbmass/kg)" = "#66a61e",
  "WHO2011" = "#1b9e77",
  "-1.5SD" = "#e6ab02",
  "-1.5SD (Hbmass/kg)" = "#a6761d",
  "WHO2024" = "#d95f02",
  "-2SD" = "#e7298a",
  "-2SD (Hbmass/kg)" = "#666666"
)) +
    stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  stat_pvalue_manual(
    data = p_values_sig,
    label = "p.signif.adj",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  facet_wrap(~ Ville_eval, scales = "fixed") +
  labs(
    title = "Comparison of anemia detection methods in 0-3 year olds \nwith low Ferritin, by city",
    x = "Methods",
    y = "Prevalence (%)",
    fill = "Methods",
  caption = "* p < 0.05   ** p < 0.01   *** p < 0.001"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
```{r}
data <- read.csv("datafinalfinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

data_long <- data %>%
  pivot_longer(
    cols = c(Anemie_OMS2011_FER, Anemie_OMS2024_FER),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Anémie"
  )

data_long$Ville_eval <- factor(data_long$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

data_long$Méthode <- factor(
  data_long$Méthode,
  levels = c("Anemie_OMS2011_FER", "Anemie_OMS2024_FER"),
  labels = c("WHO2011", "WHO2024")
)

# Test global par ville
global_tests <- data_long %>%
  group_by(Ville_eval) %>%
  summarise(
    p_global = {
      tbl <- table(Méthode, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl, simulate.p.value = T)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

# Prévalence par ville et méthode
prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

# Comparaisons entre méthodes dans chaque ville
method_pairs <- combn(unique(data_long$Méthode), 2, simplify = FALSE)

all_pvals <- lapply(unique(data_long$Ville_eval), function(city) {
  data_city <- data_long %>% filter(Ville_eval == city)
  do.call(rbind, lapply(method_pairs, function(pair) {
    m1 <- pair[1]
    m2 <- pair[2]
    sub_data <- data_city %>% filter(Méthode %in% pair)
    tbl <- table(sub_data$Méthode, sub_data$Résultat_bin)
    print(paste("Ville:", city, "Méthode1:", m1, "Méthode2:", m2))
    print(tbl)
    if (nrow(tbl) > 1 && ncol(tbl) > 1) {
      p <- if (any(tbl < 5)) {
        tryCatch(fisher.test(tbl, simulate.p.value = TRUE)$p.value, error = function(e) NA_real_)
      } else {
        chisq.test(tbl)$p.value
      }
    } else {
      p <- NA_real_
    }
    data.frame(
      Ville_eval = city,
      group1 = m1,
      group2 = m2,
      p = p
    )
  }))
})

p_values <- bind_rows(all_pvals) %>%
  group_by(Ville_eval) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),
    p.signif.adj = case_when(
      p_adj < 0.001 ~ "***",
      p_adj < 0.01 ~ "**",
      p_adj < 0.05 ~ "*",
      TRUE ~ "ns"
    )
  ) %>%
  ungroup()

p_values <- p_values %>%
  left_join(global_tests, by = "Ville_eval") %>%
  filter(p_global < 0.05)

# Ajouter positions Y pour affichage
max_prev <- prevalence %>% group_by(Ville_eval) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Ville_eval") %>%
  group_by(Ville_eval) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

p_values_sig <- p_values %>% filter(p_adj < 0.05)

# Graphique : chaque facette est une ville, comparaisons entre méthodes
if (nrow(p_values_sig) == 0) {
  # Pas de comparaisons significatives : plot simple
  ggplot(data_long, aes(x = Méthode, y = Résultat_bin * 100, fill = Méthode)) +
  scale_fill_manual(values = c(
  "-1SD" = "#7570b3",
  "-1SD (Hbmass/kg)" = "#66a61e",
  "WHO2011" = "#1b9e77",
  "-1.5SD" = "#e6ab02",
  "-1.5SD (Hbmass/kg)" = "#a6761d",
  "WHO2024" = "#d95f02",
  "-2SD" = "#e7298a",
  "-2SD (Hbmass/kg)" = "#666666"
)) +
    stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
    facet_wrap(~ Ville_eval, scales = "fixed") +
    labs(
      title = "Comparison of anemia detection methods in 8-12 year olds \nwith low Ferritin, by city",
      
      x = "Methods",
      y = "Prevalence (%)",
      fill = "Methods",
      caption = "* p < 0.05   ** p < 0.01   *** p < 0.001"
    ) +
    theme_minimal(base_size = 14) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
} else {
  # Avec annotations de p-value
  ggplot(data_long, aes(x = Méthode, y = Résultat_bin * 100, fill = Méthode)) +
    scale_fill_manual(values = c(
  "-1SD" = "#7570b3",
  "-1SD (Hbmass/kg)" = "#66a61e",
  "WHO2011" = "#1b9e77",
  "-1.5SD" = "#e6ab02",
  "-1.5SD (Hbmass/kg)" = "#a6761d",
  "WHO2024" = "#d95f02",
  "-2SD" = "#e7298a",
  "-2SD (Hbmass/kg)" = "#666666"
)) +
    stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
    stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2, position = position_dodge(width = 0.8)) +
    stat_pvalue_manual(
      data = p_values_sig,
      label = "p.signif.adj",
      y.position = "y.position",
      xmin = "group1",
      xmax = "group2",
      tip.length = 0.01,
      bracket.size = 0.6,
      inherit.aes = FALSE
    ) +
    facet_wrap(~ Ville_eval, scales = "fixed") +
    labs(
      title = "Comparison of anemia detection methods in 8-12 year olds, by city",
      x = "Methods",
      y = "Prevalence (%)",
      fill = "Methods",
      caption = "* p < 0.05   ** p < 0.01   *** p < 0.001"
    ) +
    theme_minimal(base_size = 14) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
}
```

```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Iron.deficiency)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "McNemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "McNemar chi² test"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Iron.deficiency)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Iron.deficiency)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Anemia crossed proportions : WHO 2024 v.s. Ferritin.low\n",
  "n = ", n_total, " ; ", "pval ", methode, " = ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, Iron.deficiency) %>%
  group_by(Iron.deficiency) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = Iron.deficiency, fill = prop)) +
  geom_tile(color = "white") + 
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "Anemia_WHO2024",
    y = "Ferritin.low",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Anemie_OMS2011, Iron.deficiency)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "McNemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "McNemar chi² test"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Iron.deficiency)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Iron.deficiency)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Anemia crossed proportions : WHO 2011 v.s. Ferritin.low\n",
  "n = ", n_total, " ; ", "pval ", methode, " = ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2011, Iron.deficiency) %>%
  group_by(Iron.deficiency) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2011, y = Iron.deficiency, fill = prop)) +
  geom_tile(color = "white") + 
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "Anemia_WHO2011",
    y = "Ferritin.low",
    fill = "Proportion"
  ) +
  theme_minimal()
```

# ROC analysis
```{r}
roc1 <- roc(response = data$Anemie_OMS2011,
            predictor = data$FER..micromol.L.,
            quiet = TRUE)

roc2 <- roc(response = data$Anemie_OMS2024,
            predictor = data$FER..micromol.L.,
            quiet = TRUE)

# Test de DeLong pour comparer les AUC (courbes corrélées)
test_delong <- roc.test(roc1, roc2, method = "delong")

# Préparer les libellés AUC et p-value
auc1 <- paste0("WHO2011 (AUC = ", round(auc(roc1), 2), ")")
auc2 <- paste0("WHO2024 (AUC = ", round(auc(roc2), 2), ")")
p_lab <- paste0("p.delong = ", format.pval(test_delong$p.value, digits = 3, eps = 1e-4))

# Plot
plot(roc1, col = "blue", lwd = 2, print.auc = FALSE,
     main = "ROC analysis Iron (µmol/L) / Anemia (WHO2011 vs WHO2024)")
plot(roc2, col = "red",  lwd = 2, add = TRUE, print.auc = FALSE)

legend("bottomright",
       legend = c(auc1, auc2, p_lab),
       col = c("blue", "red", NA),
       lwd = c(2, 2, NA),
       bty = "n", inset = 0.02)
```
```{r}
roc1 <- roc(response = data$Anemie_OMS2011,
            predictor = data$FERRITINE..microg.L.,
            quiet = TRUE)

roc2 <- roc(response = data$Anemie_OMS2024,
            predictor = data$FERRITINE..microg.L.,
            quiet = TRUE)

# Test de DeLong pour comparer les AUC (courbes corrélées)
test_delong <- roc.test(roc1, roc2, method = "delong")

# Préparer les libellés AUC et p-value
auc1 <- paste0("WHO2011 (AUC = ", round(auc(roc1), 2), ")")
auc2 <- paste0("WHO2024 (AUC = ", round(auc(roc2), 2), ")")
p_lab <- paste0("p.delong = ", format.pval(test_delong$p.value, digits = 3, eps = 1e-4))

# Plot
plot(roc1, col = "blue", lwd = 2, print.auc = FALSE,
     main = "ROC analysis Ferritin (µg/L) / Anemia (WHO2011 vs WHO2024)")
plot(roc2, col = "red",  lwd = 2, add = TRUE, print.auc = FALSE)

legend("bottomright",
       legend = c(auc1, auc2, p_lab),
       col = c("blue", "red", NA),
       lwd = c(2, 2, NA),
       bty = "n", inset = 0.02)
```
```{r}
roc1 <- roc(response = data$Anemie_OMS2011,
            predictor = data$TRANSFERINE..g.L.,
            quiet = TRUE)

roc2 <- roc(response = data$Anemie_OMS2024,
            predictor = data$TRANSFERINE..g.L.,
            quiet = TRUE)

# Test de DeLong pour comparer les AUC (courbes corrélées)
test_delong <- roc.test(roc1, roc2, method = "delong")

# Préparer les libellés AUC et p-value
auc1 <- paste0("WHO2011 (AUC = ", round(auc(roc1), 2), ")")
auc2 <- paste0("WHO2024 (AUC = ", round(auc(roc2), 2), ")")
p_lab <- paste0("p.delong = ", format.pval(test_delong$p.value, digits = 3, eps = 1e-4))

# Plot
plot(roc1, col = "blue", lwd = 2, print.auc = FALSE,
     main = "ROC analysis Transferrin (g/L) / Anemia (WHO2011 vs WHO2024)")
plot(roc2, col = "red",  lwd = 2, add = TRUE, print.auc = FALSE)

legend("bottomright",
       legend = c(auc1, auc2, p_lab),
       col = c("blue", "red", NA),
       lwd = c(2, 2, NA),
       bty = "n", inset = 0.02)
```
```{r}
roc1 <- roc(response = data$Anemie_OMS2011,
            predictor = data$RECEPTEUR.TRANSFERINE..mg.L.,
            quiet = TRUE)

roc2 <- roc(response = data$Anemie_OMS2024,
            predictor = data$RECEPTEUR.TRANSFERINE..mg.L.,
            quiet = TRUE)

# Test de DeLong pour comparer les AUC (courbes corrélées)
test_delong <- roc.test(roc1, roc2, method = "delong")

# Préparer les libellés AUC et p-value
auc1 <- paste0("WHO2011 (AUC = ", round(auc(roc1), 2), ")")
auc2 <- paste0("WHO2024 (AUC = ", round(auc(roc2), 2), ")")
p_lab <- paste0("p.delong = ", format.pval(test_delong$p.value, digits = 3, eps = 1e-4))

# Plot
plot(roc1, col = "blue", lwd = 2, print.auc = FALSE,
     main = "ROC analysis Soluble transferrin receptor (mg/L) /\n Anemia (WHO2011 vs WHO2024)")
plot(roc2, col = "red",  lwd = 2, add = TRUE, print.auc = FALSE)

legend("bottomright",
       legend = c(auc1, auc2, p_lab),
       col = c("blue", "red", NA),
       lwd = c(2, 2, NA),
       bty = "n", inset = 0.02)
```
```{r}
roc1 <- roc(response = data$Anemie_OMS2011,
            predictor = data$Coef.Sat.Tf,
            quiet = TRUE)

roc2 <- roc(response = data$Anemie_OMS2024,
            predictor = data$Coef.Sat.Tf,
            quiet = TRUE)

# Test de DeLong pour comparer les AUC (courbes corrélées)
test_delong <- roc.test(roc1, roc2, method = "delong")

# Préparer les libellés AUC et p-value
auc1 <- paste0("WHO2011 (AUC = ", round(auc(roc1), 2), ")")
auc2 <- paste0("WHO2024 (AUC = ", round(auc(roc2), 2), ")")
p_lab <- paste0("p.delong = ", format.pval(test_delong$p.value, digits = 3, eps = 1e-4))

# Plot
plot(roc1, col = "blue", lwd = 2, print.auc = FALSE,
     main = "ROC analysis Coef.Sat.Tf / Anemia (WHO2011 vs WHO2024)")
plot(roc2, col = "red",  lwd = 2, add = TRUE, print.auc = FALSE)

legend("bottomright",
       legend = c(auc1, auc2, p_lab),
       col = c("blue", "red", NA),
       lwd = c(2, 2, NA),
       bty = "n", inset = 0.02)
```
```{r}
roc1 <- roc(response = data$Anemie_OMS2011,
            predictor = data$sTfR.logTf,
            quiet = TRUE)

roc2 <- roc(response = data$Anemie_OMS2024,
            predictor = data$sTfR.logTf,
            quiet = TRUE)

# Test de DeLong pour comparer les AUC (courbes corrélées)
test_delong <- roc.test(roc1, roc2, method = "delong")

# Préparer les libellés AUC et p-value
auc1 <- paste0("WHO2011 (AUC = ", round(auc(roc1), 2), ")")
auc2 <- paste0("WHO2024 (AUC = ", round(auc(roc2), 2), ")")
p_lab <- paste0("p.delong = ", format.pval(test_delong$p.value, digits = 3, eps = 1e-4))

# Plot
plot(roc1, col = "blue", lwd = 2, print.auc = FALSE,
     main = "ROC analysis sTfR.logTf / Anemia (WHO2011 vs WHO2024)")
plot(roc2, col = "red",  lwd = 2, add = TRUE, print.auc = FALSE)

legend("bottomright",
       legend = c(auc1, auc2, p_lab),
       col = c("blue", "red", NA),
       lwd = c(2, 2, NA),
       bty = "n", inset = 0.02)
```
```{r}
roc1 <- roc(response = data$Anemie_OMS2011,
            predictor = data$Body.iron,
            quiet = TRUE)

roc2 <- roc(response = data$Anemie_OMS2024,
            predictor = data$Body.iron,
            quiet = TRUE)

# Test de DeLong pour comparer les AUC (courbes corrélées)
test_delong <- roc.test(roc1, roc2, method = "delong")

# Préparer les libellés AUC et p-value
auc1 <- paste0("WHO2011 (AUC = ", round(auc(roc1), 2), ")")
auc2 <- paste0("WHO2024 (AUC = ", round(auc(roc2), 2), ")")
p_lab <- paste0("p.delong = ", format.pval(test_delong$p.value, digits = 3, eps = 1e-4))

# Plot
plot(roc1, col = "blue", lwd = 2, print.auc = FALSE,
     main = "ROC analysis Body iron (mg/kg) / Anemia (WHO2011 vs WHO2024)")
plot(roc2, col = "red",  lwd = 2, add = TRUE, print.auc = FALSE)

legend("bottomright",
       legend = c(auc1, auc2, p_lab),
       col = c("blue", "red", NA),
       lwd = c(2, 2, NA),
       bty = "n", inset = 0.02)
```
```{r}
roc1 <- roc(response = data$Anemie_OMS2011,
            predictor = data$ERFE..ng.mL.,
            quiet = TRUE)

roc2 <- roc(response = data$Anemie_OMS2024,
            predictor = data$ERFE..ng.mL.,
            quiet = TRUE)

# Test de DeLong pour comparer les AUC (courbes corrélées)
test_delong <- roc.test(roc1, roc2, method = "delong")

# Préparer les libellés AUC et p-value
auc1 <- paste0("WHO2011 (AUC = ", round(auc(roc1), 2), ")")
auc2 <- paste0("WHO2024 (AUC = ", round(auc(roc2), 2), ")")
p_lab <- paste0("p.delong = ", format.pval(test_delong$p.value, digits = 3, eps = 1e-4))

# Plot
plot(roc1, col = "blue", lwd = 2, print.auc = FALSE,
     main = "ROC analysis ERFE (ng/mL) / Anemia (WHO2011 vs WHO2024)")
plot(roc2, col = "red",  lwd = 2, add = TRUE, print.auc = FALSE)

legend("bottomright",
       legend = c(auc1, auc2, p_lab),
       col = c("blue", "red", NA),
       lwd = c(2, 2, NA),
       bty = "n", inset = 0.02)
```
```{r}
roc1 <- roc(response = data$Anemie_OMS2011,
            predictor = data$Vit.B9,
            quiet = TRUE)

roc2 <- roc(response = data$Anemie_OMS2024,
            predictor = data$Vit.B9,
            quiet = TRUE)

# Test de DeLong pour comparer les AUC (courbes corrélées)
test_delong <- roc.test(roc1, roc2, method = "delong")

# Préparer les libellés AUC et p-value
auc1 <- paste0("WHO2011 (AUC = ", round(auc(roc1), 2), ")")
auc2 <- paste0("WHO2024 (AUC = ", round(auc(roc2), 2), ")")
p_lab <- paste0("p.delong = ", format.pval(test_delong$p.value, digits = 3, eps = 1e-4))

# Plot
plot(roc1, col = "blue", lwd = 2, print.auc = FALSE,
     main = "ROC analysis Vitamin B9 (nmol/L) / Anemia (WHO2011 vs WHO2024)")
plot(roc2, col = "red",  lwd = 2, add = TRUE, print.auc = FALSE)

legend("bottomright",
       legend = c(auc1, auc2, p_lab),
       col = c("blue", "red", NA),
       lwd = c(2, 2, NA),
       bty = "n", inset = 0.02)
```
```{r}
roc1 <- roc(response = data$Anemie_OMS2011,
            predictor = data$Vit.B12,
            quiet = TRUE)

roc2 <- roc(response = data$Anemie_OMS2024,
            predictor = data$Vit.B12,
            quiet = TRUE)

# Test de DeLong pour comparer les AUC (courbes corrélées)
test_delong <- roc.test(roc1, roc2, method = "delong")

# Préparer les libellés AUC et p-value
auc1 <- paste0("WHO2011 (AUC = ", round(auc(roc1), 2), ")")
auc2 <- paste0("WHO2024 (AUC = ", round(auc(roc2), 2), ")")
p_lab <- paste0("p.delong = ", format.pval(test_delong$p.value, digits = 3, eps = 1e-4))

# Plot
plot(roc1, col = "blue", lwd = 2, print.auc = FALSE,
     main = "ROC analysis Vitamin B12 (nmol/L) / Anemia (WHO2011 vs WHO2024)")
plot(roc2, col = "red",  lwd = 2, add = TRUE, print.auc = FALSE)

legend("bottomright",
       legend = c(auc1, auc2, p_lab),
       col = c("blue", "red", NA),
       lwd = c(2, 2, NA),
       bty = "n", inset = 0.02)
```

# modèles simples CRP - Ferritine
```{r}
# 8-12 ans


data = read.csv("datafinalfinal.csv")

data$RECEPTEUR.TRANSFERINE <- as.numeric(gsub("<", "", data$RECEPTEUR.TRANSFERINE))
data$PROGESTERONE <- as.numeric(gsub("<", "", data$PROGESTERONE))
data$OESTRADIOL <- as.numeric(gsub("<", "", data$OESTRADIOL))

data <- data %>%
  filter(!is.na(Ville_eval))


data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

data = data[data$Age_categorie_binaire == "0-3 ans",]

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_CRP = lm(FERRITINE..microg.L. ~ CRP..mg.L., data = df),
  #mod_FER   = lm(HCT.. ~ FER, data = df),
  #mod_FERRITINE  = lm(HCT.. ~ FERRITINE, data = df),
  #mod_TRANSFERINE    = lm(HCT.. ~ TRANSFERINE, data = df),
  #mod_RTS   = lm(HCT.. ~ RECEPTEUR.TRANSFERINE, data = df),
  #mod_BI       = lm(HCT.. ~ Body.iron, data = df),
  #mod_ERFE      = lm(HCT.. ~ ERFE..ng.mL., data = df),
  #mod_VitC      = lm(HCT.. ~ OESTRADIOL, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  bind_rows(
    tidy(mods$mod_CRP, conf.int = TRUE) %>% mutate(var_dep = "CRP..mg.L.", r2 = summary(mods$mod_CRP)$r.squared),
    #tidy(mods$mod_FER, conf.int = TRUE) %>% mutate(var_dep = "FER", r2 = summary(mods$mod_FER)$r.squared),
    #tidy(mods$mod_FERRITINE, conf.int = TRUE) %>% mutate(var_dep = "FERRITINE", r2 = summary(mods$mod_FERRITINE)$r.squared),
    #tidy(mods$mod_TRANSFERINE, conf.int = TRUE) %>% mutate(var_dep = "TRANSFERINE", r2 = summary(mods$mod_TRANSFERINE)$r.squared),
    #tidy(mods$mod_RTS, conf.int = TRUE) %>% mutate(var_dep = "RECEPTEUR.TRANSFERINE", r2 = summary(mods$mod_RTS)$r.squared),
    #tidy(mods$mod_BI, conf.int = TRUE) %>% mutate(var_dep = "Body.iron", r2 = summary(mods$mod_BI)$r.squared),
    #tidy(mods$mod_ERFE, conf.int = TRUE) %>% mutate(var_dep = "ERFE..ng.mL.", r2 = summary(mods$mod_ERFE)$r.squared)
  ) %>% mutate(Ville_eval = altitude)
})


coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_table_stars <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(
    stars = case_when(
      p.value <= 0.001 ~ "***",
      p.value <= 0.01 ~ "**",
      p.value <= 0.05 ~ "*",
      TRUE ~ ""
    ),
    fill_color = case_when(
      (p.value <= 0.05 & estimate > 0) ~ "positif",
      (p.value <= 0.05 & estimate < 0) ~ "négatif",
      TRUE ~ "neutre"
    ),
    label = paste0(stars, "\nR²=", sprintf("%.2f", r2))
  ) %>%
  select(Ville_eval, var_dep, label, fill_color)


ggplot(coef_table_stars, aes(x = Ville_eval, y = var_dep, fill = fill_color)) +
  geom_tile(color = "white") +
  geom_text(aes(label = label), size = 4) +
  scale_fill_manual(
    values = c("positif" = "#1b9e77", "négatif" = "red2", "neutre" = "#e0e0e0"),
    guide = FALSE
  ) +
  labs(
    title = "Simple linear models : Ferritin (µg/L) ~ CRP (mg/L) (0-3 years old)",
    x = "City",
    y = "Explanatory variable"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 20, hjust = 1),
    panel.grid = element_blank()
  )
```
```{r}
# 8-12 ans


data = read.csv("datafinalfinal.csv")

data$RECEPTEUR.TRANSFERINE <- as.numeric(gsub("<", "", data$RECEPTEUR.TRANSFERINE))
data$PROGESTERONE <- as.numeric(gsub("<", "", data$PROGESTERONE))
data$OESTRADIOL <- as.numeric(gsub("<", "", data$OESTRADIOL))

data <- data %>%
  filter(!is.na(Ville_eval))


data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

data = data[data$Age_categorie_binaire == "8-12 ans",]

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_CRP = lm(FERRITINE..microg.L. ~ CRP..mg.L., data = df),
  #mod_FER   = lm(HCT.. ~ FER, data = df),
  #mod_FERRITINE  = lm(HCT.. ~ FERRITINE, data = df),
  #mod_TRANSFERINE    = lm(HCT.. ~ TRANSFERINE, data = df),
  #mod_RTS   = lm(HCT.. ~ RECEPTEUR.TRANSFERINE, data = df),
  #mod_BI       = lm(HCT.. ~ Body.iron, data = df),
  #mod_ERFE      = lm(HCT.. ~ ERFE..ng.mL., data = df),
  #mod_VitC      = lm(HCT.. ~ OESTRADIOL, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  bind_rows(
    tidy(mods$mod_CRP, conf.int = TRUE) %>% mutate(var_dep = "CRP..mg.L.", r2 = summary(mods$mod_CRP)$r.squared),
    #tidy(mods$mod_FER, conf.int = TRUE) %>% mutate(var_dep = "FER", r2 = summary(mods$mod_FER)$r.squared),
    #tidy(mods$mod_FERRITINE, conf.int = TRUE) %>% mutate(var_dep = "FERRITINE", r2 = summary(mods$mod_FERRITINE)$r.squared),
    #tidy(mods$mod_TRANSFERINE, conf.int = TRUE) %>% mutate(var_dep = "TRANSFERINE", r2 = summary(mods$mod_TRANSFERINE)$r.squared),
    #tidy(mods$mod_RTS, conf.int = TRUE) %>% mutate(var_dep = "RECEPTEUR.TRANSFERINE", r2 = summary(mods$mod_RTS)$r.squared),
    #tidy(mods$mod_BI, conf.int = TRUE) %>% mutate(var_dep = "Body.iron", r2 = summary(mods$mod_BI)$r.squared),
    #tidy(mods$mod_ERFE, conf.int = TRUE) %>% mutate(var_dep = "ERFE..ng.mL.", r2 = summary(mods$mod_ERFE)$r.squared)
  ) %>% mutate(Ville_eval = altitude)
})


coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_table_stars <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(
    stars = case_when(
      p.value <= 0.001 ~ "***",
      p.value <= 0.01 ~ "**",
      p.value <= 0.05 ~ "*",
      TRUE ~ ""
    ),
    fill_color = case_when(
      (p.value <= 0.05 & estimate > 0) ~ "positif",
      (p.value <= 0.05 & estimate < 0) ~ "négatif",
      TRUE ~ "neutre"
    ),
    label = paste0(stars, "\nR²=", sprintf("%.2f", r2))
  ) %>%
  select(Ville_eval, var_dep, label, fill_color)


ggplot(coef_table_stars, aes(x = Ville_eval, y = var_dep, fill = fill_color)) +
  geom_tile(color = "white") +
  geom_text(aes(label = label), size = 4) +
  scale_fill_manual(
    values = c("positif" = "#1b9e77", "négatif" = "red2", "neutre" = "#e0e0e0"),
    guide = FALSE
  ) +
  labs(
    title = "Simple linear models : Ferritin (µg/L) ~ CRP (mg/L) (8-12 years old)",
    x = "City",
    y = "Explanatory variable"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 20, hjust = 1),
    panel.grid = element_blank()
  )
```
```{r}


data = read.csv("datafinalfinal.csv")

data$RECEPTEUR.TRANSFERINE <- as.numeric(gsub("<", "", data$RECEPTEUR.TRANSFERINE))
data$PROGESTERONE <- as.numeric(gsub("<", "", data$PROGESTERONE))
data$OESTRADIOL <- as.numeric(gsub("<", "", data$OESTRADIOL))

data <- data %>%
  filter(!is.na(Ville_eval))


data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))


# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_CRP = lm(FERRITINE..microg.L. ~ CRP..mg.L., data = df),
  #mod_FER   = lm(HCT.. ~ FER, data = df),
  #mod_FERRITINE  = lm(HCT.. ~ FERRITINE, data = df),
  #mod_TRANSFERINE    = lm(HCT.. ~ TRANSFERINE, data = df),
  #mod_RTS   = lm(HCT.. ~ RECEPTEUR.TRANSFERINE, data = df),
  #mod_BI       = lm(HCT.. ~ Body.iron, data = df),
  #mod_ERFE      = lm(HCT.. ~ ERFE..ng.mL., data = df),
  #mod_VitC      = lm(HCT.. ~ OESTRADIOL, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  bind_rows(
    tidy(mods$mod_CRP, conf.int = TRUE) %>% mutate(var_dep = "CRP..mg.L.", r2 = summary(mods$mod_CRP)$r.squared),
    #tidy(mods$mod_FER, conf.int = TRUE) %>% mutate(var_dep = "FER", r2 = summary(mods$mod_FER)$r.squared),
    #tidy(mods$mod_FERRITINE, conf.int = TRUE) %>% mutate(var_dep = "FERRITINE", r2 = summary(mods$mod_FERRITINE)$r.squared),
    #tidy(mods$mod_TRANSFERINE, conf.int = TRUE) %>% mutate(var_dep = "TRANSFERINE", r2 = summary(mods$mod_TRANSFERINE)$r.squared),
    #tidy(mods$mod_RTS, conf.int = TRUE) %>% mutate(var_dep = "RECEPTEUR.TRANSFERINE", r2 = summary(mods$mod_RTS)$r.squared),
    #tidy(mods$mod_BI, conf.int = TRUE) %>% mutate(var_dep = "Body.iron", r2 = summary(mods$mod_BI)$r.squared),
    #tidy(mods$mod_ERFE, conf.int = TRUE) %>% mutate(var_dep = "ERFE..ng.mL.", r2 = summary(mods$mod_ERFE)$r.squared)
  ) %>% mutate(Ville_eval = altitude)
})


coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_table_stars <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(
    stars = case_when(
      p.value <= 0.001 ~ "***",
      p.value <= 0.01 ~ "**",
      p.value <= 0.05 ~ "*",
      TRUE ~ ""
    ),
    fill_color = case_when(
      (p.value <= 0.05 & estimate > 0) ~ "positif",
      (p.value <= 0.05 & estimate < 0) ~ "négatif",
      TRUE ~ "neutre"
    ),
    label = paste0(stars, "\nR²=", sprintf("%.2f", r2))
  ) %>%
  select(Ville_eval, var_dep, label, fill_color)


ggplot(coef_table_stars, aes(x = Ville_eval, y = var_dep, fill = fill_color)) +
  geom_tile(color = "white") +
  geom_text(aes(label = label), size = 4) +
  scale_fill_manual(
    values = c("positif" = "#1b9e77", "négatif" = "red2", "neutre" = "#e0e0e0"),
    guide = FALSE
  ) +
  labs(
    title = "Simple linear models : Ferritin (µg/L) ~ CRP (mg/L) (all ages)",
    x = "City",
    y = "Explanatory variable"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 20, hjust = 1),
    panel.grid = element_blank()
  )
```
# modèles simples hepcidine
```{r}
# HB


data = read.csv("datafinalfinal.csv")

data <- data %>%
  filter(!is.na(Ville_eval))

data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

data = data[data$Age_categorie_binaire == "0-3 ans",]

# Fonction qui crée les modèles pour chaque niveau d'altitude
# Créer les modèles par ville
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod_CRP = lm(ERFE..ng.mL. ~ CRP..mg.L., data = df),
      mod_FER   = lm(ERFE..ng.mL. ~ FER..micromol.L., data = df),
      mod_FERRITINE  = lm(ERFE..ng.mL. ~ FERRITINE..microg.L., data = df),
      mod_TRANSFERINE    = lm(ERFE..ng.mL. ~ TRANSFERINE..g.L., data = df),
      mod_RTS   = lm(ERFE..ng.mL. ~ RECEPTEUR.TRANSFERINE..mg.L., data = df),
      mod_BI       = lm(ERFE..ng.mL. ~ Body.iron, data = df),
      mod_ERFE      = lm(ERFE..ng.mL. ~ Vit.B9, data = df),
      mod_VitC      = lm(ERFE..ng.mL. ~ Vit.B12, data = df),
      Ville_eval      = unique(df$Ville_eval)
    )
  })

# Créer les modèles pour toutes villes confondues
models_all <- list(
  mod_CRP = lm(ERFE..ng.mL. ~ CRP..mg.L., data = data),
  mod_FER   = lm(ERFE..ng.mL. ~ FER..micromol.L., data = data),
  mod_FERRITINE  = lm(ERFE..ng.mL. ~ FERRITINE..microg.L., data = data),
  mod_TRANSFERINE    = lm(ERFE..ng.mL. ~ TRANSFERINE..g.L., data = data),
  mod_RTS   = lm(ERFE..ng.mL. ~ RECEPTEUR.TRANSFERINE..mg.L., data = data),
  mod_BI       = lm(ERFE..ng.mL. ~ Body.iron, data = data),
  mod_ERFE      = lm(ERFE..ng.mL. ~ Vit.B9, data = data),
  mod_VitC      = lm(ERFE..ng.mL. ~ Vit.B12, data = data),
  Ville_eval = "All cities"
)

# Ajouter à la liste existante
models_by_altitude <- append(models_by_altitude, list(models_all))


coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  bind_rows(
    tidy(mods$mod_CRP, conf.int = TRUE) %>% mutate(var_dep = "CRP..mg.L.", r2 = summary(mods$mod_CRP)$r.squared),
    tidy(mods$mod_FER, conf.int = TRUE) %>% mutate(var_dep = "FER..micromol.L.", r2 = summary(mods$mod_FER)$r.squared),
    tidy(mods$mod_FERRITINE, conf.int = TRUE) %>% mutate(var_dep = "FERRITINE..microg.L.", r2 = summary(mods$mod_FERRITINE)$r.squared),
    tidy(mods$mod_TRANSFERINE, conf.int = TRUE) %>% mutate(var_dep = "TRANSFERINE..g.L.", r2 = summary(mods$mod_TRANSFERINE)$r.squared),
    tidy(mods$mod_RTS, conf.int = TRUE) %>% mutate(var_dep = "RECEPTEUR.TRANSFERINE..mg.L.", r2 = summary(mods$mod_RTS)$r.squared)
  ,
    tidy(mods$mod_BI, conf.int = TRUE) %>% mutate(var_dep = "Body.iron", r2 = summary(mods$mod_BI)$r.squared),
    tidy(mods$mod_ERFE, conf.int = TRUE) %>% mutate(var_dep = "Vit.B9", r2 = summary(mods$mod_ERFE)$r.squared),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(var_dep = "Vit.B12", r2 = summary(mods$mod_VitC)$r.squared)
  ) %>% mutate(Ville_eval = altitude)
})

coef_data$Ville_eval <- factor(
  coef_data$Ville_eval,
  levels = c("All cities", "Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)")
)
coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_table_stars <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(
    stars = case_when(
      p.value <= 0.001 ~ "***",
      p.value <= 0.01 ~ "**",
      p.value <= 0.05 ~ "*",
      TRUE ~ ""
    ),
    fill_color = case_when(
      (p.value <= 0.05 & estimate > 0) ~ "positif",
      (p.value <= 0.05 & estimate < 0) ~ "négatif",
      TRUE ~ "neutre"
    ),
    label = paste0(stars, "\nR²=", sprintf("%.2f", r2))
  ) %>%
  select(Ville_eval, var_dep, label, fill_color)


ggplot(coef_table_stars, aes(x = Ville_eval, y = var_dep, fill = fill_color)) +
  geom_tile(color = "white") +
  geom_text(aes(label = label), size = 4) +
  scale_fill_manual(
    values = c("positif" = "#1b9e77", "négatif" = "red2", "neutre" = "#e0e0e0"),
    guide = FALSE
  ) +
  labs(
    title = "Simple linear models : ERFE..ng.mL. ~ Iron indicators (0-3 years old)",
    x = "City",
    y = "Explanatory variable"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 20, hjust = 1),
    panel.grid = element_blank()
  )
```
```{r}
# HB


data = read.csv("datafinalfinal.csv")

data <- data %>%
  filter(!is.na(Ville_eval))

data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

data = data[data$Age_categorie_binaire == "8-12 ans",]

# Fonction qui crée les modèles pour chaque niveau d'altitude
# Créer les modèles par ville
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod_CRP = lm(ERFE..ng.mL. ~ CRP..mg.L., data = df),
      mod_FER   = lm(ERFE..ng.mL. ~ FER..micromol.L., data = df),
      mod_FERRITINE  = lm(ERFE..ng.mL. ~ FERRITINE..microg.L., data = df),
      mod_TRANSFERINE    = lm(ERFE..ng.mL. ~ TRANSFERINE..g.L., data = df),
      mod_RTS   = lm(ERFE..ng.mL. ~ RECEPTEUR.TRANSFERINE..mg.L., data = df),
      mod_BI       = lm(ERFE..ng.mL. ~ Body.iron, data = df),
      mod_ERFE      = lm(ERFE..ng.mL. ~ Vit.B9, data = df),
      mod_VitC      = lm(ERFE..ng.mL. ~ Vit.B12, data = df),
      Ville_eval      = unique(df$Ville_eval)
    )
  })

# Créer les modèles pour toutes villes confondues
models_all <- list(
  mod_CRP = lm(ERFE..ng.mL. ~ CRP..mg.L., data = data),
  mod_FER   = lm(ERFE..ng.mL. ~ FER..micromol.L., data = data),
  mod_FERRITINE  = lm(ERFE..ng.mL. ~ FERRITINE..microg.L., data = data),
  mod_TRANSFERINE    = lm(ERFE..ng.mL. ~ TRANSFERINE..g.L., data = data),
  mod_RTS   = lm(ERFE..ng.mL. ~ RECEPTEUR.TRANSFERINE..mg.L., data = data),
  mod_BI       = lm(ERFE..ng.mL. ~ Body.iron, data = data),
  mod_ERFE      = lm(ERFE..ng.mL. ~ Vit.B9, data = data),
  mod_VitC      = lm(ERFE..ng.mL. ~ Vit.B12, data = data),
  Ville_eval = "All cities"
)

# Ajouter à la liste existante
models_by_altitude <- append(models_by_altitude, list(models_all))


coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  bind_rows(
    tidy(mods$mod_CRP, conf.int = TRUE) %>% mutate(var_dep = "CRP..mg.L.", r2 = summary(mods$mod_CRP)$r.squared),
    tidy(mods$mod_FER, conf.int = TRUE) %>% mutate(var_dep = "FER..micromol.L.", r2 = summary(mods$mod_FER)$r.squared),
    tidy(mods$mod_FERRITINE, conf.int = TRUE) %>% mutate(var_dep = "FERRITINE..microg.L.", r2 = summary(mods$mod_FERRITINE)$r.squared),
    tidy(mods$mod_TRANSFERINE, conf.int = TRUE) %>% mutate(var_dep = "TRANSFERINE..g.L.", r2 = summary(mods$mod_TRANSFERINE)$r.squared),
    tidy(mods$mod_RTS, conf.int = TRUE) %>% mutate(var_dep = "RECEPTEUR.TRANSFERINE..mg.L.", r2 = summary(mods$mod_RTS)$r.squared)
  ,
    tidy(mods$mod_BI, conf.int = TRUE) %>% mutate(var_dep = "Body.iron", r2 = summary(mods$mod_BI)$r.squared),
    tidy(mods$mod_ERFE, conf.int = TRUE) %>% mutate(var_dep = "Vit.B9", r2 = summary(mods$mod_ERFE)$r.squared),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(var_dep = "Vit.B12", r2 = summary(mods$mod_VitC)$r.squared)
  ) %>% mutate(Ville_eval = altitude)
})

coef_data$Ville_eval <- factor(
  coef_data$Ville_eval,
  levels = c("All cities", "Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)")
)
coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_table_stars <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(
    stars = case_when(
      p.value <= 0.001 ~ "***",
      p.value <= 0.01 ~ "**",
      p.value <= 0.05 ~ "*",
      TRUE ~ ""
    ),
    fill_color = case_when(
      (p.value <= 0.05 & estimate > 0) ~ "positif",
      (p.value <= 0.05 & estimate < 0) ~ "négatif",
      TRUE ~ "neutre"
    ),
    label = paste0(stars, "\nR²=", sprintf("%.2f", r2))
  ) %>%
  select(Ville_eval, var_dep, label, fill_color)


ggplot(coef_table_stars, aes(x = Ville_eval, y = var_dep, fill = fill_color)) +
  geom_tile(color = "white") +
  geom_text(aes(label = label), size = 4) +
  scale_fill_manual(
    values = c("positif" = "#1b9e77", "négatif" = "red2", "neutre" = "#e0e0e0"),
    guide = FALSE
  ) +
  labs(
    title = "Simple linear models : ERFE..ng.mL. ~ Iron indicators (8-12 years old)",
    x = "City",
    y = "Explanatory variable"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 20, hjust = 1),
    panel.grid = element_blank()
  )
```

```{r}
# HB


data = read.csv("datafinalfinal.csv")

data <- data %>%
  filter(!is.na(Ville_eval))

data$ERFE..ng.mL. = as.numeric(data$ERFE..ng.mL.)
data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

data = data[data$Age_categorie_binaire == "8-12 ans",]

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_CRP = lm(ERFE..ng.mL. ~ CRP..mg.L., data = df),
  mod_FER   = lm(ERFE..ng.mL. ~ FER..micromol.L., data = df),
  mod_FERRITINE  = lm(ERFE..ng.mL. ~ FERRITINE..microg.L., data = df),
  mod_TRANSFERINE    = lm(ERFE..ng.mL. ~ TRANSFERINE..g.L., data = df),
  mod_RTS   = lm(ERFE..ng.mL. ~ RECEPTEUR.TRANSFERINE..mg.L., data = df),
  mod_BI       = lm(ERFE..ng.mL. ~ Body.iron, data = df),
  #mod_ERFE      = lm(HCT.. ~ ERFE..ng.mL., data = df),
  #mod_VitC      = lm(HCT.. ~ OESTRADIOL, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  bind_rows(
    tidy(mods$mod_CRP, conf.int = TRUE) %>% mutate(var_dep = "CRP..mg.L.", r2 = summary(mods$mod_CRP)$r.squared),
    tidy(mods$mod_FER, conf.int = TRUE) %>% mutate(var_dep = "FER..micromol.L.", r2 = summary(mods$mod_FER)$r.squared),
    tidy(mods$mod_FERRITINE, conf.int = TRUE) %>% mutate(var_dep = "FERRITINE..microg.L.", r2 = summary(mods$mod_FERRITINE)$r.squared),
    tidy(mods$mod_TRANSFERINE, conf.int = TRUE) %>% mutate(var_dep = "TRANSFERINE..g.L.", r2 = summary(mods$mod_TRANSFERINE)$r.squared),
    tidy(mods$mod_RTS, conf.int = TRUE) %>% mutate(var_dep = "RECEPTEUR.TRANSFERINE..mg.L.", r2 = summary(mods$mod_RTS)$r.squared)
  ,
    tidy(mods$mod_BI, conf.int = TRUE) %>% mutate(var_dep = "Body.iron", r2 = summary(mods$mod_BI)$r.squared),
    #tidy(mods$mod_ERFE, conf.int = TRUE) %>% mutate(var_dep = "ERFE..ng.mL.", r2 = summary(mods$mod_ERFE)$r.squared)
  ) %>% mutate(Ville_eval = altitude)
})


coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_table_stars <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(
    stars = case_when(
      p.value <= 0.001 ~ "***",
      p.value <= 0.01 ~ "**",
      p.value <= 0.05 ~ "*",
      TRUE ~ ""
    ),
    fill_color = case_when(
      (p.value <= 0.05 & estimate > 0) ~ "positif",
      (p.value <= 0.05 & estimate < 0) ~ "négatif",
      TRUE ~ "neutre"
    ),
    label = paste0(stars, "\nR²=", sprintf("%.2f", r2))
  ) %>%
  select(Ville_eval, var_dep, label, fill_color)


ggplot(coef_table_stars, aes(x = Ville_eval, y = var_dep, fill = fill_color)) +
  geom_tile(color = "white") +
  geom_text(aes(label = label), size = 4) +
  scale_fill_manual(
    values = c("positif" = "#1b9e77", "négatif" = "red2", "neutre" = "#e0e0e0"),
    guide = FALSE
  ) +
  labs(
    title = "Simple linear models : ERFE..ng.mL. ~ Iron indicators (8-12 years old)",
    x = "City",
    y = "Explanatory variable"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 20, hjust = 1),
    panel.grid = element_blank()
  )
```

```{r}
data = read.csv("datafinalfinal.csv")
data = data[data$Age_categorie_binaire == "0-3 ans",]
data = data[data$Ville_eval == "Lima (150m)",]
mod = lm(ERFE..ng.mL. ~ FERRITINE, data = data)
summary(mod)
check_model(mod)

```

```{r}
df = read.csv("datafinalfinal.csv")

seuils_groupes <- df %>%
  group_by(Ville_eval, Age_categorie_binaire) %>%
  summarise(
    seuil_plus_1_5SD_HB = mean(HB, na.rm = TRUE) + 1.5 * sd(HB, na.rm = TRUE),
    seuil_plus_1_5SD_HBMASS = mean(Hb.mass.kg..g...kg., na.rm = TRUE) + 1.5 * sd(Hb.mass.kg..g...kg., na.rm = TRUE),
    .groups = "drop"
  )

df <- df %>%
  left_join(seuils_groupes, by = c("Ville_eval", "Age_categorie_binaire")) %>%
  mutate(Polyglobulie_1.5SD = ifelse(HB > seuil_plus_1_5SD_HB, "oui", "non")) %>%
  mutate(Polyglobulie_1.5SD_Hbmass_kg = ifelse(Hb.mass.kg..g...kg. > seuil_plus_1_5SD_HBMASS, "oui", "non"))
```



# Comparaison moyennes FER - OMS (modifié)
```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Anemie_OMS2011 = factor(Anemie_OMS2011, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Anemie_OMS2011, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Anemie_OMS2011, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Anemie_OMS2011)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Anemie_OMS2011)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Anemie_OMS2011)), aes(x = Anemie_OMS2011, y = valeur, fill = Anemie_OMS2011)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between anemic and non-anemic children (0-3 years old)\n according to anemia diagnosis (WHO 2011) (n=", n_global,")"),
    subtitle = "Method: t-test (anemic vs non-anemic)",
    x = "Anemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Anemie_OMS2011 = factor(Anemie_OMS2011, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Anemie_OMS2011, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Anemie_OMS2011, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Anemie_OMS2011)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Anemie_OMS2011)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Anemie_OMS2011)), aes(x = Anemie_OMS2011, y = valeur, fill = Anemie_OMS2011)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between anemic and non-anemic children (8-12 years old)\n according to anemia diagnosis (WHO 2011) (n=", n_global,")"),
    subtitle = "Method: t-test (anemic vs non-anemic)",
    x = "Anemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Anemie_OMS2024 = factor(Anemie_OMS2024, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Anemie_OMS2024, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Anemie_OMS2024, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Anemie_OMS2024)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Anemie_OMS2024)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Anemie_OMS2024)), aes(x = Anemie_OMS2024, y = valeur, fill = Anemie_OMS2024)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between anemic and non-anemic children (0-3 years old)\naccording to anemia diagnosis (WHO 2024) (n=", n_global,")"),
    subtitle = "Method: t-test (anemic vs non-anemic)",
    x = "Anemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Anemie_OMS2024 = factor(Anemie_OMS2024, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Anemie_OMS2024, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Anemie_OMS2024, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Anemie_OMS2024)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Anemie_OMS2024)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Anemie_OMS2024)), aes(x = Anemie_OMS2024, y = valeur, fill = Anemie_OMS2024)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between anemic and non-anemic children (8-12 years old)\naccording to anemia diagnosis (WHO 2024) (n=", n_global,")"),
    subtitle = "Method: t-test (anemic vs non-anemic)",
    x = "Anemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```



```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
df = df[df$Ville_eval == "Lima (150m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Anemie_OMS2024 = factor(Anemie_OMS2024, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Anemie_OMS2024, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Anemie_OMS2024, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Anemie_OMS2024)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Anemie_OMS2024)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Anemie_OMS2024)), aes(x = Anemie_OMS2024, y = valeur, fill = Anemie_OMS2024)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between anemic and non-anemic children (0-3 years old)\nfrom Lima (150m) according to anemia diagnosis (WHO 2024) (n=", n_global,")"),
    subtitle = "Method: t-test (anemic vs non-anemic)",
    x = "Anemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
df = df[df$Ville_eval == "Lima (150m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Anemie_OMS2011 = factor(Anemie_OMS2011, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Anemie_OMS2011, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Anemie_OMS2011, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Anemie_OMS2011)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Anemie_OMS2011)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Anemie_OMS2011)), aes(x = Anemie_OMS2011, y = valeur, fill = Anemie_OMS2011)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between anemic and non-anemic children (0-3 years old)\nfrom Lima (150m) according to anemia diagnosis (WHO 2011) (n=", n_global,")"),
    subtitle = "Method: t-test (anemic vs non-anemic)",
    x = "Anemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
df = df[df$Ville_eval == "Cusco (3400m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Anemie_OMS2024 = factor(Anemie_OMS2024, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Anemie_OMS2024, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Anemie_OMS2024, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Anemie_OMS2024)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Anemie_OMS2024)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Anemie_OMS2024)), aes(x = Anemie_OMS2024, y = valeur, fill = Anemie_OMS2024)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between anemic and non-anemic children (0-3 years old)\nfrom Cusco (3400m) according to anemia diagnosis (WHO 2024) (n=", n_global,")"),
    subtitle = "Method: t-test (anemic vs non-anemic)",
    x = "Anemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
df = df[df$Ville_eval == "Cusco (3400m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Anemie_OMS2011 = factor(Anemie_OMS2011, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Anemie_OMS2011, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Anemie_OMS2011, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Anemie_OMS2011)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Anemie_OMS2011)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Anemie_OMS2011)), aes(x = Anemie_OMS2011, y = valeur, fill = Anemie_OMS2011)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between anemic and non-anemic children (0-3 years old)\nfrom Cusco (3400m) according to anemia diagnosis (WHO 2011) (n=", n_global,")"),
    subtitle = "Method: t-test (anemic vs non-anemic)",
    x = "Anemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
df = df[df$Ville_eval == "Juliaca (3800m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Anemie_OMS2024 = factor(Anemie_OMS2024, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Anemie_OMS2024, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Anemie_OMS2024, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Anemie_OMS2024)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Anemie_OMS2024)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")
n_global = nrow(df_clean)
# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Anemie_OMS2024)), aes(x = Anemie_OMS2024, y = valeur, fill = Anemie_OMS2024)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between anemic and non-anemic children (0-3 years old)\nfrom Juliaca (3800m) according to anemia diagnosis (WHO 2024) (n=", n_global,")"),
    subtitle = "Method: t-test (anemic vs non-anemic)",
    x = "Anemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
df = df[df$Ville_eval == "Juliaca (3800m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Anemie_OMS2011 = factor(Anemie_OMS2011, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Anemie_OMS2011, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Anemie_OMS2011, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Anemie_OMS2011)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Anemie_OMS2011)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Anemie_OMS2011)), aes(x = Anemie_OMS2011, y = valeur, fill = Anemie_OMS2011)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between anemic and non-anemic children (0-3 years old)\nfrom Juliaca (3800m) according to anemia diagnosis (WHO 2011) (n=", n_global,")"),
    subtitle = "Method: t-test (anemic vs non-anemic)",
    x = "Anemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
df = df[df$Ville_eval == "La Rinconada (5100m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Anemie_OMS2024 = factor(Anemie_OMS2024, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Anemie_OMS2024, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Anemie_OMS2024, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Anemie_OMS2024)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Anemie_OMS2024)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Anemie_OMS2024)), aes(x = Anemie_OMS2024, y = valeur, fill = Anemie_OMS2024)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between anemic and non-anemic children (0-3 years old)\nfrom La Rinconada (5100m) according to anemia diagnosis (WHO 2024) (n=", n_global,")"),
    subtitle = "Method: t-test (anemic vs non-anemic)",
    x = "Anemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
df = df[df$Ville_eval == "La Rinconada (5100m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Anemie_OMS2011 = factor(Anemie_OMS2011, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Anemie_OMS2011, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Anemie_OMS2011, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Anemie_OMS2011)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Anemie_OMS2011)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Anemie_OMS2011)), aes(x = Anemie_OMS2011, y = valeur, fill = Anemie_OMS2011)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between anemic and non-anemic children (0-3 years old)\nfrom La Rinconada (5100m) according to anemia diagnosis (WHO 2011) (n=", n_global,")"),
    subtitle = "Method: t-test (anemic vs non-anemic)",
    x = "Anemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```


```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]
df = df[df$Ville_eval == "Lima (150m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Anemie_OMS2024 = factor(Anemie_OMS2024, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Anemie_OMS2024, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Anemie_OMS2024, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Anemie_OMS2024)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Anemie_OMS2024)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Anemie_OMS2024)), aes(x = Anemie_OMS2024, y = valeur, fill = Anemie_OMS2024)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between anemic and non-anemic children (8-12 years old)\nfrom Lima (150m) according to anemia diagnosis (WHO 2024) (n=", n_global,")"),
    subtitle = "Method: t-test (anemic vs non-anemic)",
    x = "Anemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]
df = df[df$Ville_eval == "Lima (150m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Anemie_OMS2011 = factor(Anemie_OMS2011, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Anemie_OMS2011, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Anemie_OMS2011, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Anemie_OMS2011)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Anemie_OMS2011)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Anemie_OMS2011)), aes(x = Anemie_OMS2011, y = valeur, fill = Anemie_OMS2011)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between anemic and non-anemic children (8-12 years old)\nfrom Lima (150m) according to anemia diagnosis (WHO 2011) (n=", n_global,")"),
    subtitle = "Method: t-test (anemic vs non-anemic)",
    x = "Anemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]
df = df[df$Ville_eval == "Cusco (3400m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Anemie_OMS2024 = factor(Anemie_OMS2024, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Anemie_OMS2024, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Anemie_OMS2024, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Anemie_OMS2024)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Anemie_OMS2024)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Anemie_OMS2024)), aes(x = Anemie_OMS2024, y = valeur, fill = Anemie_OMS2024)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between anemic and non-anemic children (8-12 years old)\nfrom Cusco (3400m) according to anemia diagnosis (WHO 2024) (n=", n_global,")"),
    subtitle = "Method: t-test (anemic vs non-anemic)",
    x = "Anemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]
df = df[df$Ville_eval == "Cusco (3400m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Anemie_OMS2011 = factor(Anemie_OMS2011, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Anemie_OMS2011, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
df_long <- df_clean %>%
  pivot_longer(cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
               names_to = "parametre",
               values_to = "valeur")

# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Anemie_OMS2011, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Anemie_OMS2011)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Anemie_OMS2011)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Anemie_OMS2011)), aes(x = Anemie_OMS2011, y = valeur, fill = Anemie_OMS2011)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between anemic and non-anemic children (8-12 years old)\nfrom Cusco (3400m) according to anemia diagnosis (WHO 2011) (n=", n_global,")"),
    subtitle = "Method: t-test (anemic vs non-anemic)",
    x = "Anemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]
df = df[df$Ville_eval == "Juliaca (3800m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Anemie_OMS2024 = factor(Anemie_OMS2024, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Anemie_OMS2024, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Anemie_OMS2024, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Anemie_OMS2024)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Anemie_OMS2024)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Anemie_OMS2024)), aes(x = Anemie_OMS2024, y = valeur, fill = Anemie_OMS2024)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between anemic and non-anemic children (8-12 years old)\nfrom Juliaca (3800m) according to anemia diagnosis (WHO 2024) (n=", n_global,")"),
    subtitle = "Method: t-test (anemic vs non-anemic)",
    x = "Anemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]
df = df[df$Ville_eval == "Juliaca (3800m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Anemie_OMS2011 = factor(Anemie_OMS2011, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Anemie_OMS2011, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Anemie_OMS2011, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Anemie_OMS2011)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Anemie_OMS2011)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Anemie_OMS2011)), aes(x = Anemie_OMS2011, y = valeur, fill = Anemie_OMS2011)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between anemic and non-anemic children (8-12 years old)\nfrom Juliaca (3800m) according to anemia diagnosis (WHO 2011) (n=", n_global,")"),
    subtitle = "Method: t-test (anemic vs non-anemic)",
    x = "Anemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]
df = df[df$Ville_eval == "La Rinconada (5100m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Anemie_OMS2024 = factor(Anemie_OMS2024, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Anemie_OMS2024, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Anemie_OMS2024, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Anemie_OMS2024)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Anemie_OMS2024)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Anemie_OMS2024)), aes(x = Anemie_OMS2024, y = valeur, fill = Anemie_OMS2024)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between anemic and non-anemic children (8-12 years old)\nfrom La Rinconada (5100m) according to anemia diagnosis (WHO 2024) (n=", n_global,")"),
    subtitle = "Method: t-test (anemic vs non-anemic)",
    x = "Anemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]
df = df[df$Ville_eval == "La Rinconada (5100m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Anemie_OMS2011 = factor(Anemie_OMS2011, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Anemie_OMS2011, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Anemie_OMS2011, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Anemie_OMS2011)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Anemie_OMS2011)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Anemie_OMS2011)), aes(x = Anemie_OMS2011, y = valeur, fill = Anemie_OMS2011)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between anemic and non-anemic children (8-12 years old)\nfrom La Rinconada (5100m) according to anemia diagnosis (WHO 2011) (n=", n_global,")"),
    subtitle = "Method: t-test (anemic vs non-anemic)",
    x = "Anemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```




```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Polyglobulie_14.5_OMS2024 = factor(Polyglobulie_14.5_OMS2024, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Polyglobulie_14.5_OMS2024, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Polyglobulie_14.5_OMS2024, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Polyglobulie_14.5_OMS2024)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Polyglobulie_14.5_OMS2024)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Polyglobulie_14.5_OMS2024)), aes(x = Polyglobulie_14.5_OMS2024, y = valeur, fill = Polyglobulie_14.5_OMS2024)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between polycythemic and non-polycythemic children (0-3 years old)\n according to polycythemia diagnosis (WHO 2024) (n=", n_global,")"),
    subtitle = "Method: t-test (polycythemic vs non-polycythemic)",
    x = "polycythemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Polyglobulie_14.5_OMS2011 = factor(Polyglobulie_14.5_OMS2011, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Polyglobulie_14.5_OMS2011, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Polyglobulie_14.5_OMS2011, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Polyglobulie_14.5_OMS2011)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Polyglobulie_14.5_OMS2011)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Polyglobulie_14.5_OMS2011)), aes(x = Polyglobulie_14.5_OMS2011, y = valeur, fill = Polyglobulie_14.5_OMS2011)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between polycythemic and non-polycythemic children (0-3 years old)\n according to polycythemia diagnosis (WHO 2011) (n=", n_global,")"),
    subtitle = "Method: t-test (polycythemic vs non-polycythemic)",
    x = "polycythemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Polyglobulie_14.5_OMS2024 = factor(Polyglobulie_14.5_OMS2024, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Polyglobulie_14.5_OMS2024, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Polyglobulie_14.5_OMS2024, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Polyglobulie_14.5_OMS2024)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Polyglobulie_14.5_OMS2024)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Polyglobulie_14.5_OMS2024)), aes(x = Polyglobulie_14.5_OMS2024, y = valeur, fill = Polyglobulie_14.5_OMS2024)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between polycythemic and non-polycythemic children (8-12 years old)\n according to polycythemia diagnosis (WHO 2024) (n=", n_global,")"),
    subtitle = "Method: t-test (polycythemic vs non-polycythemic)",
    x = "polycythemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Polyglobulie_14.5_OMS2011 = factor(Polyglobulie_14.5_OMS2011, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Polyglobulie_14.5_OMS2011, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Polyglobulie_14.5_OMS2011, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Polyglobulie_14.5_OMS2011)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Polyglobulie_14.5_OMS2011)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Polyglobulie_14.5_OMS2011)), aes(x = Polyglobulie_14.5_OMS2011, y = valeur, fill = Polyglobulie_14.5_OMS2011)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between polycythemic and non-polycythemic children (8-12 years old)\n according to polycythemia diagnosis (WHO 2011) (n=", n_global,")"),
    subtitle = "Method: t-test (polycythemic vs non-polycythemic)",
    x = "polycythemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```


```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
df = df[df$Ville_eval == "Lima (150m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Polyglobulie_14.5_OMS2024 = factor(Polyglobulie_14.5_OMS2024, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Polyglobulie_14.5_OMS2024, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Polyglobulie_14.5_OMS2024, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Polyglobulie_14.5_OMS2024)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Polyglobulie_14.5_OMS2024)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Polyglobulie_14.5_OMS2024)), aes(x = Polyglobulie_14.5_OMS2024, y = valeur, fill = Polyglobulie_14.5_OMS2024)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between polycythemic and non-polycythemic children (0-3 years old)\nfrom Lima (150m) according to polycythemia diagnosis (WHO 2024) (n=", n_global,")"),
    subtitle = "Method: t-test (polycythemic vs non-polycythemic)",
    x = "polycythemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
df = df[df$Ville_eval == "Lima (150m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Polyglobulie_14.5_OMS2011 = factor(Polyglobulie_14.5_OMS2011, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Polyglobulie_14.5_OMS2011, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Polyglobulie_14.5_OMS2011, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Polyglobulie_14.5_OMS2011)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Polyglobulie_14.5_OMS2011)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Polyglobulie_14.5_OMS2011)), aes(x = Polyglobulie_14.5_OMS2011, y = valeur, fill = Polyglobulie_14.5_OMS2011)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between polycythemic and non-polycythemic children (0-3 years old)\nfrom Lima (150m) according to polycythemia diagnosis (WHO 2011) (n=", n_global,")"),
    subtitle = "Method: t-test (polycythemic vs non-polycythemic)",
    x = "polycythemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
df = df[df$Ville_eval == "Cusco (3400m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Polyglobulie_14.5_OMS2024 = factor(Polyglobulie_14.5_OMS2024, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Polyglobulie_14.5_OMS2024, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Polyglobulie_14.5_OMS2024, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Polyglobulie_14.5_OMS2024)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Polyglobulie_14.5_OMS2024)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Polyglobulie_14.5_OMS2024)), aes(x = Polyglobulie_14.5_OMS2024, y = valeur, fill = Polyglobulie_14.5_OMS2024)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between polycythemic and non-polycythemic children (0-3 years old)\nfrom Cusco (3400m) according to polycythemia diagnosis (WHO 2024) (n=", n_global,")"),
    subtitle = "Method: t-test (polycythemic vs non-polycythemic)",
    x = "polycythemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
df = df[df$Ville_eval == "Cusco (3400m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Polyglobulie_14.5_OMS2011 = factor(Polyglobulie_14.5_OMS2011, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Polyglobulie_14.5_OMS2011, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Polyglobulie_14.5_OMS2011, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Polyglobulie_14.5_OMS2011)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Polyglobulie_14.5_OMS2011)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Polyglobulie_14.5_OMS2011)), aes(x = Polyglobulie_14.5_OMS2011, y = valeur, fill = Polyglobulie_14.5_OMS2011)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between polycythemic and non-polycythemic children (0-3 years old)\nfrom Cusco (3400m) according to polycythemia diagnosis (WHO 2011) (n=", n_global,")"),
    subtitle = "Method: t-test (polycythemic vs non-polycythemic)",
    x = "polycythemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
df = df[df$Ville_eval == "Juliaca (3800m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Polyglobulie_14.5_OMS2024 = factor(Polyglobulie_14.5_OMS2024, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Polyglobulie_14.5_OMS2024, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Polyglobulie_14.5_OMS2024, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Polyglobulie_14.5_OMS2024)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Polyglobulie_14.5_OMS2024)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Polyglobulie_14.5_OMS2024)), aes(x = Polyglobulie_14.5_OMS2024, y = valeur, fill = Polyglobulie_14.5_OMS2024)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between polycythemic and non-polycythemic children (0-3 years old)\nfrom Juliaca (3800m) according to polycythemia diagnosis (WHO 2024) (n=", n_global,")"),
    subtitle = "Method: t-test (polycythemic vs non-polycythemic)",
    x = "polycythemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
df = df[df$Ville_eval == "Juliaca (3800m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Polyglobulie_14.5_OMS2011 = factor(Polyglobulie_14.5_OMS2011, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Polyglobulie_14.5_OMS2011, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Polyglobulie_14.5_OMS2011, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Polyglobulie_14.5_OMS2011)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Polyglobulie_14.5_OMS2011)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Polyglobulie_14.5_OMS2011)), aes(x = Polyglobulie_14.5_OMS2011, y = valeur, fill = Polyglobulie_14.5_OMS2011)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between polycythemic and non-polycythemic children (0-3 years old)\nfrom Juliaca (3800m) according to polycythemia diagnosis (WHO 2011) (n=", n_global,")"),
    subtitle = "Method: t-test (polycythemic vs non-polycythemic)",
    x = "polycythemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
df = df[df$Ville_eval == "La Rinconada (5100m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Polyglobulie_14.5_OMS2024 = factor(Polyglobulie_14.5_OMS2024, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Polyglobulie_14.5_OMS2024, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Polyglobulie_14.5_OMS2024, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Polyglobulie_14.5_OMS2024)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Polyglobulie_14.5_OMS2024)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Polyglobulie_14.5_OMS2024)), aes(x = Polyglobulie_14.5_OMS2024, y = valeur, fill = Polyglobulie_14.5_OMS2024)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between polycythemic and non-polycythemic children (0-3 years old)\nfrom La Rinconada (5100m) according to polycythemia diagnosis (WHO 2024) (n=", n_global,")"),
    subtitle = "Method: t-test (polycythemic vs non-polycythemic)",
    x = "polycythemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
df = df[df$Ville_eval == "La Rinconada (5100m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Polyglobulie_14.5_OMS2011 = factor(Polyglobulie_14.5_OMS2011, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Polyglobulie_14.5_OMS2011, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Polyglobulie_14.5_OMS2011, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Polyglobulie_14.5_OMS2011)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Polyglobulie_14.5_OMS2011)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Polyglobulie_14.5_OMS2011)), aes(x = Polyglobulie_14.5_OMS2011, y = valeur, fill = Polyglobulie_14.5_OMS2011)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between polycythemic and non-polycythemic children (0-3 years old)\nfrom La Rinconada (5100m) according to polycythemia diagnosis (WHO 2011) (n=", n_global,")"),
    subtitle = "Method: t-test (polycythemic vs non-polycythemic)",
    x = "polycythemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```


```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]
df = df[df$Ville_eval == "Lima (150m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Polyglobulie_14.5_OMS2024 = factor(Polyglobulie_14.5_OMS2024, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Polyglobulie_14.5_OMS2024, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Polyglobulie_14.5_OMS2024, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Polyglobulie_14.5_OMS2024)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Polyglobulie_14.5_OMS2024)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Polyglobulie_14.5_OMS2024)), aes(x = Polyglobulie_14.5_OMS2024, y = valeur, fill = Polyglobulie_14.5_OMS2024)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between polycythemic and non-polycythemic children (8-12 years old)\nfrom Lima (150m) according to polycythemia diagnosis (WHO 2024) (n=", n_global,")"),
    subtitle = "Method: t-test (polycythemic vs non-polycythemic)",
    x = "polycythemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]
df = df[df$Ville_eval == "Lima (150m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Polyglobulie_14.5_OMS2011 = factor(Polyglobulie_14.5_OMS2011, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Polyglobulie_14.5_OMS2011, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Polyglobulie_14.5_OMS2011, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Polyglobulie_14.5_OMS2011)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Polyglobulie_14.5_OMS2011)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Polyglobulie_14.5_OMS2011)), aes(x = Polyglobulie_14.5_OMS2011, y = valeur, fill = Polyglobulie_14.5_OMS2011)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between polycythemic and non-polycythemic children (8-12 years old)\nfrom Lima (150m) according to polycythemia diagnosis (WHO 2011) (n=", n_global,")"),
    subtitle = "Method: t-test (polycythemic vs non-polycythemic)",
    x = "polycythemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]
df = df[df$Ville_eval == "Cusco (3400m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Polyglobulie_14.5_OMS2024 = factor(Polyglobulie_14.5_OMS2024, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Polyglobulie_14.5_OMS2024, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Polyglobulie_14.5_OMS2024, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Polyglobulie_14.5_OMS2024)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Polyglobulie_14.5_OMS2024)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Polyglobulie_14.5_OMS2024)), aes(x = Polyglobulie_14.5_OMS2024, y = valeur, fill = Polyglobulie_14.5_OMS2024)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between polycythemic and non-polycythemic children (8-12 years old)\nfrom Cusco (3400m) according to polycythemia diagnosis (WHO 2024) (n=", n_global,")"),
    subtitle = "Method: t-test (polycythemic vs non-polycythemic)",
    x = "polycythemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]
df = df[df$Ville_eval == "Cusco (3400m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Polyglobulie_14.5_OMS2011 = factor(Polyglobulie_14.5_OMS2011, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Polyglobulie_14.5_OMS2011, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Polyglobulie_14.5_OMS2011, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Polyglobulie_14.5_OMS2011)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Polyglobulie_14.5_OMS2011)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Polyglobulie_14.5_OMS2011)), aes(x = Polyglobulie_14.5_OMS2011, y = valeur, fill = Polyglobulie_14.5_OMS2011)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between polycythemic and non-polycythemic children (8-12 years old)\nfrom Cusco (3400m) according to polycythemia diagnosis (WHO 2011) (n=", n_global,")"),
    subtitle = "Method: t-test (polycythemic vs non-polycythemic)",
    x = "polycythemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]
df = df[df$Ville_eval == "Juliaca (3800m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Polyglobulie_14.5_OMS2024 = factor(Polyglobulie_14.5_OMS2024, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Polyglobulie_14.5_OMS2024, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Polyglobulie_14.5_OMS2024, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Polyglobulie_14.5_OMS2024)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Polyglobulie_14.5_OMS2024)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Polyglobulie_14.5_OMS2024)), aes(x = Polyglobulie_14.5_OMS2024, y = valeur, fill = Polyglobulie_14.5_OMS2024)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between polycythemic and non-polycythemic children (8-12 years old)\nfrom Juliaca (3800m) according to polycythemia diagnosis (WHO 2024) (n=", n_global,")"),
    subtitle = "Method: t-test (polycythemic vs non-polycythemic)",
    x = "polycythemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]
df = df[df$Ville_eval == "Juliaca (3800m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Polyglobulie_14.5_OMS2011 = factor(Polyglobulie_14.5_OMS2011, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Polyglobulie_14.5_OMS2011, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Polyglobulie_14.5_OMS2011, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Polyglobulie_14.5_OMS2011)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Polyglobulie_14.5_OMS2011)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Polyglobulie_14.5_OMS2011)), aes(x = Polyglobulie_14.5_OMS2011, y = valeur, fill = Polyglobulie_14.5_OMS2011)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between polycythemic and non-polycythemic children (8-12 years old)\nfrom Juliaca (3800m) according to polycythemia diagnosis (WHO 2011) (n=", n_global,")"),
    subtitle = "Method: t-test (polycythemic vs non-polycythemic)",
    x = "polycythemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]
df = df[df$Ville_eval == "La Rinconada (5100m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Polyglobulie_14.5_OMS2024 = factor(Polyglobulie_14.5_OMS2024, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Polyglobulie_14.5_OMS2024, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Polyglobulie_14.5_OMS2024, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Polyglobulie_14.5_OMS2024)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Polyglobulie_14.5_OMS2024)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Polyglobulie_14.5_OMS2024)), aes(x = Polyglobulie_14.5_OMS2024, y = valeur, fill = Polyglobulie_14.5_OMS2024)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between polycythemic and non-polycythemic children (8-12 years old)\nfrom La Rinconada (5100m) according to polycythemia diagnosis (WHO 2024) (n=", n_global,")"),
    subtitle = "Method: t-test (polycythemic vs non-polycythemic)",
    x = "polycythemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]
df = df[df$Ville_eval == "La Rinconada (5100m)",]
# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Polyglobulie_14.5_OMS2011 = factor(Polyglobulie_14.5_OMS2011, levels = c("non", "oui"), labels = c("no", "yes")),
    FER = FER..micromol.L.,
    FERRITINE = FERRITINE..microg.L.,
    TRANSFERINE = TRANSFERINE..g.L.,
    RECEPTEUR.TRANSFERINE = RECEPTEUR.TRANSFERINE..mg.L.,
    Body.iron = Body.iron,
    ERFE..ng.mL. = as.numeric(ERFE..ng.mL.),
    CRP..mg.L. = CRP..mg.L.,
    Vit.B9 = as.numeric(Vit.B9),
    Vit.B12 = as.numeric(Vit.B12)
  ) %>%
  select(Polyglobulie_14.5_OMS2011, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12)
n_global = nrow(df_clean)
# Passage en format long
# Dictionnaire de traduction
dict <- tibble::tibble(
  parametre = c("FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", 
                "Body.iron", "ERFE..ng.mL.", "CRP..mg.L.", "Vit.B9", "Vit.B12"),
  parametre_en = c("Iron (µmol/L)", "Ferritin (µg/L)", "Transferrin (g/L)", 
                   "Soluble transferrin receptor (mg/L)", "Body iron (mg/kg)", 
                   "ERFE (ng/mL)", "CRP (mg/L)", 
                   "Vitamin B9 (nmol/L)", "Vitamin B12 (pmol/L)")
)

df_long <- df_clean %>%
  pivot_longer(
    cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE, Body.iron, ERFE..ng.mL., CRP..mg.L., Vit.B9, Vit.B12),
    names_to = "parametre",
    values_to = "valeur"
  ) %>%
  left_join(dict, by = "parametre") %>%
  select(-parametre) %>%
  rename(parametre = parametre_en)


# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Polyglobulie_14.5_OMS2011, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

pvals <- df_long %>%
  filter(!is.na(valeur), !is.na(Polyglobulie_14.5_OMS2011)) %>%
  group_by(parametre) %>%
  summarise(
    p = tryCatch(
      t.test(valeur ~ Polyglobulie_14.5_OMS2011)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) %>%
  mutate(
    signif_label = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      TRUE     ~ "ns"
    )
  )

# Étape 2 : Placement des labels
# Calculer la position Y maximale pour chaque facette
y_positions <- df_long %>%
  group_by(parametre) %>%
  summarise(y_max = max(valeur, na.rm = TRUE) * 1.05)

# Fusion des p-values et des positions
labels_df <- left_join(pvals, y_positions, by = "parametre")

# Étape 3 : Affichage ggplot
ggplot(df_long %>% filter(!is.na(Polyglobulie_14.5_OMS2011)), aes(x = Polyglobulie_14.5_OMS2011, y = valeur, fill = Polyglobulie_14.5_OMS2011)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ parametre, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE,
    size = 4
  ) +
  labs(
    title = paste0("Comparison of iron parameters between polycythemic and non-polycythemic children (8-12 years old)\nfrom La Rinconada (5100m) according to polycythemia diagnosis (WHO 2011) (n=", n_global,")"),
    subtitle = "Method: t-test (polycythemic vs non-polycythemic)",
    x = "polycythemic?",
    y = "Variable value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

# Comparaison moyennes CRP + mcnemar
```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
# Sélection et nettoyage
df_clean <- df %>%
  mutate(Iron.deficiency = factor(Iron.deficiency, levels = c("non", "oui"), labels = c("no", "yes"))) %>%
  select(Iron.deficiency, CRP..mg.L.) %>%
  filter(!is.na(Iron.deficiency))
n_global = nrow(df_clean)
# Résumé
df_summary <- df_clean %>%
  group_by(Iron.deficiency) %>%
  summarise(moyenne = mean(CRP..mg.L., na.rm = TRUE), .groups = "drop")

# Test t
p_val <- t.test(CRP..mg.L. ~ Iron.deficiency, data = df_clean)$p.value
signif_label <- case_when(
  p_val < 0.001 ~ "***",
  p_val < 0.01 ~ "**",
  p_val < 0.05 ~ "*",
  TRUE         ~ "ns"
)

# Position du label
y_max <- max(df_clean$CRP..mg.L., na.rm = TRUE) * 1.05

# Graphique
ggplot(df_clean, aes(x = Iron.deficiency, y = CRP..mg.L., fill = Iron.deficiency)) +
  geom_boxplot(outliers = F) +
  geom_text(aes(x = 1.5, y = y_max, label = signif_label), inherit.aes = FALSE, size = 8) +
  labs(
    title = paste0("Comparison of CRP means of childrens (0-3 years old)\naccording to Ferritin deficiency (n=", n_global,")"),
    subtitle = "Method: t-test",
    x = "Iron deficiency?",
    y = "CRP (mg/L)"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

```
```{r}
# Lecture des données
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]

# Sélection et nettoyage
df_clean <- df %>%
  mutate(Iron.deficiency = factor(Iron.deficiency, levels = c("non", "oui"), labels = c("no", "yes"))) %>%
  select(Iron.deficiency, CRP..mg.L.) %>%
  filter(!is.na(Iron.deficiency))
n_global = nrow(df_clean)
# Résumé
df_summary <- df_clean %>%
  group_by(Iron.deficiency) %>%
  summarise(moyenne = mean(CRP..mg.L., na.rm = TRUE), .groups = "drop")

# Test t
p_val <- t.test(CRP..mg.L. ~ Iron.deficiency, data = df_clean)$p.value
signif_label <- case_when(
  p_val < 0.001 ~ "***",
  p_val < 0.01 ~ "**",
  p_val < 0.05 ~ "*",
  TRUE         ~ "ns"
)

# Position du label
y_max <- max(df_clean$CRP..mg.L., na.rm = TRUE) * 1.05

# Graphique
ggplot(df_clean, aes(x = Iron.deficiency, y = CRP..mg.L., fill = Iron.deficiency)) +
  geom_boxplot(outliers = F) +
  geom_text(aes(x = 1.5, y = y_max, label = signif_label), inherit.aes = FALSE, size = 8) +
  labs(
    title = paste0("Comparison of CRP mean of childrens (8-12 years old)\naccording to Ferritin deficiency (n=",n_global,")") ,
    subtitle = "Method: t-test",
    x = "Iron deficiency?",
    y = "CRP (mg/L)"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```



```{r}
df <- data.frame(
  #Zinc_baja = data$Zinc.mg.j.RNP..Baja.,
  #Zinc_moderata = data$Zinc.mg.j.RNP..Moderada.,
  #Zinc_alta = data$Zinc.mg.j.RNP..Alta.
  #Fer_baja = data$Fer.mg.j.RNP...Baja.,
  #Fer_moderata = data$Fer.mg.j.RNP..Moderada.,
  Fer_alta = data$Fer.mg.j.RNP..Alta.
)

library(dplyr)

proportions_categoriels <- lapply(df, function(x) {
  prop <- prop.table(table(x))
  round(prop, 3)
})

# Regrouper en un seul tableau
library(tidyr)
library(purrr)

# Conversion en data frame pour affichage clair
proportions_table <- map_dfr(names(proportions_categoriels), function(var) {
  data.frame(
    variable = var,
    modalité = names(proportions_categoriels[[var]]),
    proportion = as.numeric(proportions_categoriels[[var]])
  )
})

# Affichage final
print(proportions_table)
```

```{r}
# Installer les packages si besoin
# install.packages("flextable")
# install.packages("officer")

library(flextable)
library(dplyr)

# Optionnel : arrondir les valeurs
proportions_table <- proportions_table %>%
  mutate(proportion = round(proportion, 3))

# Créer le tableau flextable
ft <- flextable(proportions_table) %>%
  set_header_labels(
    variable = "Variable",
    modalité = "Modalité",
    proportion = "Proportion"
  ) %>%
  autofit() %>%
  theme_box() %>%
  align(align = "center", part = "all") %>%
  color(i = ~ proportion > 0.3, color = "darkred", part = "body") %>%
  bold(i = ~ proportion > 0.3, bold = TRUE, part = "body") %>%
  fontsize(size = 11, part = "all") %>%
  border_outer() %>%
  border_inner()

# Afficher dans la visionneuse RStudio
ft

```

```{r}
bin_vars = c("Iron.deficiency", "CRP.high..20", "CRP.high..5")

# WHO 2024 vs WHO2024.FER
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Iron.deficiency, CRP.high..20)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Iron.deficiency, data_clean$CRP.high..20)$p.value
methode = mcnemar_auto(data_clean$Iron.deficiency, data_clean$CRP.high..20)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions : Ferritin.low v.s. CRP.high..20\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Iron.deficiency, CRP.high..20) %>%
  group_by(CRP.high..20) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Iron.deficiency, y = CRP.high..20, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "Ferritin.low",
    y = "CRP.high..20",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
bin_vars = c("Iron.deficiency", "CRP.high..20", "CRP.high..5")

# WHO 2024 vs WHO2024.FER
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Iron.deficiency, CRP.high..5)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Iron.deficiency, data_clean$CRP.high..5)$p.value
methode = mcnemar_auto(data_clean$Iron.deficiency, data_clean$CRP.high..5)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (anemia) : Ferritin.low v.s. CRP.high..5\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Iron.deficiency, CRP.high..5) %>%
  group_by(CRP.high..5) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Iron.deficiency, y = CRP.high..5, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "Ferritin.low",
    y = "CRP.high..5",
    fill = "Proportion"
  ) +
  theme_minimal()
```
# Mcnemar & proportion croisées OMS v.s. Binaire fer
```{r}
bin_vars = c("Iron.deficiency", "CRP.high..20", "CRP.high..5", "Coef.Sat.Tf.bas", "Anemie_OMS2024_FER", "Anemie_OMS2011_FER")

# WHO 2024 vs WHO2024.FER
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Anemie_OMS2024_FER)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_OMS2024_FER)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_OMS2024_FER)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (anemia) : WHO2024 v.s. WHO2024.Ferritin.low\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, Anemie_OMS2024_FER) %>%
  group_by(Anemie_OMS2024_FER) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = Anemie_OMS2024_FER, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2024",
    y = "WHO2024.Ferritin.low",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
bin_vars = c("Iron.deficiency", "CRP.high..20", "CRP.high..5", "Coef.Sat.Tf.bas", "Anemie_OMS2024_FER", "Anemie_OMS2011_FER")

# WHO 2024 vs WHO2024.FER
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Iron.deficiency)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Iron.deficiency)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Iron.deficiency)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (anemia) : WHO2024 v.s. Ferritin.low\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, Iron.deficiency) %>%
  group_by(Iron.deficiency) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = Iron.deficiency, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2024",
    y = "Ferritin.low",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
bin_vars = c("Iron.deficiency", "CRP.high..20", "CRP.high..5", "Coef.Sat.Tf.bas", "Anemie_OMS2024_FER", "Anemie_OMS2011_FER")

# WHO 2024 vs WHO2024.FER
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, "CRP.high..20")

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$CRP.high..20)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$CRP.high..20)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (anemia) : WHO2024 v.s. CRP.high..20\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, CRP.high..20) %>%
  group_by(CRP.high..20) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = CRP.high..20, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2024",
    y = "CRP.high..20",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
bin_vars = c("Iron.deficiency", "CRP.high..20", "CRP.high..5", "Coef.Sat.Tf.bas", "Anemie_OMS2024_FER", "Anemie_OMS2011_FER")

# WHO 2024 vs WHO2024.FER
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, CRP.high..5)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$CRP.high..5)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$CRP.high..5)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (anemia) : WHO2024 v.s. CRP.high..5\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, CRP.high..5) %>%
  group_by(CRP.high..5) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = CRP.high..5, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2024",
    y = "CRP.high..5",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
bin_vars = c("Iron.deficiency", "CRP.high..20", "CRP.high..5", "Coef.Sat.Tf.bas", "Anemie_OMS2024_FER", "Anemie_OMS2011_FER")

# WHO 2024 vs WHO2024.FER
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Coef.Sat.Tf.bas)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Coef.Sat.Tf.bas)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Coef.Sat.Tf.bas)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (anemia) : WHO2024 v.s. Coef.Sat.Tf.bas\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, Coef.Sat.Tf.bas) %>%
  group_by(Coef.Sat.Tf.bas) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = Coef.Sat.Tf.bas, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2024",
    y = "Coef.Sat.Tf.bas",
    fill = "Proportion"
  ) +
  theme_minimal()
```
(PAS FINI)
```{r}
bin_vars = c("Iron.deficiency", "CRP.high..20", "CRP.high..5", "Coef.Sat.Tf.bas", "Anemie_OMS2024_FER", "Anemie_OMS2011_FER")

# WHO 2024 vs WHO2024.FER
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2011, Anemie_OMS2011_FER)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Anemie_OMS2011_FER)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Anemie_OMS2011_FER)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (anemia) : WHO2011 v.s. WHO2011.Ferritin.low\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2011, Anemie_OMS2011_FER) %>%
  group_by(Anemie_OMS2011_FER) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2011, y = Anemie_OMS2011_FER, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2011",
    y = "WHO2011.Ferritin.low",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
bin_vars = c("Iron.deficiency", "CRP.high..20", "CRP.high..5", "Coef.Sat.Tf.bas", "Anemie_OMS2024_FER", "Anemie_OMS2011_FER")

# WHO 2024 vs WHO2024.FER
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2011, Iron.deficiency)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Iron.deficiency)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Iron.deficiency)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (anemia) : WHO2011 v.s. Ferritin.low\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2011, Iron.deficiency) %>%
  group_by(Iron.deficiency) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2011, y = Iron.deficiency, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2011",
    y = "Ferritin.low",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
bin_vars = c("Iron.deficiency", "CRP.high..20", "CRP.high..5", "Coef.Sat.Tf.bas", "Anemie_OMS2024_FER", "Anemie_OMS2011_FER")

# WHO 2024 vs WHO2024.FER
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2011, CRP.high..20)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$CRP.high..20)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$CRP.high..20)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (anemia) : WHO2011 v.s. CRP.high..20\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2011, CRP.high..20) %>%
  group_by(CRP.high..20) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2011, y = CRP.high..20, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2011",
    y = "CRP.high..20",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
bin_vars = c("Iron.deficiency", "CRP.high..20", "CRP.high..5", "Coef.Sat.Tf.bas", "Anemie_OMS2024_FER", "Anemie_OMS2011_FER")

# WHO 2024 vs WHO2024.FER
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2011, CRP.high..5)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$CRP.high..5)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$CRP.high..5)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (anemia) : WHO2011 v.s. CRP.high..5\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2011, CRP.high..5) %>%
  group_by(CRP.high..5) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2011, y = CRP.high..5, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2011",
    y = "CRP.high..5",
    fill = "Proportion"
  ) +
  theme_minimal()
```
```{r}
bin_vars = c("Iron.deficiency", "CRP.high..20", "CRP.high..5", "Coef.Sat.Tf.bas", "Anemie_OMS2024_FER", "Anemie_OMS2011_FER")

# WHO 2024 vs WHO2024.FER
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2011, Coef.Sat.Tf.bas)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.exact(tbl)
    type <- "mcnemar exact test"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "mcnemar chi² test"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Coef.Sat.Tf.bas)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Coef.Sat.Tf.bas)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Crossed proportions (anemia) : WHO2011 v.s. Coef.Sat.Tf.bas\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2011, Coef.Sat.Tf.bas) %>%
  group_by(Coef.Sat.Tf.bas) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2011, y = Coef.Sat.Tf.bas, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = paste0(scales::percent(prop, accuracy = 1), "\n(n=", n, ")")), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "WHO2011",
    y = "Coef.Sat.Tf.bas",
    fill = "Proportion"
  ) +
  theme_minimal()
```

# Comparaison moyennes hepcidine (ERFE) - Ferritine / CRP / Coef sat


```{r}
# 0-3ans / Lima
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]

bin_vars <- c("Iron.deficiency", "CRP.high..20", "CRP.high..5", "Coef.Sat.Tf.bas", "Anemie_OMS2024_FER", "Anemie_OMS2011_FER")

df <- df %>%
  mutate(across(all_of(bin_vars), ~{
    x <- as.character(.x)
    x <- ifelse(tolower(x) %in% c("oui","yes","1","true","vrai"), "yes",
         ifelse(tolower(x) %in% c("non","no","0","false","faux"), "no", NA))
    factor(x, levels = c("no","yes"))
  }))

df0 <- df %>%
  mutate(ERFE = as.numeric(ERFE..ng.mL.))

# Harmoniser les modalités (oui/non → yes/no)

# Passer en format long
df_erfe_long <- df0 %>%
  select(ERFE, all_of(bin_vars)) %>%
  tidyr::pivot_longer(cols = all_of(bin_vars),
                      names_to = "var_bin",
                      values_to = "groupe") %>%
  filter(!is.na(ERFE), !is.na(groupe))

# p-values par variable (t-test, remplace par wilcox.test si nécessaire)
pvals <- df_erfe_long %>%
  group_by(var_bin) %>%
  summarise(
    p = tryCatch(t.test(ERFE ~ groupe)$p.value, error = function(e) NA_real_),
    .groups = "drop"
  ) %>%
  mutate(signif_label = case_when(
    p < 0.001 ~ "***",
    p < 0.01  ~ "**",
    p < 0.05  ~ "*",
    TRUE      ~ "ns"
  ))

# Position des labels
ypos <- df_erfe_long %>%
  group_by(var_bin) %>%
  summarise(y_max = max(ERFE, na.rm = TRUE) * 1.05, .groups = "drop")

labels_df <- left_join(pvals, ypos, by = "var_bin")

age_label  <- unique(df$Age_categorie_binaire)
ville_label <- unique(df$Ville_eval)
n_global = nrow(df0)
# Plot
ggplot(df_erfe_long, aes(x = groupe, y = ERFE, fill = groupe)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ var_bin, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE, size = 4
  ) +
  labs(
    title = paste0("ERFE selon différentes variables binaires chez les enfants de ", age_label, ", (n=", n_global,")"),
    subtitle = "Test: t-test (yes vs no)",
    x = NULL, y = "ERFE (ng/mL)"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none",
        strip.text = element_text(face = "bold"))
```

```{r}
# 0-3ans / Lima
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]

bin_vars <- c("Iron.deficiency", "CRP.high..20", "CRP.high..5", "Coef.Sat.Tf.bas", "Anemie_OMS2024_FER", "Anemie_OMS2011_FER")

df <- df %>%
  mutate(across(all_of(bin_vars), ~{
    x <- as.character(.x)
    x <- ifelse(tolower(x) %in% c("oui","yes","1","true","vrai"), "yes",
         ifelse(tolower(x) %in% c("non","no","0","false","faux"), "no", NA))
    factor(x, levels = c("no","yes"))
  }))

df0 <- df %>%
  mutate(ERFE = as.numeric(ERFE..ng.mL.))

# Harmoniser les modalités (oui/non → yes/no)

# Passer en format long
df_erfe_long <- df0 %>%
  select(ERFE, all_of(bin_vars)) %>%
  tidyr::pivot_longer(cols = all_of(bin_vars),
                      names_to = "var_bin",
                      values_to = "groupe") %>%
  filter(!is.na(ERFE), !is.na(groupe))

# p-values par variable (t-test, remplace par wilcox.test si nécessaire)
pvals <- df_erfe_long %>%
  group_by(var_bin) %>%
  summarise(
    p = tryCatch(t.test(ERFE ~ groupe)$p.value, error = function(e) NA_real_),
    .groups = "drop"
  ) %>%
  mutate(signif_label = case_when(
    p < 0.001 ~ "***",
    p < 0.01  ~ "**",
    p < 0.05  ~ "*",
    TRUE      ~ "ns"
  ))

# Position des labels
ypos <- df_erfe_long %>%
  group_by(var_bin) %>%
  summarise(y_max = max(ERFE, na.rm = TRUE) * 1.05, .groups = "drop")

labels_df <- left_join(pvals, ypos, by = "var_bin")

age_label  <- unique(df$Age_categorie_binaire)
ville_label <- unique(df$Ville_eval)
n_global = nrow(df0)
# Plot
ggplot(df_erfe_long, aes(x = groupe, y = ERFE, fill = groupe)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ var_bin, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE, size = 4
  ) +
  labs(
    title = paste0("ERFE selon différentes variables binaires chez les enfants de ", age_label, ", (n=", n_global,")"),
    subtitle = "Test: t-test (yes vs no)",
    x = NULL, y = "ERFE (ng/mL)"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none",
        strip.text = element_text(face = "bold"))
```



```{r}
# 0-3ans / Lima
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
df = df[df$Ville_eval == "Lima (150m)",]

bin_vars <- c("Iron.deficiency", "CRP.high..20", "CRP.high..5", "Coef.Sat.Tf.bas", "Anemie_OMS2024_FER", "Anemie_OMS2011_FER")

df <- df %>%
  mutate(across(all_of(bin_vars), ~{
    x <- as.character(.x)
    x <- ifelse(tolower(x) %in% c("oui","yes","1","true","vrai"), "yes",
         ifelse(tolower(x) %in% c("non","no","0","false","faux"), "no", NA))
    factor(x, levels = c("no","yes"))
  }))

df0 <- df %>%
  mutate(ERFE = as.numeric(ERFE..ng.mL.))

# Harmoniser les modalités (oui/non → yes/no)

# Passer en format long
df_erfe_long <- df0 %>%
  select(ERFE, all_of(bin_vars)) %>%
  tidyr::pivot_longer(cols = all_of(bin_vars),
                      names_to = "var_bin",
                      values_to = "groupe") %>%
  filter(!is.na(ERFE), !is.na(groupe))

# p-values par variable (t-test, remplace par wilcox.test si nécessaire)
pvals <- df_erfe_long %>%
  group_by(var_bin) %>%
  summarise(
    p = tryCatch(t.test(ERFE ~ groupe)$p.value, error = function(e) NA_real_),
    .groups = "drop"
  ) %>%
  mutate(signif_label = case_when(
    p < 0.001 ~ "***",
    p < 0.01  ~ "**",
    p < 0.05  ~ "*",
    TRUE      ~ "ns"
  ))

# Position des labels
ypos <- df_erfe_long %>%
  group_by(var_bin) %>%
  summarise(y_max = max(ERFE, na.rm = TRUE) * 1.05, .groups = "drop")

labels_df <- left_join(pvals, ypos, by = "var_bin")

age_label  <- unique(df$Age_categorie_binaire)
ville_label <- unique(df$Ville_eval)
n_global = nrow(df0)
# Plot
ggplot(df_erfe_long, aes(x = groupe, y = ERFE, fill = groupe)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ var_bin, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE, size = 4
  ) +
  labs(
    title = paste0("ERFE selon différentes variables binaires\n enfants ", age_label, ", ", ville_label, " (n=", n_global,")"),
    subtitle = "Test: t-test (yes vs no)",
    x = NULL, y = "ERFE (ng/mL)"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none",
        strip.text = element_text(face = "bold"))
```
```{r}
# 0-3ans / Cusco
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
df = df[df$Ville_eval == "Cusco (3400m)",]

bin_vars <- c("Iron.deficiency", "CRP.high..20", "CRP.high..5", "Coef.Sat.Tf.bas", "Anemie_OMS2024_FER", "Anemie_OMS2011_FER")

df <- df %>%
  mutate(across(all_of(bin_vars), ~{
    x <- as.character(.x)
    x <- ifelse(tolower(x) %in% c("oui","yes","1","true","vrai"), "yes",
         ifelse(tolower(x) %in% c("non","no","0","false","faux"), "no", NA))
    factor(x, levels = c("no","yes"))
  }))

df0 <- df %>%
  mutate(ERFE = as.numeric(ERFE..ng.mL.))

# Harmoniser les modalités (oui/non → yes/no)

# Passer en format long
df_erfe_long <- df0 %>%
  select(ERFE, all_of(bin_vars)) %>%
  tidyr::pivot_longer(cols = all_of(bin_vars),
                      names_to = "var_bin",
                      values_to = "groupe") %>%
  filter(!is.na(ERFE), !is.na(groupe))

# p-values par variable (t-test, remplace par wilcox.test si nécessaire)
pvals <- df_erfe_long %>%
  group_by(var_bin) %>%
  summarise(
    p = tryCatch(t.test(ERFE ~ groupe)$p.value, error = function(e) NA_real_),
    .groups = "drop"
  ) %>%
  mutate(signif_label = case_when(
    p < 0.001 ~ "***",
    p < 0.01  ~ "**",
    p < 0.05  ~ "*",
    TRUE      ~ "ns"
  ))

# Position des labels
ypos <- df_erfe_long %>%
  group_by(var_bin) %>%
  summarise(y_max = max(ERFE, na.rm = TRUE) * 1.05, .groups = "drop")

labels_df <- left_join(pvals, ypos, by = "var_bin")

age_label  <- unique(df$Age_categorie_binaire)
ville_label <- unique(df$Ville_eval)
n_global = nrow(df0)
# Plot
ggplot(df_erfe_long, aes(x = groupe, y = ERFE, fill = groupe)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ var_bin, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE, size = 4
  ) +
  labs(
    title =  paste0("ERFE selon différentes variables binaires\n enfants ", age_label, ", ", ville_label, " (n=", n_global,")"),
    subtitle = "Test: t-test (yes vs no)",
    x = NULL, y = "ERFE (ng/mL)"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none",
        strip.text = element_text(face = "bold"))
```
```{r}
# 0-3ans / Juliaca
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
df = df[df$Ville_eval == "Juliaca (3800m)",]

bin_vars <- c("Iron.deficiency", "CRP.high..20", "CRP.high..5", "Coef.Sat.Tf.bas", "Anemie_OMS2024_FER", "Anemie_OMS2011_FER")

df <- df %>%
  mutate(across(all_of(bin_vars), ~{
    x <- as.character(.x)
    x <- ifelse(tolower(x) %in% c("oui","yes","1","true","vrai"), "yes",
         ifelse(tolower(x) %in% c("non","no","0","false","faux"), "no", NA))
    factor(x, levels = c("no","yes"))
  }))

df0 <- df %>%
  mutate(ERFE = as.numeric(ERFE..ng.mL.))

# Harmoniser les modalités (oui/non → yes/no)

# Passer en format long
df_erfe_long <- df0 %>%
  select(ERFE, all_of(bin_vars)) %>%
  tidyr::pivot_longer(cols = all_of(bin_vars),
                      names_to = "var_bin",
                      values_to = "groupe") %>%
  filter(!is.na(ERFE), !is.na(groupe))

# p-values par variable (t-test, remplace par wilcox.test si nécessaire)
pvals <- df_erfe_long %>%
  group_by(var_bin) %>%
  summarise(
    p = tryCatch(t.test(ERFE ~ groupe)$p.value, error = function(e) NA_real_),
    .groups = "drop"
  ) %>%
  mutate(signif_label = case_when(
    p < 0.001 ~ "***",
    p < 0.01  ~ "**",
    p < 0.05  ~ "*",
    TRUE      ~ "ns"
  ))

# Position des labels
ypos <- df_erfe_long %>%
  group_by(var_bin) %>%
  summarise(y_max = max(ERFE, na.rm = TRUE) * 1.05, .groups = "drop")

labels_df <- left_join(pvals, ypos, by = "var_bin")

age_label  <- unique(df$Age_categorie_binaire)
ville_label <- unique(df$Ville_eval)
n_global = nrow(df0)
# Plot
ggplot(df_erfe_long, aes(x = groupe, y = ERFE, fill = groupe)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ var_bin, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE, size = 4
  ) +
  labs(
    title =  paste0("ERFE selon différentes variables binaires\n enfants ", age_label, ", ", ville_label, " (n=", n_global,")"),
    subtitle = "Test: t-test (yes vs no)",
    x = NULL, y = "ERFE (ng/mL)"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none",
        strip.text = element_text(face = "bold"))
```
```{r}
# 0-3ans / La Rinconada
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "0-3 ans",]
df = df[df$Ville_eval == "La Rinconada (5100m)",]

bin_vars <- c("Iron.deficiency", "CRP.high..20", "CRP.high..5", "Coef.Sat.Tf.bas", "Anemie_OMS2024_FER", "Anemie_OMS2011_FER")

df <- df %>%
  mutate(across(all_of(bin_vars), ~{
    x <- as.character(.x)
    x <- ifelse(tolower(x) %in% c("oui","yes","1","true","vrai"), "yes",
         ifelse(tolower(x) %in% c("non","no","0","false","faux"), "no", NA))
    factor(x, levels = c("no","yes"))
  }))

df0 <- df %>%
  mutate(ERFE = as.numeric(ERFE..ng.mL.))

# Harmoniser les modalités (oui/non → yes/no)

# Passer en format long
df_erfe_long <- df0 %>%
  select(ERFE, all_of(bin_vars)) %>%
  tidyr::pivot_longer(cols = all_of(bin_vars),
                      names_to = "var_bin",
                      values_to = "groupe") %>%
  filter(!is.na(ERFE), !is.na(groupe))

# p-values par variable (t-test, remplace par wilcox.test si nécessaire)
pvals <- df_erfe_long %>%
  group_by(var_bin) %>%
  summarise(
    p = tryCatch(t.test(ERFE ~ groupe)$p.value, error = function(e) NA_real_),
    .groups = "drop"
  ) %>%
  mutate(signif_label = case_when(
    p < 0.001 ~ "***",
    p < 0.01  ~ "**",
    p < 0.05  ~ "*",
    TRUE      ~ "ns"
  ))

# Position des labels
ypos <- df_erfe_long %>%
  group_by(var_bin) %>%
  summarise(y_max = max(ERFE, na.rm = TRUE) * 1.05, .groups = "drop")

labels_df <- left_join(pvals, ypos, by = "var_bin")

age_label  <- unique(df$Age_categorie_binaire)
ville_label <- unique(df$Ville_eval)
n_global = nrow(df0)
# Plot
ggplot(df_erfe_long, aes(x = groupe, y = ERFE, fill = groupe)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ var_bin, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE, size = 4
  ) +
  labs(
    title =  paste0("ERFE selon différentes variables binaires\n enfants ", age_label, ", ", ville_label, " (n=", n_global,")"),
    subtitle = "Test: t-test (yes vs no)",
    x = NULL, y = "ERFE (ng/mL)"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none",
        strip.text = element_text(face = "bold"))
```

```{r}
# 8-12ans / Lima
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]
df = df[df$Ville_eval == "Lima (150m)",]

bin_vars <- c("Iron.deficiency", "CRP.high..20", "CRP.high..5", "Coef.Sat.Tf.bas", "Anemie_OMS2024_FER", "Anemie_OMS2011_FER")

df <- df %>%
  mutate(across(all_of(bin_vars), ~{
    x <- as.character(.x)
    x <- ifelse(tolower(x) %in% c("oui","yes","1","true","vrai"), "yes",
         ifelse(tolower(x) %in% c("non","no","0","false","faux"), "no", NA))
    factor(x, levels = c("no","yes"))
  }))

df0 <- df %>%
  mutate(ERFE = as.numeric(ERFE..ng.mL.))

# Harmoniser les modalités (oui/non → yes/no)

# Passer en format long
df_erfe_long <- df0 %>%
  select(ERFE, all_of(bin_vars)) %>%
  tidyr::pivot_longer(cols = all_of(bin_vars),
                      names_to = "var_bin",
                      values_to = "groupe") %>%
  filter(!is.na(ERFE), !is.na(groupe))

# p-values par variable (t-test, remplace par wilcox.test si nécessaire)
pvals <- df_erfe_long %>%
  group_by(var_bin) %>%
  summarise(
    p = tryCatch(t.test(ERFE ~ groupe)$p.value, error = function(e) NA_real_),
    .groups = "drop"
  ) %>%
  mutate(signif_label = case_when(
    p < 0.001 ~ "***",
    p < 0.01  ~ "**",
    p < 0.05  ~ "*",
    TRUE      ~ "ns"
  ))

# Position des labels
ypos <- df_erfe_long %>%
  group_by(var_bin) %>%
  summarise(y_max = max(ERFE, na.rm = TRUE) * 1.05, .groups = "drop")

labels_df <- left_join(pvals, ypos, by = "var_bin")

age_label  <- unique(df$Age_categorie_binaire)
ville_label <- unique(df$Ville_eval)
n_global = nrow(df0)
# Plot
ggplot(df_erfe_long, aes(x = groupe, y = ERFE, fill = groupe)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ var_bin, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE, size = 4
  ) +
  labs(
    title =  paste0("ERFE selon différentes variables binaires\n enfants ", age_label, ", ", ville_label, " (n=", n_global,")"),
    subtitle = "Test: t-test (yes vs no)",
    x = NULL, y = "ERFE (ng/mL)"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none",
        strip.text = element_text(face = "bold"))
```
```{r}
# 8-12ans / Cusco
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]
df = df[df$Ville_eval == "Cusco (3400m)",]

bin_vars <- c("Iron.deficiency", "CRP.high..20", "CRP.high..5", "Coef.Sat.Tf.bas", "Anemie_OMS2024_FER", "Anemie_OMS2011_FER")

df <- df %>%
  mutate(across(all_of(bin_vars), ~{
    x <- as.character(.x)
    x <- ifelse(tolower(x) %in% c("oui","yes","1","true","vrai"), "yes",
         ifelse(tolower(x) %in% c("non","no","0","false","faux"), "no", NA))
    factor(x, levels = c("no","yes"))
  }))

df0 <- df %>%
  mutate(ERFE = as.numeric(ERFE..ng.mL.))

# Harmoniser les modalités (oui/non → yes/no)

# Passer en format long
df_erfe_long <- df0 %>%
  select(ERFE, all_of(bin_vars)) %>%
  tidyr::pivot_longer(cols = all_of(bin_vars),
                      names_to = "var_bin",
                      values_to = "groupe") %>%
  filter(!is.na(ERFE), !is.na(groupe))

# p-values par variable (t-test, remplace par wilcox.test si nécessaire)
pvals <- df_erfe_long %>%
  group_by(var_bin) %>%
  summarise(
    p = tryCatch(t.test(ERFE ~ groupe)$p.value, error = function(e) NA_real_),
    .groups = "drop"
  ) %>%
  mutate(signif_label = case_when(
    p < 0.001 ~ "***",
    p < 0.01  ~ "**",
    p < 0.05  ~ "*",
    TRUE      ~ "ns"
  ))

# Position des labels
ypos <- df_erfe_long %>%
  group_by(var_bin) %>%
  summarise(y_max = max(ERFE, na.rm = TRUE) * 1.05, .groups = "drop")

labels_df <- left_join(pvals, ypos, by = "var_bin")

age_label  <- unique(df$Age_categorie_binaire)
ville_label <- unique(df$Ville_eval)
n_global = nrow(df0)
# Plot
ggplot(df_erfe_long, aes(x = groupe, y = ERFE, fill = groupe)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ var_bin, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE, size = 4
  ) +
  labs(
    title =  paste0("ERFE selon différentes variables binaires\n enfants ", age_label, ", ", ville_label, " (n=", n_global,")"),
    subtitle = "Test: t-test (yes vs no)",
    x = NULL, y = "ERFE (ng/mL)"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none",
        strip.text = element_text(face = "bold"))
```
```{r}
# 8-12ans / Juliaca
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]
df = df[df$Ville_eval == "Juliaca (3800m)",]

bin_vars <- c("Iron.deficiency", "CRP.high..20", "CRP.high..5", "Coef.Sat.Tf.bas", "Anemie_OMS2024_FER", "Anemie_OMS2011_FER")

df <- df %>%
  mutate(across(all_of(bin_vars), ~{
    x <- as.character(.x)
    x <- ifelse(tolower(x) %in% c("oui","yes","1","true","vrai"), "yes",
         ifelse(tolower(x) %in% c("non","no","0","false","faux"), "no", NA))
    factor(x, levels = c("no","yes"))
  }))

df0 <- df %>%
  mutate(ERFE = as.numeric(ERFE..ng.mL.))

# Harmoniser les modalités (oui/non → yes/no)

# Passer en format long
df_erfe_long <- df0 %>%
  select(ERFE, all_of(bin_vars)) %>%
  tidyr::pivot_longer(cols = all_of(bin_vars),
                      names_to = "var_bin",
                      values_to = "groupe") %>%
  filter(!is.na(ERFE), !is.na(groupe))

# p-values par variable (t-test, remplace par wilcox.test si nécessaire)
pvals <- df_erfe_long %>%
  group_by(var_bin) %>%
  summarise(
    p = tryCatch(t.test(ERFE ~ groupe)$p.value, error = function(e) NA_real_),
    .groups = "drop"
  ) %>%
  mutate(signif_label = case_when(
    p < 0.001 ~ "***",
    p < 0.01  ~ "**",
    p < 0.05  ~ "*",
    TRUE      ~ "ns"
  ))

# Position des labels
ypos <- df_erfe_long %>%
  group_by(var_bin) %>%
  summarise(y_max = max(ERFE, na.rm = TRUE) * 1.05, .groups = "drop")

labels_df <- left_join(pvals, ypos, by = "var_bin")

age_label  <- unique(df$Age_categorie_binaire)
ville_label <- unique(df$Ville_eval)
n_global = nrow(df0)
# Plot
ggplot(df_erfe_long, aes(x = groupe, y = ERFE, fill = groupe)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ var_bin, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE, size = 4
  ) +
  labs(
    title =  paste0("ERFE selon différentes variables binaires\n enfants ", age_label, ", ", ville_label, " (n=", n_global,")"),
    subtitle = "Test: t-test (yes vs no)",
    x = NULL, y = "ERFE (ng/mL)"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none",
        strip.text = element_text(face = "bold"))
```
```{r}
# 8-12ans / La Rinconada
df <- read.csv("datafinalfinal.csv")
df = df[df$Age_categorie_binaire == "8-12 ans",]
df = df[df$Ville_eval == "La Rinconada (5100m)",]

bin_vars <- c("Iron.deficiency", "CRP.high..20", "CRP.high..5", "Coef.Sat.Tf.bas", "Anemie_OMS2024_FER", "Anemie_OMS2011_FER")

df <- df %>%
  mutate(across(all_of(bin_vars), ~{
    x <- as.character(.x)
    x <- ifelse(tolower(x) %in% c("oui","yes","1","true","vrai"), "yes",
         ifelse(tolower(x) %in% c("non","no","0","false","faux"), "no", NA))
    factor(x, levels = c("no","yes"))
  }))

df0 <- df %>%
  mutate(ERFE = as.numeric(ERFE..ng.mL.))

# Harmoniser les modalités (oui/non → yes/no)

# Passer en format long
df_erfe_long <- df0 %>%
  select(ERFE, all_of(bin_vars)) %>%
  tidyr::pivot_longer(cols = all_of(bin_vars),
                      names_to = "var_bin",
                      values_to = "groupe") %>%
  filter(!is.na(ERFE), !is.na(groupe))

# p-values par variable (t-test, remplace par wilcox.test si nécessaire)
pvals <- df_erfe_long %>%
  group_by(var_bin) %>%
  summarise(
    p = tryCatch(t.test(ERFE ~ groupe)$p.value, error = function(e) NA_real_),
    .groups = "drop"
  ) %>%
  mutate(signif_label = case_when(
    p < 0.001 ~ "***",
    p < 0.01  ~ "**",
    p < 0.05  ~ "*",
    TRUE      ~ "ns"
  ))

# Position des labels
ypos <- df_erfe_long %>%
  group_by(var_bin) %>%
  summarise(y_max = max(ERFE, na.rm = TRUE) * 1.05, .groups = "drop")

labels_df <- left_join(pvals, ypos, by = "var_bin")

age_label  <- unique(df$Age_categorie_binaire)
ville_label <- unique(df$Ville_eval)
n_global = nrow(df0)
# Plot
ggplot(df_erfe_long, aes(x = groupe, y = ERFE, fill = groupe)) +
  geom_boxplot(outliers = F) +
  facet_wrap(~ var_bin, scales = "free_y") +
  geom_text(
    data = labels_df,
    aes(x = 1.5, y = y_max, label = signif_label),
    inherit.aes = FALSE, size = 4
  ) +
  labs(
    title = paste0("ERFE selon différentes variables binaires\n enfants ", age_label, ", ", ville_label, " (n=", n_global,")"),
    subtitle = "Test: t-test (yes vs no)",
    x = NULL, y = "ERFE (ng/mL)"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none",
        strip.text = element_text(face = "bold"))
```




# HB/HCT vs Hbmass/PV/Hbmass(g)
## Modèles linéaires simples
```{r}
# HB


data = read.csv("datafinalfinal.csv")

data <- data %>%
  filter(!is.na(Ville_eval))

data$ERFE..ng.mL. = as.numeric(data$ERFE..ng.mL.)
data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod_CRP = lm(HB ~ Hb.mass..g., data = df),
      mod_FER = lm(HB ~ Hb.mass.kg..g...kg., data = df),
      mod_FERRITINE = lm(HB ~ PV.ml., data = df),
      mod_TRANSFERINE = lm(HB ~ PV..kg..ml.kg., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

# Modèles toutes villes confondues
models_all <- list(
  mod_CRP = lm(HB ~ Hb.mass..g., data = data),
  mod_FER = lm(HB ~ Hb.mass.kg..g...kg., data = data),
  mod_FERRITINE = lm(HB ~ PV.ml., data = data),
  mod_TRANSFERINE = lm(HB ~ PV..kg..ml.kg., data = data),
  Ville_eval = "All cities"
)

# Ajouter à la liste
models_by_altitude <- append(models_by_altitude, list(models_all))

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  bind_rows(
    tidy(mods$mod_CRP, conf.int = TRUE) %>% mutate(var_dep = "Hb.mass..g.", r2 = summary(mods$mod_CRP)$r.squared),
    tidy(mods$mod_FER, conf.int = TRUE) %>% mutate(var_dep = "Hb.mass.kg..g...kg.", r2 = summary(mods$mod_FER)$r.squared),
    tidy(mods$mod_FERRITINE, conf.int = TRUE) %>% mutate(var_dep = "PV.ml.", r2 = summary(mods$mod_FERRITINE)$r.squared),
    tidy(mods$mod_TRANSFERINE, conf.int = TRUE) %>% mutate(var_dep = "PV..kg..ml.kg.", r2 = summary(mods$mod_TRANSFERINE)$r.squared)
  ) %>% mutate(Ville_eval = altitude)
})

coef_data$Ville_eval <- factor(coef_data$Ville_eval,
  levels = c("All cities", "Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)")
)
coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_table_stars <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(
    stars = case_when(
      p.value <= 0.001 ~ "***",
      p.value <= 0.01 ~ "**",
      p.value <= 0.05 ~ "*",
      TRUE ~ ""
    ),
    fill_color = case_when(
      (p.value <= 0.05 & estimate > 0) ~ "positif",
      (p.value <= 0.05 & estimate < 0) ~ "négatif",
      TRUE ~ "neutre"
    ),
    label = paste0(stars, "\nR²=", sprintf("%.2f", r2))
  ) %>%
  select(Ville_eval, var_dep, label, fill_color)


ggplot(coef_table_stars, aes(x = Ville_eval, y = var_dep, fill = fill_color)) +
  geom_tile(color = "white") +
  geom_text(aes(label = label), size = 4) +
  scale_fill_manual(
    values = c("positif" = "#1b9e77", "négatif" = "red2", "neutre" = "#e0e0e0"),
    guide = FALSE
  ) +
  labs(
    title = "Simple linear models : [Hb] ~ Blood indicators for each city (all childrens)",
    x = "City",
    y = "Explanatory variable"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 20, hjust = 1),
    panel.grid = element_blank()
  )
```
```{r}
# HB


data = read.csv("datafinalfinal.csv")

data <- data %>%
  filter(!is.na(Ville_eval))

data$ERFE..ng.mL. = as.numeric(data$ERFE..ng.mL.)
data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod_CRP = lm(HB ~ Hb.mass..g., data = df),
      mod_FER = lm(HB ~ Hb.mass.kg..g...kg., data = df),
      mod_FERRITINE = lm(HB ~ PV.ml., data = df),
      mod_TRANSFERINE = lm(HB ~ PV..kg..ml.kg., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

# Modèles toutes villes confondues
models_all <- list(
  mod_CRP = lm(HB ~ Hb.mass..g., data = data),
  mod_FER = lm(HB ~ Hb.mass.kg..g...kg., data = data),
  mod_FERRITINE = lm(HB ~ PV.ml., data = data),
  mod_TRANSFERINE = lm(HB ~ PV..kg..ml.kg., data = data),
  Ville_eval = "All cities"
)

# Ajouter à la liste
models_by_altitude <- append(models_by_altitude, list(models_all))

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  bind_rows(
    tidy(mods$mod_CRP, conf.int = TRUE) %>% mutate(var_dep = "Hb.mass..g.", r2 = summary(mods$mod_CRP)$r.squared),
    tidy(mods$mod_FER, conf.int = TRUE) %>% mutate(var_dep = "Hb.mass.kg..g...kg.", r2 = summary(mods$mod_FER)$r.squared),
    tidy(mods$mod_FERRITINE, conf.int = TRUE) %>% mutate(var_dep = "PV.ml.", r2 = summary(mods$mod_FERRITINE)$r.squared),
    tidy(mods$mod_TRANSFERINE, conf.int = TRUE) %>% mutate(var_dep = "PV..kg..ml.kg.", r2 = summary(mods$mod_TRANSFERINE)$r.squared)
  ) %>% mutate(Ville_eval = altitude)
})

coef_data$Ville_eval <- factor(coef_data$Ville_eval,
  levels = c("All cities", "Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)")
)
coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_table_stars <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(
    stars = case_when(
      p.value <= 0.001 ~ "***",
      p.value <= 0.01 ~ "**",
      p.value <= 0.05 ~ "*",
      TRUE ~ ""
    ),
    fill_color = case_when(
      (p.value <= 0.05 & estimate > 0) ~ "positif",
      (p.value <= 0.05 & estimate < 0) ~ "négatif",
      TRUE ~ "neutre"
    ),
    label = paste0(stars, "\nR²=", sprintf("%.2f", r2))
  ) %>%
  select(Ville_eval, var_dep, label, fill_color)


ggplot(coef_table_stars, aes(x = Ville_eval, y = var_dep, fill = fill_color)) +
  geom_tile(color = "white") +
  geom_text(aes(label = label), size = 4) +
  scale_fill_manual(
    values = c("positif" = "#1b9e77", "négatif" = "red2", "neutre" = "#e0e0e0"),
    guide = FALSE
  ) +
  labs(
    title = "Simple linear models : [Hb] ~ Blood indicators for each city (8-12 years old childrens)",
    x = "City",
    y = "Explanatory variable"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 20, hjust = 1),
    panel.grid = element_blank()
  )
```
```{r}
# HB


data = read.csv("datafinalfinal.csv")

data <- data %>%
  filter(!is.na(Ville_eval))

data$ERFE..ng.mL. = as.numeric(data$ERFE..ng.mL.)
data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod_CRP = lm(HCT.. ~ Hb.mass..g., data = df),
      mod_FER = lm(HCT.. ~ Hb.mass.kg..g...kg., data = df),
      mod_FERRITINE = lm(HCT.. ~ PV.ml., data = df),
      mod_TRANSFERINE = lm(HCT.. ~ PV..kg..ml.kg., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

# Modèles toutes villes confondues
models_all <- list(
  mod_CRP = lm(HCT.. ~ Hb.mass..g., data = data),
  mod_FER = lm(HCT.. ~ Hb.mass.kg..g...kg., data = data),
  mod_FERRITINE = lm(HCT.. ~ PV.ml., data = data),
  mod_TRANSFERINE = lm(HCT.. ~ PV..kg..ml.kg., data = data),
  Ville_eval = "All cities"
)

# Ajouter à la liste
models_by_altitude <- append(models_by_altitude, list(models_all))

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  bind_rows(
    tidy(mods$mod_CRP, conf.int = TRUE) %>% mutate(var_dep = "Hb.mass..g.", r2 = summary(mods$mod_CRP)$r.squared),
    tidy(mods$mod_FER, conf.int = TRUE) %>% mutate(var_dep = "Hb.mass.kg..g...kg.", r2 = summary(mods$mod_FER)$r.squared),
    tidy(mods$mod_FERRITINE, conf.int = TRUE) %>% mutate(var_dep = "PV.ml.", r2 = summary(mods$mod_FERRITINE)$r.squared),
    tidy(mods$mod_TRANSFERINE, conf.int = TRUE) %>% mutate(var_dep = "PV..kg..ml.kg.", r2 = summary(mods$mod_TRANSFERINE)$r.squared)
  ) %>% mutate(Ville_eval = altitude)
})

coef_data$Ville_eval <- factor(coef_data$Ville_eval,
  levels = c("All cities", "Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)")
)
coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_table_stars <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(
    stars = case_when(
      p.value <= 0.001 ~ "***",
      p.value <= 0.01 ~ "**",
      p.value <= 0.05 ~ "*",
      TRUE ~ ""
    ),
    fill_color = case_when(
      (p.value <= 0.05 & estimate > 0) ~ "positif",
      (p.value <= 0.05 & estimate < 0) ~ "négatif",
      TRUE ~ "neutre"
    ),
    label = paste0(stars, "\nR²=", sprintf("%.2f", r2))
  ) %>%
  select(Ville_eval, var_dep, label, fill_color)


ggplot(coef_table_stars, aes(x = Ville_eval, y = var_dep, fill = fill_color)) +
  geom_tile(color = "white") +
  geom_text(aes(label = label), size = 4) +
  scale_fill_manual(
    values = c("positif" = "#1b9e77", "négatif" = "red2", "neutre" = "#e0e0e0"),
    guide = FALSE
  ) +
  labs(
    title = "Simple linear models : [HCT] ~ Blood indicators for each city (8-12 years old childrens)",
    x = "City",
    y = "Explanatory variable"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 20, hjust = 1),
    panel.grid = element_blank()
  )
```
## Tests de rank
```{r}
data <- read.csv("data/datafinal.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Altitude est un facteur ou une variable catégorielle
data$Altitude[data$Altitude == "150m"] <- "Lima (150m)"
data$Altitude[data$Altitude == "3400m"] <- "Cusco (3400m)"
data$Altitude[data$Altitude == "3800m"] <- "Juliaca (3800m)"
data$Altitude[data$Altitude == "5100m_5300m"] <- "La Rinconada (5100m)"

data$Altitude <- factor(data$Altitude, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

data$Rang_HB <- rank(data$HB)
data$Rang_HBMASS <- rank(data$Hb.mass.kg..g...kg.)


pvals_df <- data %>%
  group_by(Altitude) %>%
  summarise(
    p_value = wilcox.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired wilcoxon = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Altitude)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HB vs HBMASS (g/kg)) and paired Wilcoxon test \n for each city in 8-12 years old", x = "Rank HBMASS (g/kg)", y = "Rank HB", color = "City") +
  facet_wrap(~ Altitude)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```

```{r}
data$Rang_HB <- rank(data$HB)
data$Rang_HBMASS <- rank(data$Hb.mass..g.)


pvals_df <- data %>%
  group_by(Altitude) %>%
  summarise(
    p_value = wilcox.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired wilcoxon = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Altitude)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HB vs HBMASS (g)) and paired Wilcoxon test \n for each city in 8-12 years old", x = "Rank HBMASS (g)", y = "Rank HB", color = "City") +
  facet_wrap(~ Altitude)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```

```{r}
data$Rang_HB <- rank(data$HB)
data$Rang_HBMASS <- rank(data$RBCV..ml.)


pvals_df <- data %>%
  group_by(Altitude) %>%
  summarise(
    p_value = wilcox.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired wilcoxon = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Altitude)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HB vs RBCV (ml)) and paired Wilcoxon test \n for each city in 8-12 years old", x = "Rank RBCV (ml)", y = "Rank HB", color = "City") +
  facet_wrap(~ Altitude)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```

```{r}
data$Rang_HB <- rank(data$HB)
data$Rang_HBMASS <- rank(data$MCV..fL.)


pvals_df <- data %>%
  group_by(Altitude) %>%
  summarise(
    p_value = wilcox.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired wilcoxon = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Altitude)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HB vs MCV (fL)) and paired Wilcoxon test \n for each city in 8-12 years old", x = "Rank MCV (fL)", y = "Rank HB", color = "City") +
  facet_wrap(~ Altitude)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```

```{r}
data$Rang_HB <- rank(data$HCT..)
data$Rang_HBMASS <- rank(data$Hb.mass.kg..g...kg.)


pvals_df <- data %>%
  group_by(Altitude) %>%
  summarise(
    p_value = wilcox.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired wilcoxon = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Altitude)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HCT vs HBMASS (g/kg)) and paired Wilcoxon test \n for each city in 8-12 years old", x = "Rank HBMASS (g/kg)", y = "Rank HCT", color = "City") +
  facet_wrap(~ Altitude)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```

```{r}
data$Rang_HB <- rank(data$HCT..)
data$Rang_HBMASS <- rank(data$Hb.mass..g.)


pvals_df <- data %>%
  group_by(Altitude) %>%
  summarise(
    p_value = wilcox.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired wilcoxon = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Altitude)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HCT vs HBMASS (g) and paired Wilcoxon test \n for each city in 8-12 years old", x = "Rank HBMASS (g)", y = "Rank HCT", color = "City") +
  facet_wrap(~ Altitude)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```

```{r}
data$Rang_HB <- rank(data$HCT..)
data$Rang_HBMASS <- rank(data$RBCV..ml.)


pvals_df <- data %>%
  group_by(Altitude) %>%
  summarise(
    p_value = wilcox.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired wilcoxon = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Altitude)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HCT vs RBCV (ml) and paired Wilcoxon test \n for each city in 8-12 years old", x = "Rank RBCV (ml)", y = "Rank HCT", color = "City") +
  facet_wrap(~ Altitude)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```

```{r}
data$Rang_HB <- rank(data$HCT..)
data$Rang_HBMASS <- rank(data$MCV..fL.)


pvals_df <- data %>%
  group_by(Altitude) %>%
  summarise(
    p_value = wilcox.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired wilcoxon = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Altitude)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HCT vs MCV (fL)) and paired Wilcoxon test \n for each city in 8-12 years old", x = "Rank MCV (fL)", y = "Rank HCT", color = "City") +
  facet_wrap(~ Altitude)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```
