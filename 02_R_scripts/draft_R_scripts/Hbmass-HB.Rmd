---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r}
library(dplyr)
library(tidyr)
library(modelsummary)
library(glue)
library(gt)
library(car)
library(dunn.test)
library(rcompanion)
library(rstatix)
library(purrr)
library(ggplot2)
library(patchwork)
library(psych)
library(performance)
library(lmtest)
library(readxl)
library(openxlsx)
library(pheatmap)
library(sjPlot)
library(stats)
```

```{r}
data = read.csv("data/datafinal.csv")
```

```{r}
ggplot(data = data, aes(x = Hb.mass.kg..g...kg., y = HB, color = Age_categorie_binaire)) +
  geom_point()
```

```{r}
mod = lm(HB ~ Hb.mass.kg..g...kg. + Altitude + Hb.mass.kg..g...kg. * Altitude, data = data)
summary(mod)
check_heteroskedasticity(mod)
check_normality(mod)
check_autocorrelation(mod)
check_outliers(mod)
```

```{r}
df_moyennes <- data %>%
  group_by(Altitude) %>%
  summarise(
    HB = mean(HB, na.rm = TRUE),
    Hbmass = mean(Hb.mass.kg..g...kg., na.rm = TRUE),
    PV = mean(PV..kg..ml.kg., na.rm = TRUE),
    .groups = "drop"
  ) %>%
  tidyr::pivot_longer(cols = c(HB, Hbmass, PV), names_to = "Mesure", values_to = "Valeur")

ggplot(df_moyennes, aes(x = Altitude, y = Valeur, color = Mesure, group = Mesure)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  labs(title = "Évolution de HB et Hbmass selon l'altitude", y = "Valeur moyenne")
```

```{r}
cor(data$HB, data$Hb.mass.kg..g...kg., method = "spearman", use = "complete.obs")
mod = lm(HB ~ Hb.mass.kg..g...kg., data = data)
summary(mod)
check_heteroskedasticity(mod)
check_normality(mod)
check_autocorrelation(mod)
check_outliers(mod)
```

```{r}
data_12ans = data[data$Age_categorie_binaire == "8-12 ans", ]
data_12ans$Rang_HB <- rank(data_12ans$HB)
data_12ans$Rang_HBMASS <- rank(data_12ans$Hb.mass.kg..g...kg.)

ggplot(data_12ans, aes(x = Rang_HBMASS, y = Rang_HB, color = Ville_eval)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Comparaison des rangs HB vs HBMASS")
```



```{r}
data$ecart <- data$rank_HB - data$rank_HBMASS

ggplot(data, aes(x = ecart)) +
  geom_histogram(bins = 50) +
  labs(title = "Distribution des écarts de rang HB - HBMASS")
```

```{r}
#R2 Adj.	0.502	0.884	0.913	0.928	0.928
mod1 = lm(HB ~ Hb.mass.kg..g...kg., data = data)
mod2 = lm(HB ~ Hb.mass.kg..g...kg. + PV..kg..ml.kg. , data = data)
mod3 = lm(HB ~ Hb.mass.kg..g...kg. + PV..kg..ml.kg. + Altitude, data = data)
mod4 = lm(HB ~ Hb.mass.kg..g...kg. * Altitude + PV..kg..ml.kg. * Altitude, data = data)
mod5 = lm(HB ~ Hb.mass.kg..g...kg. * Altitude + PV..kg..ml.kg. * Altitude * Sexe_F_Fille_G_Garçon, data = data)
models = list(mod1, mod2, mod3, mod4, mod5)
```

```{r}
data = read.csv("data/datafinal.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]

mod1 = lm(HB ~ Hb.mass.kg..g...kg., data = data)
mod2 = lm(HB ~ Hb.mass.kg..g...kg. + PV..kg..ml.kg. , data = data)

label_models_r2adj <- function(models, prefix = "") {
  # Calcule le R² ajusté et formate le nom
  model_names <- sapply(seq_along(models), function(i) {
    r2_adj <- summary(models[[i]])$adj.r.squared
    sprintf("%s %d (R² adj = %.3f)", prefix, i, r2_adj)
  })
  # Renvoie une liste nommée
  names(models) <- model_names
  return(models)
}

models <- list(mod1, mod2, mod3, mod4, mod5)
models <- label_models_r2adj(models)

coef_data <- bind_rows(lapply(seq_along(models), function(i) {
  tidy(models[[i]], conf.int = TRUE) %>%
    mutate(model = names(models)[i])  # ✅ utilise les noms renommés
}))

term_order <- coef_data %>%
  group_by(term) %>%
  summarise(n_models = n_distinct(model)) %>%
  arrange(-n_models) %>%
  pull(term)

# Réordonner les termes selon la fréquence croissante
coef_data <- coef_data %>%
  mutate(term = factor(term, levels = term_order))

# Ajouter colonne de significativité (IC ne contenant pas 0)
coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%  # Enlever intercept si souhaité
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

# Tracer le graphique
ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Modèle", shape = "Significatif ?") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
data = read.csv("data/datafinal.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]

mod1 = lm(HB ~ Hb.mass..g., data = data)
mod2 = lm(HB ~ Hb.mass..g. + PV.ml. , data = data)

label_models_r2adj <- function(models, prefix = "") {
  # Calcule le R² ajusté et formate le nom
  model_names <- sapply(seq_along(models), function(i) {
    r2_adj <- summary(models[[i]])$adj.r.squared
    sprintf("%s %d (R² adj = %.2f)", prefix, i, r2_adj)
  })
  # Renvoie une liste nommée
  names(models) <- model_names
  return(models)
}

models <- list(mod1, mod2)
models <- label_models_r2adj(models)

coef_data <- bind_rows(lapply(seq_along(models), function(i) {
  tidy(models[[i]], conf.int = TRUE) %>%
    mutate(model = names(models)[i])  # ✅ utilise les noms renommés
}))

term_order <- coef_data %>%
  group_by(term) %>%
  summarise(n_models = n_distinct(model)) %>%
  arrange(-n_models) %>%
  pull(term)

# Réordonner les termes selon la fréquence croissante
coef_data <- coef_data %>%
  mutate(term = factor(term, levels = term_order))

# Ajouter colonne de significativité (IC ne contenant pas 0)
coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%  # Enlever intercept si souhaité
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

# Tracer le graphique
ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Modèle", shape = "Significatif ?") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  theme_minimal() +
  theme(legend.position = "bottom")
```