---
title: "Untitled"
author: "Lancelot Ravier"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r}
library(dplyr)
library(tidyr)
library(modelsummary)
library(glue)
library(gt)
library(car)
library(pROC)
library(dunn.test)
library(rcompanion)
library(rstatix)
library(purrr)
library(ggplot2)
library(patchwork)
library(psych)
library(performance)
library(lmtest)
library(readxl)
library(openxlsx)
library(pheatmap)
library(forcats)
```



```{r}
# === Variables à tracer ===
mes_vars <- c("Indice.hémolyse", "CRP",
"FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", "PROGESTERONE", "OESTRADIOL")


# === Catégories d'âge à boucler ===
ages <- c("0-3 ans")

# === Chargement de la base ===
data_all <- read.csv("fer.csv")

data_all$RECEPTEUR.TRANSFERINE <- as.numeric(gsub("<", "", data_all$RECEPTEUR.TRANSFERINE))
data_all$PROGESTERONE <- as.numeric(gsub("<", "", data_all$PROGESTERONE))
data_all$OESTRADIOL <- as.numeric(gsub("<", "", data_all$OESTRADIOL))
data_all$Ville_eval <- factor(data_all$Ville_eval,
  levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)")
)

# === Boucle sur les tranches d’âge ===
for (categorie_age in ages) {
  message("Traitement : ", categorie_age)

  # Filtrage
  data <- data_all %>% filter(Age_categorie_binaire == categorie_age)

  # Long format
  data_long <- data %>%
    select(all_of(mes_vars), Ville_eval) %>%
    pivot_longer(cols = all_of(mes_vars), names_to = "Variable", values_to = "Valeur")

  # Tests post-hoc robustes
  comparaisons <- data_long %>%
    group_split(Variable) %>%
    map_df(function(df) {
      variable <- unique(df$Variable)
      groupes_valides <- df %>%
        group_by(Ville_eval) %>%
        summarise(n = sum(!is.na(Valeur)), .groups = "drop") %>%
        filter(n >= 2) %>%
        nrow()
      if (groupes_valides < 2) return(NULL)

      tryCatch({
        df %>%
          pairwise_wilcox_test(
            Valeur ~ Ville_eval,
            p.adjust.method = "BH"
          ) %>%
          filter(p.adj < 0.1) %>%
          mutate(
            Variable = variable,
            p.signif = case_when(
              p.adj < 0.01 ~ "***",
              p.adj < 0.05 ~ "**",
              p.adj < 0.1  ~ "*"
            )
          )
      }, error = function(e) NULL)
    })

  # Position des p-values
  positions_max <- data_long %>%
    group_by(Variable) %>%
    summarise(base_y = max(Valeur, na.rm = TRUE), .groups = "drop")

  comparaisons <- comparaisons %>%
    left_join(positions_max, by = "Variable") %>%
    group_by(Variable) %>%
    mutate(
      y.position = base_y + 0.1 * base_y + 0.05 * base_y * row_number()
    ) %>%
    ungroup()

  # Génération du graphique
  p <- ggplot(data_long, aes(x = Ville_eval, y = Valeur, fill = Ville_eval)) +
    facet_wrap(~Variable, scales = "free_y", ncol = 3) +
    geom_boxplot(alpha = 0.7, outlier.size = 0.5) +
    stat_pvalue_manual(
      data = comparaisons,
      label = "p.signif",
      y.position = "y.position",
      xmin = "group1",
      xmax = "group2",
      tip.length = 0.01,
      bracket.size = 0.6,
      inherit.aes = FALSE
    ) +
    scale_fill_manual(values = c(
      "Lima (150m)" = "#1b9e77",
      "Cusco (3400m)" = "#d95f02",
      "Juliaca (3800m)" = "#7570b3",
      "La Rinconada (5100m)" = "#e7298a"
    )) +
    labs(
      title = paste("Comparaison des distributions par ville (", categorie_age, ")"),
      x = "Ville",
      y = "Valeur",
      fill = "Ville"
    ) +
    theme_minimal(base_size = 14) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  print(p)
}
```

```{r}
# HB


data = read.csv("fer.csv")
data = data %>% select("Code_Sujet", "Indice.hémolyse", "CRP",
"FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", "PROGESTERONE", "OESTRADIOL")
data$RECEPTEUR.TRANSFERINE <- as.numeric(gsub("<", "", data$RECEPTEUR.TRANSFERINE))
data$PROGESTERONE <- as.numeric(gsub("<", "", data$PROGESTERONE))
data$OESTRADIOL <- as.numeric(gsub("<", "", data$OESTRADIOL))

data2 = read.csv("data.csv")

data = left_join(data, data2, by = "Code_Sujet")
data <- data %>%
  filter(!is.na(Ville_eval))

mes_vars <- c("Indice.hémolyse", "CRP",
"FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", "PROGESTERONE", "OESTRADIOL")

data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))
data = data[data$Age_categorie_binaire == "0-3 ans",]
# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(HCT.. ~ Indice.hémolyse, data = df),
  mod_Lipides   = lm(HCT.. ~ CRP, data = df),
  mod_Glucides  = lm(HCT.. ~ FER, data = df),
  mod_Fibres    = lm(HCT.. ~ FERRITINE, data = df),
  mod_Calcium   = lm(HCT.. ~ TRANSFERINE, data = df),
  mod_Fer       = lm(HCT.. ~ RECEPTEUR.TRANSFERINE, data = df),
  #mod_Zinc      = lm(HCT.. ~ PROGESTERONE, data = df),
  #mod_VitC      = lm(HCT.. ~ OESTRADIOL, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Inhibition"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Supervision"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Flexibility"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Emotional Control"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Initiative"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Memory-Work"),
    #tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Planification"),
    #tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Supervision"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_table_stars <- coef_data %>%
  mutate(
    stars = case_when(
      p.value <= 0.01 ~ "***",
      p.value <= 0.05 ~ "**",
      p.value <= 0.1 ~ "*",
      TRUE ~ ""
    ),
    fill_color = case_when(
      (p.value <= 0.1 & estimate > 0) ~ "positif",
      (p.value <= 0.1 & estimate < 0) ~ "négatif",
      TRUE ~ "neutre"
    )
  ) %>%
  select(Ville_eval, term, stars, fill_color)

ggplot(coef_table_stars, aes(x = Ville_eval, y = term, fill = fill_color)) +
geom_tile(color = "white") +
geom_text(aes(label = stars), size = 5) +
scale_fill_manual(
  values = c("positif" = "#1b9e77", "négatif" = "red2", "neutre" = "#e0e0e0"),
  guide = FALSE
) +
labs(
  title = "Modèles simples : HCT.. ~ FER (0-3 ans)",
  x = "Ville",
  y = "Variable explicative"
) +
theme_minimal() +
theme(
  axis.text.x = element_text(angle = 20, hjust = 1),
  panel.grid = element_blank()
)
```

```{r}
# PAPm


data = read.csv("fer.csv")
data = data %>% select("Code_Sujet", "Indice.hémolyse", "CRP",
"FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", "PROGESTERONE", "OESTRADIOL")
data$RECEPTEUR.TRANSFERINE <- as.numeric(gsub("<", "", data$RECEPTEUR.TRANSFERINE))
data$PROGESTERONE <- as.numeric(gsub("<", "", data$PROGESTERONE))
data$OESTRADIOL <- as.numeric(gsub("<", "", data$OESTRADIOL))

data2 = read.csv("data.csv")

data = left_join(data, data2, by = "Code_Sujet")
data <- data %>%
  filter(!is.na(Ville_eval))

mes_vars <- c("Indice.hémolyse", "CRP",
"FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", "PROGESTERONE", "OESTRADIOL")

data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))
data = data[data$Age_categorie_binaire == "8-12 ans",]
# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod = lm(PAPm ~ FER, data = df),
  mod_Fibres    = lm(PAPm ~ FERRITINE, data = df),
  mod_Calcium   = lm(PAPm ~ TRANSFERINE, data = df),
  mod_Fer       = lm(PAPm ~ RECEPTEUR.TRANSFERINE, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod, conf.int = TRUE) %>% mutate(model = "ontrol"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Emotional Control"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Initiative"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Memory-Work"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_table_stars <- coef_data %>%
  mutate(
    stars = case_when(
      p.value <= 0.01 ~ "***",
      p.value <= 0.05 ~ "**",
      p.value <= 0.1 ~ "*",
      TRUE ~ ""
    ),
    fill_color = case_when(
      (p.value <= 0.1 & estimate > 0) ~ "positif",
      (p.value <= 0.1 & estimate < 0) ~ "négatif",
      TRUE ~ "neutre"
    )
  ) %>%
  select(Ville_eval, term, stars, fill_color)

ggplot(coef_table_stars, aes(x = Ville_eval, y = term, fill = fill_color)) +
geom_tile(color = "white") +
geom_text(aes(label = stars), size = 5) +
scale_fill_manual(
  values = c("positif" = "#1b9e77", "négatif" = "red2", "neutre" = "#e0e0e0"),
  guide = FALSE
) +
labs(
  title = "Modèles simples : PAPm ~ FER (8-12 ans)",
  x = "Ville",
  y = "Variable explicative"
) +
theme_minimal() +
theme(
  axis.text.x = element_text(angle = 20, hjust = 1),
  panel.grid = element_blank()
)
```

```{r}
# FULL 12

data = read.csv("fer.csv")
data = data %>% select("Code_Sujet", "Indice.hémolyse", "CRP",
"FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", "PROGESTERONE", "OESTRADIOL")
data$RECEPTEUR.TRANSFERINE <- as.numeric(gsub("<", "", data$RECEPTEUR.TRANSFERINE))
data$PROGESTERONE <- as.numeric(gsub("<", "", data$PROGESTERONE))
data$OESTRADIOL <- as.numeric(gsub("<", "", data$OESTRADIOL))

data2 = read.csv("data.csv")

data = left_join(data, data2, by = "Code_Sujet")
data <- data %>%
  filter(!is.na(Ville_eval))

mes_vars <- c("Indice.hémolyse", "CRP",
"FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", "PROGESTERONE", "OESTRADIOL")

data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))
data = data[data$Age_categorie_binaire == "8-12 ans",]

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(PAPm ~ FER, data = df),
      mod2 = lm(PAPm ~ FERRITINE, data = df),
      mod3 = lm(PAPm ~ TRANSFERINE, data = df),
      mod4 = lm(PAPm ~ RECEPTEUR.TRANSFERINE, data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod1, conf.int = TRUE) %>% mutate(model = "FER"),
    tidy(mods$mod2, conf.int = TRUE) %>% mutate(model = "FERRITINE"),
    tidy(mods$mod3, conf.int = TRUE) %>% mutate(model = "TRANSFERINE"),
    tidy(mods$mod4, conf.int = TRUE) %>% mutate(model = "RECEPTEUR.TRANSFERINE")
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
  "FERRITINE" = "#1b9e77",           # vert foncé
  "TRANSFERINE" = "#e6ab02",          # orange
  "RECEPTEUR.TRANSFERINE" = "#7570b3",
  "FER" = "salmon"
)) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Explained variable", shape = "Significatif ?", title = "Linear models PAPm ~ FER") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# ANEMIE


data = read.csv("fer.csv")
data = data %>% select("Code_Sujet", "Indice.hémolyse", "CRP",
"FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", "PROGESTERONE", "OESTRADIOL")
data$RECEPTEUR.TRANSFERINE <- as.numeric(gsub("<", "", data$RECEPTEUR.TRANSFERINE))
data$PROGESTERONE <- as.numeric(gsub("<", "", data$PROGESTERONE))
data$OESTRADIOL <- as.numeric(gsub("<", "", data$OESTRADIOL))

data2 = read.csv("data.csv")

data = left_join(data, data2, by = "Code_Sujet")
data <- data %>%
  filter(!is.na(Ville_eval))

mes_vars <- c("Indice.hémolyse", "CRP",
"FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", "PROGESTERONE", "OESTRADIOL")

data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))
data = data[data$Age_categorie_binaire == "0-3 ans",]
# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod = lm(Vitamine.C..mg. ~ FER, data = df),
  mod_Fibres    = lm(Vitamine.C..mg. ~ FERRITINE, data = df),
  mod_Calcium   = lm(Vitamine.C..mg. ~ TRANSFERINE, data = df),
  mod_Fer       = lm(Vitamine.C..mg. ~ RECEPTEUR.TRANSFERINE, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod, conf.int = TRUE) %>% mutate(model = "ontrol"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Emotional Control"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Initiative"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Memory-Work"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_table_stars <- coef_data %>%
  mutate(
    stars = case_when(
      p.value <= 0.01 ~ "***",
      p.value <= 0.05 ~ "**",
      p.value <= 0.1 ~ "*",
      TRUE ~ ""
    ),
    fill_color = case_when(
      (p.value <= 0.1 & estimate > 0) ~ "positif",
      (p.value <= 0.1 & estimate < 0) ~ "négatif",
      TRUE ~ "neutre"
    )
  ) %>%
  select(Ville_eval, term, stars, fill_color)

ggplot(coef_table_stars, aes(x = Ville_eval, y = term, fill = fill_color)) +
geom_tile(color = "white") +
geom_text(aes(label = stars), size = 5) +
scale_fill_manual(
  values = c("positif" = "#1b9e77", "négatif" = "red2", "neutre" = "#e0e0e0"),
  guide = FALSE
) +
labs(
  title = "Modèles simples : Vit.C ~ FER (sang) (0-3 ans)",
  x = "Ville",
  y = "Variable explicative"
) +
theme_minimal() +
theme(
  axis.text.x = element_text(angle = 20, hjust = 1),
  panel.grid = element_blank()
)
```

```{r}
# HB


data = read.csv("fer.csv")
data = data %>% select("Code_Sujet", "Indice.hémolyse", "CRP",
"FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", "PROGESTERONE", "OESTRADIOL")
data$RECEPTEUR.TRANSFERINE <- as.numeric(gsub("<", "", data$RECEPTEUR.TRANSFERINE))
data$PROGESTERONE <- as.numeric(gsub("<", "", data$PROGESTERONE))
data$OESTRADIOL <- as.numeric(gsub("<", "", data$OESTRADIOL))

data2 = read.csv("data.csv")

data = left_join(data, data2, by = "Code_Sujet")
data <- data %>%
  filter(!is.na(Ville_eval))

mes_vars <- c("Indice.hémolyse", "CRP",
"FER", "FERRITINE", "TRANSFERINE", "RECEPTEUR.TRANSFERINE", "PROGESTERONE", "OESTRADIOL")

data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

data = data[data$Age_categorie_binaire == "8-12 ans",]

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  #mod_Protéines = lm(HCT.. ~ Indice.hémolyse, data = df),
  mod_Lipides   = lm(CRP ~ Polyglobulie_14.5_OMS2024, data = df),
  mod_Glucides  = lm(FER ~ Polyglobulie_14.5_OMS2024, data = df),
  mod_Fibres    = lm(FERRITINE ~ Polyglobulie_14.5_OMS2024, data = df),
  mod_Calcium   = lm(TRANSFERINE ~ Polyglobulie_14.5_OMS2024, data = df),
  mod_Fer       = lm(RECEPTEUR.TRANSFERINE ~ Polyglobulie_14.5_OMS2024, data = df),
  #mod_Zinc      = lm(HCT.. ~ PROGESTERONE, data = df),
  #mod_VitC      = lm(HCT.. ~ OESTRADIOL, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  bind_rows(
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(var_dep = "CRP"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(var_dep = "FER"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(var_dep = "FERRITINE"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(var_dep = "TRANSFERINE"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(var_dep = "RECEPTEUR.TRANSFERINE")
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_table_stars <- coef_data %>%
  mutate(
    stars = case_when(
      p.value <= 0.01 ~ "***",
      p.value <= 0.05 ~ "**",
      p.value <= 0.1 ~ "*",
      TRUE ~ ""
    ),
    fill_color = case_when(
      (p.value <= 0.1 & estimate > 0) ~ "positif",
      (p.value <= 0.1 & estimate < 0) ~ "négatif",
      TRUE ~ "neutre"
    )
  ) %>%
  select(Ville_eval, var_dep, stars, fill_color)

ggplot(coef_table_stars, aes(x = Ville_eval, y = var_dep, fill = fill_color)) +
geom_tile(color = "white") +
geom_text(aes(label = stars), size = 5) +
scale_fill_manual(
  values = c("positif" = "#1b9e77", "négatif" = "red2", "neutre" = "#e0e0e0"),
  guide = FALSE
) +
labs(
  title = "Modèles simples : FER ~ Polyglobulie_OMS2024 (8-12 ans)",
  x = "Ville",
  y = "Variable explicative"
) +
theme_minimal() +
theme(
  axis.text.x = element_text(angle = 20, hjust = 1),
  panel.grid = element_blank()
)
```

```{r}
df = read.csv("datafinalfinal.csv")

prop_df <- df %>%
  mutate(
    Anemie_OMS2011 = Anemie_OMS2011 == "oui",
    Anemie_OMS2024 = Anemie_OMS2024 == "oui",
    CRP.élevée = CRP.élevée == "oui",
    Iron.deficiency = Iron.deficiency == "oui"
  ) %>%
  select(Anemie_OMS2011, Anemie_OMS2024, CRP.élevée, Iron.deficiency) %>%
  tidyr::pivot_longer(cols = c(Anemie_OMS2011, Anemie_OMS2024),
                      names_to = "definition_anemie",
                      values_to = "anemie") %>%
  filter(anemie == TRUE) %>%
  summarise(
    n = n(),
    CRP.élevée = mean(CRP.élevée, na.rm = TRUE),
    Iron.deficiency = mean(Iron.deficiency, na.rm = TRUE),
    .by = definition_anemie
  ) %>%
  tidyr::pivot_longer(cols = c(CRP.élevée, Iron.deficiency),
                      names_to = "variable",
                      values_to = "proportion")

# Affichage
ggplot(prop_df, aes(x = definition_anemie, y = proportion, fill = variable)) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Proportion de biomarqueurs anormaux chez les enfants anémiques",
    subtitle = "Comparaison entre les définitions OMS 2011 et OMS 2024",
    x = "Définition de l'anémie",
    y = "Proportion avec anomalie",
    fill = "Variable"
  ) +
  theme_minimal()
```

```{r}
df <- read.xlsx("fer4.xlsx")

# Mise au format logique
df2 <- df %>%
  mutate(
    CRP.élevée = CRP.élevée == "oui",
    Iron.deficiency = Iron.deficiency == "oui",
    Anemie_OMS2011 = Anemie_OMS2011 == "oui",
    Anemie_OMS2024 = Anemie_OMS2024 == "oui"
  )

# Pivot plus calculs
prop_reverse <- df2 %>%
  select(CRP.élevée, Iron.deficiency, Anemie_OMS2011, Anemie_OMS2024) %>%
  pivot_longer(cols = c(CRP.élevée, Iron.deficiency),
               names_to = "anomalie",
               values_to = "valeur_anomalie") %>%
  filter(valeur_anomalie == TRUE) %>%
  summarise(
    n = n(),
    OMS2011 = mean(Anemie_OMS2011, na.rm = TRUE),
    OMS2024 = mean(Anemie_OMS2024, na.rm = TRUE),
    .by = anomalie
  ) %>%
  pivot_longer(cols = c(OMS2011, OMS2024),
               names_to = "definition_anemie",
               values_to = "proportion")

# Graphique
ggplot(prop_reverse, aes(x = anomalie, y = proportion, fill = definition_anemie)) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Proportion d'enfants anémiques parmi ceux avec anomalie biologique",
    subtitle = "Qui parmi les CRP élevées ou carences martiales est anémique ?",
    x = "Biomarqueur anormal",
    y = "Proportion anémique",
    fill = "Définition OMS"
  ) +
  theme_minimal()
```

```{r}
data = read.csv("datafinalfinal.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Anemie_OMS2011, Iron.deficiency, CRP.élevée)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.test(tbl, correct = correct, exact = TRUE)
    type <- "Test exact de McNemar"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "Test de McNemar (chi²)"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Iron.deficiency)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Iron.deficiency)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Proportions croisées anémie : OMS 2024 v.s. Iron.low\n",
  "n = ", n_total, " ; ", "pval ", methode, " = ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, Iron.deficiency) %>%
  group_by(Iron.deficiency) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = Iron.deficiency, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = scales::percent(prop, accuracy = 1)), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "Anémie_OMS2024",
    y = "Iron.low",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
data = read.xlsx("fer4.xlsx")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Anemie_OMS2011, Iron.deficiency, CRP.élevée)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.test(tbl, correct = correct, exact = TRUE)
    type <- "Test exact de McNemar"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "Test de McNemar (chi²)"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$CRP.élevée)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$CRP.élevée)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Proportions croisées anémie : OMS 2024 v.s. CRP.élevée \n",
  "n = ", n_total, " ; ", "pval ", methode, " = ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, CRP.élevée) %>%
  group_by(CRP.élevée) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = CRP.élevée, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = scales::percent(prop, accuracy = 1)), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "Anémie_OMS2024",
    y = "CRP.élevée",
    fill = "Proportion"
  ) +
  theme_minimal()
```



```{r}
data = read.xlsx("fer4.xlsx")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Anemie_OMS2011, Iron.deficiency, CRP.élevée)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.test(tbl, correct = correct, exact = TRUE)
    type <- "Test exact de McNemar"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "Test de McNemar (chi²)"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Iron.deficiency)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Iron.deficiency)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Proportions croisées anémie : OMS 2011 v.s. Iron.low\n",
  "n = ", n_total, " ; ", "pval ", methode, " = ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2011, Iron.deficiency) %>%
  group_by(Iron.deficiency) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2011, y = Iron.deficiency, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = scales::percent(prop, accuracy = 1)), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "Anemie_OMS2011",
    y = "Iron.low",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
data = read.xlsx("fer4.xlsx")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Anemie_OMS2011, Iron.deficiency, CRP.élevée)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.test(tbl, correct = correct, exact = TRUE)
    type <- "Test exact de McNemar"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "Test de McNemar (chi²)"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$CRP.élevée)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$CRP.élevée)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Proportions croisées anémie : OMS 2011 v.s. CRP.élevée \n",
  "n = ", n_total, " ; ", "pval ", methode, " = ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2011, CRP.élevée) %>%
  group_by(CRP.élevée) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2011, y = CRP.élevée, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = scales::percent(prop, accuracy = 1)), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "Anemie_OMS2011",
    y = "CRP.élevée",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
data = read.xlsx("fer4.xlsx")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Anemie_OMS2011, Iron.deficiency, CRP.élevée)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.test(tbl, correct = correct, exact = TRUE)
    type <- "Test exact de McNemar"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "Test de McNemar (chi²)"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Iron.deficiency, data_clean$CRP.élevée)$p.value
methode = mcnemar_auto(data_clean$Iron.deficiency, data_clean$CRP.élevée)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Proportions croisées : Iron.low v.s. CRP.élevée \n",
  "n = ", n_total, " ; ", "pval ", methode, " = ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Iron.deficiency, CRP.élevée) %>%
  group_by(CRP.élevée) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Iron.deficiency, y = CRP.élevée, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = scales::percent(prop, accuracy = 1)), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "Iron.low",
    y = "CRP.élevée",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
# Lecture des données
df <- read.xlsx("fer4.xlsx")

# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    CRP.élevée = factor(CRP.élevée, levels = c("non", "oui")),
    FER = as.numeric(FER),
    FERRITINE = as.numeric(FERRITINE),
    TRANSFERINE = as.numeric(TRANSFERINE),
    RECEPTEUR.TRANSFERINE = as.numeric(RECEPTEUR.TRANSFERINE)
  ) %>%
  select(CRP.élevée, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE)

# Passage en format long
df_long <- df_clean %>%
  pivot_longer(cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE),
               names_to = "parametre",
               values_to = "valeur")

# Calcul des moyennes
df_summary <- df_long %>%
  group_by(CRP.élevée, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

ggplot(df_long %>% filter(!is.na(CRP.élevée)), aes(x = CRP.élevée, y = valeur, fill = CRP.élevée)) +
  geom_boxplot() +
  facet_wrap(~ parametre, scales = "free_y") +
  stat_compare_means(method = "t.test", label = "p.signif", hjust = -5, vjust = 3, symnum.args = list(
      cutpoints = c(0, 0.01, 0.05, 0.10, 1),
      symbols = c("***", "**", "*", "ns")
    ), size = 6) +  # ou "p.format" pour la valeur exacte
  labs(
    title = "Comparaison des paramètres du fer selon le statut CRP",
    subtitle = "Avec t.test (CRP élevée vs normale)",
    x = "CRP élevée ?",
    y = "Valeur du paramètre"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
# Lecture des données
df <- read.xlsx("fer4.xlsx")

# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Anemie_OMS2024 = factor(Anemie_OMS2024, levels = c("non", "oui")),
    FER = as.numeric(FER),
    FERRITINE = as.numeric(FERRITINE),
    TRANSFERINE = as.numeric(TRANSFERINE),
    RECEPTEUR.TRANSFERINE = as.numeric(RECEPTEUR.TRANSFERINE)
  ) %>%
  select(Anemie_OMS2024, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE)

# Passage en format long
df_long <- df_clean %>%
  pivot_longer(cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE),
               names_to = "parametre",
               values_to = "valeur")

# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Anemie_OMS2024, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

ggplot(df_long %>% filter(!is.na(Anemie_OMS2024)), aes(x = Anemie_OMS2024, y = valeur, fill = Anemie_OMS2024)) +
  geom_boxplot() +
  facet_wrap(~ parametre, scales = "free_y") +
  stat_compare_means(method = "t.test", label = "p.signif", hjust = -5, vjust = 3, symnum.args = list(
      cutpoints = c(0, 0.01, 0.05, 0.10, 1),
      symbols = c("***", "**", "*", "ns")
    ), size = 6) +  # ou "p.format" pour la valeur exacte
  labs(
    title = "Comparaison des paramètres du fer selon le statut Anemique (OMS2024)",
    subtitle = "Avec t.test (Anemique vs non-anemique)",
    x = "Anemique (OMS2024) ?",
    y = "Valeur du paramètre"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
# Lecture des données
df <- read.xlsx("fer4.xlsx")

# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Anemie_OMS2011 = factor(Anemie_OMS2011, levels = c("non", "oui")),
    FER = as.numeric(FER),
    FERRITINE = as.numeric(FERRITINE),
    TRANSFERINE = as.numeric(TRANSFERINE),
    RECEPTEUR.TRANSFERINE = as.numeric(RECEPTEUR.TRANSFERINE)
  ) %>%
  select(Anemie_OMS2011, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE)

# Passage en format long
df_long <- df_clean %>%
  pivot_longer(cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE),
               names_to = "parametre",
               values_to = "valeur")

# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Anemie_OMS2011, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

ggplot(df_long %>% filter(!is.na(Anemie_OMS2011)), aes(x = Anemie_OMS2011, y = valeur, fill = Anemie_OMS2011)) +
  geom_boxplot() +
  facet_wrap(~ parametre, scales = "free_y") +
  stat_compare_means(method = "t.test", label = "p.signif", hjust = -5, vjust = 3, symnum.args = list(
      cutpoints = c(0, 0.01, 0.05, 0.10, 1),
      symbols = c("***", "**", "*", "ns")
    ), size = 6) +  # ou "p.format" pour la valeur exacte
  labs(
    title = "Comparaison des paramètres du fer selon le statut Anemique (OMS2011)",
    subtitle = "Avec t.test (Anemique vs non-anemique)",
    x = "Anemique (OMS2011) ?",
    y = "Valeur du paramètre"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
# Lecture des données
df <- read.xlsx("fer5.xlsx")

# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Polyglobulie_OMS2024 = factor(Polyglobulie_14.5_OMS2024, levels = c("non", "oui")),
    FER = as.numeric(FER),
    FERRITINE = as.numeric(FERRITINE),
    TRANSFERINE = as.numeric(TRANSFERINE),
    RECEPTEUR.TRANSFERINE = as.numeric(RECEPTEUR.TRANSFERINE)
  ) %>%
  select(Polyglobulie_14.5_OMS2024, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE)

# Passage en format long
df_long <- df_clean %>%
  pivot_longer(cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE),
               names_to = "parametre",
               values_to = "valeur")

# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Polyglobulie_14.5_OMS2024, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

ggplot(df_long %>% filter(!is.na(Polyglobulie_14.5_OMS2024)), aes(x = Polyglobulie_14.5_OMS2024, y = valeur, fill = Polyglobulie_14.5_OMS2024)) +
  geom_boxplot() +
  facet_wrap(~ parametre, scales = "free_y") +
  stat_compare_means(method = "t.test", label = "p.signif", hjust = -5, vjust = 3, symnum.args = list(
      cutpoints = c(0, 0.01, 0.05, 0.10, 1),
      symbols = c("***", "**", "*", "ns")
    ), size = 6) +  # ou "p.format" pour la valeur exacte
  labs(
    title = "Comparaison des paramètres du fer selon le statut Polyglobulique (OMS2024)",
    subtitle = "Avec t.test (Polyglobulique vs non-polyglobulique)",
    x = "Polyglobulique (OMS2024) ?",
    y = "Valeur du paramètre"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
# Lecture des données
df <- read.xlsx("fer5.xlsx")

# Sélection et conversion des colonnes
df_clean <- df %>%
  mutate(
    Polyglobulie_OMS2011 = factor(Polyglobulie_14.5_OMS2011, levels = c("non", "oui")),
    FER = as.numeric(FER),
    FERRITINE = as.numeric(FERRITINE),
    TRANSFERINE = as.numeric(TRANSFERINE),
    RECEPTEUR.TRANSFERINE = as.numeric(RECEPTEUR.TRANSFERINE)
  ) %>%
  select(Polyglobulie_14.5_OMS2011, FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE)

# Passage en format long
df_long <- df_clean %>%
  pivot_longer(cols = c(FER, FERRITINE, TRANSFERINE, RECEPTEUR.TRANSFERINE),
               names_to = "parametre",
               values_to = "valeur")

# Calcul des moyennes
df_summary <- df_long %>%
  group_by(Polyglobulie_14.5_OMS2011, parametre) %>%
  summarise(moyenne = mean(valeur, na.rm = TRUE), .groups = "drop")

# Barplot

ggplot(df_long %>% filter(!is.na(Polyglobulie_14.5_OMS2011)), aes(x = Polyglobulie_14.5_OMS2011, y = valeur, fill = Polyglobulie_14.5_OMS2011)) +
  geom_boxplot() +
  facet_wrap(~ parametre, scales = "free_y") +
  stat_compare_means(method = "t.test", label = "p.signif", hjust = -5, vjust = 3, symnum.args = list(
      cutpoints = c(0, 0.01, 0.05, 0.10, 1),
      symbols = c("***", "**", "*", "ns")
    ), size = 6) +  # ou "p.format" pour la valeur exacte
  labs(
    title = "Comparaison des paramètres du fer selon le statut Polyglobulique (OMS2011)",
    subtitle = "Avec t.test (Polyglobulique vs non-polyglobulique)",
    x = "Polyglobulique (OMS2011) ?",
    y = "Valeur du paramètre"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
roc1 <- roc(data$Anemie_OMS2011, data$FER)
roc2 <- roc(data$Anemie_OMS2024, data$FER)

plot(roc1, col = "blue", print.auc = FALSE, main = "Courbes ROC FER Anemie (OMS2011 v.s. OMS2024)")
plot(roc2, col = "red", add = TRUE, print.auc = FALSE)

legend("bottomright",
       legend = c(
         paste0("OMS2011 (AUC = ", round(auc(roc1), 2), ")"),
         paste0("OMS2024 (AUC = ", round(auc(roc2), 2), ")")
       ),
       col = c("blue", "red"),
       lwd = 2)
```