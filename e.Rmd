---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r, include = FALSE}
library(dplyr)
library(tidyr)
library(modelsummary)
library(glue)
library(gt)
library(car)
library(dunn.test)
library(rcompanion)
library(rstatix)
library(purrr)
library(ggplot2)
library(patchwork)
library(psych)
library(performance)
library(lmtest)
library(readxl)
library(openxlsx)
library(pheatmap)
library(ggpubr)
library(exact2x2)
```

```{r}
data = read.csv("dataclean/7.csv")
names(data)
```

```{r}

groupes_vars <- list(

  # 🫀 CARDIAQUE
  cardiaque1 = c("SC", "PAS", "PAD", "PAM", "FC", "DC", "IC", "TVR", "PAPm"),
  cardiaque2 = c("DTDVG", "DTSVG", "VTDVG", "DTDVGi", "DTSVGi", "VTDVGi", "PP", "RWT", "masseVG"),
  cardiaque3 = c("FEVG..teich.", "vol.ej..teich.", "FEVG.auto", "GLS.VG", "CCVG", "vol.éj..CCVG.", "h.r", "ITVSSAo", "DC"),
  cardiaque4 = c("diam.OG", "ao.og", "surf.OG", "vol.OG", "surf.OG.ind", "vol.OG.ind"),
  cardiaque5 = c("E.mit", "A.mit", "E.A.mit", "TDM.Emit", "E..lat", "E.e..mit"),
  cardiaque6 = c("STDVD", "STSVD", "STDVDi", "STSVDi", "FR.VD", "strain.VD", "TAPSE"),
  cardiaque7 = c("surf.OD", "vol.OD", "surf.OD.ind", "vol.OD.ind"),
  cardiaque8 = c("E.tric", "A.tric", "E.A.tric", "TDM.Etric", "onde.S.tric"),
  cardiaque9 = c("PAPs", "PAPm", "vitesse.IT", "ITV.pulm", "Tacc.pulm"),

  # 🧠 COGNITIF / BRIEF / QI / MOTEUR
  sociodemo = c("IMC", "Altitude_naissance", "N_edu_M", "CSP_M", "CSP_P", "Infrecuencia", "Incoherencia", "Negatividad"),
  inhibition_flex = c("Inhibicion", "Inhibicion_Nota_T", "Supervision_Si_Mismo", "Supervision_Si_Mismo_Nota_T",
                      "Flexibilidad", "Flexibilidad_Nota_T", "Control_Emocional", "Control_Emocional_Nota_T"),
  exec_memoire = c("Iniciativa", "Iniciativa_Nota_T", "Memoria_Trabajo", "Memoria_Trabajo_Nota_T",
                   "Planificacion_Organizacion", "Planificacion_Organizacion_Nota_T",
                   "Supervision_Tarea", "Supervision_Tarea_Nota_T"),
  organisation_brief = c("Organizacion_Materiales", "Organizacion_Materiales_Nota_T",
                         "BRIEF_IFL", "BRIEF_IFL_Nota_T", "BRIEF_IME", "BRIEF_IME_Nota_T",
                         "BRIEF_IGFE", "BRIEF_IGFE_Nota_T"),
  brief2_composites = c("BRIEF2_IRCN", "BRIEF2_IRCN_Nota_T", "BRIEF2_IREM", "BRIEF2_IREM_Nota_T",
                        "BRIEF2_IRCG", "BRIEF2_IRCG_Nota_T", "BRIEF2_IGE", "BRIEF2_IGE_Nota_T"),
  matrices_codes = c("DS_Matrice", "QI_Matrice", "DS_Code", "QI_Code",
                     "DS_Barrage_partie_1", "DS_Barrage_partie_2", "QI_Barrage"),
  labyrinthe = c("DS_Labyrinthe", "QI_Labyrinthe"),
  purdue_main = c("DS_Purdue_Main_Dominante", "MD_Z", "DS_Purdue_Main_Non_Dominante", "MND_Z",
                  "DS_Purdue_Coordination", "Coordination_Z", "DS_Purdue_Assemblage", "Assemblage_Z"),

  # 🍽️ NUTRITIONNEL
  morphologie = c("Age_mois", "Poids", "Taille",
                  "poids.mini.kg", "poids.max.kg",
                  "Taille.mini.cm", "Taille.max.cm"),
  macros = c("kCalHors.fibres", "X..ENERGIE.RNP", "Pr..g.", "L.g.", "G.g.", "Fibres"),
  micro_apports = c("Calcium..mg.", "X..CALCIUM...RNP", "Fer..mg.100.g.", "Zinc..mg.100.g.",
                    "Vitamine.C..mg.", "X..vit.C...RNP"),
  rnp_journaliers = c("Energie.Kcal..j.RNP", "Calcium.mg.j.RNP", "Vit.C.mg.j.RNP",
                      "Vit.D.µg.j.RNP", "Vit.B9.mg.j.RNP", "Vit.B12.mg.j.RNP"),

  # 🩸 HÉMATOLOGIE / VOLUME SANGUIN
  hemoglobine = c("Hb.mass..g.", "Hb.mass.kg..g...kg.", "Hb.mass.kg..g...kg.2",
                  "Hb.NFS", "X.Hb...g.L..ABL.80", "Hct...."),
  volumes_sanguins = c("RBCV..ml.", "PV.ml.", "BV..ml.",
                       "PV..kg..ml.kg.", "BV..kg..ml.kg."),
)
```



```{r}
# === Variables à tracer ===

mes_vars = c("Inhibicion", "Inhibicion_Nota_T", "Supervision_Si_Mismo", "Supervision_Si_Mismo_Nota_T",
                      "Flexibilidad", "Flexibilidad_Nota_T", "Control_Emocional", "Control_Emocional_Nota_T")

# === Catégories d'âge à boucler ===
ages <- c("8-12 ans")

# === Chargement de la base ===
data_all <- read.csv("data.csv")
data_all$Ville_eval <- factor(data_all$Ville_eval,
  levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)")
)

# === Boucle sur les tranches d’âge ===
for (categorie_age in ages) {
  message("Traitement : ", categorie_age)

  # Filtrage
  data <- data_all %>% filter(Age_categorie_binaire == categorie_age)

  # Long format
  data_long <- data %>%
    select(all_of(mes_vars), Ville_eval) %>%
    pivot_longer(cols = all_of(mes_vars), names_to = "Variable", values_to = "Valeur")

  # Tests post-hoc robustes
comparaisons <- data_long %>%
  group_split(Variable) %>%
  map_df(function(df) {
    variable <- unique(df$Variable)

    groupes_valides <- df %>%
      group_by(Ville_eval) %>%
      summarise(n = sum(!is.na(Valeur)), .groups = "drop") %>%
      filter(n >= 2) %>%
      nrow()

    if (groupes_valides < 2) {
      return(tibble(
        group1 = NA,
        group2 = NA,
        p.adj = NA,
        p.signif = "FAIL",  # ou "NA", ou "n<2"
        Variable = variable,
        test_fail = TRUE
      ))
    }

    tryCatch({
      df %>%
        pairwise_wilcox_test(
          Valeur ~ Ville_eval,
          p.adjust.method = "BH"
        ) %>%
        mutate(
          Variable = variable,
          p.signif = case_when(
            p.adj < 0.01 ~ "***",
            p.adj < 0.05 ~ "**",
            p.adj < 0.1  ~ "*"
          ),
          test_fail = FALSE
        )
    }, error = function(e) {
      tibble(
        group1 = NA,
        group2 = NA,
        p.adj = NA,
        p.signif = "FAIL",
        Variable = variable,
        test_fail = TRUE
      )
    })
  })

  # Position des p-values
  positions_max <- data_long %>%
    group_by(Variable) %>%
    summarise(base_y = max(Valeur, na.rm = TRUE), .groups = "drop")

comparaisons <- comparaisons %>%
  left_join(positions_max, by = "Variable") %>%
  group_by(Variable) %>%
  mutate(
    y.position = base_y + 0.1 * base_y + 0.05 * base_y * row_number(),
    group1 = if_else(test_fail, "Lima (150m)", group1),
    group2 = if_else(test_fail, "Cusco (3400m)", group2)
  ) %>%
  ungroup()

  # Génération du graphique
  p <- ggplot(data_long, aes(x = Ville_eval, y = Valeur, fill = Ville_eval)) +
    facet_wrap(~Variable, scales = "free_y", ncol = 3) +
    geom_boxplot(alpha = 0.7, outlier.size = 0.5) +
    stat_pvalue_manual(
      data = comparaisons,
      label = "p.signif",
      y.position = "y.position",
      xmin = "group1",
      xmax = "group2",
      tip.length = 0.01,
      bracket.size = 0.6,
      inherit.aes = FALSE
    ) +
    scale_fill_manual(values = c(
      "Lima (150m)" = "#1b9e77",
      "Cusco (3400m)" = "#d95f02",
      "Juliaca (3800m)" = "#7570b3",
      "La Rinconada (5100m)" = "#e7298a"
    )) +
    labs(
      title = paste("Comparaison des distributions par ville (", categorie_age, ")"),
      x = "Ville",
      y = "Valeur",
      fill = "Ville"
    ) +
    theme_minimal(base_size = 14) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  print(p)
}
```

```{r}
ages <- c("0-3 ans")

# === Chargement de la base
data_all <- read.csv("data.csv")
data_all$Ville_eval <- factor(data_all$Ville_eval,
  levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)")
)

# === Boucle principale
for (nom_groupe in names(groupes_vars)) {
  mes_vars <- groupes_vars[[nom_groupe]]

  for (categorie_age in ages) {
    message("Traitement : ", nom_groupe, " – ", categorie_age)

    data <- data_all %>% filter(Age_categorie_binaire == categorie_age)

    data_long <- data %>%
      select(all_of(mes_vars), Ville_eval) %>%
      pivot_longer(cols = all_of(mes_vars), names_to = "Variable", values_to = "Valeur")
if (nrow(data_long %>% filter(!is.na(Valeur))) == 0) {
  message("📭 Aucune donnée exploitable pour ", nom_groupe, " – ", categorie_age)
  next
}
    comparaisons <- data_long %>%
      group_split(Variable) %>%
      map_df(function(df) {
        variable <- unique(df$Variable)

        groupes_valides <- df %>%
          group_by(Ville_eval) %>%
          summarise(n = sum(!is.na(Valeur)), .groups = "drop") %>%
          filter(n >= 2) %>%
          nrow()

        if (groupes_valides < 2) {
          return(tibble(
            group1 = NA,
            group2 = NA,
            p.adj = NA,
            p.signif = "FAIL",
            Variable = variable,
            test_fail = TRUE
          ))
        }

        tryCatch({
          df %>%
            pairwise_wilcox_test(
              Valeur ~ Ville_eval,
              p.adjust.method = "BH"
            ) %>%
            mutate(
              Variable = variable,
              p.signif = case_when(
                p.adj < 0.01 ~ "***",
                p.adj < 0.05 ~ "**",
                p.adj < 0.1  ~ "*"
              ),
              test_fail = FALSE
            )
        }, error = function(e) {
          tibble(
            group1 = NA,
            group2 = NA,
            p.adj = NA,
            p.signif = "FAIL",
            Variable = variable,
            test_fail = TRUE
          )
        })
      })

    # Position des p-values
    positions_max <- data_long %>%
      group_by(Variable) %>%
      summarise(base_y = max(Valeur, na.rm = TRUE), .groups = "drop")

    comparaisons <- comparaisons %>%
      left_join(positions_max, by = "Variable") %>%
      group_by(Variable) %>%
      mutate(
        y.position = base_y + 0.1 * base_y + 0.05 * base_y * row_number(),
        group1 = if_else(test_fail, "Lima (150m)", group1),
        group2 = if_else(test_fail, "Cusco (3400m)", group2)
      ) %>%
      ungroup()

    # Plot
    p <- ggplot(data_long, aes(x = Ville_eval, y = Valeur, fill = Ville_eval)) +
      facet_wrap(~Variable, scales = "free_y", ncol = 3) +
      geom_boxplot(alpha = 0.7, outlier.size = 0.5) +
      stat_pvalue_manual(
        data = comparaisons,
        label = "p.signif",
        y.position = "y.position",
        xmin = "group1",
        xmax = "group2",
        tip.length = 0.01,
        bracket.size = 0.6,
        inherit.aes = FALSE
      ) +
      scale_fill_manual(values = c(
        "Lima (150m)" = "#1b9e77",
        "Cusco (3400m)" = "#d95f02",
        "Juliaca (3800m)" = "#7570b3",
        "La Rinconada (5100m)" = "#e7298a"
      )) +
      labs(
        title = paste("Comparaison par ville –", nom_groupe, "(", categorie_age, ")"),
        x = "Ville",
        y = "Valeur",
        fill = "Ville"
      ) +
      theme_minimal(base_size = 14) +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))

    # Affichage
    print(p)

    # Sauvegarde (optionnelle)
    # ggsave(paste0("boxplot_", nom_groupe, "_", gsub(" ", "_", categorie_age), ".pdf"),
    #        plot = p, width = 10, height = 8)
  }
}
```

