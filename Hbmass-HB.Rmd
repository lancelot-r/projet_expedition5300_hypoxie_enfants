---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r}
library(dplyr)
library(tidyr)
library(modelsummary)
library(glue)
library(gt)
library(car)
library(dunn.test)
library(rcompanion)
library(rstatix)
library(purrr)
library(ggplot2)
library(patchwork)
library(psych)
library(performance)
library(lmtest)
library(readxl)
library(openxlsx)
library(pheatmap)
library(sjPlot)
library(stats)
```

```{r}
data = read.csv("data/datafinal.csv")
```

```{r}
ggplot(data = data, aes(x = Hb.mass.kg..g...kg., y = HB, color = Altitude)) +
  geom_point()
```

```{r}
mod = lm(HB ~ Hb.mass.kg..g...kg. + Altitude + Hb.mass.kg..g...kg. * Altitude, data = data)
summary(mod)
check_heteroskedasticity(mod)
check_normality(mod)
check_autocorrelation(mod)
check_outliers(mod)
```

```{r}
df_moyennes <- data %>%
  group_by(Altitude) %>%
  summarise(
    HB = mean(HB, na.rm = TRUE),
    Hbmass = mean(Hb.mass.kg..g...kg., na.rm = TRUE),
    PV = mean(PV..kg..ml.kg., na.rm = TRUE),
    .groups = "drop"
  ) %>%
  tidyr::pivot_longer(cols = c(HB, Hbmass, PV), names_to = "Mesure", values_to = "Valeur")

ggplot(df_moyennes, aes(x = Altitude, y = Valeur, color = Mesure, group = Mesure)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  labs(title = "Évolution de HB et Hbmass selon l'altitude", y = "Valeur moyenne")
```

```{r}
cor(data$HB, data$Hb.mass.kg..g...kg., method = "spearman", use = "complete.obs")
mod = lm(HB ~ Hb.mass.kg..g...kg., data = data)
summary(mod)
check_heteroskedasticity(mod)
check_normality(mod)
check_autocorrelation(mod)
check_outliers(mod)
```

```{r}
data$rank_HB <- rank(data$HB)
data$rank_HBMASS <- rank(data$Hb.mass.kg..g...kg.)

ggplot(data, aes(x = rank_HBMASS, y = rank_HB)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Comparaison des rangs HB vs HBMASS")
```

```{r}
ggplot(data, aes(x = Hb.mass.kg..g...kg., y = HB)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Relation entre HB et HBMASS")
```

```{r}
data$ecart <- data$rank_HB - data$rank_HBMASS

ggplot(data, aes(x = ecart)) +
  geom_histogram(bins = 50) +
  labs(title = "Distribution des écarts de rang HB - HBMASS")
```

```{r}
#R2 Adj.	0.502	0.884	0.913	0.928	0.928
mod1 = lm(HB ~ Hb.mass.kg..g...kg., data = data)
mod2 = lm(HB ~ Hb.mass.kg..g...kg. + PV..kg..ml.kg. , data = data)
mod3 = lm(HB ~ Hb.mass.kg..g...kg. + PV..kg..ml.kg. + Altitude, data = data)
mod4 = lm(HB ~ Hb.mass.kg..g...kg. * Altitude + PV..kg..ml.kg. * Altitude, data = data)
mod5 = lm(HB ~ Hb.mass.kg..g...kg. * Altitude + PV..kg..ml.kg. * Altitude * Sexe_F_Fille_G_Garçon, data = data)
models = list(mod1, mod2, mod3, mod4, mod5)
modelsummary(models, stars = T, statistic = NULL)
```

```{r}
#R2 Adj.	0.291	0.870	0.900	0.920	0.923
mod1 = lm(HB ~ Hb.mass..g., data = data)
mod2 = lm(HB ~ Hb.mass..g. + PV.ml. , data = data)
mod3 = lm(HB ~ Hb.mass..g. + PV.ml. + Altitude, data = data)
mod4 = lm(HB ~ Hb.mass..g. * Altitude + PV.ml. * Altitude, data = data)
mod5 = lm(HB ~ Hb.mass..g. * Altitude + PV.ml. * Altitude * Sexe_F_Fille_G_Garçon, data = data)
models = list(mod1, mod2, mod3, mod4, mod5)
modelsummary(models, stars = T, statistic = NULL)
```

