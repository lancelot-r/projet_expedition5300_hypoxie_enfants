---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup}
knitr::opts_chunk$set(echo=FALSE, warning = F)
knitr::opts_chunk$set(
  fig.width = 12,
  fig.height = 6,
  out.width = '100%')
```

```{css, echo=FALSE}
body, .main-container, .container-fluid, .row, .col-xs-12 {
  border: none !important;
  box-shadow: none !important;
  background: white !important;
  padding: 0 !important;
  margin: 0 !important;
}
pre, code, .table {
  border: none !important;
  box-shadow: none !important;
  background: none !important;
}
```

```{r, include = FALSE}
library(dplyr)
library(tidyr)
library(modelsummary)
library(glue)
library(gt)
library(car)
library(dunn.test)
library(rcompanion)
library(rstatix)
library(purrr)
library(ggplot2)
library(patchwork)
library(psych)
library(performance)
library(lmtest)
library(readxl)
library(openxlsx)
library(pheatmap)
library(ggpubr)
library(exact2x2)
```

# Différences OMS2024 - SD

```{r}
data = read.csv("data.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Anemie_OMS2011)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.test(tbl, correct = correct, exact = TRUE)
    type <- "Test exact de McNemar"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "Test de McNemar (chi²)"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_OMS2011)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_OMS2011)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Proportions croisées anémie : OMS 2024 v.s. -1SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " = ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, Anemie_OMS2011) %>%
  group_by(Anemie_OMS2011) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = Anemie_OMS2011, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = scales::percent(prop, accuracy = 1)), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "Anémie_OMS2024",
    y = "Anémie_OMS2011",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
data = read.csv("data.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Anemie_SD)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.test(tbl, correct = correct, exact = TRUE)
    type <- "Test exact de McNemar"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "Test de McNemar (chi²)"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_SD)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_SD)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Proportions croisées anémie : OMS 2024 v.s. -1SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, Anemie_SD) %>%
  group_by(Anemie_SD) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = Anemie_SD, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = scales::percent(prop, accuracy = 1)), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "Anémie_OMS2024",
    y = "Anémie_SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
data = read.csv("data.csv")
data_clean <- data %>%
  drop_na(Polyglobulie_14.5_OMS2024, Polyglobulie_14.5_OMS2011)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.test(tbl, correct = correct, exact = TRUE)
    type <- "Test exact de McNemar"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "Test de McNemar (chi²)"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2024, data_clean$Polyglobulie_14.5_OMS2011)$p.value
methode = mcnemar_auto(data_clean$Polyglobulie_14.5_OMS2024, data_clean$Polyglobulie_14.5_OMS2011)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Proportions croisées polyglobulie : OMS 2024 v.s. -1SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Polyglobulie_14.5_OMS2024, Polyglobulie_14.5_OMS2011) %>%
  group_by(Polyglobulie_14.5_OMS2011) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Polyglobulie_14.5_OMS2024, y = Polyglobulie_14.5_OMS2011, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = scales::percent(prop, accuracy = 1)), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "Polyglobulie OMS2024",
    y = "Polyglobulie OMS2011",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
data = read.csv("data.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Anemie_SD)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.test(tbl, correct = correct, exact = TRUE)
    type <- "Test exact de McNemar"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "Test de McNemar (chi²)"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_SD)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_SD)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Proportions croisées anémie : OMS 2024 v.s. -1SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " = ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, Anemie_SD) %>%
  group_by(Anemie_SD) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = Anemie_SD, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = scales::percent(prop, accuracy = 1)), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "Anémie_OMS2024",
    y = "Anémie_SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
data = read.csv("data/diags.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Anemie_2SD)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.test(tbl, correct = correct, exact = TRUE)
    type <- "Test exact de McNemar"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "Test de McNemar (chi²)"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_2SD)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_2SD)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Proportions croisées anémie : OMS 2024 v.s. -2SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " = ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, Anemie_2SD) %>%
  group_by(Anemie_2SD) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = Anemie_2SD, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = scales::percent(prop, accuracy = 1)), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "Anémie_OMS2024",
    y = "Anemie_2SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
data = read.csv("data/diags.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Anemie_SD_Hbmass_kg)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.test(tbl, correct = correct, exact = TRUE)
    type <- "Test exact de McNemar"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "Test de McNemar (chi²)"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_SD_Hbmass_kg)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_SD_Hbmass_kg)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Proportions croisées anémie : OMS 2024 v.s. -1SD_Hbmass_kg\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, Anemie_SD_Hbmass_kg) %>%
  group_by(Anemie_SD_Hbmass_kg) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = Anemie_SD_Hbmass_kg, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = scales::percent(prop, accuracy = 1)), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "Anémie_OMS2024",
    y = "Anemie_SD_Hbmass_kg",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
data = read.csv("data/diags.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2024, Anemie_2SD_Hbmass_kg)

mcnemar_auto <- function(x, y, correct = FALSE) {
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  if (discordants < 25) {
    if (!requireNamespace("exact2x2", quietly = TRUE)) {
      stop("Le package 'exact2x2' est requis pour le test exact. Veuillez l'installer.")
    }
    res <- exact2x2::mcnemar.exact(tbl)
    type <- "Test exact de McNemar"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "Test de McNemar (chi²)"
  }

  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_2SD_Hbmass_kg)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2024, data_clean$Anemie_2SD_Hbmass_kg)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Proportions croisées anémie : OMS 2024 v.s. -2SD_Hbmass_kg\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2024, Anemie_2SD_Hbmass_kg) %>%
  group_by(Anemie_2SD_Hbmass_kg) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2024, y = Anemie_2SD_Hbmass_kg, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = scales::percent(prop, accuracy = 1)), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "Anémie_OMS2024",
    y = "Anemie_2SD_Hbmass_kg",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
data = read.csv("data.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2011, Anemie_SD)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.test(tbl, correct = correct, exact = TRUE)
    type <- "Test exact de McNemar"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "Test de McNemar (chi²)"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Anemie_SD)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Anemie_SD)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Proportions croisées anémie : OMS 2011 v.s. -1SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2011, Anemie_SD) %>%
  group_by(Anemie_SD) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2011, y = Anemie_SD, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = scales::percent(prop, accuracy = 1)), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "Anemie_OMS2011",
    y = "Anémie_SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
data = read.csv("data/diags.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2011, Anemie_2SD)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.test(tbl, correct = correct, exact = TRUE)
    type <- "Test exact de McNemar"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "Test de McNemar (chi²)"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Anemie_2SD)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Anemie_2SD)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Proportions croisées anémie : OMS 2011 v.s. -2SD\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2011, Anemie_2SD) %>%
  group_by(Anemie_2SD) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2011, y = Anemie_2SD, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = scales::percent(prop, accuracy = 1)), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "Anemie_OMS2011",
    y = "Anemie_2SD",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
data = read.csv("data/diags.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2011, Anemie_SD_Hbmass_kg)

mcnemar_auto <- function(x, y, correct = FALSE) {
  # Vérifier que x et y sont binaires
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  # Table de contingence
  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  # Test exact si discordants < 25
  if (discordants < 25) {
    res <- mcnemar.test(tbl, correct = correct, exact = TRUE)
    type <- "Test exact de McNemar"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "Test de McNemar (chi²)"
  }

  # Retourne un résumé
  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Anemie_SD_Hbmass_kg)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Anemie_SD_Hbmass_kg)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Proportions croisées anémie : OMS 2011 v.s. -1SD_Hbmass_kg\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2011, Anemie_SD_Hbmass_kg) %>%
  group_by(Anemie_SD_Hbmass_kg) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2011, y = Anemie_SD_Hbmass_kg, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = scales::percent(prop, accuracy = 1)), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "Anemie_OMS2011",
    y = "Anemie_SD_Hbmass_kg",
    fill = "Proportion"
  ) +
  theme_minimal()
```

```{r}
data = read.csv("data/diags.csv")
data_clean <- data %>%
  drop_na(Anemie_OMS2011, Anemie_2SD_Hbmass_kg)

mcnemar_auto <- function(x, y, correct = FALSE) {
  if (length(unique(na.omit(x))) != 2 || length(unique(na.omit(y))) != 2) {
    stop("Les deux variables doivent être binaires (2 modalités).")
  }

  tbl <- table(x, y)

  # Discordants
  n01 <- tbl[1, 2]
  n10 <- tbl[2, 1]
  discordants <- n01 + n10

  if (discordants < 25) {
    if (!requireNamespace("exact2x2", quietly = TRUE)) {
      stop("Le package 'exact2x2' est requis pour le test exact. Veuillez l'installer.")
    }
    res <- exact2x2::mcnemar.exact(tbl)
    type <- "Test exact de McNemar"
  } else {
    res <- mcnemar.test(tbl, correct = correct)
    type <- "Test de McNemar (chi²)"
  }

  list(
    table = tbl,
    method = type,
    statistic = res$statistic,
    p.value = res$p.value
  )
}

pval = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Anemie_2SD_Hbmass_kg)$p.value
methode = mcnemar_auto(data_clean$Anemie_OMS2011, data_clean$Anemie_2SD_Hbmass_kg)$method
n_total <- nrow(data_clean)

# Créer un titre dynamique
titre <- paste0(
  "Proportions croisées anémie : OMS 2011 v.s. -2SD_Hbmass_kg\n",
  "n = ", n_total, " ; ", "pval ", methode, " ~ ", round(pval, 3)
)

# Construire la heatmap
data_clean %>%
  count(Anemie_OMS2011, Anemie_2SD_Hbmass_kg) %>%
  group_by(Anemie_2SD_Hbmass_kg) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Anemie_OMS2011, y = Anemie_2SD_Hbmass_kg, fill = prop)) +
  geom_tile(color = "white") +
  geom_text(aes(label = scales::percent(prop, accuracy = 1)), size = 5) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(
    title = titre,
    x = "Anemie_OMS2011",
    y = "Anemie_2SD_Hbmass_kg",
    fill = "Proportion"
  ) +
  theme_minimal()
```



# HB HBMASS PVML

```{r}
# HB ~ HBMASS (g)
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle





data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ Hb.mass..g., data = df),
      mod2 = lm(HB ~ PV.ml., data = df),
      mod3 = lm(HB ~ Hb.mass..g. + PV.ml., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (Hbmass (g))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Ville_eval = modset$Ville_eval)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"


r2_labels <- coef_data %>%
  select(model, Ville_eval, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (Hbmass (g))`, `mod 2 (PV (ml))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HB ~ Hbmass (g) + PV (ml) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

r2_plot <- r2_labels %>%
  pivot_longer(cols = starts_with("mod"), names_to = "Modèle", values_to = "R2_adj")

ggplot(r2_plot, aes(x = Modèle, y = R2_adj, fill = Modèle)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  facet_wrap(~ Ville_eval) +
  labs(title = "Comparaison des R² ajustés par modèle et par ville",
       x = "Modèle", y = "R² ajusté") +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal()

ggplot(r2_plot, aes(x = Modèle, y = Ville_eval, fill = R2_adj)) +
  geom_tile(color = "white") +
  geom_text(aes(label = sprintf("%.2f", R2_adj)), color = "black") +
  scale_fill_gradient(low = "#fef0d9", high = "#d7301f") +
  labs(title = "Heatmap des R² ajustés", x = "Modèle", y = "Ville") +
  theme_minimal()
```

```{r}
# Modèles simples
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle





data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ Hb.mass..g., data = df),
      mod2 = lm(HB ~ Hb.mass.kg..g...kg., data = df),
      mod3 = lm(HB ~ RBC..106.µL., data = df),
      mod4 = lm(HB ~ RBCV..ml., data = df),
      mod5 = lm(HB ~ PV.ml., data = df),
      mod6 = lm(HB ~ PV..kg..ml.kg., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared
  r2_mod4 <- summary(modset$mod4)$adj.r.squared
  r2_mod5 <- summary(modset$mod5)$adj.r.squared
  r2_mod6 <- summary(modset$mod6)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "Hbmass (g)", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "Hbmass (g/kg)", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "RBC (106 µl)", r2_adj = r2_mod3),
    tidy(modset$mod4, conf.int = TRUE) %>%
      mutate(model = "RBCV (ml)", r2_adj = r2_mod4),
    tidy(modset$mod5, conf.int = TRUE) %>%
      mutate(model = "PV (ml)", r2_adj = r2_mod5),
    tidy(modset$mod6, conf.int = TRUE) %>%
      mutate(model = "PV (ml/kg)", r2_adj = r2_mod6),
  ) %>%
    mutate(Ville_eval = modset$Ville_eval)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"
coef_data$term[coef_data$term == "RBC..106.µL."] <- "RBC (106 µL)"
coef_data$term[coef_data$term == "RBCV..ml."] <- "RBCV (ml)"


r2_labels <- coef_data %>%
  select(model, Ville_eval, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj)

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HB ~ Hbmass (g) + PV (ml) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

r2_plot <- r2_labels %>%
  pivot_longer(cols = starts_with(c("H", "R", "P")), names_to = "Modèle", values_to = "R2_adj")

ggplot(r2_plot, aes(x = Modèle, y = R2_adj, fill = Modèle)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  facet_wrap(~ Ville_eval) +
  labs(title = "Comparaison des R² ajustés par modèle et par ville",
       x = "Modèle", y = "R² ajusté") +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal()

ggplot(r2_plot, aes(x = Modèle, y = Ville_eval, fill = R2_adj)) +
  geom_tile(color = "white") +
  geom_text(aes(label = sprintf("%.2f", R2_adj)), color = "black") +
  scale_fill_gradient(low = "white", high = "#d7301f") +
  labs(title = "Heatmap des R² ajustés", x = "Modèle", y = "Ville") +
  theme_minimal()
```

```{r}
# Modèles multiples
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle





data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ Hb.mass..g. + PV.ml., data = df),
      mod2 = lm(HB ~ Hb.mass.kg..g...kg. + PV.ml., data = df),
      mod3 = lm(HB ~ RBC..106.µL. + PV.ml., data = df),
      mod4 = lm(HB ~ RBCV..ml. + PV.ml., data = df),
      mod5 = lm(HB ~ Hb.mass..g. + PV..kg..ml.kg., data = df),
      mod6 = lm(HB ~ Hb.mass.kg..g...kg. + PV..kg..ml.kg., data = df),
      mod7 = lm(HB ~ RBC..106.µL. + PV..kg..ml.kg., data = df),
      mod8 = lm(HB ~ RBCV..ml. + PV..kg..ml.kg., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared
  r2_mod4 <- summary(modset$mod4)$adj.r.squared
  r2_mod5 <- summary(modset$mod5)$adj.r.squared
  r2_mod6 <- summary(modset$mod6)$adj.r.squared
  r2_mod7 <- summary(modset$mod7)$adj.r.squared
  r2_mod8 <- summary(modset$mod8)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "Hbmass (g) PV", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "Hbmass (g/kg) PV", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "RBC (106 µl) PV", r2_adj = r2_mod3),
    tidy(modset$mod4, conf.int = TRUE) %>%
      mutate(model = "RBCV (ml) PV", r2_adj = r2_mod4),
    tidy(modset$mod5, conf.int = TRUE) %>%
      mutate(model = "Hbmass (g) PVkg", r2_adj = r2_mod5),
    tidy(modset$mod6, conf.int = TRUE) %>%
      mutate(model = "Hbmass (g/kg) PVkg", r2_adj = r2_mod6),
    tidy(modset$mod7, conf.int = TRUE) %>%
      mutate(model = "RBC (106 µl) PVkg", r2_adj = r2_mod7),
    tidy(modset$mod8, conf.int = TRUE) %>%
      mutate(model = "RBCV (ml) PVkg", r2_adj = r2_mod8),
  ) %>%
    mutate(Ville_eval = modset$Ville_eval)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"
coef_data$term[coef_data$term == "RBC..106.µL."] <- "RBC (106 µL)"
coef_data$term[coef_data$term == "RBCV..ml."] <- "RBCV (ml)"


r2_labels <- coef_data %>%
  select(model, Ville_eval, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj)

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HB ~ Hbmass (g) + PV (ml) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

r2_plot <- r2_labels %>%
  pivot_longer(cols = starts_with(c("H", "R", "P")), names_to = "Modèle", values_to = "R2_adj")

ggplot(r2_plot, aes(x = Modèle, y = R2_adj, fill = Modèle)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  facet_wrap(~ Ville_eval) +
  labs(title = "Comparaison des R² ajustés par modèle et par ville",
       x = "Modèle", y = "R² ajusté") +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal()

ggplot(r2_plot, aes(x = Modèle, y = Ville_eval, fill = R2_adj)) +
  geom_tile(color = "white") +
  geom_text(aes(label = sprintf("%.2f", R2_adj)), color = "black") +
  scale_fill_gradient(low = "white", high = "#d7301f") +
  labs(title = "Heatmap des R² ajustés", x = "Modèle", y = "Ville") +
  theme_minimal()
```

```{r}
# HB ~ HBMASS (g/kg)
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle





data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ Hb.mass.kg..g...kg., data = df),
      mod2 = lm(HB ~ PV.ml., data = df),
      mod3 = lm(HB ~ Hb.mass.kg..g...kg. + PV.ml., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (Hbmass (g/kg))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Ville_eval = modset$Ville_eval)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"


r2_labels <- coef_data %>%
  select(model, Ville_eval, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (Hbmass (g/kg))`, `mod 2 (PV (ml))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HB ~ Hbmass (g/kg) + PV (ml) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HB ~ RBCV
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle





data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ RBCV..ml., data = df),
      mod2 = lm(HB ~ PV.ml., data = df),
      mod3 = lm(HB ~ RBCV..ml. + PV.ml., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (RBCV (ml))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Ville_eval = modset$Ville_eval)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "RBCV..ml."] <- "RBCV (ml)"


r2_labels <- coef_data %>%
  select(model, Ville_eval, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (RBCV (ml))`, `mod 2 (PV (ml))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HB ~ RBCV (ml) + PV (ml) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HB ~ RBC
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle





data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ RBC..106.µL., data = df),
      mod2 = lm(HB ~ PV.ml., data = df),
      mod3 = lm(HB ~ RBC..106.µL. + PV.ml., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (RBC (106 µL))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Ville_eval = modset$Ville_eval)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "RBC..106.µL."] <- "RBC (106 µL)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "RBCV..ml."] <- "RBCV (ml)"


r2_labels <- coef_data %>%
  select(model, Ville_eval, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (RBC (106 µL))`, `mod 2 (PV (ml))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HB ~ RBC (106 µL) + PV (ml) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HCT.. ~ HBMASS (g)
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle





data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HCT.. ~ Hb.mass..g., data = df),
      mod2 = lm(HCT.. ~ PV.ml., data = df),
      mod3 = lm(HCT.. ~ Hb.mass..g. + PV.ml., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (Hbmass (g))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Ville_eval = modset$Ville_eval)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"


r2_labels <- coef_data %>%
  select(model, Ville_eval, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (Hbmass (g))`, `mod 2 (PV (ml))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HCT ~ Hbmass (g) + PV (ml) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HCT.. ~ HBMASS (g/kg)
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle





data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HCT.. ~ Hb.mass.kg..g...kg., data = df),
      mod2 = lm(HCT.. ~ PV.ml., data = df),
      mod3 = lm(HCT.. ~ Hb.mass.kg..g...kg. + PV.ml., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (Hbmass (g/kg))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Ville_eval = modset$Ville_eval)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"


r2_labels <- coef_data %>%
  select(model, Ville_eval, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (Hbmass (g/kg))`, `mod 2 (PV (ml))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HCT ~ Hbmass (g/kg) + PV (ml) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HCT ~ RBCV
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle





data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HCT.. ~ RBCV..ml., data = df),
      mod2 = lm(HCT.. ~ PV.ml., data = df),
      mod3 = lm(HCT.. ~ RBCV..ml. + PV.ml., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (RBCV (ml))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Ville_eval = modset$Ville_eval)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "RBCV..ml."] <- "RBCV (ml)"


r2_labels <- coef_data %>%
  select(model, Ville_eval, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (RBCV (ml))`, `mod 2 (PV (ml))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HCT ~ RBCV (ml) + PV (ml) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HCT ~ RBC
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle





data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HCT.. ~ RBC..106.µL., data = df),
      mod2 = lm(HCT.. ~ PV.ml., data = df),
      mod3 = lm(HCT.. ~ RBC..106.µL. + PV.ml., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (RBC (106 µL))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Ville_eval = modset$Ville_eval)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "RBC..106.µL."] <- "RBC (106 µL)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "RBCV..ml."] <- "RBCV (ml)"


r2_labels <- coef_data %>%
  select(model, Ville_eval, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (RBC (106 µL))`, `mod 2 (PV (ml))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HCT ~ RBC (106 µL) + PV (ml) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

# PVKG

```{r}
# HB ~ HBMASS (g)
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle





data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ Hb.mass..g., data = df),
      mod2 = lm(HB ~ PV..kg..ml.kg., data = df),
      mod3 = lm(HB ~ Hb.mass..g. + PV..kg..ml.kg., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (Hbmass (g))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml/kg))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Ville_eval = modset$Ville_eval)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"


r2_labels <- coef_data %>%
  select(model, Ville_eval, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (Hbmass (g))`, `mod 2 (PV (ml/kg))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HB ~ Hbmass (g) + PV (ml/kg) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HB ~ HBMASS (g/kg)
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle





data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ Hb.mass.kg..g...kg., data = df),
      mod2 = lm(HB ~ PV..kg..ml.kg., data = df),
      mod3 = lm(HB ~ Hb.mass.kg..g...kg. + PV..kg..ml.kg., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (Hbmass (g/kg))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml/kg))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Ville_eval = modset$Ville_eval)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"


r2_labels <- coef_data %>%
  select(model, Ville_eval, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (Hbmass (g/kg))`, `mod 2 (PV (ml/kg))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HB ~ Hbmass (g/kg) + PV (ml/kg) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HB ~ HBMASS (g)
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle





data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ RBCV..ml., data = df),
      mod2 = lm(HB ~ PV..kg..ml.kg., data = df),
      mod3 = lm(HB ~ RBCV..ml. + PV..kg..ml.kg., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (RBCV (ml))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml/kg))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Ville_eval = modset$Ville_eval)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "RBCV..ml."] <- "RBCV (ml)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"


r2_labels <- coef_data %>%
  select(model, Ville_eval, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (RBCV (ml))`, `mod 2 (PV (ml/kg))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HB ~ RBCV (ml) + PV (ml/kg) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HB ~ RBC
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle





data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ RBC..106.µL., data = df),
      mod2 = lm(HB ~ PV..kg..ml.kg., data = df),
      mod3 = lm(HB ~ RBC..106.µL. + PV..kg..ml.kg., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (RBC (106 µL))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml/kg))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Ville_eval = modset$Ville_eval)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "RBC..106.µL."] <- "RBC (106 µL)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"
coef_data$term[coef_data$term == "RBCV..ml."] <- "RBCV (ml)"


r2_labels <- coef_data %>%
  select(model, Ville_eval, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (RBC (106 µL))`, `mod 2 (PV (ml/kg))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HB ~ RBC (106 µL) + PV (ml/kg) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HCT.. ~ HBMASS (g)
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle





data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HCT.. ~ Hb.mass..g., data = df),
      mod2 = lm(HCT.. ~ PV..kg..ml.kg., data = df),
      mod3 = lm(HCT.. ~ Hb.mass..g. + PV..kg..ml.kg., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (Hbmass (g))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml/kg))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Ville_eval = modset$Ville_eval)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"

r2_labels <- coef_data %>%
  select(model, Ville_eval, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (Hbmass (g))`, `mod 2 (PV (ml/kg))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HCT ~ Hbmass (g) + PV (ml/kg) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HCT.. ~ HBMASS (g/kg)
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle





data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HCT.. ~ Hb.mass.kg..g...kg., data = df),
      mod2 = lm(HCT.. ~ PV..kg..ml.kg., data = df),
      mod3 = lm(HCT.. ~ Hb.mass.kg..g...kg. + PV..kg..ml.kg., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (Hbmass (g/kg))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml/kg))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Ville_eval = modset$Ville_eval)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV.ml."] <- "PV (ml)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"

r2_labels <- coef_data %>%
  select(model, Ville_eval, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (Hbmass (g/kg))`, `mod 2 (PV (ml/kg))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HCT ~ Hbmass (g/kg) + PV (ml/kg) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HB ~ HBMASS (g)
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle





data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HCT.. ~ RBCV..ml., data = df),
      mod2 = lm(HCT.. ~ PV..kg..ml.kg., data = df),
      mod3 = lm(HCT.. ~ RBCV..ml. + PV..kg..ml.kg., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (RBCV (ml))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml/kg))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Ville_eval = modset$Ville_eval)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "Hb.mass..g."] <- "Hbmass (g)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "RBCV..ml."] <- "RBCV (ml)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"


r2_labels <- coef_data %>%
  select(model, Ville_eval, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (RBCV (ml))`, `mod 2 (PV (ml/kg))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HCT ~ RBCV (ml) + PV (ml/kg) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HCT ~ RBC
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle





data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HCT.. ~ RBC..106.µL., data = df),
      mod2 = lm(HCT.. ~ PV..kg..ml.kg., data = df),
      mod3 = lm(HCT.. ~ RBC..106.µL. + PV..kg..ml.kg., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "mod 1 (RBC (106 µL))", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "mod 2 (PV (ml/kg))", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "mod 3 (multiple)", r2_adj = r2_mod3),
  ) %>%
    mutate(Ville_eval = modset$Ville_eval)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "RBC..106.µL."] <- "RBC (106 µL)"
coef_data$term[coef_data$term == "Hb.mass.kg..g...kg."] <- "Hbmass (g/kg)"
coef_data$term[coef_data$term == "PV..kg..ml.kg."] <- "PV (ml/kg)"
coef_data$term[coef_data$term == "RBCV..ml."] <- "RBCV (ml)"


r2_labels <- coef_data %>%
  select(model, Ville_eval, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - mod1 : %.2f | mod2 : %.2f | mod3 : %.2f",
                         `mod 1 (RBC (106 µL))`, `mod 2 (PV (ml/kg))`, `mod 3 (multiple)`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Model", shape = "Significant ?", title = "Linear models : HCT ~ RBC (106 µL) + PV (ml/kg) by city in 8-12 years old") +
  scale_shape_manual(values = c("No" = 7, "Yes" = 15)) +
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

# RANK
```{r}
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle





data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

data$Rang_HB <- rank(data$HB)
data$Rang_HBMASS <- rank(data$Hb.mass.kg..g...kg.)


pvals_df <- data %>%
  group_by(Ville_eval) %>%
  summarise(
    p_value = t.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired t.test = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Ville_eval)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HB vs HBMASS (g/kg)) and paired Wilcoxon test \n for each city in 8-12 years old (n = 304)", x = "Rank HBMASS (g/kg)", y = "Rank HB", color = "City") +
  facet_wrap(~ Ville_eval)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```

```{r}
data$Rang_HB <- rank(data$HB)
data$Rang_HBMASS <- rank(data$Hb.mass..g.)


pvals_df <- data %>%
  group_by(Ville_eval) %>%
  summarise(
    p_value = wilcox.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired wilcoxon = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Ville_eval)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HB vs HBMASS (g)) and paired Wilcoxon test \n for each city in 8-12 years old", x = "Rank HBMASS (g)", y = "Rank HB", color = "City") +
  facet_wrap(~ Ville_eval)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```

```{r}
data$Rang_HB <- rank(data$HB)
data$Rang_HBMASS <- rank(data$RBCV..ml.)


pvals_df <- data %>%
  group_by(Ville_eval) %>%
  summarise(
    p_value = wilcox.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired wilcoxon = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Ville_eval)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HB vs RBCV (ml)) and paired Wilcoxon test \n for each city in 8-12 years old", x = "Rank RBCV (ml)", y = "Rank HB", color = "City") +
  facet_wrap(~ Ville_eval)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```

```{r}
data$Rang_HB <- rank(data$HB)
data$Rang_HBMASS <- rank(data$RBC..106.µL.)


pvals_df <- data %>%
  group_by(Ville_eval) %>%
  summarise(
    p_value = wilcox.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired wilcoxon = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Ville_eval)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HB vs RBC (106 µL)) and paired Wilcoxon test \n for each city in 8-12 years old", x = "Rank RBC (106 µL)", y = "Rank HB", color = "City") +
  facet_wrap(~ Ville_eval)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```

```{r}
data$Rang_HB <- rank(data$HB)
data$Rang_HBMASS <- rank(data$PV.ml.)


pvals_df <- data %>%
  group_by(Ville_eval) %>%
  summarise(
    p_value = wilcox.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired wilcoxon = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Ville_eval)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HB vs PV (ml)) and paired Wilcoxon test \n for each city in 8-12 years old", x = "Rank PV (ml)", y = "Rank HB", color = "City") +
  facet_wrap(~ Ville_eval)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```

```{r}
data$Rang_HB <- rank(data$HCT..)
data$Rang_HBMASS <- rank(data$Hb.mass.kg..g...kg.)


pvals_df <- data %>%
  group_by(Ville_eval) %>%
  summarise(
    p_value = wilcox.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired wilcoxon = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Ville_eval)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HCT vs HBMASS (g/kg)) and paired Wilcoxon test \n for each city in 8-12 years old", x = "Rank HBMASS (g/kg)", y = "Rank HCT", color = "City") +
  facet_wrap(~ Ville_eval)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```

```{r}
data$Rang_HB <- rank(data$HCT..)
data$Rang_HBMASS <- rank(data$Hb.mass..g.)


pvals_df <- data %>%
  group_by(Ville_eval) %>%
  summarise(
    p_value = wilcox.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired wilcoxon = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Ville_eval)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HCT vs HBMASS (g) and paired Wilcoxon test \n for each city in 8-12 years old", x = "Rank HBMASS (g)", y = "Rank HCT", color = "City") +
  facet_wrap(~ Ville_eval)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```

```{r}
data$Rang_HB <- rank(data$HCT..)
data$Rang_HBMASS <- rank(data$RBCV..ml.)


pvals_df <- data %>%
  group_by(Ville_eval) %>%
  summarise(
    p_value = wilcox.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired wilcoxon = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Ville_eval)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HCT vs RBCV (ml) and paired Wilcoxon test \n for each city in 8-12 years old", x = "Rank RBCV (ml)", y = "Rank HCT", color = "City") +
  facet_wrap(~ Ville_eval)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```

```{r}
data$Rang_HB <- rank(data$HCT..)
data$Rang_HBMASS <- rank(data$RBC..106.µL.)


pvals_df <- data %>%
  group_by(Ville_eval) %>%
  summarise(
    p_value = wilcox.test(Rang_HB, Rang_HBMASS, paired = TRUE)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    label = paste0("pval paired wilcoxon = ", signif(p_value, 3))
  )

ggplot(data, aes(x = Rang_HBMASS, y = Rang_HB, color = Ville_eval)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Rank comparison (HCT vs RBC (106 µL)) and paired Wilcoxon test \n for each city in 8-12 years old", x = "Rank RBC (106 µL)", y = "Rank HCT", color = "City") +
  facet_wrap(~ Ville_eval)+ 
  geom_text(
    data = pvals_df,
    aes(x = 100, y = max(data$Rang_HB, na.rm = TRUE), label = label),
    inherit.aes = FALSE,
    size = 3
  )
```

```{r}
data = read.csv("data/datafinal.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]

mod1 = lm(HB ~ Hb.mass.kg..g...kg., data = data[data$Ville_eval == "Lima",])
mod2 = lm(HB ~ Hb.mass.kg..g...kg., data = data[data$Ville_eval == "Cusco",])
mod3 = lm(HB ~ Hb.mass.kg..g...kg., data = data[data$Ville_eval == "Juliaca",])
mod4 = lm(HB ~ Hb.mass.kg..g...kg., data = data[data$Ville_eval == "Rinconada",])

label_models_r2adj <- function(models) {
  model_names <- names(models)
  r2_labeled <- sapply(model_names, function(name) {
    r2_adj <- summary(models[[name]])$adj.r.squared
    sprintf("%s (R² adj = %.2f)", name, r2_adj)
  })
  names(models) <- r2_labeled
  return(models)
}

models <- list(
  "1 : Lima" = mod1,
  "2 : Cusco" = mod2,
  "3 : Juliaca" = mod3,
  "4 : La Rinconada" = mod4
)

models <- label_models_r2adj(models)

coef_data <- bind_rows(lapply(seq_along(models), function(i) {
  tidy(models[[i]], conf.int = TRUE) %>%
    mutate(model = names(models)[i])  # ✅ utilise les noms renommés
}))

term_order <- coef_data %>%
  group_by(term) %>%
  summarise(n_models = n_distinct(model)) %>%
  arrange(-n_models) %>%
  pull(term)

# Réordonner les termes selon la fréquence croissante
coef_data <- coef_data %>%
  mutate(term = factor(term, levels = term_order))

# Ajouter colonne de significativité (IC ne contenant pas 0)
coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%  # Enlever intercept si souhaité
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

# Tracer le graphique
ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Model", shape = "Significatif ?", title = "Evolution de HB en fonction de HBMASS (g/kg) par altitude") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
data = read.csv("data/datafinal.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]

mod1 = lm(HB ~ Hb.mass..g., data = data[data$Ville_eval == "Lima",])
mod2 = lm(HB ~ Hb.mass..g., data = data[data$Ville_eval == "Cusco",])
mod3 = lm(HB ~ Hb.mass..g., data = data[data$Ville_eval == "Juliaca",])
mod4 = lm(HB ~ Hb.mass..g., data = data[data$Ville_eval == "Rinconada",])

label_models_r2adj <- function(models) {
  model_names <- names(models)
  r2_labeled <- sapply(model_names, function(name) {
    r2_adj <- summary(models[[name]])$adj.r.squared
    sprintf("%s (R² adj = %.2f)", name, r2_adj)
  })
  names(models) <- r2_labeled
  return(models)
}

models <- list(
  "1 : Lima" = mod1,
  "2 : Cusco" = mod2,
  "3 : Juliaca" = mod3,
  "4 : La Rinconada" = mod4
)

models <- label_models_r2adj(models)

coef_data <- bind_rows(lapply(seq_along(models), function(i) {
  tidy(models[[i]], conf.int = TRUE) %>%
    mutate(model = names(models)[i])  # ✅ utilise les noms renommés
}))

term_order <- coef_data %>%
  group_by(term) %>%
  summarise(n_models = n_distinct(model)) %>%
  arrange(-n_models) %>%
  pull(term)

# Réordonner les termes selon la fréquence croissante
coef_data <- coef_data %>%
  mutate(term = factor(term, levels = term_order))

# Ajouter colonne de significativité (IC ne contenant pas 0)
coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%  # Enlever intercept si souhaité
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

# Tracer le graphique
ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Model", shape = "Significatif ?", title = "Evolution de HB en fonction de HBMASS (g) par altitude") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
data = read.csv("data/datafinal.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]

mod1 = lm(HCT.. ~ Hb.mass.kg..g...kg., data = data[data$Ville_eval == "Lima",])
mod2 = lm(HCT.. ~ Hb.mass.kg..g...kg., data = data[data$Ville_eval == "Cusco",])
mod3 = lm(HCT.. ~ Hb.mass.kg..g...kg., data = data[data$Ville_eval == "Juliaca",])
mod4 = lm(HCT.. ~ Hb.mass.kg..g...kg., data = data[data$Ville_eval == "Rinconada",])

label_models_r2adj <- function(models) {
  model_names <- names(models)
  r2_labeled <- sapply(model_names, function(name) {
    r2_adj <- summary(models[[name]])$adj.r.squared
    sprintf("%s (R² adj = %.2f)", name, r2_adj)
  })
  names(models) <- r2_labeled
  return(models)
}

models <- list(
  "1 : Lima" = mod1,
  "2 : Cusco" = mod2,
  "3 : Juliaca" = mod3,
  "4 : La Rinconada" = mod4
)

models <- label_models_r2adj(models)

coef_data <- bind_rows(lapply(seq_along(models), function(i) {
  tidy(models[[i]], conf.int = TRUE) %>%
    mutate(model = names(models)[i])  # ✅ utilise les noms renommés
}))

term_order <- coef_data %>%
  group_by(term) %>%
  summarise(n_models = n_distinct(model)) %>%
  arrange(-n_models) %>%
  pull(term)

# Réordonner les termes selon la fréquence croissante
coef_data <- coef_data %>%
  mutate(term = factor(term, levels = term_order))

# Ajouter colonne de significativité (IC ne contenant pas 0)
coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%  # Enlever intercept si souhaité
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

# Tracer le graphique
ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Model", shape = "Significatif ?", title = "Evolution de HCT en fonction de HBMASS (g/kg) par altitude") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
data = read.csv("data/datafinal.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]

mod1 = lm(HCT.. ~ Hb.mass..g., data = data[data$Ville_eval == "Lima",])
mod2 = lm(HCT.. ~ Hb.mass..g., data = data[data$Ville_eval == "Cusco",])
mod3 = lm(HCT.. ~ Hb.mass..g., data = data[data$Ville_eval == "Juliaca",])
mod4 = lm(HCT.. ~ Hb.mass..g., data = data[data$Ville_eval == "Rinconada",])

label_models_r2adj <- function(models) {
  model_names <- names(models)
  r2_labeled <- sapply(model_names, function(name) {
    r2_adj <- summary(models[[name]])$adj.r.squared
    sprintf("%s (R² adj = %.2f)", name, r2_adj)
  })
  names(models) <- r2_labeled
  return(models)
}

models <- list(
  "1 : Lima" = mod1,
  "2 : Cusco" = mod2,
  "3 : Juliaca" = mod3,
  "4 : La Rinconada" = mod4
)

models <- label_models_r2adj(models)

coef_data <- bind_rows(lapply(seq_along(models), function(i) {
  tidy(models[[i]], conf.int = TRUE) %>%
    mutate(model = names(models)[i])  # ✅ utilise les noms renommés
}))

term_order <- coef_data %>%
  group_by(term) %>%
  summarise(n_models = n_distinct(model)) %>%
  arrange(-n_models) %>%
  pull(term)

# Réordonner les termes selon la fréquence croissante
coef_data <- coef_data %>%
  mutate(term = factor(term, levels = term_order))

# Ajouter colonne de significativité (IC ne contenant pas 0)
coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%  # Enlever intercept si souhaité
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

# Tracer le graphique
ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Model", shape = "Significatif ?", title = "Evolution de HCT en fonction de HBMASS (g) par altitude") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
data = read.csv("data/datafinal.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]

mod1 = lm(HB ~ PV..kg..ml.kg., data = data[data$Ville_eval == "Lima",])
mod2 = lm(HB ~ PV..kg..ml.kg., data = data[data$Ville_eval == "Cusco",])
mod3 = lm(HB ~ PV..kg..ml.kg., data = data[data$Ville_eval == "Juliaca",])
mod4 = lm(HB ~ PV..kg..ml.kg., data = data[data$Ville_eval == "Rinconada",])

label_models_r2adj <- function(models) {
  model_names <- names(models)
  r2_labeled <- sapply(model_names, function(name) {
    r2_adj <- summary(models[[name]])$adj.r.squared
    sprintf("%s (R² adj = %.2f)", name, r2_adj)
  })
  names(models) <- r2_labeled
  return(models)
}

models <- list(
  "1 : Lima" = mod1,
  "2 : Cusco" = mod2,
  "3 : Juliaca" = mod3,
  "4 : La Rinconada" = mod4
)

models <- label_models_r2adj(models)

coef_data <- bind_rows(lapply(seq_along(models), function(i) {
  tidy(models[[i]], conf.int = TRUE) %>%
    mutate(model = names(models)[i])  # ✅ utilise les noms renommés
}))

term_order <- coef_data %>%
  group_by(term) %>%
  summarise(n_models = n_distinct(model)) %>%
  arrange(-n_models) %>%
  pull(term)

# Réordonner les termes selon la fréquence croissante
coef_data <- coef_data %>%
  mutate(term = factor(term, levels = term_order))

# Ajouter colonne de significativité (IC ne contenant pas 0)
coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%  # Enlever intercept si souhaité
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

# Tracer le graphique
ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Model", shape = "Significatif ?", title = "Evolution de HB en fonction de HBMASS (g) par altitude") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
data = read.csv("data/datafinal.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]

mod1 = lm(HCT.. ~ PV..kg..ml.kg., data = data[data$Ville_eval == "Lima",])
mod2 = lm(HCT.. ~ PV..kg..ml.kg., data = data[data$Ville_eval == "Cusco",])
mod3 = lm(HCT.. ~ PV..kg..ml.kg., data = data[data$Ville_eval == "Juliaca",])
mod4 = lm(HCT.. ~ PV..kg..ml.kg., data = data[data$Ville_eval == "Rinconada",])

label_models_r2adj <- function(models) {
  model_names <- names(models)
  r2_labeled <- sapply(model_names, function(name) {
    r2_adj <- summary(models[[name]])$adj.r.squared
    sprintf("%s (R² adj = %.2f)", name, r2_adj)
  })
  names(models) <- r2_labeled
  return(models)
}

models <- list(
  "1 : Lima" = mod1,
  "2 : Cusco" = mod2,
  "3 : Juliaca" = mod3,
  "4 : La Rinconada" = mod4
)

models <- label_models_r2adj(models)

coef_data <- bind_rows(lapply(seq_along(models), function(i) {
  tidy(models[[i]], conf.int = TRUE) %>%
    mutate(model = names(models)[i])  # ✅ utilise les noms renommés
}))

term_order <- coef_data %>%
  group_by(term) %>%
  summarise(n_models = n_distinct(model)) %>%
  arrange(-n_models) %>%
  pull(term)

# Réordonner les termes selon la fréquence croissante
coef_data <- coef_data %>%
  mutate(term = factor(term, levels = term_order))

# Ajouter colonne de significativité (IC ne contenant pas 0)
coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%  # Enlever intercept si souhaité
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

# Tracer le graphique
ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Model", shape = "Significatif ?", title = "Evolution de HB en fonction de HBMASS (g) par altitude") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  theme_minimal() +
  theme(legend.position = "bottom")
```



```{r}
# HB ~ HBMASS (g/kg) + PV
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle
data$Ville_eval <- as.factor(data$Ville_eval)  # ou adapte si autre nom

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ Hb.mass.kg..g...kg., data = df),
      mod2 = lm(HB ~ Hb.mass.kg..g...kg. + PV.ml., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "Modèle 1", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "Modèle 2", r2_adj = r2_mod2)
  ) %>%
    mutate(Ville_eval = modset$Ville_eval)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

r2_labels <- coef_data %>%
  select(model, Ville_eval, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - Modèle 1 : %.2f | Modèle 2 : %.2f",
                         `Modèle 1`, `Modèle 2`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Modèle", shape = "Significatif ?", title = "Modèles HB ~ Hbmass (g/kg) + PV par altitude") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HB ~ RBCV + PV
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle
data$Ville_eval <- as.factor(data$Ville_eval)  # ou adapte si autre nom

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ RBCV..ml., data = df),
      mod2 = lm(HB ~ PV.ml., data = df),
      mod3 = lm(HB ~ RBCV..ml. + PV.ml., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared
  r2_mod3 <- summary(modset$mod3)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "Modèle 1", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "Modèle 2", r2_adj = r2_mod2),
    tidy(modset$mod3, conf.int = TRUE) %>%
      mutate(model = "Modèle 3", r2_adj = r2_mod3)
  ) %>%
    mutate(Ville_eval = modset$Ville_eval)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

r2_labels <- coef_data %>%
  select(model, Ville_eval, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - Modèle 1 : %.2f | Modèle 2 : %.2f | Modèle 3 : %.2f",
                         `Modèle 1`, `Modèle 2`, `Modèle 3`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Modèle", shape = "Significatif ?", title = "Modèles HB ~ RBCV + PV par altitude") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HB ~ RBCV + PV
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle
data$Ville_eval <- as.factor(data$Ville_eval)  # ou adapte si autre nom

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ RBC..106.µL., data = df),
      mod2 = lm(HB ~ RBC..106.µL. + PV.ml., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "Modèle 1", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "Modèle 2", r2_adj = r2_mod2)
  ) %>%
    mutate(Ville_eval = modset$Ville_eval)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

r2_labels <- coef_data %>%
  select(model, Ville_eval, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - Modèle 1 : %.2f | Modèle 2 : %.2f",
                         `Modèle 1`, `Modèle 2`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Modèle", shape = "Significatif ?", title = "Modèles HB ~ RBC + PV par altitude") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HCT ~ HBMASS (g/kg) + PV
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle
data$Ville_eval <- as.factor(data$Ville_eval)  # ou adapte si autre nom

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HCT.. ~ Hb.mass.kg..g...kg., data = df),
      mod2 = lm(HCT.. ~ Hb.mass.kg..g...kg. + PV.ml., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "Modèle 1", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "Modèle 2", r2_adj = r2_mod2)
  ) %>%
    mutate(Ville_eval = modset$Ville_eval)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

r2_labels <- coef_data %>%
  select(model, Ville_eval, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - Modèle 1 : %.2f | Modèle 2 : %.2f",
                         `Modèle 1`, `Modèle 2`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Modèle", shape = "Significatif ?", title = "Modèles HCT ~ Hbmass (g/kg) + PV par altitude") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HB ~ RBCV + PV
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle
data$Ville_eval <- as.factor(data$Ville_eval)  # ou adapte si autre nom

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HCT.. ~ RBCV..ml., data = df),
      mod2 = lm(HCT.. ~ RBCV..ml. + PV.ml., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "Modèle 1", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "Modèle 2", r2_adj = r2_mod2)
  ) %>%
    mutate(Ville_eval = modset$Ville_eval)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

r2_labels <- coef_data %>%
  select(model, Ville_eval, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - Modèle 1 : %.2f | Modèle 2 : %.2f",
                         `Modèle 1`, `Modèle 2`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Modèle", shape = "Significatif ?", title = "Modèles HCT ~ RBCV + PV par altitude") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HB ~ RBCV + PV
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans", ]

# Vérifie bien que Ville_eval est un facteur ou une variable catégorielle
data$Ville_eval <- as.factor(data$Ville_eval)  # ou adapte si autre nom

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HCT.. ~ RBC..106.µL., data = df),
      mod2 = lm(HCT.. ~ RBC..106.µL. + PV.ml., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- bind_rows(lapply(models_by_altitude, function(modset) {
  # R² ajustés
  r2_mod1 <- summary(modset$mod1)$adj.r.squared
  r2_mod2 <- summary(modset$mod2)$adj.r.squared

  bind_rows(
    tidy(modset$mod1, conf.int = TRUE) %>%
      mutate(model = "Modèle 1", r2_adj = r2_mod1),
    tidy(modset$mod2, conf.int = TRUE) %>%
      mutate(model = "Modèle 2", r2_adj = r2_mod2)
  ) %>%
    mutate(Ville_eval = modset$Ville_eval)
}))

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Oui", "Non"))

r2_labels <- coef_data %>%
  select(model, Ville_eval, r2_adj) %>%
  distinct() %>%
  pivot_wider(names_from = model, values_from = r2_adj) %>%
  mutate(label = sprintf("R² adj - Modèle 1 : %.2f | Modèle 2 : %.2f",
                         `Modèle 1`, `Modèle 2`))

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  geom_text(
    data = r2_labels,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.45, vjust = 1.5,
    inherit.aes = FALSE,
    size = 3
  ) +
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Modèle", shape = "Significatif ?", title = "Modèles HCT ~ RBC + PV par altitude") +
  scale_shape_manual(values = c("Non" = 7, "Oui" = 15)) +
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

# Prevalence par ville pour chaque methode
## Anemie

```{r}
data = read.csv("data/diags.csv")
data = data[data$Age_categorie_binaire == "0-3 ans", ]
data = data[, -c(10,11,12,13)]
data_long <- data %>%
  pivot_longer(
    cols = starts_with("Anemie_"),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Anémie"
  )

data_long$Ville_eval[data_long$Ville_eval == "Lima"] <- "Lima (150m)"
data_long$Ville_eval[data_long$Ville_eval == "Cusco"] <- "Cusco (3400m)"
data_long$Ville_eval[data_long$Ville_eval == "Juliaca"] <- "Juliaca (3800m)"
data_long$Ville_eval[data_long$Ville_eval == "Rinconada"] <- "La Rinconada \n (5100m - 5300m)"

data_long$Méthode <- gsub("Anemie_", "", data_long$Méthode)
data_long$Méthode <- gsub("_kg", "/kg)", data_long$Méthode)
data_long$Méthode <- gsub("_", " (", data_long$Méthode)
data_long$Méthode <- factor(data_long$Méthode, levels = c("OMS2011", "SD", "SD (Hbmass/kg)", "OMS2024" , "2SD", "2SD (Hbmass/kg)"))

global_tests <- data_long %>%
  group_by(Méthode) %>%
  summarise(
    p_global = {
      tbl <- table(Ville_eval, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

ville_pairs <- combn(unique(data_long$Ville_eval), 2, simplify = FALSE)

# Fonction pour calculer les p-values pour chaque paire de villes et chaque méthode
all_pvals <- lapply(ville_pairs, function(pair) {
  ville1 <- pair[1]
  ville2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Ville_eval %in% pair)
  
  data_sub %>%
    group_by(Méthode) %>%
    summarise(
      p = {
        tbl <- table(Ville_eval, Résultat_bin)
        if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
      },
      group1 = ville1,
      group2 = ville2,
      .groups = "drop"
    )
})

# Fusionner toutes les paires
p_values <- bind_rows(all_pvals)
p_values <- p_values %>%
  group_by(Méthode) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),  # méthode possible : "bonferroni", "holm", "BH", etc.
    p.signif.adj = case_when(
      p_adj < 0.01 ~ "***",
      p_adj < 0.05  ~ "**",
      p_adj < 0.1  ~ "*",
      TRUE          ~ "ns"
    )
  ) %>%
  ungroup()
p_values <- p_values %>%
  left_join(global_tests, by = "Méthode") %>%
  filter(p_global < 0.1)


# Ajouter des positions Y pour éviter le chevauchement des p-values
max_prev <- prevalence %>% group_by(Méthode) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Méthode") %>%
  group_by(Méthode) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

p_values_sig <- p_values %>% filter(p_adj < 0.1)

ggplot(data_long, aes(x = Ville_eval, y = Résultat_bin * 100, fill = Ville_eval)) +
  scale_x_discrete(limits = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada \n (5100m - 5300m)")) +
  scale_fill_manual(values = c(
    "Lima (150m)" = "#1b9e77",
    "Cusco (3400m)" = "#d95f02",
    "Juliaca (3800m)" = "#7570b3",
    "La Rinconada \n (5100m - 5300m)" = "#e7298a"
  )) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  stat_pvalue_manual(
    data = p_values_sig,
    label = "p.signif.adj",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  facet_wrap(~ Méthode, scales = "fixed") +
  labs(
    title = "Anemia prevalence in 0-3 year olds for each methods, by city",
    x = "City",
    y = "Prevalence (%) \n Anemia",
    fill = "City",
  caption = "* p < 0.1   ** p < 0.05   *** p < 0.01"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
data = read.csv("data/diags.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]
data = data[, -c(10,13)]
data_long <- data %>%
  pivot_longer(
    cols = starts_with("Anemie_"),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Anémie"
  )

data_long$Ville_eval[data_long$Ville_eval == "Lima"] <- "Lima (150m)"
data_long$Ville_eval[data_long$Ville_eval == "Cusco"] <- "Cusco (3400m)"
data_long$Ville_eval[data_long$Ville_eval == "Juliaca"] <- "Juliaca (3800m)"
data_long$Ville_eval[data_long$Ville_eval == "Rinconada"] <- "La Rinconada \n (5100m - 5300m)"

data_long$Méthode <- gsub("Anemie_", "", data_long$Méthode)
data_long$Méthode <- gsub("_kg", "/kg)", data_long$Méthode)
data_long$Méthode <- gsub("_", " (", data_long$Méthode)
data_long$Méthode <- factor(data_long$Méthode, levels = c("OMS2011", "SD", "SD (Hbmass/kg)", "OMS2024" , "2SD", "2SD (Hbmass/kg)"))


global_tests <- data_long %>%
  group_by(Méthode) %>%
  summarise(
    p_global = {
      tbl <- table(Ville_eval, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

ville_pairs <- combn(unique(data_long$Ville_eval), 2, simplify = FALSE)

# Fonction pour calculer les p-values pour chaque paire de villes et chaque méthode
all_pvals <- lapply(ville_pairs, function(pair) {
  ville1 <- pair[1]
  ville2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Ville_eval %in% pair)
  
  data_sub %>%
    group_by(Méthode) %>%
    summarise(
      p = {
        tbl <- table(Ville_eval, Résultat_bin)
        if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
      },
      group1 = ville1,
      group2 = ville2,
      .groups = "drop"
    )
})

# Fusionner toutes les paires
p_values <- bind_rows(all_pvals)
p_values <- p_values %>%
  group_by(Méthode) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),  # méthode possible : "bonferroni", "holm", "BH", etc.
    p.signif.adj = case_when(
      p_adj < 0.01 ~ "***",
      p_adj < 0.05  ~ "**",
      p_adj < 0.1  ~ "*",
      TRUE          ~ "ns"
    )
  ) %>%
  ungroup()
p_values <- p_values %>%
  left_join(global_tests, by = "Méthode") %>%
  filter(p_global < 0.1)


# Ajouter des positions Y pour éviter le chevauchement des p-values
max_prev <- prevalence %>% group_by(Méthode) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Méthode") %>%
  group_by(Méthode) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

p_values_sig <- p_values %>% filter(p_adj < 0.1)

ggplot(data_long, aes(x = Ville_eval, y = Résultat_bin * 100, fill = Ville_eval)) +
  scale_x_discrete(limits = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada \n (5100m - 5300m)")) +
  scale_fill_manual(values = c(
    "Lima (150m)" = "#1b9e77",
    "Cusco (3400m)" = "#d95f02",
    "Juliaca (3800m)" = "#7570b3",
    "La Rinconada \n (5100m - 5300m)" = "#e7298a"
  )) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  stat_pvalue_manual(
    data = p_values_sig,
    label = "p.signif.adj",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  facet_wrap(~ Méthode, scales = "fixed") +
labs(
    title = "Anemia prevalence in 8-12 year olds for each methods, by city",
    x = "City",
    y = "Prevalence (%) \n Anemia",
    fill = "City",
  caption = "* p < 0.1   ** p < 0.05   *** p < 0.01"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Polyglobulie

```{r}
data = read.csv("data/diags.csv")
data = data[data$Age_categorie_binaire == "0-3 ans", ]
data = data[, -c(18,19,20,21)]
data_long <- data %>%
  pivot_longer(
    cols = starts_with("Polyglobulie_"),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Polyglobulie"
  )

data_long$Ville_eval[data_long$Ville_eval == "Lima"] <- "Lima (150m)"
data_long$Ville_eval[data_long$Ville_eval == "Cusco"] <- "Cusco (3400m)"
data_long$Ville_eval[data_long$Ville_eval == "Juliaca"] <- "Juliaca (3800m)"
data_long$Ville_eval[data_long$Ville_eval == "Rinconada"] <- "La Rinconada \n (5100m - 5300m)"

data_long$Méthode <- gsub("Polyglobulie_", "", data_long$Méthode)
data_long$Méthode <- gsub("14.5_", "", data_long$Méthode)
data_long$Méthode <- gsub("_kg", "/kg)", data_long$Méthode)
data_long$Méthode <- gsub("_", " (", data_long$Méthode)
data_long$Méthode <- factor(data_long$Méthode, levels = c("OMS2011", "SD", "SD (Hbmass/kg)", "OMS2024" , "2SD", "2SD (Hbmass/kg)"))

levels(data_long$Ville_eval) <- c(
  "Lima (150m)",
  "Cusco (3400m)",
  "Juliaca (3800m)",
  "La Rinconada \n (5100m - 5300m)"
)

global_tests <- data_long %>%
  group_by(Méthode) %>%
  summarise(
    p_global = {
      tbl <- table(Ville_eval, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

ville_pairs <- combn(unique(data_long$Ville_eval), 2, simplify = FALSE)

# Fonction pour calculer les p-values pour chaque paire de villes et chaque méthode
all_pvals <- lapply(ville_pairs, function(pair) {
  ville1 <- pair[1]
  ville2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Ville_eval %in% pair)
  
  data_sub %>%
    group_by(Méthode) %>%
    summarise(
      p = {
        tbl <- table(Ville_eval, Résultat_bin)
        if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
      },
      group1 = ville1,
      group2 = ville2,
      .groups = "drop"
    )
})

# Fusionner toutes les paires
p_values <- bind_rows(all_pvals)
p_values <- p_values %>%
  group_by(Méthode) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),  # méthode possible : "bonferroni", "holm", "BH", etc.
    p.signif.adj = case_when(
      p_adj < 0.01 ~ "***",
      p_adj < 0.05  ~ "**",
      p_adj < 0.1  ~ "*",
      TRUE          ~ "ns"
    )
  ) %>%
  ungroup()
p_values <- p_values %>%
  left_join(global_tests, by = "Méthode") %>%
  filter(p_global < 0.1)


# Ajouter des positions Y pour éviter le chevauchement des p-values
max_prev <- prevalence %>% group_by(Méthode) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Méthode") %>%
  group_by(Méthode) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

p_values_sig <- p_values %>% filter(p_adj < 0.1)

ggplot(data_long, aes(x = Ville_eval, y = Résultat_bin * 100, fill = Ville_eval)) +
  scale_x_discrete(limits = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada \n (5100m - 5300m)")) +
  scale_fill_manual(values = c(
    "Lima (150m)" = "#1b9e77",
    "Cusco (3400m)" = "#d95f02",
    "Juliaca (3800m)" = "#7570b3",
    "La Rinconada \n (5100m - 5300m)" = "#e7298a"
  )) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  facet_wrap(~ Méthode, scales = "fixed") +
labs(
    title = "Polycythemia prevalence in 0-3 year olds for each methods, by city",
    x = "City",
    y = "Prevalence (%) \n polycythemia",
    fill = "City",
  caption = "* p < 0.1   ** p < 0.05   *** p < 0.01"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
data = read.csv("data/diags.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]
data = data[, -c(18,21)]
data_long <- data %>%
  pivot_longer(
    cols = starts_with("Polyglobulie_"),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Polyglobulie"
  )

data_long$Ville_eval <- factor(data_long$Ville_eval, levels = c("Lima", "Cusco", "Juliaca", "Rinconada"))
data_long$Méthode <- gsub("Polyglobulie_", "", data_long$Méthode)
data_long$Méthode <- gsub("14.5_", "", data_long$Méthode)
data_long$Méthode <- gsub("_kg", "/kg)", data_long$Méthode)
data_long$Méthode <- gsub("_", " (", data_long$Méthode)
data_long$Méthode <- factor(data_long$Méthode, levels = c("OMS2011", "SD", "SD (Hbmass/kg)", "OMS2024" , "2SD", "2SD (Hbmass/kg)"))

levels(data_long$Ville_eval) <- c(
  "Lima (150m)",
  "Cusco (3400m)",
  "Juliaca (3800m)",
  "La Rinconada \n (5100m - 5300m)"
)

global_tests <- data_long %>%
  group_by(Méthode) %>%
  summarise(
    p_global = {
      tbl <- table(Ville_eval, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

ville_pairs <- combn(unique(data_long$Ville_eval), 2, simplify = FALSE)

# Fonction pour calculer les p-values pour chaque paire de villes et chaque méthode
all_pvals <- lapply(ville_pairs, function(pair) {
  ville1 <- pair[1]
  ville2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Ville_eval %in% pair)
  
  data_sub %>%
    group_by(Méthode) %>%
    summarise(
      p = {
        tbl <- table(Ville_eval, Résultat_bin)
        if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
      },
      group1 = ville1,
      group2 = ville2,
      .groups = "drop"
    )
})

# Fusionner toutes les paires
p_values <- bind_rows(all_pvals)
p_values <- p_values %>%
  group_by(Méthode) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),  # méthode possible : "bonferroni", "holm", "BH", etc.
    p.signif.adj = case_when(
      p_adj < 0.01 ~ "***",
      p_adj < 0.05  ~ "**",
      p_adj < 0.1  ~ "*",
      TRUE          ~ "ns"
    )
  ) %>%
  ungroup()
p_values <- p_values %>%
  left_join(global_tests, by = "Méthode") %>%
  filter(p_global < 0.1)


# Ajouter des positions Y pour éviter le chevauchement des p-values
max_prev <- prevalence %>% group_by(Méthode) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Méthode") %>%
  group_by(Méthode) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

p_values_sig <- p_values %>% filter(p_adj < 0.1)

ggplot(data_long, aes(x = Ville_eval, y = Résultat_bin * 100, fill = Ville_eval)) +
  scale_fill_manual(values = c(
    "Lima (150m)" = "#1b9e77",
    "Cusco (3400m)" = "#d95f02",
    "Juliaca (3800m)" = "#7570b3",
    "La Rinconada \n (5100m - 5300m)" = "#e7298a"
  )) +  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  stat_pvalue_manual(
    data = p_values_sig,
    label = "p.signif.adj",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  facet_wrap(~ Méthode, scales = "fixed") +
labs(
    title = "Polycythemia prevalence in 8-12 year olds for each methods, by city",
    x = "City",
    y = "Prevalence (%) \n polycythemia",
    fill = "City",
  caption = "* p < 0.1   ** p < 0.05   *** p < 0.01"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Comparaison des différences entre méthodes pour chaque ville

## Anemie
```{r}
data <- read.csv("data/diags.csv")
data <- data[data$Age_categorie_binaire == "0-3 ans", ]
data <- data[, -c(10,11,12,13)]

data_long <- data %>%
  pivot_longer(
    cols = starts_with("Anemie_"),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Anémie"
  )

data_long$Ville_eval <- factor(data_long$Ville_eval, levels = c("Lima", "Cusco", "Juliaca", "Rinconada"))
data_long$Méthode <- factor(data_long$Méthode, levels = c("Anemie_OMS2011", "Anemie_OMS2024", "Anemie_SD", "Anemie_2SD"))
levels(data_long$Méthode) <- gsub("Anemie_", "", levels(data_long$Méthode))
levels(data_long$Ville_eval) <- c(
  "Lima (150m)",
  "Cusco (3400m)",
  "Juliaca (3800m)",
  "La Rinconada (5100m)"
)

# Test global par ville
global_tests <- data_long %>%
  group_by(Ville_eval) %>%
  summarise(
    p_global = {
      tbl <- table(Méthode, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

# Prévalence par ville et méthode
prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

# Comparaisons entre méthodes dans chaque ville
method_pairs <- combn(unique(data_long$Méthode), 2, simplify = FALSE)

all_pvals <- lapply(method_pairs, function(pair) {
  m1 <- pair[1]
  m2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Méthode %in% pair)
  
  data_sub %>%
    group_by(Ville_eval) %>%
    summarise(
      p = {
        tbl <- table(Méthode, Résultat_bin)
        if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
      },
      group1 = m1,
      group2 = m2,
      .groups = "drop"
    )
})

p_values <- bind_rows(all_pvals) %>%
  group_by(Ville_eval) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),
    p.signif.adj = case_when(
      p_adj < 0.01 ~ "***",
      p_adj < 0.05 ~ "**",
      p_adj < 0.1 ~ "*",
      TRUE ~ "ns"
    )
  ) %>%
  ungroup()

p_values <- p_values %>%
  left_join(global_tests, by = "Ville_eval") %>%
  filter(p_global < 0.1)

# Ajouter positions Y pour affichage
max_prev <- prevalence %>% group_by(Ville_eval) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Ville_eval") %>%
  group_by(Ville_eval) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

p_values_sig <- p_values %>% filter(p_adj < 0.1)

# Graphique : chaque facette est une ville, comparaisons entre méthodes
ggplot(data_long, aes(x = Méthode, y = Résultat_bin * 100, fill = Méthode)) +
  scale_fill_manual(values = c(
    "OMS2011" = "#1b9e77",
    "OMS2024" = "#d95f02",
    "SD" = "#7570b3",
    "2SD" = "#e7298a"
  )) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  stat_pvalue_manual(
    data = p_values_sig,
    label = "p.signif.adj",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  facet_wrap(~ Ville_eval, scales = "fixed") +
  labs(
    title = "Comparison of anemia detection methods in 0-3 year olds, by city",
    x = "Methods",
    y = "Prevalence (%)",
    fill = "Methods (anemia)",
  caption = "* p < 0.1   ** p < 0.05   *** p < 0.01"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
data = read.csv("data/diags.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]
data = data[, -c(10,13)]

data_long <- data %>%
  pivot_longer(
    cols = starts_with("Anemie_"),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Anémie"
  )

data_long$Ville_eval <- factor(data_long$Ville_eval, levels = c("Lima", "Cusco", "Juliaca", "Rinconada"))
data_long$Méthode <- factor(data_long$Méthode)
data_long$Méthode <- gsub("Anemie_", "", data_long$Méthode)
data_long$Méthode <- gsub("_kg", "/kg)", data_long$Méthode)
data_long$Méthode <- gsub("_", " (", data_long$Méthode)

levels(data_long$Ville_eval) <- c(
  "Lima (150m)",
  "Cusco (3400m)",
  "Juliaca (3800m)",
  "La Rinconada (5100m)"
)

# Test global par ville
global_tests <- data_long %>%
  group_by(Ville_eval) %>%
  summarise(
    p_global = {
      tbl <- table(Méthode, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl, simulate.p.value = TRUE)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

# Prévalence par ville et méthode
prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

# Comparaisons entre méthodes dans chaque ville
method_pairs <- combn(unique(data_long$Méthode), 2, simplify = FALSE)

all_pvals <- lapply(method_pairs, function(pair) {
  m1 <- pair[1]
  m2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Méthode %in% pair)
  
  data_sub %>%
    group_by(Ville_eval) %>%
    summarise(
      p = {
        tbl <- table(Méthode, Résultat_bin)
        if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
      },
      group1 = m1,
      group2 = m2,
      .groups = "drop"
    )
})

p_values <- bind_rows(all_pvals) %>%
  group_by(Ville_eval) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),
    p.signif.adj = case_when(
      p_adj < 0.01 ~ "***",
      p_adj < 0.05 ~ "**",
      p_adj < 0.1 ~ "*",
      TRUE ~ "ns"
    )
  ) %>%
  ungroup()

p_values <- p_values %>%
  left_join(global_tests, by = "Ville_eval") %>%
  filter(p_global < 0.1)

# Ajouter positions Y pour affichage
max_prev <- prevalence %>% group_by(Ville_eval) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Ville_eval") %>%
  group_by(Ville_eval) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

p_values_sig <- p_values %>% filter(p_adj < 0.1)

# Graphique : chaque facette est une ville, comparaisons entre méthodes
ggplot(data_long, aes(x = Méthode, y = Résultat_bin * 100, fill = Méthode)) +
  scale_x_discrete(limits = c("OMS2011", "OMS2024", "SD", "2SD", "SD (Hbmass/kg)", "2SD (Hbmass/kg)")) +
  scale_fill_manual(values = c(
    "OMS2011" = "#1b9e77",
    "OMS2024" = "#d95f02",
    "SD" = "#7570b3",
    "2SD" = "#e7298a",
    "SD (Hbmass/kg)" = "#66a61e",
    "2SD (Hbmass/kg)" = "#e6ab02"
  )) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  stat_pvalue_manual(
    data = p_values_sig,
    label = "p.signif.adj",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  facet_wrap(~ Ville_eval, scales = "fixed") +
  labs(
    title = "Comparison of anemia detection methods in 8-12 year olds, by city",
    x = "Methods",
    y = "Prevalence (%)",
    fill = "Methods (anemia)",
  caption = "* p < 0.1   ** p < 0.05   *** p < 0.01"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
## Polyglobulie
```{r}
data = read.csv("data/diags.csv")
data = data[data$Age_categorie_binaire == "0-3 ans", ]
data = data[, -c(18,19,20,21)]
data_long <- data %>%
  pivot_longer(
    cols = starts_with("Polyglobulie_"),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Polyglobulie"
  )

data_long$Ville_eval <- factor(data_long$Ville_eval, levels = c("Lima", "Cusco", "Juliaca", "Rinconada"))
data_long$Méthode <- gsub("Polyglobulie_", "", data_long$Méthode)
data_long$Méthode <- gsub("14.5_", "", data_long$Méthode)

levels(data_long$Ville_eval) <- c(
  "Lima (150m)",
  "Cusco (3400m)",
  "Juliaca (3800m)",
  "La Rinconada (5100m)"
)

# Test global par ville
global_tests <- data_long %>%
  group_by(Ville_eval) %>%
  summarise(
    p_global = {
      tbl <- table(Méthode, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )

# Prévalence par ville et méthode
prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

# Comparaisons entre méthodes dans chaque ville
method_pairs <- combn(unique(data_long$Méthode), 2, simplify = FALSE)

all_pvals <- lapply(method_pairs, function(pair) {
  m1 <- pair[1]
  m2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Méthode %in% pair)
  
  data_sub %>%
    group_by(Ville_eval) %>%
    summarise(
      p = {
        tbl <- table(Méthode, Résultat_bin)
        if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
      },
      group1 = m1,
      group2 = m2,
      .groups = "drop"
    )
})

p_values <- bind_rows(all_pvals) %>%
  group_by(Ville_eval) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),
    p.signif.adj = case_when(
      p_adj < 0.01 ~ "***",
      p_adj < 0.05 ~ "**",
      p_adj < 0.1 ~ "*",
      TRUE ~ "ns"
    )
  ) %>%
  ungroup()

p_values <- p_values %>%
  left_join(global_tests, by = "Ville_eval") %>%
  filter(p_global < 0.1)

# Ajouter positions Y pour affichage
max_prev <- prevalence %>% group_by(Ville_eval) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Ville_eval") %>%
  group_by(Ville_eval) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

p_values_sig <- p_values %>% filter(p_adj < 0.1)

# Graphique : chaque facette est une ville, comparaisons entre méthodes
ggplot(data_long, aes(x = Méthode, y = Résultat_bin * 100, fill = Méthode)) +
  scale_x_discrete(limits = c("OMS2011", "OMS2024", "SD", "2SD")) +
  scale_fill_manual(values = c(
    "OMS2011" = "#1b9e77",
    "OMS2024" = "#d95f02",
    "SD" = "#7570b3",
    "2SD" = "#e7298a"
  )) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  stat_pvalue_manual(
    data = p_values_sig,
    label = "p.signif.adj",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  facet_wrap(~ Ville_eval, scales = "fixed") +
  labs(
    title = "Comparison of polycythemia detection methods in 0-3 year olds, by city",
    x = "Methods",
    y = "Prevalence (%)",
    fill = "Methods (polycythemia)",
  caption = "* p < 0.1   ** p < 0.05   *** p < 0.01"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
data = read.csv("data/diags.csv")
data = data[data$Age_categorie_binaire == "8-12 ans", ]
data = data[, -c(18,21)]
data_long <- data %>%
  pivot_longer(
    cols = starts_with("Polyglobulie_"),
    names_to = "Méthode",
    values_to = "Résultat"
  ) %>%
  mutate(
    Résultat_bin = ifelse(Résultat == "oui", 1, 0),
    Type = "Polyglobulie"
  )

data_long$Ville_eval <- factor(data_long$Ville_eval, levels = c("Lima", "Cusco", "Juliaca", "Rinconada"))
data_long$Méthode <- gsub("Polyglobulie_", "", data_long$Méthode)
data_long$Méthode <- gsub("14.5_", "", data_long$Méthode)
data_long$Méthode <- gsub("_kg", "/kg)", data_long$Méthode)
data_long$Méthode <- gsub("_", " (", data_long$Méthode)

levels(data_long$Ville_eval) <- c(
  "Lima (150m)",
  "Cusco (3400m)",
  "Juliaca (3800m)",
  "La Rinconada (5100m)"
)

# Test global par ville
global_tests <- data_long %>%
  group_by(Ville_eval) %>%
  summarise(
    p_global = {
      tbl <- table(Méthode, Résultat_bin)
      if (any(tbl < 5)) fisher.test(tbl, simulate.p.value = TRUE)$p.value else chisq.test(tbl)$p.value
    },
    .groups = "drop"
  )


# Prévalence par ville et méthode
prevalence <- data_long %>%
  group_by(Ville_eval, Méthode) %>%
  summarise(
    Prevalence = mean(Résultat_bin, na.rm = TRUE) * 100,
    .groups = "drop"
  )

# Comparaisons entre méthodes dans chaque ville
method_pairs <- combn(unique(data_long$Méthode), 2, simplify = FALSE)

all_pvals <- lapply(method_pairs, function(pair) {
  m1 <- pair[1]
  m2 <- pair[2]
  
  data_sub <- data_long %>%
    filter(Méthode %in% pair)
  
  data_sub %>%
    group_by(Ville_eval) %>%
    summarise(
      p = {
        tbl <- table(Méthode, Résultat_bin)
        if (any(tbl < 5)) fisher.test(tbl)$p.value else chisq.test(tbl)$p.value
      },
      group1 = m1,
      group2 = m2,
      .groups = "drop"
    )
})

p_values <- bind_rows(all_pvals) %>%
  group_by(Ville_eval) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),
    p.signif.adj = case_when(
      p_adj < 0.01 ~ "***",
      p_adj < 0.05 ~ "**",
      p_adj < 0.1 ~ "*",
      TRUE ~ "ns"
    )
  ) %>%
  ungroup()

p_values <- p_values %>%
  left_join(global_tests, by = "Ville_eval") %>%
  filter(p_global < 0.1)

# Ajouter positions Y pour affichage
max_prev <- prevalence %>% group_by(Ville_eval) %>% summarise(maxY = max(Prevalence))
p_values <- p_values %>%
  left_join(max_prev, by = "Ville_eval") %>%
  group_by(Ville_eval) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

p_values_sig <- p_values %>% filter(p_adj < 0.1)

# Graphique : chaque facette est une ville, comparaisons entre méthodes
ggplot(data_long, aes(x = Méthode, y = Résultat_bin * 100, fill = Méthode)) +
  scale_x_discrete(limits = c("OMS2011", "OMS2024", "SD", "2SD", "SD (Hbmass/kg)", "2SD (Hbmass/kg)")) +
  scale_fill_manual(values = c(
    "OMS2011" = "#1b9e77",
    "OMS2024" = "#d95f02",
    "SD" = "#7570b3",
    "2SD" = "#e7298a",
    "SD (Hbmass/kg)" = "#66a61e",
    "2SD (Hbmass/kg)" = "#e6ab02"
  )) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  stat_pvalue_manual(
    data = p_values_sig,
    label = "p.signif.adj",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  facet_wrap(~ Ville_eval, scales = "fixed") +
  labs(
    title = "Comparison of polycythemia detection methods in 8-12 year olds, by city",
    x = "Methods",
    y = "Prevalence (%)",
    fill = "Methods (polycythemia)",
  caption = "* p < 0.1   ** p < 0.05   *** p < 0.01"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Nutrition

```{r}
# FULL 03


data = read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "0-3 ans",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ Pr..g. + L.g.+ G.g.+ Fibres + Calcium.....mg.+ Fer..mg.100.g.+ Zinc..mg.100.g.+ Vitamine.C..mg., data = df),
      mod2 = lm(HCT.. ~ Pr..g. + L.g.+ G.g.+ Fibres + Calcium.....mg.+ Fer..mg.100.g.+ Zinc..mg.100.g.+ Vitamine.C..mg., data = df),
      mod3 = lm(RBC..106.µL. ~ Pr..g. + L.g.+ G.g.+ Fibres + Calcium.....mg.+ Fer..mg.100.g.+ Zinc..mg.100.g.+ Vitamine.C..mg., data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod1, conf.int = TRUE) %>% mutate(model = "HB"),
    tidy(mods$mod2, conf.int = TRUE) %>% mutate(model = "HCT"),
    tidy(mods$mod3, conf.int = TRUE) %>% mutate(model = "RBC (106 µL)"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "Pr..g."] <- "Protein (g)"
coef_data$term[coef_data$term == "L.g."] <- "Lipids (g)"
coef_data$term[coef_data$term == "G.g."] <- "Carbohydrates (g)"
coef_data$term[coef_data$term == "Fibres"] <- "Fibers"
coef_data$term[coef_data$term == "Calcium.....mg."] <- "Calcium (mg)"
coef_data$term[coef_data$term == "Fer..mg.100.g."] <- "Iron (mg/100g)"
coef_data$term[coef_data$term == "Zinc..mg.100.g."] <- "Zinc (mg/100g)"
coef_data$term[coef_data$term == "Vitamine.C..mg."] <- "Vitamin C (mg)"

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
   "HB" = "#1b9e77",           # vert foncé
  "HCT" = "#e6ab02",          # orange
  "RBC (106 µL)" = "#7570b3"     # violet
  )) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "Multiple linear regressions (nutrition) for each blood indicator, by city for 0-3 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# FULL 12


data = read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ Pr..g. + L.g.+ G.g.+ Fibres + Calcium.....mg.+ Fer..mg.100.g.+ Zinc..mg.100.g.+ Vitamine.C..mg. + Age_mois, data = df),
      mod2 = lm(HCT.. ~ Pr..g. + L.g.+ G.g.+ Fibres + Calcium.....mg.+ Fer..mg.100.g.+ Zinc..mg.100.g.+ Vitamine.C..mg. + Age_mois, data = df),
      mod3 = lm(RBC..106.µL. ~ Pr..g. + L.g.+ G.g.+ Fibres + Calcium.....mg.+ Fer..mg.100.g.+ Zinc..mg.100.g.+ Vitamine.C..mg. + Age_mois, data = df),
      mod4 = lm(RBCV..ml. ~ Pr..g. + L.g.+ G.g.+ Fibres + Calcium.....mg.+ Fer..mg.100.g.+ Zinc..mg.100.g.+ Vitamine.C..mg. + Age_mois, data = df),
      mod5 = lm(Hb.mass..g. ~ Pr..g. + L.g.+ G.g.+ Fibres + Calcium.....mg.+ Fer..mg.100.g.+ Zinc..mg.100.g.+ Vitamine.C..mg. + Age_mois, data = df),
      mod6 = lm(Hb.mass.kg..g...kg. ~ Pr..g. + L.g.+ G.g.+ Fibres + Calcium.....mg.+ Fer..mg.100.g.+ Zinc..mg.100.g.+ Vitamine.C..mg. + Age_mois, data = df),
      mod7 = lm(PV.ml. ~ Pr..g. + L.g.+ G.g.+ Fibres + Calcium.....mg.+ Fer..mg.100.g.+ Zinc..mg.100.g.+ Vitamine.C..mg. + Age_mois, data = df),
      mod8 = lm(PV..kg..ml.kg. ~ Pr..g. + L.g.+ G.g.+ Fibres + Calcium.....mg.+ Fer..mg.100.g.+ Zinc..mg.100.g.+ Vitamine.C..mg. + Age_mois, data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod1, conf.int = TRUE) %>% mutate(model = "HB"),
    tidy(mods$mod2, conf.int = TRUE) %>% mutate(model = "HCT"),
    tidy(mods$mod3, conf.int = TRUE) %>% mutate(model = "RBC (106 µL) / RBCV (ml) / Hbmass (g) / Hbmass (g/kg) / PV (ml) / PV (ml/kg)")
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "Pr..g."] <- "Protein (g)"
coef_data$term[coef_data$term == "L.g."] <- "Lipids (g)"
coef_data$term[coef_data$term == "G.g."] <- "Carbohydrates (g)"
coef_data$term[coef_data$term == "Fibres"] <- "Fibers"
coef_data$term[coef_data$term == "Calcium.....mg."] <- "Calcium (mg)"
coef_data$term[coef_data$term == "Fer..mg.100.g."] <- "Iron (mg/100g)"
coef_data$term[coef_data$term == "Zinc..mg.100.g."] <- "Zinc (mg/100g)"
coef_data$term[coef_data$term == "Vitamine.C..mg."] <- "Vitamin C (mg)"

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
  "HB" = "#1b9e77",           # vert foncé
  "HCT" = "#e6ab02",          # orange
  "RBC (106 µL) / RBCV (ml) / Hbmass (g) / Hbmass (g/kg) / PV (ml) / PV (ml/kg)" = "#7570b3"
)) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Coefficient estimé", y = "Variable explicative",
       color = "Explained variable", shape = "Significatif ?", title = "Multiple linear regressions (nutrition) for each blood indicator, by city for 8-12 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

```{r}
# HB 03


data = read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "0-3 ans",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(HB ~ Pr..g., data = df),
  mod_Lipides   = lm(HB ~ L.g., data = df),
  mod_Glucides  = lm(HB ~ G.g., data = df),
  mod_Fibres    = lm(HB ~ Fibres, data = df),
  mod_Calcium   = lm(HB ~ Calcium.....mg., data = df),
  mod_Fer       = lm(HB ~ Fer..mg.100.g., data = df),
  mod_Zinc      = lm(HB ~ Zinc..mg.100.g., data = df),
  mod_VitC      = lm(HB ~ Vitamine.C..mg., data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Protein"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Lipids"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Carbohydrates"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Fibers"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Calcium"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Iron"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vit.C"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "Pr..g."] <- "Protein (g)"
coef_data$term[coef_data$term == "L.g."] <- "Lipids (g)"
coef_data$term[coef_data$term == "G.g."] <- "Carbohydrates (g)"
coef_data$term[coef_data$term == "Fibres"] <- "Fibers"
coef_data$term[coef_data$term == "Calcium.....mg."] <- "Calcium (mg)"
coef_data$term[coef_data$term == "Fer..mg.100.g."] <- "Iron (mg/100g)"
coef_data$term[coef_data$term == "Zinc..mg.100.g."] <- "Zinc (mg/100g)"
coef_data$term[coef_data$term == "Vitamine.C..mg."] <- "Vitamin C (mg)"

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "HB - Simple linear regressions (nutrition) by city for 0-3 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

coef_table_stars <- coef_data %>%
  mutate(
    stars = case_when(
      p.value <= 0.01 ~ "***",
      p.value <= 0.05 ~ "**",
      p.value <= 0.1 ~ "*",
      TRUE ~ ""
    )
  ) %>%
  select(Ville_eval, term, stars)

coef_table_stars$term[coef_table_stars$term == "X..vit.C...RNP"] <- "% Vit. C RNP"
coef_table_stars$term[coef_table_stars$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_table_stars$term[coef_table_stars$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_table_stars$term[coef_table_stars$term == "statut.Fer.inf"] <- "Low Iron"
coef_table_stars$term[coef_table_stars$term == "statut.Fer.sup"] <- "High Iron"
coef_table_stars$term[coef_table_stars$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_table_stars$term[coef_table_stars$term == "statut.Zinc.sup"] <- "High Zinc"
# Créer le graphique tableau avec étoiles
ggplot(coef_table_stars, aes(x = Ville_eval, y = term, fill = stars != "")) +
  geom_tile(color = "white") +
  geom_text(aes(label = stars), size = 5) +
  scale_fill_manual(
    values = c("TRUE" = "#1b9e77", "FALSE" = "#e0e0e0"),
    guide = FALSE
  ) +
  labs(
    title = "Modèles simples : HB ~ nutrition (0-3 ans)",
    x = "Ville",
    y = "Variable explicative"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 20, hjust = 1),
    panel.grid = element_blank()
  )
```

```{r}
# HB 12


data = read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(HB ~ Pr..g., data = df),
  mod_Lipides   = lm(HB ~ L.g., data = df),
  mod_Glucides  = lm(HB ~ G.g., data = df),
  mod_Fibres    = lm(HB ~ Fibres, data = df),
  mod_Calcium   = lm(HB ~ Calcium.....mg., data = df),
  mod_Fer       = lm(HB ~ Fer..mg.100.g., data = df),
  mod_Zinc      = lm(HB ~ Zinc..mg.100.g., data = df),
  mod_VitC      = lm(HB ~ Vitamine.C..mg., data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Protein"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Lipids"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Carbohydrates"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Fibers"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Calcium"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Iron"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vit.C"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "Pr..g."] <- "Protein (g)"
coef_data$term[coef_data$term == "L.g."] <- "Lipids (g)"
coef_data$term[coef_data$term == "G.g."] <- "Carbohydrates (g)"
coef_data$term[coef_data$term == "Fibres"] <- "Fibers"
coef_data$term[coef_data$term == "Calcium.....mg."] <- "Calcium (mg)"
coef_data$term[coef_data$term == "Fer..mg.100.g."] <- "Iron (mg/100g)"
coef_data$term[coef_data$term == "Zinc..mg.100.g."] <- "Zinc (mg/100g)"
coef_data$term[coef_data$term == "Vitamine.C..mg."] <- "Vitamin C (mg)"

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "HB - Simple linear regressions (nutrition) by city for 8-12 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

coef_table_stars <- coef_data %>%
  mutate(
    stars = case_when(
      p.value <= 0.01 ~ "***",
      p.value <= 0.05 ~ "**",
      p.value <= 0.1 ~ "*",
      TRUE ~ ""
    )
  ) %>%
  select(Ville_eval, term, stars)

coef_table_stars$term[coef_table_stars$term == "X..vit.C...RNP"] <- "% Vit. C RNP"
coef_table_stars$term[coef_table_stars$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_table_stars$term[coef_table_stars$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_table_stars$term[coef_table_stars$term == "statut.Fer.inf"] <- "Low Iron"
coef_table_stars$term[coef_table_stars$term == "statut.Fer.sup"] <- "High Iron"
coef_table_stars$term[coef_table_stars$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_table_stars$term[coef_table_stars$term == "statut.Zinc.sup"] <- "High Zinc"
# Créer le graphique tableau avec étoiles
ggplot(coef_table_stars, aes(x = Ville_eval, y = term, fill = stars != "")) +
  geom_tile(color = "white") +
  geom_text(aes(label = stars), size = 5) +
  scale_fill_manual(
    values = c("TRUE" = "#1b9e77", "FALSE" = "#e0e0e0"),
    guide = FALSE
  ) +
  labs(
    title = "Modèles simples : HB ~ nutrition (8-12 ans)",
    x = "Ville",
    y = "Variable explicative"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 20, hjust = 1),
    panel.grid = element_blank()
  )
```

```{r}
# HCT 03


data = read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "0-3 ans",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(HCT.. ~ Pr..g., data = df),
  mod_Lipides   = lm(HCT.. ~ L.g., data = df),
  mod_Glucides  = lm(HCT.. ~ G.g., data = df),
  mod_Fibres    = lm(HCT.. ~ Fibres, data = df),
  mod_Calcium   = lm(HCT.. ~ Calcium.....mg., data = df),
  mod_Fer       = lm(HCT.. ~ Fer..mg.100.g., data = df),
  mod_Zinc      = lm(HCT.. ~ Zinc..mg.100.g., data = df),
  mod_VitC      = lm(HCT.. ~ Vitamine.C..mg., data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Protein"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Lipids"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Carbohydrates"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Fibers"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Calcium"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Iron"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vit.C"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "Pr..g."] <- "Protein (g)"
coef_data$term[coef_data$term == "L.g."] <- "Lipids (g)"
coef_data$term[coef_data$term == "G.g."] <- "Carbohydrates (g)"
coef_data$term[coef_data$term == "Fibres"] <- "Fibers"
coef_data$term[coef_data$term == "Calcium.....mg."] <- "Calcium (mg)"
coef_data$term[coef_data$term == "Fer..mg.100.g."] <- "Iron (mg/100g)"
coef_data$term[coef_data$term == "Zinc..mg.100.g."] <- "Zinc (mg/100g)"
coef_data$term[coef_data$term == "Vitamine.C..mg."] <- "Vitamin C (mg)"

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "HCT - Simple linear regressions (nutrition) by city for 0-3 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HCT 12


data = read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(HCT.. ~ Pr..g., data = df),
  mod_Lipides   = lm(HCT.. ~ L.g., data = df),
  mod_Glucides  = lm(HCT.. ~ G.g., data = df),
  mod_Fibres    = lm(HCT.. ~ Fibres, data = df),
  mod_Calcium   = lm(HCT.. ~ Calcium.....mg., data = df),
  mod_Fer       = lm(HCT.. ~ Fer..mg.100.g., data = df),
  mod_Zinc      = lm(HCT.. ~ Zinc..mg.100.g., data = df),
  mod_VitC      = lm(HCT.. ~ Vitamine.C..mg., data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Protein"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Lipids"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Carbohydrates"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Fibers"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Calcium"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Iron"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vit.C"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "Pr..g."] <- "Protein (g)"
coef_data$term[coef_data$term == "L.g."] <- "Lipids (g)"
coef_data$term[coef_data$term == "G.g."] <- "Carbohydrates (g)"
coef_data$term[coef_data$term == "Fibres"] <- "Fibers"
coef_data$term[coef_data$term == "Calcium.....mg."] <- "Calcium (mg)"
coef_data$term[coef_data$term == "Fer..mg.100.g."] <- "Iron (mg/100g)"
coef_data$term[coef_data$term == "Zinc..mg.100.g."] <- "Zinc (mg/100g)"
coef_data$term[coef_data$term == "Vitamine.C..mg."] <- "Vitamin C (mg)"

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "HCT - Simple linear regressions (nutrition) by city for 8-12 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# RBC 03


data = read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "0-3 ans",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(RBC..106.µL. ~ Pr..g., data = df),
  mod_Lipides   = lm(RBC..106.µL. ~ L.g., data = df),
  mod_Glucides  = lm(RBC..106.µL. ~ G.g., data = df),
  mod_Fibres    = lm(RBC..106.µL. ~ Fibres, data = df),
  mod_Calcium   = lm(RBC..106.µL. ~ Calcium.....mg., data = df),
  mod_Fer       = lm(RBC..106.µL. ~ Fer..mg.100.g., data = df),
  mod_Zinc      = lm(RBC..106.µL. ~ Zinc..mg.100.g., data = df),
  mod_VitC      = lm(RBC..106.µL. ~ Vitamine.C..mg., data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Protein"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Lipids"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Carbohydrates"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Fibers"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Calcium"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Iron"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vit.C"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "Pr..g."] <- "Protein (g)"
coef_data$term[coef_data$term == "L.g."] <- "Lipids (g)"
coef_data$term[coef_data$term == "G.g."] <- "Carbohydrates (g)"
coef_data$term[coef_data$term == "Fibres"] <- "Fibers"
coef_data$term[coef_data$term == "Calcium.....mg."] <- "Calcium (mg)"
coef_data$term[coef_data$term == "Fer..mg.100.g."] <- "Iron (mg/100g)"
coef_data$term[coef_data$term == "Zinc..mg.100.g."] <- "Zinc (mg/100g)"
coef_data$term[coef_data$term == "Vitamine.C..mg."] <- "Vitamin C (mg)"

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "RBC (106 µL) - Simple linear regressions (nutrition) by city for 0-3 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# RBC 812


data = read.csv("data.csv")
data$Age_categorie_binaire[data$Age_categorie_binaire == "8-12 ans"] <- "8-12"
data$Age_categorie_binaire[data$Age_categorie_binaire == "0-3 ans"] <- "0-3"
data <- data[data$Age_categorie_binaire == "8-12",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(RBC..106.µL. ~ Pr..g., data = df),
  mod_Lipides   = lm(RBC..106.µL. ~ L.g., data = df),
  mod_Glucides  = lm(RBC..106.µL. ~ G.g., data = df),
  mod_Fibres    = lm(RBC..106.µL. ~ Fibres, data = df),
  mod_Calcium   = lm(RBC..106.µL. ~ Calcium.....mg., data = df),
  mod_Fer       = lm(RBC..106.µL. ~ Fer..mg.100.g., data = df),
  mod_Zinc      = lm(RBC..106.µL. ~ Zinc..mg.100.g., data = df),
  mod_VitC      = lm(RBC..106.µL. ~ Vitamine.C..mg., data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Protein"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Lipids"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Carbohydrates"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Fibers"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Calcium"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Iron"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vit.C"),
  ) %>% mutate(Ville_eval = altitude)
})


coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "Pr..g."] <- "Protein (g)"
coef_data$term[coef_data$term == "L.g."] <- "Lipids (g)"
coef_data$term[coef_data$term == "G.g."] <- "Carbohydrates (g)"
coef_data$term[coef_data$term == "Fibres"] <- "Fibers"
coef_data$term[coef_data$term == "Calcium.....mg."] <- "Calcium (mg)"
coef_data$term[coef_data$term == "Fer..mg.100.g."] <- "Iron (mg/100g)"
coef_data$term[coef_data$term == "Zinc..mg.100.g."] <- "Zinc (mg/100g)"
coef_data$term[coef_data$term == "Vitamine.C..mg."] <- "Vitamin C (mg)"

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = paste0("RBC (106 µL) - Simple linear regressions (nutrition) by city for ", unique(data$Age_categorie_binaire), " years old")) +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# RBCV 812


data = read.csv("data.csv")
data$Age_categorie_binaire[data$Age_categorie_binaire == "8-12 ans"] <- "8-12"
data$Age_categorie_binaire[data$Age_categorie_binaire == "0-3 ans"] <- "0-3"
data <- data[data$Age_categorie_binaire == "8-12",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(RBCV..ml. ~ Pr..g., data = df),
  mod_Lipides   = lm(RBCV..ml. ~ L.g., data = df),
  mod_Glucides  = lm(RBCV..ml. ~ G.g., data = df),
  mod_Fibres    = lm(RBCV..ml. ~ Fibres, data = df),
  mod_Calcium   = lm(RBCV..ml. ~ Calcium.....mg., data = df),
  mod_Fer       = lm(RBCV..ml. ~ Fer..mg.100.g., data = df),
  mod_Zinc      = lm(RBCV..ml. ~ Zinc..mg.100.g., data = df),
  mod_VitC      = lm(RBCV..ml. ~ Vitamine.C..mg., data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Protein"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Lipids"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Carbohydrates"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Fibers"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Calcium"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Iron"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vit.C"),
  ) %>% mutate(Ville_eval = altitude)
})


coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "Pr..g."] <- "Protein (g)"
coef_data$term[coef_data$term == "L.g."] <- "Lipids (g)"
coef_data$term[coef_data$term == "G.g."] <- "Carbohydrates (g)"
coef_data$term[coef_data$term == "Fibres"] <- "Fibers"
coef_data$term[coef_data$term == "Calcium.....mg."] <- "Calcium (mg)"
coef_data$term[coef_data$term == "Fer..mg.100.g."] <- "Iron (mg/100g)"
coef_data$term[coef_data$term == "Zinc..mg.100.g."] <- "Zinc (mg/100g)"
coef_data$term[coef_data$term == "Vitamine.C..mg."] <- "Vitamin C (mg)"

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = paste0("RBCV (ml) - Simple linear regressions (nutrition) by city for ", unique(data$Age_categorie_binaire), " years old")) +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HBMASS (g) 812


data = read.csv("data.csv")
data$Age_categorie_binaire[data$Age_categorie_binaire == "8-12 ans"] <- "8-12"
data$Age_categorie_binaire[data$Age_categorie_binaire == "0-3 ans"] <- "0-3"
data <- data[data$Age_categorie_binaire == "8-12",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(Hb.mass..g. ~ Pr..g., data = df),
  mod_Lipides   = lm(Hb.mass..g. ~ L.g., data = df),
  mod_Glucides  = lm(Hb.mass..g. ~ G.g., data = df),
  mod_Fibres    = lm(Hb.mass..g. ~ Fibres, data = df),
  mod_Calcium   = lm(Hb.mass..g. ~ Calcium.....mg., data = df),
  mod_Fer       = lm(Hb.mass..g. ~ Fer..mg.100.g., data = df),
  mod_Zinc      = lm(Hb.mass..g. ~ Zinc..mg.100.g., data = df),
  mod_VitC      = lm(Hb.mass..g. ~ Vitamine.C..mg., data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Protein"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Lipids"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Carbohydrates"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Fibers"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Calcium"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Iron"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vit.C"),
  ) %>% mutate(Ville_eval = altitude)
})


coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "Pr..g."] <- "Protein (g)"
coef_data$term[coef_data$term == "L.g."] <- "Lipids (g)"
coef_data$term[coef_data$term == "G.g."] <- "Carbohydrates (g)"
coef_data$term[coef_data$term == "Fibres"] <- "Fibers"
coef_data$term[coef_data$term == "Calcium.....mg."] <- "Calcium (mg)"
coef_data$term[coef_data$term == "Fer..mg.100.g."] <- "Iron (mg/100g)"
coef_data$term[coef_data$term == "Zinc..mg.100.g."] <- "Zinc (mg/100g)"
coef_data$term[coef_data$term == "Vitamine.C..mg."] <- "Vitamin C (mg)"

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = paste0("Hbmass (g) - Simple linear regressions (nutrition) by city for ", unique(data$Age_categorie_binaire), " years old")) +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HBMASS (g/kg) 812


data = read.csv("data.csv")
data$Age_categorie_binaire[data$Age_categorie_binaire == "8-12 ans"] <- "8-12"
data$Age_categorie_binaire[data$Age_categorie_binaire == "0-3 ans"] <- "0-3"
data <- data[data$Age_categorie_binaire == "8-12",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(Hb.mass.kg..g...kg. ~ Pr..g., data = df),
  mod_Lipides   = lm(Hb.mass.kg..g...kg. ~ L.g., data = df),
  mod_Glucides  = lm(Hb.mass.kg..g...kg. ~ G.g., data = df),
  mod_Fibres    = lm(Hb.mass.kg..g...kg. ~ Fibres, data = df),
  mod_Calcium   = lm(Hb.mass.kg..g...kg. ~ Calcium.....mg., data = df),
  mod_Fer       = lm(Hb.mass.kg..g...kg. ~ Fer..mg.100.g., data = df),
  mod_Zinc      = lm(Hb.mass.kg..g...kg. ~ Zinc..mg.100.g., data = df),
  mod_VitC      = lm(Hb.mass.kg..g...kg. ~ Vitamine.C..mg., data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Protein"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Lipids"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Carbohydrates"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Fibers"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Calcium"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Iron"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vit.C"),
  ) %>% mutate(Ville_eval = altitude)
})



coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "Pr..g."] <- "Protein (g)"
coef_data$term[coef_data$term == "L.g."] <- "Lipids (g)"
coef_data$term[coef_data$term == "G.g."] <- "Carbohydrates (g)"
coef_data$term[coef_data$term == "Fibres"] <- "Fibers"
coef_data$term[coef_data$term == "Calcium.....mg."] <- "Calcium (mg)"
coef_data$term[coef_data$term == "Fer..mg.100.g."] <- "Iron (mg/100g)"
coef_data$term[coef_data$term == "Zinc..mg.100.g."] <- "Zinc (mg/100g)"
coef_data$term[coef_data$term == "Vitamine.C..mg."] <- "Vitamin C (mg)"

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = paste0("Hbmass (g/kg) - Simple linear regressions (nutrition) by city for ", unique(data$Age_categorie_binaire), " years old")) +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# PVML 812


data = read.csv("data.csv")
data$Age_categorie_binaire[data$Age_categorie_binaire == "8-12 ans"] <- "8-12"
data$Age_categorie_binaire[data$Age_categorie_binaire == "0-3 ans"] <- "0-3"
data <- data[data$Age_categorie_binaire == "8-12",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(PV.ml. ~ Pr..g., data = df),
  mod_Lipides   = lm(PV.ml. ~ L.g., data = df),
  mod_Glucides  = lm(PV.ml. ~ G.g., data = df),
  mod_Fibres    = lm(PV.ml. ~ Fibres, data = df),
  mod_Calcium   = lm(PV.ml. ~ Calcium.....mg., data = df),
  mod_Fer       = lm(PV.ml. ~ Fer..mg.100.g., data = df),
  mod_Zinc      = lm(PV.ml. ~ Zinc..mg.100.g., data = df),
  mod_VitC      = lm(PV.ml. ~ Vitamine.C..mg., data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Protein"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Lipids"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Carbohydrates"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Fibers"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Calcium"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Iron"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vit.C"),
  ) %>% mutate(Ville_eval = altitude)
})



coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "Pr..g."] <- "Protein (g)"
coef_data$term[coef_data$term == "L.g."] <- "Lipids (g)"
coef_data$term[coef_data$term == "G.g."] <- "Carbohydrates (g)"
coef_data$term[coef_data$term == "Fibres"] <- "Fibers"
coef_data$term[coef_data$term == "Calcium.....mg."] <- "Calcium (mg)"
coef_data$term[coef_data$term == "Fer..mg.100.g."] <- "Iron (mg/100g)"
coef_data$term[coef_data$term == "Zinc..mg.100.g."] <- "Zinc (mg/100g)"
coef_data$term[coef_data$term == "Vitamine.C..mg."] <- "Vitamin C (mg)"

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = paste0("PV (ml) - Simple linear regressions (nutrition) by city for ", unique(data$Age_categorie_binaire), " years old")) +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# PVMLkg 812


data = read.csv("data.csv")
data$Age_categorie_binaire[data$Age_categorie_binaire == "8-12 ans"] <- "8-12"
data$Age_categorie_binaire[data$Age_categorie_binaire == "0-3 ans"] <- "0-3"
data <- data[data$Age_categorie_binaire == "8-12",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(PV..kg..ml.kg. ~ Pr..g., data = df),
  mod_Lipides   = lm(PV..kg..ml.kg. ~ L.g., data = df),
  mod_Glucides  = lm(PV..kg..ml.kg. ~ G.g., data = df),
  mod_Fibres    = lm(PV..kg..ml.kg. ~ Fibres, data = df),
  mod_Calcium   = lm(PV..kg..ml.kg. ~ Calcium.....mg., data = df),
  mod_Fer       = lm(PV..kg..ml.kg. ~ Fer..mg.100.g., data = df),
  mod_Zinc      = lm(PV..kg..ml.kg. ~ Zinc..mg.100.g., data = df),
  mod_VitC      = lm(PV..kg..ml.kg. ~ Vitamine.C..mg., data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Protein"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Lipids"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Carbohydrates"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Fibers"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Calcium"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Iron"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vit.C"),
  ) %>% mutate(Ville_eval = altitude)
})



coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "Pr..g."] <- "Protein (g)"
coef_data$term[coef_data$term == "L.g."] <- "Lipids (g)"
coef_data$term[coef_data$term == "G.g."] <- "Carbohydrates (g)"
coef_data$term[coef_data$term == "Fibres"] <- "Fibers"
coef_data$term[coef_data$term == "Calcium.....mg."] <- "Calcium (mg)"
coef_data$term[coef_data$term == "Fer..mg.100.g."] <- "Iron (mg/100g)"
coef_data$term[coef_data$term == "Zinc..mg.100.g."] <- "Zinc (mg/100g)"
coef_data$term[coef_data$term == "Vitamine.C..mg."] <- "Vitamin C (mg)"

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = paste0("PV (ml/kg) - Simple linear regressions (nutrition) by city for ", unique(data$Age_categorie_binaire), " years old")) +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

# NUTI RNP

```{r}
# FULL 03


data = read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "0-3 ans",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ X..ENERGIE.RNP + X..CALCIUM...RNP + statut.Fer.inf+ statut.Fer.sup + statut.Zinc.inf + statut.Zinc.sup + X..vit.C...RNP, data = df),
      mod2 = lm(HCT.. ~ X..ENERGIE.RNP + X..CALCIUM...RNP + statut.Fer.inf+ statut.Fer.sup + statut.Zinc.inf + statut.Zinc.sup + X..vit.C...RNP, data = df),
      mod3 = lm(RBC..106.µL. ~ X..ENERGIE.RNP + X..CALCIUM...RNP + statut.Fer.inf+ statut.Fer.sup + statut.Zinc.inf + statut.Zinc.sup + X..vit.C...RNP, data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod1, conf.int = TRUE) %>% mutate(model = "HB"),
    tidy(mods$mod2, conf.int = TRUE) %>% mutate(model = "HCT"),
    tidy(mods$mod3, conf.int = TRUE) %>% mutate(model = "RBC (106 µL)"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))

coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"
coef_data$term[coef_data$term == "X..vit.C...RNP"] <- "% vit.C RNP"

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
   "HB" = "#1b9e77",           # vert foncé
  "HCT" = "#e6ab02",          # orange
  "RBC (106 µL)" = "#7570b3"     # violet
  )) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "Multiple linear regressions (nutrition RNP) for each blood indicator, by city for 0-3 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# FULL 12


data = read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)
# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
    list(
      mod1 = lm(HB ~ X..ENERGIE.RNP + X..CALCIUM...RNP + statut.Fer.inf+ statut.Fer.sup + statut.Zinc.inf + statut.Zinc.sup+ X..vit.C...RNP, data = df),
      mod2 = lm(HCT.. ~ X..ENERGIE.RNP + X..CALCIUM...RNP + statut.Fer.inf+ statut.Fer.sup + statut.Zinc.inf + statut.Zinc.sup+ X..vit.C...RNP, data = df),
      mod3 = lm(RBC..106.µL. ~ X..ENERGIE.RNP + X..CALCIUM...RNP + statut.Fer.inf+ statut.Fer.sup + statut.Zinc.inf + statut.Zinc.sup+ X..vit.C...RNP, data = df),
      mod4 = lm(RBCV..ml. ~ X..ENERGIE.RNP + X..CALCIUM...RNP + statut.Fer.inf+ statut.Fer.sup + statut.Zinc.inf + statut.Zinc.sup+ X..vit.C...RNP, data = df),
      mod5 = lm(Hb.mass..g. ~ X..ENERGIE.RNP + X..CALCIUM...RNP + statut.Fer.inf+ statut.Fer.sup + statut.Zinc.inf + statut.Zinc.sup+ X..vit.C...RNP, data = df),
      mod6 = lm(Hb.mass.kg..g...kg. ~ X..ENERGIE.RNP + X..CALCIUM...RNP + statut.Fer.inf+ statut.Fer.sup + statut.Zinc.inf + statut.Zinc.sup+ X..vit.C...RNP, data = df),
      mod7 = lm(PV.ml. ~ X..ENERGIE.RNP + X..CALCIUM...RNP + statut.Fer.inf+ statut.Fer.sup + statut.Zinc.inf + statut.Zinc.sup+ X..vit.C...RNP, data = df),
      mod8 = lm(PV..kg..ml.kg. ~ X..ENERGIE.RNP + X..CALCIUM...RNP + statut.Fer.inf+ statut.Fer.sup + statut.Zinc.inf + statut.Zinc.sup+ X..vit.C...RNP, data = df),
      Ville_eval = unique(df$Ville_eval)
    )
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod1, conf.int = TRUE) %>% mutate(model = "HB"),
    tidy(mods$mod2, conf.int = TRUE) %>% mutate(model = "HCT"),
    tidy(mods$mod3, conf.int = TRUE) %>% mutate(model = "RBC (106 µL) / RBCV (ml) / Hbmass (g) / Hbmass (g/kg) / PV (ml) / PV (ml/kg)")
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"
coef_data$term[coef_data$term == "X..vit.C...RNP"] <- "% vit.C RNP"

ggplot(coef_data, aes(x = estimate, y = term, color = model, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
  "HB" = "#1b9e77",           # vert foncé
  "HCT" = "#e6ab02",          # orange
  "RBC (106 µL) / RBCV (ml) / Hbmass (g) / Hbmass (g/kg) / PV (ml) / PV (ml/kg)" = "#7570b3"
)) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "Multiple linear regressions (nutrition RNP) for each blood indicator, by city for 8-12 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HB 03


data = read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "0-3 ans",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)


# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(HB ~ X..ENERGIE.RNP, data = df),
  mod_Lipides   = lm(HB ~ X..CALCIUM...RNP, data = df),
  mod_Glucides  = lm(HB ~ statut.Fer.inf, data = df),
  mod_Fibres    = lm(HB ~ statut.Fer.sup, data = df),
  mod_Calcium   = lm(HB ~ statut.Zinc.inf, data = df),
  mod_Fer       = lm(HB ~ statut.Zinc.sup, data = df),
  mod_VitC      = lm(HB ~ X..vit.C...RNP, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "% kCal RNP"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "% Calcium RNP"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Low Iron"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "High Iron"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Low Zinc"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "High Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vitamin C"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"
coef_data$term[coef_data$term == "X..vit.C...RNP"] <- "% Vit.C RNP"

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "HB - Simple linear regressions (nutrition RNP) by city for 0-3 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

coef_table_stars <- coef_data %>%
  mutate(
    stars = case_when(
      p.value <= 0.01 ~ "***",
      p.value <= 0.05 ~ "**",
      p.value <= 0.1 ~ "*",
      TRUE ~ ""
    )
  ) %>%
  select(Ville_eval, term, stars)

coef_table_stars$term[coef_table_stars$term == "X..vit.C...RNP"] <- "% Vit. C RNP"
coef_table_stars$term[coef_table_stars$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_table_stars$term[coef_table_stars$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_table_stars$term[coef_table_stars$term == "statut.Fer.inf"] <- "Low Iron"
coef_table_stars$term[coef_table_stars$term == "statut.Fer.sup"] <- "High Iron"
coef_table_stars$term[coef_table_stars$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_table_stars$term[coef_table_stars$term == "statut.Zinc.sup"] <- "High Zinc"
# Créer le graphique tableau avec étoiles
ggplot(coef_table_stars, aes(x = Ville_eval, y = term, fill = stars != "")) +
  geom_tile(color = "white") +
  geom_text(aes(label = stars), size = 5) +
  scale_fill_manual(
    values = c("TRUE" = "#1b9e77", "FALSE" = "#e0e0e0"),
    guide = FALSE
  ) +
  labs(
    title = "Modèles simples : HB ~ nutrition RNP (0-3 ans)",
    x = "Ville",
    y = "Variable explicative"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 20, hjust = 1),
    panel.grid = element_blank()
  )
```

```{r}
# HB 12


data = read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(HB ~ X..ENERGIE.RNP, data = df),
  mod_Lipides   = lm(HB ~ X..CALCIUM...RNP, data = df),
  mod_Glucides  = lm(HB ~ statut.Fer.inf, data = df),
  mod_Fibres    = lm(HB ~ statut.Fer.sup, data = df),
  mod_Calcium   = lm(HB ~ statut.Zinc.inf, data = df),
  mod_Fer       = lm(HB ~ statut.Zinc.sup, data = df),
  mod_VitC      = lm(HB ~ X..vit.C...RNP, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "% kCal RNP"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "% Calcium RNP"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Low Iron"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "High Iron"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Low Zinc"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "High Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vitamin C"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"
ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "HB - Simple linear regressions (nutrition RNP) by city for 8-12 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

coef_table_stars <- coef_data %>%
  mutate(
    stars = case_when(
      p.value <= 0.01 ~ "***",
      p.value <= 0.05 ~ "**",
      p.value <= 0.1 ~ "*",
      TRUE ~ ""
    )
  ) %>%
  select(Ville_eval, term, stars)

coef_table_stars$term[coef_table_stars$term == "X..vit.C...RNP"] <- "% Vit. C RNP"
coef_table_stars$term[coef_table_stars$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_table_stars$term[coef_table_stars$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_table_stars$term[coef_table_stars$term == "statut.Fer.inf"] <- "Low Iron"
coef_table_stars$term[coef_table_stars$term == "statut.Fer.sup"] <- "High Iron"
coef_table_stars$term[coef_table_stars$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_table_stars$term[coef_table_stars$term == "statut.Zinc.sup"] <- "High Zinc"
# Créer le graphique tableau avec étoiles
ggplot(coef_table_stars, aes(x = Ville_eval, y = term, fill = stars != "")) +
  geom_tile(color = "white") +
  geom_text(aes(label = stars), size = 5) +
  scale_fill_manual(
    values = c("TRUE" = "#1b9e77", "FALSE" = "#e0e0e0"),
    guide = FALSE
  ) +
  labs(
    title = "Modèles simples : HB ~ nutrition RNP (8-12 ans)",
    x = "Ville",
    y = "Variable explicative"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 20, hjust = 1),
    panel.grid = element_blank()
  )
```

```{r}
# HCT 03


data = read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "0-3 ans",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(HCT.. ~ X..ENERGIE.RNP, data = df),
  mod_Lipides   = lm(HCT.. ~ X..CALCIUM...RNP, data = df),
  mod_Glucides  = lm(HCT.. ~ statut.Fer.inf, data = df),
  mod_Fibres    = lm(HCT.. ~ statut.Fer.sup, data = df),
  mod_Calcium   = lm(HCT.. ~ statut.Zinc.inf, data = df),
  mod_Fer       = lm(HCT.. ~ statut.Zinc.sup, data = df),
  mod_VitC      = lm(HCT.. ~ X..vit.C...RNP, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "% kCal RNP"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "% Calcium RNP"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Low Iron"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "High Iron"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Low Zinc"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "High Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vitamin C"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"
ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "HCT - Simple linear regressions (nutrition RNP) by city for 0-3 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
#HCT 12


data = read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(HCT.. ~ X..ENERGIE.RNP, data = df),
  mod_Lipides   = lm(HCT.. ~ X..CALCIUM...RNP, data = df),
  mod_Glucides  = lm(HCT.. ~ statut.Fer.inf, data = df),
  mod_Fibres    = lm(HCT.. ~ statut.Fer.sup, data = df),
  mod_Calcium   = lm(HCT.. ~ statut.Zinc.inf, data = df),
  mod_Fer       = lm(HCT.. ~ statut.Zinc.sup, data = df),
  mod_VitC      = lm(HCT.. ~ X..vit.C...RNP, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "% kCal RNP"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "% Calcium RNP"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Low Iron"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "High Iron"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Low Zinc"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "High Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vitamin C"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"
ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "HCT - Simple linear regressions (nutrition RNP) by city for 8-12 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# RBC 03


data = read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "0-3 ans",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(RBC..106.µL. ~ X..ENERGIE.RNP, data = df),
  mod_Lipides   = lm(RBC..106.µL. ~ X..CALCIUM...RNP, data = df),
  mod_Glucides  = lm(RBC..106.µL. ~ statut.Fer.inf, data = df),
  mod_Fibres    = lm(RBC..106.µL. ~ statut.Fer.sup, data = df),
  mod_Calcium   = lm(RBC..106.µL. ~ statut.Zinc.inf, data = df),
  mod_Fer       = lm(RBC..106.µL. ~ statut.Zinc.sup, data = df),
  mod_VitC      = lm(RBC..106.µL. ~ X..vit.C...RNP, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "% kCal RNP"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "% Calcium RNP"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Low Iron"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "High Iron"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Low Zinc"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "High Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vitamin C"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"
ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "RBC (106 µL) - Simple linear regressions (nutrition RNP) by city for 0-3 years old") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# RBC 812


data = read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(RBC..106.µL. ~ X..ENERGIE.RNP, data = df),
  mod_Lipides   = lm(RBC..106.µL. ~ X..CALCIUM...RNP, data = df),
  mod_Glucides  = lm(RBC..106.µL. ~ statut.Fer.inf, data = df),
  mod_Fibres    = lm(RBC..106.µL. ~ statut.Fer.sup, data = df),
  mod_Calcium   = lm(RBC..106.µL. ~ statut.Zinc.inf, data = df),
  mod_Fer       = lm(RBC..106.µL. ~ statut.Zinc.sup, data = df),
  mod_VitC      = lm(RBC..106.µL. ~ X..vit.C...RNP, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "% kCal RNP"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "% Calcium RNP"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Low Iron"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "High Iron"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Low Zinc"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "High Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vitamin C"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"
ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = paste0("RBC (106 µL) - Simple linear regressions (nutrition RNP) by city for ", unique(data$Age_categorie_binaire), " years old")) +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# RBCV 812


data = read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(RBCV..ml. ~ X..ENERGIE.RNP, data = df),
  mod_Lipides   = lm(RBCV..ml. ~ X..CALCIUM...RNP, data = df),
  mod_Glucides  = lm(RBCV..ml. ~ statut.Fer.inf, data = df),
  mod_Fibres    = lm(RBCV..ml. ~ statut.Fer.sup, data = df),
  mod_Calcium   = lm(RBCV..ml. ~ statut.Zinc.inf, data = df),
  mod_Fer       = lm(RBCV..ml. ~ statut.Zinc.sup, data = df),
  mod_VitC      = lm(RBCV..ml. ~ X..vit.C...RNP, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "% kCal RNP"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "% Calcium RNP"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Low Iron"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "High Iron"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Low Zinc"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "High Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vitamin C"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"
ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = paste0("RBCV (ml) - Simple linear regressions (nutrition RNP) by city for ", unique(data$Age_categorie_binaire), " years old")) +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HBMASS (g) 812


data = read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(Hb.mass..g. ~ X..ENERGIE.RNP, data = df),
  mod_Lipides   = lm(Hb.mass..g. ~ X..CALCIUM...RNP, data = df),
  mod_Glucides  = lm(Hb.mass..g. ~ statut.Fer.inf, data = df),
  mod_Fibres    = lm(Hb.mass..g. ~ statut.Fer.sup, data = df),
  mod_Calcium   = lm(Hb.mass..g. ~ statut.Zinc.inf, data = df),
  mod_Fer       = lm(Hb.mass..g. ~ statut.Zinc.sup, data = df),
  mod_VitC      = lm(Hb.mass..g. ~ X..vit.C...RNP, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "% kCal RNP"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "% Calcium RNP"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Low Iron"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "High Iron"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Low Zinc"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "High Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vitamin C"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"
ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = paste0("Hbmass (g) - Simple linear regressions (nutrition RNP) by city for ", unique(data$Age_categorie_binaire), " years old")) +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# HBMASS (g/kg) 812


data = read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
    mod_Protéines = lm(Hb.mass.kg..g...kg. ~ X..ENERGIE.RNP, data = df),
  mod_Lipides   = lm(Hb.mass.kg..g...kg. ~ X..CALCIUM...RNP, data = df),
  mod_Glucides  = lm(Hb.mass.kg..g...kg. ~ statut.Fer.inf, data = df),
  mod_Fibres    = lm(Hb.mass.kg..g...kg. ~ statut.Fer.sup, data = df),
  mod_Calcium   = lm(Hb.mass.kg..g...kg. ~ statut.Zinc.inf, data = df),
  mod_Fer       = lm(Hb.mass.kg..g...kg. ~ statut.Zinc.sup, data = df),
  mod_VitC      = lm(Hb.mass.kg..g...kg. ~ X..vit.C...RNP, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "% kCal RNP"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "% Calcium RNP"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Low Iron"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "High Iron"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Low Zinc"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "High Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vitamin C"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"
ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = paste0("Hbmass (g/kg) - Simple linear regressions (nutrition RNP) by city for ", unique(data$Age_categorie_binaire), " years old")) +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# PVML 812


data = read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(PV.ml. ~ X..ENERGIE.RNP, data = df),
  mod_Lipides   = lm(PV.ml. ~ X..CALCIUM...RNP, data = df),
  mod_Glucides  = lm(PV.ml. ~ statut.Fer.inf, data = df),
  mod_Fibres    = lm(PV.ml. ~ statut.Fer.sup, data = df),
  mod_Calcium   = lm(PV.ml. ~ statut.Zinc.inf, data = df),
  mod_Fer       = lm(PV.ml. ~ statut.Zinc.sup, data = df),
  mod_VitC      = lm(PV.ml. ~ X..vit.C...RNP, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "% kCal RNP"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "% Calcium RNP"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Low Iron"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "High Iron"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Low Zinc"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "High Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vitamin C"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"
ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = paste0("PV (ml) - Simple linear regressions (nutrition RNP) by city for ", unique(data$Age_categorie_binaire), " years old")) +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# PVMLkg 812


data = read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "8-12 ans",]






data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))
data$statut.Zinc.inf <- ifelse(data$statut.Zinc == "supérieur", 1, 0)
data$statut.Zinc.sup <- ifelse(data$statut.Zinc == "inférieur", 1, 0)

data$statut.Fer.inf <- ifelse(data$statut.Fer == "supérieur", 1, 0)
data$statut.Fer.sup <- ifelse(data$statut.Fer == "inférieur", 1, 0)

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(PV..kg..ml.kg. ~ X..ENERGIE.RNP, data = df),
  mod_Lipides   = lm(PV..kg..ml.kg. ~ X..CALCIUM...RNP, data = df),
  mod_Glucides  = lm(PV..kg..ml.kg. ~ statut.Fer.inf, data = df),
  mod_Fibres    = lm(PV..kg..ml.kg. ~ statut.Fer.sup, data = df),
  mod_Calcium   = lm(PV..kg..ml.kg. ~ statut.Zinc.inf, data = df),
  mod_Fer       = lm(PV..kg..ml.kg. ~ statut.Zinc.sup, data = df),
  mod_VitC      = lm(PV..kg..ml.kg. ~ X..vit.C...RNP, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "% kCal RNP"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "% Calcium RNP"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Low Iron"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "High Iron"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Low Zinc"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "High Zinc"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Vitamin C"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "X..ENERGIE.RNP"] <- "% kCal RNP"
coef_data$term[coef_data$term == "X..CALCIUM...RNP"] <- "% Calcium RNP"
coef_data$term[coef_data$term == "statut.Fer.inf"] <- "Low Iron"
coef_data$term[coef_data$term == "statut.Fer.sup"] <- "High Iron"
coef_data$term[coef_data$term == "statut.Zinc.inf"] <- "Low Zinc"
coef_data$term[coef_data$term == "statut.Zinc.sup"] <- "High Zinc"
ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = paste0("PV (ml/kg) - Simple linear regressions (nutrition RNP) by city for ", unique(data$Age_categorie_binaire), " years old")) +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

# NEURO

```{r eval=FALSE, include=FALSE}
data = read.csv("data.csv")
data = data[data$Age_categorie_binaire == "0-3 ans", ]

data_csp_long <- data %>%
  pivot_longer(cols = c(CSP_M, CSP_P), names_to = "Source_CSP", values_to = "CSP") %>%
  mutate(
    CSP_cat = case_when(
      CSP %in% c(1, 2) ~ "Cadres et Professions Intellectuelles",
      CSP == 3 ~ "Professions Intermédiaires",
      CSP == 4 ~ "Personnel de soutien",
      CSP == 5 ~ "Services et Ventes",
      CSP %in% c(6, 7) ~ "Agriculture / Artisanat",
      CSP == 9 ~ "Professions élémentaires",
      CSP == 10 ~ "Étudiants",
      CSP == 11 ~ "Travail domestique",
      CSP == 0 ~ "Autres / Non spécifié",
      TRUE ~ "Inconnu"
    )
  )

data_csp_long$Ville_eval <- factor(data_csp_long$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

global_tests <- data_csp_long %>%
  group_by(CSP_cat) %>%
  nest() %>%
  rowwise() %>%
  mutate(
    p_global = {
      tmp_data <- data
      n_villes <- n_distinct(tmp_data$Ville_eval)
      
      if (n_villes < 2) {
        NA_real_
      } else if (n_villes == 2) {
        tryCatch(
          wilcox.test(variable_x ~ Ville_eval, data = tmp_data)$p.value,
          error = function(e) NA_real_
        )
      } else {
        tryCatch(
          kruskal.test(variable_x ~ Ville_eval, data = tmp_data)$p.value,
          error = function(e) NA_real_
        )
      }
    }
  ) %>%
  ungroup() %>%
  select(CSP_cat, p_global)

ville_pairs <- combn(levels(data_csp_long$Ville_eval), 2, simplify = FALSE)

all_pvals <- lapply(ville_pairs, function(pair) {
  v1 <- pair[1]
  v2 <- pair[2]
  
  data_sub <- data_csp_long %>%
    filter(Ville_eval %in% pair)
  
  data_sub %>%
    group_by(CSP_cat) %>%
    summarise(
      p = {
        if (n_distinct(Ville_eval) != 2 || any(table(Ville_eval) < 2)) {
          NA_real_
        } else {
          tryCatch({
            if (any(table(Ville_eval) < 5)) {
              wilcox.test(variable_x ~ Ville_eval)$p.value
            } else {
              kruskal.test(variable_x ~ Ville_eval)$p.value
            }
          }, error = function(e) NA_real_)
        }
      },
      group1 = v1,
      group2 = v2,
      .groups = "drop"
    )
})

p_values <- bind_rows(all_pvals) %>%
  group_by(CSP_cat) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),
    p.signif.adj = case_when(
      p_adj < 0.01 ~ "***",
      p_adj < 0.05 ~ "**",
      p_adj < 0.1 ~ "*",
      TRUE ~ "ns"
    )
  ) %>%
  ungroup() %>%
  left_join(global_tests, by = "CSP_cat") %>%
  filter(!is.na(p_global))

y_max <- data_csp_long %>%
  group_by(CSP_cat, Ville_eval) %>%
  summarise(maxY = max(variable_x, na.rm = TRUE), .groups = "drop") %>%
  group_by(CSP_cat) %>%
  summarise(maxY = max(maxY), .groups = "drop")

p_values <- p_values %>%
  left_join(y_max, by = "CSP_cat") %>%
  group_by(CSP_cat) %>%
  mutate(y.position = maxY + 5 + 5 * row_number()) %>%
  ungroup()

p_values_sig <- p_values

# Étape 5 : Graphique
ggplot(data_csp_long, aes(x = Ville_eval, y = variable_x, fill = Ville_eval)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  stat_pvalue_manual(
    data = p_values_sig,
    label = "p.signif.adj",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  facet_wrap(~CSP_cat) +
  labs(
    title = "Comparaison of mean values : -normalized Inhibition mark- for each city, by CSP, for 0-3 years old",
    x = "City",
    y = "Mean value of normalized Inhibition mark",
    caption = "* p < 0.1   ** p < 0.05   *** p < 0.01"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r eval=FALSE, include=FALSE}
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == "0-3 ans", ]

for (var in vars) {
data_csp_long <- data %>%
  pivot_longer(cols = c(CSP_M, CSP_P), names_to = "Source_CSP", values_to = "CSP") %>%
  mutate(
    CSP_cat = case_when(
  CSP %in% c(1, 2) ~ "Executives and Intellectual Professions",
  CSP == 3 ~ "Intermediate Professions",
  CSP == 4 ~ "Support Staff",
  CSP == 5 ~ "Services and Sales",
  CSP %in% c(6, 7) ~ "Agriculture / Craft",
  CSP == 9 ~ "Elementary Occupations",
  CSP == 10 ~ "Students",
  CSP == 11 ~ "Domestic Work",
  CSP == 0 ~ "Other / Unspecified",
  TRUE ~ "Unknown"
)
  )

data_csp_long <- data_csp_long %>%
  filter(CSP_cat != "Unknown")

data_csp_long$Ville_eval <- factor(
  data_csp_long$Ville_eval,
  levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)")
)

count_data <- data_csp_long %>%
  group_by(CSP_cat, Ville_eval) %>%
  summarise(
    n = n(),
    mean_value = mean(variable_x, na.rm = TRUE),
    .groups = "drop"
  )

# Graphique avec barres d'erreur et effectifs
ggplot(data_csp_long, aes(x = Ville_eval, y = variable_x, fill = Ville_eval)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2, position = position_dodge(width = 0.8)) +
  geom_text(
    data = count_data,
    aes(x = Ville_eval, y = mean_value + 25, label = paste0("n=", n)),
    inherit.aes = FALSE,
    size = 4
  ) +
  facet_wrap(~CSP_cat) +
  labs(
    title = "Comparison of mean inhibition scores (normalized) by city and occupation (0–3 years old)",
    x = "City",
    y = "Mean inhibition score"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

  print(p)  # Affiche le graphique
}
```

```{r eval=FALSE, include=FALSE}
# 1. Lecture et préparation
data <- read.csv("data.csv") %>%
  filter(Age_categorie_binaire == "0-3 ans") %>%
  mutate(
    Ville_eval = factor(
      Ville_eval,
      levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)")
    )
  )

# 2. Garder uniquement les lignes non-NA
data_clean <- data %>% filter(!is.na(variable_x))

# 3. Test global
n_villes <- n_distinct(data_clean$Ville_eval)
p_global <- if (n_villes < 2) {
  NA_real_
} else if (n_villes == 2) {
  tryCatch(wilcox.test(variable_x ~ Ville_eval, data = data_clean)$p.value, error = function(e) NA_real_)
} else {
  tryCatch(kruskal.test(variable_x ~ Ville_eval, data = data_clean)$p.value, error = function(e) NA_real_)
}

# 4. Paires de villes + tests
ville_pairs <- combn(levels(data_clean$Ville_eval), 2, simplify = FALSE)

all_pvals <- lapply(ville_pairs, function(pair) {
  sub_data <- data_clean %>% filter(Ville_eval %in% pair)

  p <- if (n_distinct(sub_data$Ville_eval) != 2 || any(table(sub_data$Ville_eval) < 2)) {
    NA_real_
  } else {
    tryCatch({
      if (any(table(sub_data$Ville_eval) < 5)) {
        wilcox.test(variable_x ~ Ville_eval, data = sub_data)$p.value
      } else {
        kruskal.test(variable_x ~ Ville_eval, data = sub_data)$p.value
      }
    }, error = function(e) NA_real_)
  }

  data.frame(group1 = pair[1], group2 = pair[2], p = p)
})

y_max <- max(data_clean$variable_x, na.rm = TRUE)
p_values <- bind_rows(all_pvals) %>%
  mutate(
    p_adj = p.adjust(p, method = "BH"),
    p.signif.adj = case_when(
      p_adj < 0.01 ~ "***",
      p_adj < 0.05 ~ "**",
      p_adj < 0.1 ~ "*",
      TRUE ~ "ns"
    ),
    y.position = y_max + 5 + 5 * row_number()
  )

# 5. Y-position des annotations
p_values <- p_values %>%
  mutate(y.position = y_max + 5 + 5 * row_number())

# 6. Graphique final
ggplot(data_clean, aes(x = Ville_eval, y = variable_x, fill = Ville_eval)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2, position = position_dodge(width = 0.8)) +
  stat_pvalue_manual(
    data = p_values,
    label = "p.signif.adj",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    step.increase = 0,
    inherit.aes = FALSE
  ) +
  labs(
    title = "Comparison of normalized inhibition score (0–3 years old)",
    x = "City",
    y = "Mean inhibition score",
    caption = "* p < 0.1   ** p < 0.05   *** p < 0.01"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


# NEURO FINAL

```{r}
data = read.csv("data.csv")
vars = names(data)[grepl("_Nota_T|_Z|QI_", names(data))]
vars = vars[sapply(vars, function(v) any(!is.na(data[[v]])))]
```



```{r}
for (var in vars) {
  data <- read.csv("data.csv")
  
data_csp_long <- data %>%
  pivot_longer(cols = c(CSP_M, CSP_P), names_to = "Source_CSP", values_to = "CSP") %>%
  mutate(
    CSP_cat = case_when(
      CSP %in% c(1, 2) ~ "Executives / Intellectual professions",
      CSP %in% c(3, 4) ~ "Intermediate / Clerical staff",
      CSP %in% c(5, 6, 7, 9, 11) ~ "Manual jobs / Service workers",
      CSP %in% c(0, 10) ~ "Others / Inactive",
      TRUE ~ "Unknown"
    )
  )
  
  # 🔁 Définir variable_x dynamiquement
  data_csp_long$variable_x <- as.numeric(gsub('"', '', data_csp_long[[var]]))
  
  data_csp_long <- data_csp_long %>%
    filter(CSP_cat != "Unknown")
  
  data_csp_long$Ville_eval <- factor(
    data_csp_long$Ville_eval,
    levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)")
  )
  
  count_data <- data_csp_long %>%
    group_by(CSP_cat, Ville_eval) %>%
    summarise(
      n = n(),
      mean_value = mean(variable_x, na.rm = TRUE),
      .groups = "drop"
    )
  
  # 📊 Graphique
  p <- ggplot(data_csp_long, aes(x = Ville_eval, y = variable_x, fill = Ville_eval)) +
    stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
    stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2, position = position_dodge(width = 0.8)) +
    facet_wrap(~CSP_cat) +
    labs(
      title = paste0("Comparison of mean normalized scores of -", var, "- by city and occupation (0–3 years old):"),
      x = "City",
      y = "Mean score",
      fill = "City"
    ) +
  scale_fill_manual(values = c(
    "Lima (150m)" = "#1b9e77",
    "Cusco (3400m)" = "#d95f02",
    "Juliaca (3800m)" = "#7570b3",
    "La Rinconada (5100m)" = "#e7298a"
  )) +
    theme_minimal(base_size = 14) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  print(p)  # Affiche le graphique
}
```

```{r}
for (var in vars) {
  # 1. Lecture et mise en forme
  data <- read.csv("data.csv")
  
  data <- data %>%
    pivot_longer(cols = c(CSP_M, CSP_P), names_to = "Source_CSP", values_to = "CSP") %>%
    mutate(
      CSP_reduced = case_when(
        CSP %in% c(1, 2) ~ "Executives / Intellectual professions",
        CSP %in% c(3, 4) ~ "Intermediate / Clerical staff",
        CSP %in% c(5, 6, 7, 9, 11) ~ "Manual jobs / Service workers",
        CSP %in% c(0, 10) ~ "Others / Inactive",
        TRUE ~ "Unknown"
      ),
      CSP_reduced = factor(
        CSP_reduced,
        levels = c(
          "Executives / Intellectual professions",
          "Intermediate / Clerical staff",
          "Manual jobs / Service workers",
          "Others / Inactive"
        )
      )
    )

  # 2. Conversion de la variable cible
  data$variable_x <- data[[var]]
  
  # 3. Nettoyage
  data_clean <- data %>% filter(!is.na(variable_x), !is.na(CSP_reduced))
  
  # 4. Test global
  n_cats <- n_distinct(data_clean$CSP_reduced)
  p_global <- if (n_cats < 2) {
    NA_real_
  } else if (n_cats == 2) {
    tryCatch(wilcox.test(variable_x ~ CSP_reduced, data = data_clean)$p.value, error = function(e) NA_real_)
  } else {
    tryCatch(kruskal.test(variable_x ~ CSP_reduced, data = data_clean)$p.value, error = function(e) NA_real_)
  }

  # 5. Comparaisons par paires
  present_levels <- levels(droplevels(data_clean$CSP_reduced))
  present_levels <- present_levels[present_levels %in% unique(data_clean$CSP_reduced)]

  if (length(present_levels) >= 2) {
    csp_pairs <- combn(present_levels, 2, simplify = FALSE)

    all_pvals <- lapply(csp_pairs, function(pair) {
      sub_data <- data_clean %>% filter(CSP_reduced %in% pair)

      p <- tryCatch({
        wilcox.test(variable_x ~ CSP_reduced, data = sub_data)$p.value
      }, error = function(e) {
        message("Test failed for: ", paste(pair, collapse = " vs "))
        NA_real_
      })

      data.frame(group1 = pair[1], group2 = pair[2], p = p)
    })

    y_max <- max(data_clean$variable_x, na.rm = TRUE)
    p_values <- bind_rows(all_pvals) %>%
      mutate(
        p_adj = p.adjust(p, method = "BH"),
        p.signif.adj = case_when(
          p_adj < 0.01 ~ "***",
          p_adj < 0.05 ~ "**",
          p_adj < 0.1 ~ "*",
          TRUE ~ NA_character_
        ),
        y.position = y_max + 5 + 5 * row_number()
      )

    # 6. Graphique final
    p <- ggplot(data_clean, aes(x = CSP_reduced, y = variable_x, fill = CSP_reduced)) +
      stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
      stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2, position = position_dodge(width = 0.8)) +
      stat_pvalue_manual(
        data = p_values,
        label = "p.signif.adj",
        y.position = "y.position",
        xmin = "group1",
        xmax = "group2",
        tip.length = 0.01,
        bracket.size = 0.6,
        step.increase = 0,
        inherit.aes = FALSE
      ) +
      scale_fill_manual(values = c(
        "Executives / Intellectual professions" = "#1b9e77",
        "Intermediate / Clerical staff" = "#d95f02",
        "Manual jobs / Service workers" = "#7570b3",
        "Others / Inactive" = "#e7298a"
      )) +
      labs(
        title = paste("Comparison of", var, "by socio-professional category"),
        x = "Socio-professional category",
        y = paste("Mean of", var),
        caption = "* p < 0.1   ** p < 0.05   *** p < 0.01",
        fill = "CSP"
      ) +
      theme_minimal(base_size = 14) +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))

    print(p)

  } else {
    message(paste("Not enough CSP groups to compare for variable:", var))
  }
}
```

```{r}

# === Chargement des données ===
data <- read.csv("data.csv")

# === Calcul des p-valeurs globales ===
resultats <- map_dfr(vars, function(var) {
  data_clean <- data %>%
    select(Ville_eval, !!sym(var)) %>%
    rename(Valeur = !!sym(var)) %>%
    filter(!is.na(Valeur), !is.na(Ville_eval))

  n_cities <- n_distinct(data_clean$Ville_eval)

  pval <- if (n_cities < 2) {
    NA_real_
  } else if (n_cities == 2) {
    tryCatch(
      wilcox.test(Valeur ~ Ville_eval, data = data_clean)$p.value,
      error = function(e) NA_real_
    )
  } else {
    tryCatch(
      kruskal.test(Valeur ~ Ville_eval, data = data_clean)$p.value,
      error = function(e) NA_real_
    )
  }

  tibble(
    Variable = var,
    p_value = pval,
    p_signif = case_when(
      is.na(pval)        ~ "NA",
      pval < 0.001       ~ "***",
      pval < 0.01        ~ "**",
      pval < 0.05        ~ "*",
      pval < 0.1         ~ ".",
      TRUE               ~ "ns"
    )
  )
})

# === Affichage du tableau
print(resultats)

```


```{r}
for (var in vars) {
  # 1. Lecture et mise en forme
  data <- read.csv("data.csv") %>%
    mutate(
      Ville_eval = factor(
        Ville_eval,
        levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)")
      )
    )

  # 2. Variable cible
  data$variable_x <- data[[var]]
  
  # 3. Nettoyage des NA
  data_clean <- data %>% filter(!is.na(variable_x), !is.na(Ville_eval))
  
  # 4. Test global
  n_villes <- n_distinct(data_clean$Ville_eval)
  p_global <- if (n_villes < 2) {
    NA_real_
  } else if (n_villes == 2) {
    tryCatch(wilcox.test(variable_x ~ Ville_eval, data = data_clean)$p.value, error = function(e) NA_real_)
  } else {
    tryCatch(kruskal.test(variable_x ~ Ville_eval, data = data_clean)$p.value, error = function(e) NA_real_)
  }

  # 5. Tests par paires entre villes
  present_levels <- levels(droplevels(data_clean$Ville_eval))
  present_levels <- present_levels[present_levels %in% unique(data_clean$Ville_eval)]

  if (length(present_levels) >= 2) {
    ville_pairs <- combn(present_levels, 2, simplify = FALSE)

    all_pvals <- lapply(ville_pairs, function(pair) {
      sub_data <- data_clean %>% filter(Ville_eval %in% pair)

      p <- tryCatch({
        wilcox.test(variable_x ~ Ville_eval, data = sub_data)$p.value
      }, error = function(e) {
        message("Test failed for: ", paste(pair, collapse = " vs "))
        NA_real_
      })

      data.frame(group1 = pair[1], group2 = pair[2], p = p)
    })

    y_max <- max(data_clean$variable_x, na.rm = TRUE)
    p_values <- bind_rows(all_pvals) %>%
      mutate(
        p_adj = p.adjust(p, method = "BH"),
        p.signif.adj = case_when(
          p_adj < 0.01 ~ "***",
          p_adj < 0.05 ~ "**",
          p_adj < 0.1 ~ "*",
          TRUE ~ NA_character_
        ),
        y.position = y_max + 5 + 5 * row_number()
      )

    # 6. Graphique
    p <- ggplot(data_clean, aes(x = Ville_eval, y = variable_x, fill = Ville_eval)) +
      stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 0.8)) +
      stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2, position = position_dodge(width = 0.8)) +
      stat_pvalue_manual(
        data = p_values,
        label = "p.signif.adj",
        y.position = "y.position",
        xmin = "group1",
        xmax = "group2",
        tip.length = 0.01,
        bracket.size = 0.6,
        step.increase = 0,
        inherit.aes = FALSE
      ) +
      labs(
        title = paste("Comparison of", var, "between cities"),
        x = "City",
        y = paste("Mean of", var),
        caption = "* p < 0.1   ** p < 0.05   *** p < 0.01",
      fill = "City"
    ) +
  scale_fill_manual(values = c(
    "Lima (150m)" = "#1b9e77",
    "Cusco (3400m)" = "#d95f02",
    "Juliaca (3800m)" = "#7570b3",
    "La Rinconada (5100m)" = "#e7298a"
  )) +
      theme_minimal(base_size = 14) +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))

    print(p)
    
  } else {
    message(paste("Not enough cities to compare for variable:", var))
  }
}
```



# Modèles neuro

```{r}
# HB


data = read.csv("data.csv")



data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(HB ~ Inhibicion_Nota_T, data = df),
  mod_Lipides   = lm(HB ~ Supervision_Si_Mismo_Nota_T, data = df),
  mod_Glucides  = lm(HB ~ Flexibilidad_Nota_T, data = df),
  mod_Fibres    = lm(HB ~ Control_Emocional_Nota_T, data = df),
  mod_Calcium   = lm(HB ~ Iniciativa_Nota_T, data = df),
  mod_Fer       = lm(HB ~ Memoria_Trabajo_Nota_T, data = df),
  mod_Zinc      = lm(HB ~ Planificacion_Organizacion_Nota_T, data = df),
  mod_VitC      = lm(HB ~ Supervision_Tarea_Nota_T, data = df),
  mod_VitC2      = lm(HB ~ Organizacion_Materiales_Nota_T, data = df),
  mod_VitC3      = lm(HB ~ BRIEF_IAI_Nota_T, data = df),
  mod_VitC4      = lm(HB ~ BRIEF_IFL_Nota_T, data = df),
  mod_VitC5      = lm(HB ~ BRIEF_IME_Nota_T, data = df),
  mod_VitC6      = lm(HB ~ BRIEF_IGFE_Nota_T, data = df),
  mod_VitC7      = lm(HB ~ BRIEF2_IRCN_Nota_T, data = df),
  mod_VitC8      = lm(HB ~ BRIEF2_IREM_Nota_T, data = df),
  mod_VitC9      = lm(HB ~ BRIEF2_IRCG_Nota_T, data = df),
  mod_VitC10      = lm(HB ~ BRIEF2_IGE_Nota_T, data = df),
    mod_VitC20      = lm(HB ~ QI_Matrice, data = df),
    mod_VitC21      = lm(HB ~ QI_Code, data = df),
    mod_VitC22      = lm(HB ~ QI_Barrage, data = df),
    mod_VitC23      = lm(HB ~ QI_Labyrinthe, data = df),
    mod_VitC24      = lm(HB ~ MD_Z, data = df),
    mod_VitC25      = lm(HB ~ MND_Z, data = df),
    mod_VitC26      = lm(HB ~ Coordination_Z, data = df),
    mod_VitC27      = lm(HB ~ Assemblage_Z, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Inhibition"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Supervision"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Flexibility"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Emotional Control"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Initiative"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Memory-Work"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Planification"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Supervision"),
    tidy(mods$mod_VitC2, conf.int = TRUE) %>% mutate(model = "Organization"),
    tidy(mods$mod_VitC3, conf.int = TRUE) %>% mutate(model = "BRIEF IAI"),
    tidy(mods$mod_VitC4, conf.int = TRUE) %>% mutate(model = "BRIEF IFL"),
    tidy(mods$mod_VitC5, conf.int = TRUE) %>% mutate(model = "BRIEF IME"),
    tidy(mods$mod_VitC6, conf.int = TRUE) %>% mutate(model = "BRIEF IGFE"),
    tidy(mods$mod_VitC7, conf.int = TRUE) %>% mutate(model = "BRIEF2 IRCN"),
    tidy(mods$mod_VitC8, conf.int = TRUE) %>% mutate(model = "BRIEF2 IREM"),
    tidy(mods$mod_VitC9, conf.int = TRUE) %>% mutate(model = "BRIEF2 IRCG"),
    tidy(mods$mod_VitC10, conf.int = TRUE) %>% mutate(model = "BRIEF2 IGE"),
    tidy(mods$mod_VitC20, conf.int = TRUE) %>% mutate(model = "QI Code"),
    tidy(mods$mod_VitC21, conf.int = TRUE) %>% mutate(model = "QI Matrice"),
    tidy(mods$mod_VitC22, conf.int = TRUE) %>% mutate(model = "QI Barrage"),
    tidy(mods$mod_VitC23, conf.int = TRUE) %>% mutate(model = "QI Labyrinthe"),
    tidy(mods$mod_VitC24, conf.int = TRUE) %>% mutate(model = "MD Z"),
    tidy(mods$mod_VitC25, conf.int = TRUE) %>% mutate(model = "MND Z"),
    tidy(mods$mod_VitC26, conf.int = TRUE) %>% mutate(model = "Coordination Z"),
    tidy(mods$mod_VitC27, conf.int = TRUE) %>% mutate(model = "Assemblage_Z"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "Inhibicion_Nota_T"] <- "Inhibition"
coef_data$term[coef_data$term == "Supervision_Si_Mismo_Nota_T"] <- "Supervision"
coef_data$term[coef_data$term == "Flexibilidad_Nota_T"] <- "Flexibility"
coef_data$term[coef_data$term == "Control_Emocional_Nota_T"] <- "Emotional Control"
coef_data$term[coef_data$term == "Iniciativa_Nota_T"] <- "Initiative"
coef_data$term[coef_data$term == "Memoria_Trabajo_Nota_T"] <- "Memory-Work"
coef_data$term[coef_data$term == "Planificacion_Organizacion_Nota_T"] <- "Planification"
coef_data$term[coef_data$term == "Supervision_Tarea_Nota_T"] <- "Supervision"
coef_data$term[coef_data$term == "Organizacion_Materiales_Nota_T"] <- "Organization"
coef_data$term[coef_data$term == "BRIEF_IAI_Nota_T"] <- "BRIEF IAI"
coef_data$term[coef_data$term == "BRIEF_IFL_Nota_T"] <- "BRIEF IFL"
coef_data$term[coef_data$term == "BRIEF_IME_Nota_T"] <- "BRIEF IME"
coef_data$term[coef_data$term == "BRIEF_IGFE_Nota_T"] <- "BRIEF IFGE"
coef_data$term[coef_data$term == "BRIEF2_IRCN_Nota_T"] <- "BRIEF2 IRCN"
coef_data$term[coef_data$term == "BRIEF2_IREM_Nota_T"] <- "BRIEF2 IREM"
coef_data$term[coef_data$term == "BRIEF2_IRCG_Nota_T"] <- "BRIEF2 IRCG"
coef_data$term[coef_data$term == "BRIEF2_IGE_Nota_T"] <- "BRIEF2 IGE"
coef_data$term[coef_data$term == "QI_Matrice"] <- "QI Matrice"
coef_data$term[coef_data$term == "QI_Code"] <- "QI Code"
coef_data$term[coef_data$term == "QI_Barrage"] <- "QI Barrage"
coef_data$term[coef_data$term == "QI_Labyrinthe"] <- "QI Labyrinthe"
coef_data$term[coef_data$term == "MD_Z"] <- "MD Z"
coef_data$term[coef_data$term == "MND_Z"] <- "MND Z"
coef_data$term[coef_data$term == "Coordination_Z"] <- "Coordination Z"
coef_data$term[coef_data$term == "Assemblage_Z"] <- "Assemblage Z"

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "Hb - Simple linear regressions (neurotests) by city") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")

coef_table_stars <- coef_data %>%
  mutate(
    stars = case_when(
      p.value <= 0.01 ~ "***",
      p.value <= 0.05 ~ "**",
      p.value <= 0.1 ~ "*",
      TRUE ~ ""
    )
  ) %>%
  select(Ville_eval, term, stars)

ggplot(coef_table_stars, aes(x = Ville_eval, y = term, fill = stars != "")) +
geom_tile(color = "white") +
geom_text(aes(label = stars), size = 5) +
scale_fill_manual(
  values = c("TRUE" = "#1b9e77", "FALSE" = "#e0e0e0"),
  guide = FALSE
) +
labs(
  title = "Modèles simples : HB ~ neuro",
  x = "Ville",
  y = "Variable explicative"
) +
theme_minimal() +
theme(
  axis.text.x = element_text(angle = 20, hjust = 1),
  panel.grid = element_blank()
)
```


```{r}
# HCT


data = read.csv("data.csv")



data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(HCT.. ~ Inhibicion_Nota_T, data = df),
  mod_Lipides   = lm(HCT.. ~ Supervision_Si_Mismo_Nota_T, data = df),
  mod_Glucides  = lm(HCT.. ~ Flexibilidad_Nota_T, data = df),
  mod_Fibres    = lm(HCT.. ~ Control_Emocional_Nota_T, data = df),
  mod_Calcium   = lm(HCT.. ~ Iniciativa_Nota_T, data = df),
  mod_Fer       = lm(HCT.. ~ Memoria_Trabajo_Nota_T, data = df),
  mod_Zinc      = lm(HCT.. ~ Planificacion_Organizacion_Nota_T, data = df),
  mod_VitC      = lm(HCT.. ~ Supervision_Tarea_Nota_T, data = df),
  mod_VitC2      = lm(HCT.. ~ Organizacion_Materiales_Nota_T, data = df),
  mod_VitC3      = lm(HCT.. ~ BRIEF_IAI_Nota_T, data = df),
  mod_VitC4      = lm(HCT.. ~ BRIEF_IFL_Nota_T, data = df),
  mod_VitC5      = lm(HCT.. ~ BRIEF_IME_Nota_T, data = df),
  mod_VitC6      = lm(HCT.. ~ BRIEF_IGFE_Nota_T, data = df),
  mod_VitC7      = lm(HCT.. ~ BRIEF2_IRCN_Nota_T, data = df),
  mod_VitC8      = lm(HCT.. ~ BRIEF2_IREM_Nota_T, data = df),
  mod_VitC9      = lm(HCT.. ~ BRIEF2_IRCG_Nota_T, data = df),
  mod_VitC10      = lm(HCT.. ~ BRIEF2_IGE_Nota_T, data = df),
    mod_VitC20      = lm(HCT.. ~ QI_Matrice, data = df),
    mod_VitC21      = lm(HCT.. ~ QI_Code, data = df),
    mod_VitC22      = lm(HCT.. ~ QI_Barrage, data = df),
    mod_VitC23      = lm(HCT.. ~ QI_Labyrinthe, data = df),
    mod_VitC24      = lm(HCT.. ~ MD_Z, data = df),
    mod_VitC25      = lm(HCT.. ~ MND_Z, data = df),
    mod_VitC26      = lm(HCT.. ~ Coordination_Z, data = df),
    mod_VitC27      = lm(HCT.. ~ Assemblage_Z, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Inhibition"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Supervision"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Flexibility"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Emotional Control"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Initiative"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Memory-Work"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Planification"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Supervision"),
    tidy(mods$mod_VitC2, conf.int = TRUE) %>% mutate(model = "Organization"),
    tidy(mods$mod_VitC3, conf.int = TRUE) %>% mutate(model = "BRIEF IAI"),
    tidy(mods$mod_VitC4, conf.int = TRUE) %>% mutate(model = "BRIEF IFL"),
    tidy(mods$mod_VitC5, conf.int = TRUE) %>% mutate(model = "BRIEF IME"),
    tidy(mods$mod_VitC6, conf.int = TRUE) %>% mutate(model = "BRIEF IGFE"),
    tidy(mods$mod_VitC7, conf.int = TRUE) %>% mutate(model = "BRIEF2 IRCN"),
    tidy(mods$mod_VitC8, conf.int = TRUE) %>% mutate(model = "BRIEF2 IREM"),
    tidy(mods$mod_VitC9, conf.int = TRUE) %>% mutate(model = "BRIEF2 IRCG"),
    tidy(mods$mod_VitC10, conf.int = TRUE) %>% mutate(model = "BRIEF2 IGE"),
    tidy(mods$mod_VitC20, conf.int = TRUE) %>% mutate(model = "QI Code"),
    tidy(mods$mod_VitC21, conf.int = TRUE) %>% mutate(model = "QI Matrice"),
    tidy(mods$mod_VitC22, conf.int = TRUE) %>% mutate(model = "QI Barrage"),
    tidy(mods$mod_VitC23, conf.int = TRUE) %>% mutate(model = "QI Labyrinthe"),
    tidy(mods$mod_VitC24, conf.int = TRUE) %>% mutate(model = "MD Z"),
    tidy(mods$mod_VitC25, conf.int = TRUE) %>% mutate(model = "MND Z"),
    tidy(mods$mod_VitC26, conf.int = TRUE) %>% mutate(model = "Coordination Z"),
    tidy(mods$mod_VitC27, conf.int = TRUE) %>% mutate(model = "Assemblage_Z"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "Inhibicion_Nota_T"] <- "Inhibition"
coef_data$term[coef_data$term == "Supervision_Si_Mismo_Nota_T"] <- "Supervision"
coef_data$term[coef_data$term == "Flexibilidad_Nota_T"] <- "Flexibility"
coef_data$term[coef_data$term == "Control_Emocional_Nota_T"] <- "Emotional Control"
coef_data$term[coef_data$term == "Iniciativa_Nota_T"] <- "Initiative"
coef_data$term[coef_data$term == "Memoria_Trabajo_Nota_T"] <- "Memory-Work"
coef_data$term[coef_data$term == "Planificacion_Organizacion_Nota_T"] <- "Planification"
coef_data$term[coef_data$term == "Supervision_Tarea_Nota_T"] <- "Supervision"
coef_data$term[coef_data$term == "Organizacion_Materiales_Nota_T"] <- "Organization"
coef_data$term[coef_data$term == "BRIEF_IAI_Nota_T"] <- "BRIEF IAI"
coef_data$term[coef_data$term == "BRIEF_IFL_Nota_T"] <- "BRIEF IFL"
coef_data$term[coef_data$term == "BRIEF_IME_Nota_T"] <- "BRIEF IME"
coef_data$term[coef_data$term == "BRIEF_IGFE_Nota_T"] <- "BRIEF IFGE"
coef_data$term[coef_data$term == "BRIEF2_IRCN_Nota_T"] <- "BRIEF2 IRCN"
coef_data$term[coef_data$term == "BRIEF2_IREM_Nota_T"] <- "BRIEF2 IREM"
coef_data$term[coef_data$term == "BRIEF2_IRCG_Nota_T"] <- "BRIEF2 IRCG"
coef_data$term[coef_data$term == "BRIEF2_IGE_Nota_T"] <- "BRIEF2 IGE"
coef_data$term[coef_data$term == "QI_Matrice"] <- "QI Matrice"
coef_data$term[coef_data$term == "QI_Code"] <- "QI Code"
coef_data$term[coef_data$term == "QI_Barrage"] <- "QI Barrage"
coef_data$term[coef_data$term == "QI_Labyrinthe"] <- "QI Labyrinthe"
coef_data$term[coef_data$term == "MD_Z"] <- "MD Z"
coef_data$term[coef_data$term == "MND_Z"] <- "MND Z"
coef_data$term[coef_data$term == "Coordination_Z"] <- "Coordination Z"
coef_data$term[coef_data$term == "Assemblage_Z"] <- "Assemblage Z"

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "HCT (%) - Simple linear regressions (neurotests) by city") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# RBC


data = read.csv("data.csv")



data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(RBC..106.µL. ~ Inhibicion_Nota_T, data = df),
  mod_Lipides   = lm(RBC..106.µL. ~ Supervision_Si_Mismo_Nota_T, data = df),
  mod_Glucides  = lm(RBC..106.µL. ~ Flexibilidad_Nota_T, data = df),
  mod_Fibres    = lm(RBC..106.µL. ~ Control_Emocional_Nota_T, data = df),
  mod_Calcium   = lm(RBC..106.µL. ~ Iniciativa_Nota_T, data = df),
  mod_Fer       = lm(RBC..106.µL. ~ Memoria_Trabajo_Nota_T, data = df),
  mod_Zinc      = lm(RBC..106.µL. ~ Planificacion_Organizacion_Nota_T, data = df),
  mod_VitC      = lm(RBC..106.µL. ~ Supervision_Tarea_Nota_T, data = df),
  mod_VitC2      = lm(RBC..106.µL. ~ Organizacion_Materiales_Nota_T, data = df),
  mod_VitC3      = lm(RBC..106.µL. ~ BRIEF_IAI_Nota_T, data = df),
  mod_VitC4      = lm(RBC..106.µL. ~ BRIEF_IFL_Nota_T, data = df),
  mod_VitC5      = lm(RBC..106.µL. ~ BRIEF_IME_Nota_T, data = df),
  mod_VitC6      = lm(RBC..106.µL. ~ BRIEF_IGFE_Nota_T, data = df),
  mod_VitC7      = lm(RBC..106.µL. ~ BRIEF2_IRCN_Nota_T, data = df),
  mod_VitC8      = lm(RBC..106.µL. ~ BRIEF2_IREM_Nota_T, data = df),
  mod_VitC9      = lm(RBC..106.µL. ~ BRIEF2_IRCG_Nota_T, data = df),
  mod_VitC10      = lm(RBC..106.µL. ~ BRIEF2_IGE_Nota_T, data = df),
    mod_VitC20      = lm(RBC..106.µL. ~ QI_Matrice, data = df),
    mod_VitC21      = lm(RBC..106.µL. ~ QI_Code, data = df),
    mod_VitC22      = lm(RBC..106.µL. ~ QI_Barrage, data = df),
    mod_VitC23      = lm(RBC..106.µL. ~ QI_Labyrinthe, data = df),
    mod_VitC24      = lm(RBC..106.µL. ~ MD_Z, data = df),
    mod_VitC25      = lm(RBC..106.µL. ~ MND_Z, data = df),
    mod_VitC26      = lm(RBC..106.µL. ~ Coordination_Z, data = df),
    mod_VitC27      = lm(RBC..106.µL. ~ Assemblage_Z, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Inhibition"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Supervision"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Flexibility"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Emotional Control"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Initiative"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Memory-Work"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Planification"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Supervision"),
    tidy(mods$mod_VitC2, conf.int = TRUE) %>% mutate(model = "Organization"),
    tidy(mods$mod_VitC3, conf.int = TRUE) %>% mutate(model = "BRIEF IAI"),
    tidy(mods$mod_VitC4, conf.int = TRUE) %>% mutate(model = "BRIEF IFL"),
    tidy(mods$mod_VitC5, conf.int = TRUE) %>% mutate(model = "BRIEF IME"),
    tidy(mods$mod_VitC6, conf.int = TRUE) %>% mutate(model = "BRIEF IGFE"),
    tidy(mods$mod_VitC7, conf.int = TRUE) %>% mutate(model = "BRIEF2 IRCN"),
    tidy(mods$mod_VitC8, conf.int = TRUE) %>% mutate(model = "BRIEF2 IREM"),
    tidy(mods$mod_VitC9, conf.int = TRUE) %>% mutate(model = "BRIEF2 IRCG"),
    tidy(mods$mod_VitC10, conf.int = TRUE) %>% mutate(model = "BRIEF2 IGE"),
    tidy(mods$mod_VitC20, conf.int = TRUE) %>% mutate(model = "QI Code"),
    tidy(mods$mod_VitC21, conf.int = TRUE) %>% mutate(model = "QI Matrice"),
    tidy(mods$mod_VitC22, conf.int = TRUE) %>% mutate(model = "QI Barrage"),
    tidy(mods$mod_VitC23, conf.int = TRUE) %>% mutate(model = "QI Labyrinthe"),
    tidy(mods$mod_VitC24, conf.int = TRUE) %>% mutate(model = "MD Z"),
    tidy(mods$mod_VitC25, conf.int = TRUE) %>% mutate(model = "MND Z"),
    tidy(mods$mod_VitC26, conf.int = TRUE) %>% mutate(model = "Coordination Z"),
    tidy(mods$mod_VitC27, conf.int = TRUE) %>% mutate(model = "Assemblage_Z"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "Inhibicion_Nota_T"] <- "Inhibition"
coef_data$term[coef_data$term == "Supervision_Si_Mismo_Nota_T"] <- "Supervision"
coef_data$term[coef_data$term == "Flexibilidad_Nota_T"] <- "Flexibility"
coef_data$term[coef_data$term == "Control_Emocional_Nota_T"] <- "Emotional Control"
coef_data$term[coef_data$term == "Iniciativa_Nota_T"] <- "Initiative"
coef_data$term[coef_data$term == "Memoria_Trabajo_Nota_T"] <- "Memory-Work"
coef_data$term[coef_data$term == "Planificacion_Organizacion_Nota_T"] <- "Planification"
coef_data$term[coef_data$term == "Supervision_Tarea_Nota_T"] <- "Supervision"
coef_data$term[coef_data$term == "Organizacion_Materiales_Nota_T"] <- "Organization"
coef_data$term[coef_data$term == "BRIEF_IAI_Nota_T"] <- "BRIEF IAI"
coef_data$term[coef_data$term == "BRIEF_IFL_Nota_T"] <- "BRIEF IFL"
coef_data$term[coef_data$term == "BRIEF_IME_Nota_T"] <- "BRIEF IME"
coef_data$term[coef_data$term == "BRIEF_IGFE_Nota_T"] <- "BRIEF IFGE"
coef_data$term[coef_data$term == "BRIEF2_IRCN_Nota_T"] <- "BRIEF2 IRCN"
coef_data$term[coef_data$term == "BRIEF2_IREM_Nota_T"] <- "BRIEF2 IREM"
coef_data$term[coef_data$term == "BRIEF2_IRCG_Nota_T"] <- "BRIEF2 IRCG"
coef_data$term[coef_data$term == "BRIEF2_IGE_Nota_T"] <- "BRIEF2 IGE"
coef_data$term[coef_data$term == "QI_Matrice"] <- "QI Matrice"
coef_data$term[coef_data$term == "QI_Code"] <- "QI Code"
coef_data$term[coef_data$term == "QI_Barrage"] <- "QI Barrage"
coef_data$term[coef_data$term == "QI_Labyrinthe"] <- "QI Labyrinthe"
coef_data$term[coef_data$term == "MD_Z"] <- "MD Z"
coef_data$term[coef_data$term == "MND_Z"] <- "MND Z"
coef_data$term[coef_data$term == "Coordination_Z"] <- "Coordination Z"
coef_data$term[coef_data$term == "Assemblage_Z"] <- "Assemblage Z"

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "RBC (106 µL) - Simple linear regressions (neurotests) by city") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# RBCV..ml.


data = read.csv("data.csv")



data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(RBCV..ml. ~ Inhibicion_Nota_T, data = df),
  mod_Lipides   = lm(RBCV..ml. ~ Supervision_Si_Mismo_Nota_T, data = df),
  mod_Glucides  = lm(RBCV..ml. ~ Flexibilidad_Nota_T, data = df),
  mod_Fibres    = lm(RBCV..ml. ~ Control_Emocional_Nota_T, data = df),
  mod_Calcium   = lm(RBCV..ml. ~ Iniciativa_Nota_T, data = df),
  mod_Fer       = lm(RBCV..ml. ~ Memoria_Trabajo_Nota_T, data = df),
  mod_Zinc      = lm(RBCV..ml. ~ Planificacion_Organizacion_Nota_T, data = df),
  mod_VitC      = lm(RBCV..ml. ~ Supervision_Tarea_Nota_T, data = df),
  mod_VitC2      = lm(RBCV..ml. ~ Organizacion_Materiales_Nota_T, data = df),
  mod_VitC7      = lm(RBCV..ml. ~ BRIEF2_IRCN_Nota_T, data = df),
  mod_VitC8      = lm(RBCV..ml. ~ BRIEF2_IREM_Nota_T, data = df),
  mod_VitC9      = lm(RBCV..ml. ~ BRIEF2_IRCG_Nota_T, data = df),
  mod_VitC10      = lm(RBCV..ml. ~ BRIEF2_IGE_Nota_T, data = df),
    mod_VitC20      = lm(RBCV..ml. ~ QI_Matrice, data = df),
    mod_VitC21      = lm(RBCV..ml. ~ QI_Code, data = df),
    mod_VitC22      = lm(RBCV..ml. ~ QI_Barrage, data = df),
    mod_VitC23      = lm(RBCV..ml. ~ QI_Labyrinthe, data = df),
    mod_VitC24      = lm(RBCV..ml. ~ MD_Z, data = df),
    mod_VitC25      = lm(RBCV..ml. ~ MND_Z, data = df),
    mod_VitC26      = lm(RBCV..ml. ~ Coordination_Z, data = df),
    mod_VitC27      = lm(RBCV..ml. ~ Assemblage_Z, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Inhibition"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Supervision"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Flexibility"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Emotional Control"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Initiative"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Memory-Work"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Planification"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Supervision"),
    tidy(mods$mod_VitC2, conf.int = TRUE) %>% mutate(model = "Organization"),
    tidy(mods$mod_VitC3, conf.int = TRUE) %>% mutate(model = "BRIEF IAI"),
    tidy(mods$mod_VitC4, conf.int = TRUE) %>% mutate(model = "BRIEF IFL"),
    tidy(mods$mod_VitC5, conf.int = TRUE) %>% mutate(model = "BRIEF IME"),
    tidy(mods$mod_VitC6, conf.int = TRUE) %>% mutate(model = "BRIEF IGFE"),
    tidy(mods$mod_VitC7, conf.int = TRUE) %>% mutate(model = "BRIEF2 IRCN"),
    tidy(mods$mod_VitC8, conf.int = TRUE) %>% mutate(model = "BRIEF2 IREM"),
    tidy(mods$mod_VitC9, conf.int = TRUE) %>% mutate(model = "BRIEF2 IRCG"),
    tidy(mods$mod_VitC10, conf.int = TRUE) %>% mutate(model = "BRIEF2 IGE"),
    tidy(mods$mod_VitC20, conf.int = TRUE) %>% mutate(model = "QI Code"),
    tidy(mods$mod_VitC21, conf.int = TRUE) %>% mutate(model = "QI Matrice"),
    tidy(mods$mod_VitC22, conf.int = TRUE) %>% mutate(model = "QI Barrage"),
    tidy(mods$mod_VitC23, conf.int = TRUE) %>% mutate(model = "QI Labyrinthe"),
    tidy(mods$mod_VitC24, conf.int = TRUE) %>% mutate(model = "MD Z"),
    tidy(mods$mod_VitC25, conf.int = TRUE) %>% mutate(model = "MND Z"),
    tidy(mods$mod_VitC26, conf.int = TRUE) %>% mutate(model = "Coordination Z"),
    tidy(mods$mod_VitC27, conf.int = TRUE) %>% mutate(model = "Assemblage_Z"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "Inhibicion_Nota_T"] <- "Inhibition"
coef_data$term[coef_data$term == "Supervision_Si_Mismo_Nota_T"] <- "Supervision"
coef_data$term[coef_data$term == "Flexibilidad_Nota_T"] <- "Flexibility"
coef_data$term[coef_data$term == "Control_Emocional_Nota_T"] <- "Emotional Control"
coef_data$term[coef_data$term == "Iniciativa_Nota_T"] <- "Initiative"
coef_data$term[coef_data$term == "Memoria_Trabajo_Nota_T"] <- "Memory-Work"
coef_data$term[coef_data$term == "Planificacion_Organizacion_Nota_T"] <- "Planification"
coef_data$term[coef_data$term == "Supervision_Tarea_Nota_T"] <- "Supervision"
coef_data$term[coef_data$term == "Organizacion_Materiales_Nota_T"] <- "Organization"
coef_data$term[coef_data$term == "BRIEF_IAI_Nota_T"] <- "BRIEF IAI"
coef_data$term[coef_data$term == "BRIEF_IFL_Nota_T"] <- "BRIEF IFL"
coef_data$term[coef_data$term == "BRIEF_IME_Nota_T"] <- "BRIEF IME"
coef_data$term[coef_data$term == "BRIEF_IGFE_Nota_T"] <- "BRIEF IFGE"
coef_data$term[coef_data$term == "BRIEF2_IRCN_Nota_T"] <- "BRIEF2 IRCN"
coef_data$term[coef_data$term == "BRIEF2_IREM_Nota_T"] <- "BRIEF2 IREM"
coef_data$term[coef_data$term == "BRIEF2_IRCG_Nota_T"] <- "BRIEF2 IRCG"
coef_data$term[coef_data$term == "BRIEF2_IGE_Nota_T"] <- "BRIEF2 IGE"
coef_data$term[coef_data$term == "QI_Matrice"] <- "QI Matrice"
coef_data$term[coef_data$term == "QI_Code"] <- "QI Code"
coef_data$term[coef_data$term == "QI_Barrage"] <- "QI Barrage"
coef_data$term[coef_data$term == "QI_Labyrinthe"] <- "QI Labyrinthe"
coef_data$term[coef_data$term == "MD_Z"] <- "MD Z"
coef_data$term[coef_data$term == "MND_Z"] <- "MND Z"
coef_data$term[coef_data$term == "Coordination_Z"] <- "Coordination Z"
coef_data$term[coef_data$term == "Assemblage_Z"] <- "Assemblage Z"

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "RBCV (ml) - Simple linear regressions (neurotests) by city") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# Hb.mass..g.


data = read.csv("data.csv")



data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(Hb.mass..g. ~ Inhibicion_Nota_T, data = df),
  mod_Lipides   = lm(Hb.mass..g. ~ Supervision_Si_Mismo_Nota_T, data = df),
  mod_Glucides  = lm(Hb.mass..g. ~ Flexibilidad_Nota_T, data = df),
  mod_Fibres    = lm(Hb.mass..g. ~ Control_Emocional_Nota_T, data = df),
  mod_Calcium   = lm(Hb.mass..g. ~ Iniciativa_Nota_T, data = df),
  mod_Fer       = lm(Hb.mass..g. ~ Memoria_Trabajo_Nota_T, data = df),
  mod_Zinc      = lm(Hb.mass..g. ~ Planificacion_Organizacion_Nota_T, data = df),
  mod_VitC      = lm(Hb.mass..g. ~ Supervision_Tarea_Nota_T, data = df),
  mod_VitC2      = lm(Hb.mass..g. ~ Organizacion_Materiales_Nota_T, data = df),
  mod_VitC7      = lm(Hb.mass..g. ~ BRIEF2_IRCN_Nota_T, data = df),
  mod_VitC8      = lm(Hb.mass..g. ~ BRIEF2_IREM_Nota_T, data = df),
  mod_VitC9      = lm(Hb.mass..g. ~ BRIEF2_IRCG_Nota_T, data = df),
  mod_VitC10      = lm(Hb.mass..g. ~ BRIEF2_IGE_Nota_T, data = df),
    mod_VitC20      = lm(Hb.mass..g. ~ QI_Matrice, data = df),
    mod_VitC21      = lm(Hb.mass..g. ~ QI_Code, data = df),
    mod_VitC22      = lm(Hb.mass..g. ~ QI_Barrage, data = df),
    mod_VitC23      = lm(Hb.mass..g. ~ QI_Labyrinthe, data = df),
    mod_VitC24      = lm(Hb.mass..g. ~ MD_Z, data = df),
    mod_VitC25      = lm(Hb.mass..g. ~ MND_Z, data = df),
    mod_VitC26      = lm(Hb.mass..g. ~ Coordination_Z, data = df),
    mod_VitC27      = lm(Hb.mass..g. ~ Assemblage_Z, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Inhibition"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Supervision"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Flexibility"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Emotional Control"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Initiative"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Memory-Work"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Planification"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Supervision"),
    tidy(mods$mod_VitC2, conf.int = TRUE) %>% mutate(model = "Organization"),
    tidy(mods$mod_VitC3, conf.int = TRUE) %>% mutate(model = "BRIEF IAI"),
    tidy(mods$mod_VitC4, conf.int = TRUE) %>% mutate(model = "BRIEF IFL"),
    tidy(mods$mod_VitC5, conf.int = TRUE) %>% mutate(model = "BRIEF IME"),
    tidy(mods$mod_VitC6, conf.int = TRUE) %>% mutate(model = "BRIEF IGFE"),
    tidy(mods$mod_VitC7, conf.int = TRUE) %>% mutate(model = "BRIEF2 IRCN"),
    tidy(mods$mod_VitC8, conf.int = TRUE) %>% mutate(model = "BRIEF2 IREM"),
    tidy(mods$mod_VitC9, conf.int = TRUE) %>% mutate(model = "BRIEF2 IRCG"),
    tidy(mods$mod_VitC10, conf.int = TRUE) %>% mutate(model = "BRIEF2 IGE"),
    tidy(mods$mod_VitC20, conf.int = TRUE) %>% mutate(model = "QI Code"),
    tidy(mods$mod_VitC21, conf.int = TRUE) %>% mutate(model = "QI Matrice"),
    tidy(mods$mod_VitC22, conf.int = TRUE) %>% mutate(model = "QI Barrage"),
    tidy(mods$mod_VitC23, conf.int = TRUE) %>% mutate(model = "QI Labyrinthe"),
    tidy(mods$mod_VitC24, conf.int = TRUE) %>% mutate(model = "MD Z"),
    tidy(mods$mod_VitC25, conf.int = TRUE) %>% mutate(model = "MND Z"),
    tidy(mods$mod_VitC26, conf.int = TRUE) %>% mutate(model = "Coordination Z"),
    tidy(mods$mod_VitC27, conf.int = TRUE) %>% mutate(model = "Assemblage_Z"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "Inhibicion_Nota_T"] <- "Inhibition"
coef_data$term[coef_data$term == "Supervision_Si_Mismo_Nota_T"] <- "Supervision"
coef_data$term[coef_data$term == "Flexibilidad_Nota_T"] <- "Flexibility"
coef_data$term[coef_data$term == "Control_Emocional_Nota_T"] <- "Emotional Control"
coef_data$term[coef_data$term == "Iniciativa_Nota_T"] <- "Initiative"
coef_data$term[coef_data$term == "Memoria_Trabajo_Nota_T"] <- "Memory-Work"
coef_data$term[coef_data$term == "Planificacion_Organizacion_Nota_T"] <- "Planification"
coef_data$term[coef_data$term == "Supervision_Tarea_Nota_T"] <- "Supervision"
coef_data$term[coef_data$term == "Organizacion_Materiales_Nota_T"] <- "Organization"
coef_data$term[coef_data$term == "BRIEF_IAI_Nota_T"] <- "BRIEF IAI"
coef_data$term[coef_data$term == "BRIEF_IFL_Nota_T"] <- "BRIEF IFL"
coef_data$term[coef_data$term == "BRIEF_IME_Nota_T"] <- "BRIEF IME"
coef_data$term[coef_data$term == "BRIEF_IGFE_Nota_T"] <- "BRIEF IFGE"
coef_data$term[coef_data$term == "BRIEF2_IRCN_Nota_T"] <- "BRIEF2 IRCN"
coef_data$term[coef_data$term == "BRIEF2_IREM_Nota_T"] <- "BRIEF2 IREM"
coef_data$term[coef_data$term == "BRIEF2_IRCG_Nota_T"] <- "BRIEF2 IRCG"
coef_data$term[coef_data$term == "BRIEF2_IGE_Nota_T"] <- "BRIEF2 IGE"
coef_data$term[coef_data$term == "QI_Matrice"] <- "QI Matrice"
coef_data$term[coef_data$term == "QI_Code"] <- "QI Code"
coef_data$term[coef_data$term == "QI_Barrage"] <- "QI Barrage"
coef_data$term[coef_data$term == "QI_Labyrinthe"] <- "QI Labyrinthe"
coef_data$term[coef_data$term == "MD_Z"] <- "MD Z"
coef_data$term[coef_data$term == "MND_Z"] <- "MND Z"
coef_data$term[coef_data$term == "Coordination_Z"] <- "Coordination Z"
coef_data$term[coef_data$term == "Assemblage_Z"] <- "Assemblage Z"

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "Hb mass (g) - Simple linear regressions (neurotests) by city") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# Hb.mass..g./kg


data = read.csv("data.csv")



data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(Hb.mass.kg..g...kg. ~ Inhibicion_Nota_T, data = df),
  mod_Lipides   = lm(Hb.mass.kg..g...kg. ~ Supervision_Si_Mismo_Nota_T, data = df),
  mod_Glucides  = lm(Hb.mass.kg..g...kg. ~ Flexibilidad_Nota_T, data = df),
  mod_Fibres    = lm(Hb.mass.kg..g...kg. ~ Control_Emocional_Nota_T, data = df),
  mod_Calcium   = lm(Hb.mass.kg..g...kg. ~ Iniciativa_Nota_T, data = df),
  mod_Fer       = lm(Hb.mass.kg..g...kg. ~ Memoria_Trabajo_Nota_T, data = df),
  mod_Zinc      = lm(Hb.mass.kg..g...kg. ~ Planificacion_Organizacion_Nota_T, data = df),
  mod_VitC      = lm(Hb.mass.kg..g...kg. ~ Supervision_Tarea_Nota_T, data = df),
  mod_VitC2      = lm(Hb.mass.kg..g...kg. ~ Organizacion_Materiales_Nota_T, data = df),
  mod_VitC7      = lm(Hb.mass.kg..g...kg. ~ BRIEF2_IRCN_Nota_T, data = df),
  mod_VitC8      = lm(Hb.mass.kg..g...kg. ~ BRIEF2_IREM_Nota_T, data = df),
  mod_VitC9      = lm(Hb.mass.kg..g...kg. ~ BRIEF2_IRCG_Nota_T, data = df),
  mod_VitC10      = lm(Hb.mass.kg..g...kg. ~ BRIEF2_IGE_Nota_T, data = df),
    mod_VitC20      = lm(Hb.mass.kg..g...kg. ~ QI_Matrice, data = df),
    mod_VitC21      = lm(Hb.mass.kg..g...kg. ~ QI_Code, data = df),
    mod_VitC22      = lm(Hb.mass.kg..g...kg. ~ QI_Barrage, data = df),
    mod_VitC23      = lm(Hb.mass.kg..g...kg. ~ QI_Labyrinthe, data = df),
    mod_VitC24      = lm(Hb.mass.kg..g...kg. ~ MD_Z, data = df),
    mod_VitC25      = lm(Hb.mass.kg..g...kg. ~ MND_Z, data = df),
    mod_VitC26      = lm(Hb.mass.kg..g...kg. ~ Coordination_Z, data = df),
    mod_VitC27      = lm(Hb.mass.kg..g...kg. ~ Assemblage_Z, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Inhibition"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Supervision"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Flexibility"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Emotional Control"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Initiative"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Memory-Work"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Planification"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Supervision"),
    tidy(mods$mod_VitC2, conf.int = TRUE) %>% mutate(model = "Organization"),
    tidy(mods$mod_VitC4, conf.int = TRUE) %>% mutate(model = "BRIEF IFL"),
    tidy(mods$mod_VitC5, conf.int = TRUE) %>% mutate(model = "BRIEF IME"),
    tidy(mods$mod_VitC6, conf.int = TRUE) %>% mutate(model = "BRIEF IGFE"),
    tidy(mods$mod_VitC7, conf.int = TRUE) %>% mutate(model = "BRIEF2 IRCN"),
    tidy(mods$mod_VitC8, conf.int = TRUE) %>% mutate(model = "BRIEF2 IREM"),
    tidy(mods$mod_VitC9, conf.int = TRUE) %>% mutate(model = "BRIEF2 IRCG"),
    tidy(mods$mod_VitC10, conf.int = TRUE) %>% mutate(model = "BRIEF2 IGE"),
    tidy(mods$mod_VitC20, conf.int = TRUE) %>% mutate(model = "QI Code"),
    tidy(mods$mod_VitC21, conf.int = TRUE) %>% mutate(model = "QI Matrice"),
    tidy(mods$mod_VitC22, conf.int = TRUE) %>% mutate(model = "QI Barrage"),
    tidy(mods$mod_VitC23, conf.int = TRUE) %>% mutate(model = "QI Labyrinthe"),
    tidy(mods$mod_VitC24, conf.int = TRUE) %>% mutate(model = "MD Z"),
    tidy(mods$mod_VitC25, conf.int = TRUE) %>% mutate(model = "MND Z"),
    tidy(mods$mod_VitC26, conf.int = TRUE) %>% mutate(model = "Coordination Z"),
    tidy(mods$mod_VitC27, conf.int = TRUE) %>% mutate(model = "Assemblage_Z"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "Inhibicion_Nota_T"] <- "Inhibition"
coef_data$term[coef_data$term == "Supervision_Si_Mismo_Nota_T"] <- "Supervision"
coef_data$term[coef_data$term == "Flexibilidad_Nota_T"] <- "Flexibility"
coef_data$term[coef_data$term == "Control_Emocional_Nota_T"] <- "Emotional Control"
coef_data$term[coef_data$term == "Iniciativa_Nota_T"] <- "Initiative"
coef_data$term[coef_data$term == "Memoria_Trabajo_Nota_T"] <- "Memory-Work"
coef_data$term[coef_data$term == "Planificacion_Organizacion_Nota_T"] <- "Planification"
coef_data$term[coef_data$term == "Supervision_Tarea_Nota_T"] <- "Supervision"
coef_data$term[coef_data$term == "Organizacion_Materiales_Nota_T"] <- "Organization"
coef_data$term[coef_data$term == "BRIEF_IFL_Nota_T"] <- "BRIEF IFL"
coef_data$term[coef_data$term == "BRIEF_IME_Nota_T"] <- "BRIEF IME"
coef_data$term[coef_data$term == "BRIEF_IGFE_Nota_T"] <- "BRIEF IFGE"
coef_data$term[coef_data$term == "BRIEF2_IRCN_Nota_T"] <- "BRIEF2 IRCN"
coef_data$term[coef_data$term == "BRIEF2_IREM_Nota_T"] <- "BRIEF2 IREM"
coef_data$term[coef_data$term == "BRIEF2_IRCG_Nota_T"] <- "BRIEF2 IRCG"
coef_data$term[coef_data$term == "BRIEF2_IGE_Nota_T"] <- "BRIEF2 IGE"
coef_data$term[coef_data$term == "QI_Matrice"] <- "QI Matrice"
coef_data$term[coef_data$term == "QI_Code"] <- "QI Code"
coef_data$term[coef_data$term == "QI_Barrage"] <- "QI Barrage"
coef_data$term[coef_data$term == "QI_Labyrinthe"] <- "QI Labyrinthe"
coef_data$term[coef_data$term == "MD_Z"] <- "MD Z"
coef_data$term[coef_data$term == "MND_Z"] <- "MND Z"
coef_data$term[coef_data$term == "Coordination_Z"] <- "Coordination Z"
coef_data$term[coef_data$term == "Assemblage_Z"] <- "Assemblage Z"

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "Hb mass (g/kg) - Simple linear regressions (neurotests) by city") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# PV.ml.


data = read.csv("data.csv")



data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(PV.ml. ~ Inhibicion_Nota_T, data = df),
  mod_Lipides   = lm(PV.ml. ~ Supervision_Si_Mismo_Nota_T, data = df),
  mod_Glucides  = lm(PV.ml. ~ Flexibilidad_Nota_T, data = df),
  mod_Fibres    = lm(PV.ml. ~ Control_Emocional_Nota_T, data = df),
  mod_Calcium   = lm(PV.ml. ~ Iniciativa_Nota_T, data = df),
  mod_Fer       = lm(PV.ml. ~ Memoria_Trabajo_Nota_T, data = df),
  mod_Zinc      = lm(PV.ml. ~ Planificacion_Organizacion_Nota_T, data = df),
  mod_VitC      = lm(PV.ml. ~ Supervision_Tarea_Nota_T, data = df),
  mod_VitC2      = lm(PV.ml. ~ Organizacion_Materiales_Nota_T, data = df),
  mod_VitC7      = lm(PV.ml. ~ BRIEF2_IRCN_Nota_T, data = df),
  mod_VitC8      = lm(PV.ml. ~ BRIEF2_IREM_Nota_T, data = df),
  mod_VitC9      = lm(PV.ml. ~ BRIEF2_IRCG_Nota_T, data = df),
  mod_VitC10      = lm(PV.ml. ~ BRIEF2_IGE_Nota_T, data = df),
    mod_VitC20      = lm(PV.ml. ~ QI_Matrice, data = df),
    mod_VitC21      = lm(PV.ml. ~ QI_Code, data = df),
    mod_VitC22      = lm(PV.ml. ~ QI_Barrage, data = df),
    mod_VitC23      = lm(PV.ml. ~ QI_Labyrinthe, data = df),
    mod_VitC24      = lm(PV.ml. ~ MD_Z, data = df),
    mod_VitC25      = lm(PV.ml. ~ MND_Z, data = df),
    mod_VitC26      = lm(PV.ml. ~ Coordination_Z, data = df),
    mod_VitC27      = lm(PV.ml. ~ Assemblage_Z, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Inhibition"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Supervision"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Flexibility"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Emotional Control"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Initiative"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Memory-Work"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Planification"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Supervision"),
    tidy(mods$mod_VitC2, conf.int = TRUE) %>% mutate(model = "Organization"),
    tidy(mods$mod_VitC3, conf.int = TRUE) %>% mutate(model = "BRIEF IAI"),
    tidy(mods$mod_VitC4, conf.int = TRUE) %>% mutate(model = "BRIEF IFL"),
    tidy(mods$mod_VitC5, conf.int = TRUE) %>% mutate(model = "BRIEF IME"),
    tidy(mods$mod_VitC6, conf.int = TRUE) %>% mutate(model = "BRIEF IGFE"),
    tidy(mods$mod_VitC7, conf.int = TRUE) %>% mutate(model = "BRIEF2 IRCN"),
    tidy(mods$mod_VitC8, conf.int = TRUE) %>% mutate(model = "BRIEF2 IREM"),
    tidy(mods$mod_VitC9, conf.int = TRUE) %>% mutate(model = "BRIEF2 IRCG"),
    tidy(mods$mod_VitC10, conf.int = TRUE) %>% mutate(model = "BRIEF2 IGE"),
    tidy(mods$mod_VitC20, conf.int = TRUE) %>% mutate(model = "QI Code"),
    tidy(mods$mod_VitC21, conf.int = TRUE) %>% mutate(model = "QI Matrice"),
    tidy(mods$mod_VitC22, conf.int = TRUE) %>% mutate(model = "QI Barrage"),
    tidy(mods$mod_VitC23, conf.int = TRUE) %>% mutate(model = "QI Labyrinthe"),
    tidy(mods$mod_VitC24, conf.int = TRUE) %>% mutate(model = "MD Z"),
    tidy(mods$mod_VitC25, conf.int = TRUE) %>% mutate(model = "MND Z"),
    tidy(mods$mod_VitC26, conf.int = TRUE) %>% mutate(model = "Coordination Z"),
    tidy(mods$mod_VitC27, conf.int = TRUE) %>% mutate(model = "Assemblage_Z"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "Inhibicion_Nota_T"] <- "Inhibition"
coef_data$term[coef_data$term == "Supervision_Si_Mismo_Nota_T"] <- "Supervision"
coef_data$term[coef_data$term == "Flexibilidad_Nota_T"] <- "Flexibility"
coef_data$term[coef_data$term == "Control_Emocional_Nota_T"] <- "Emotional Control"
coef_data$term[coef_data$term == "Iniciativa_Nota_T"] <- "Initiative"
coef_data$term[coef_data$term == "Memoria_Trabajo_Nota_T"] <- "Memory-Work"
coef_data$term[coef_data$term == "Planificacion_Organizacion_Nota_T"] <- "Planification"
coef_data$term[coef_data$term == "Supervision_Tarea_Nota_T"] <- "Supervision"
coef_data$term[coef_data$term == "Organizacion_Materiales_Nota_T"] <- "Organization"
coef_data$term[coef_data$term == "BRIEF_IAI_Nota_T"] <- "BRIEF IAI"
coef_data$term[coef_data$term == "BRIEF_IFL_Nota_T"] <- "BRIEF IFL"
coef_data$term[coef_data$term == "BRIEF_IME_Nota_T"] <- "BRIEF IME"
coef_data$term[coef_data$term == "BRIEF_IGFE_Nota_T"] <- "BRIEF IFGE"
coef_data$term[coef_data$term == "BRIEF2_IRCN_Nota_T"] <- "BRIEF2 IRCN"
coef_data$term[coef_data$term == "BRIEF2_IREM_Nota_T"] <- "BRIEF2 IREM"
coef_data$term[coef_data$term == "BRIEF2_IRCG_Nota_T"] <- "BRIEF2 IRCG"
coef_data$term[coef_data$term == "BRIEF2_IGE_Nota_T"] <- "BRIEF2 IGE"
coef_data$term[coef_data$term == "QI_Matrice"] <- "QI Matrice"
coef_data$term[coef_data$term == "QI_Code"] <- "QI Code"
coef_data$term[coef_data$term == "QI_Barrage"] <- "QI Barrage"
coef_data$term[coef_data$term == "QI_Labyrinthe"] <- "QI Labyrinthe"
coef_data$term[coef_data$term == "MD_Z"] <- "MD Z"
coef_data$term[coef_data$term == "MND_Z"] <- "MND Z"
coef_data$term[coef_data$term == "Coordination_Z"] <- "Coordination Z"
coef_data$term[coef_data$term == "Assemblage_Z"] <- "Assemblage Z"

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "PV (ml) - Simple linear regressions (neurotests) by city") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# PV.ml.


data = read.csv("data.csv")



data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# Fonction qui crée les modèles pour chaque niveau d'altitude
models_by_altitude <- data %>%
  group_by(Ville_eval) %>%
  group_split() %>%
  map(function(df) {
list(
  mod_Protéines = lm(PV..kg..ml.kg. ~ Inhibicion_Nota_T, data = df),
  mod_Lipides   = lm(PV..kg..ml.kg. ~ Supervision_Si_Mismo_Nota_T, data = df),
  mod_Glucides  = lm(PV..kg..ml.kg. ~ Flexibilidad_Nota_T, data = df),
  mod_Fibres    = lm(PV..kg..ml.kg. ~ Control_Emocional_Nota_T, data = df),
  mod_Calcium   = lm(PV..kg..ml.kg. ~ Iniciativa_Nota_T, data = df),
  mod_Fer       = lm(PV..kg..ml.kg. ~ Memoria_Trabajo_Nota_T, data = df),
  mod_Zinc      = lm(PV..kg..ml.kg. ~ Planificacion_Organizacion_Nota_T, data = df),
  mod_VitC      = lm(PV..kg..ml.kg. ~ Supervision_Tarea_Nota_T, data = df),
  mod_VitC2      = lm(PV..kg..ml.kg. ~ Organizacion_Materiales_Nota_T, data = df),
    mod_VitC20      = lm(PV..kg..ml.kg. ~ QI_Matrice, data = df),
    mod_VitC21      = lm(PV..kg..ml.kg. ~ QI_Code, data = df),
    mod_VitC22      = lm(PV..kg..ml.kg. ~ QI_Barrage, data = df),
    mod_VitC23      = lm(PV..kg..ml.kg. ~ QI_Labyrinthe, data = df),
    mod_VitC24      = lm(PV..kg..ml.kg. ~ MD_Z, data = df),
    mod_VitC25      = lm(PV..kg..ml.kg. ~ MND_Z, data = df),
    mod_VitC26      = lm(PV..kg..ml.kg. ~ Coordination_Z, data = df),
    mod_VitC27      = lm(PV..kg..ml.kg. ~ Assemblage_Z, data = df),
  mod_VitC7      = lm(PV..kg..ml.kg. ~ BRIEF2_IRCN_Nota_T, data = df),
  mod_VitC8      = lm(PV..kg..ml.kg. ~ BRIEF2_IREM_Nota_T, data = df),
  mod_VitC9      = lm(PV..kg..ml.kg. ~ BRIEF2_IRCG_Nota_T, data = df),
  mod_VitC10      = lm(PV..kg..ml.kg. ~ BRIEF2_IGE_Nota_T, data = df),
  Ville_eval      = unique(df$Ville_eval)
)
  })

coef_data <- map_df(models_by_altitude, function(mods) {
  altitude <- mods$Ville_eval

  # Extraire les coefficients de tous les modèles
  bind_rows(
    tidy(mods$mod_Protéines, conf.int = TRUE) %>% mutate(model = "Inhibition"),
    tidy(mods$mod_Lipides, conf.int = TRUE) %>% mutate(model = "Supervision"),
    tidy(mods$mod_Glucides, conf.int = TRUE) %>% mutate(model = "Flexibility"),
    tidy(mods$mod_Fibres, conf.int = TRUE) %>% mutate(model = "Emotional Control"),
    tidy(mods$mod_Calcium, conf.int = TRUE) %>% mutate(model = "Initiative"),
    tidy(mods$mod_Fer, conf.int = TRUE) %>% mutate(model = "Memory-Work"),
    tidy(mods$mod_Zinc, conf.int = TRUE) %>% mutate(model = "Planification"),
    tidy(mods$mod_VitC, conf.int = TRUE) %>% mutate(model = "Supervision"),
    tidy(mods$mod_VitC2, conf.int = TRUE) %>% mutate(model = "Organization"),
    tidy(mods$mod_VitC3, conf.int = TRUE) %>% mutate(model = "BRIEF IAI"),
    tidy(mods$mod_VitC4, conf.int = TRUE) %>% mutate(model = "BRIEF IFL"),
    tidy(mods$mod_VitC5, conf.int = TRUE) %>% mutate(model = "BRIEF IME"),
    tidy(mods$mod_VitC6, conf.int = TRUE) %>% mutate(model = "BRIEF IGFE"),
    tidy(mods$mod_VitC7, conf.int = TRUE) %>% mutate(model = "BRIEF2 IRCN"),
    tidy(mods$mod_VitC8, conf.int = TRUE) %>% mutate(model = "BRIEF2 IREM"),
    tidy(mods$mod_VitC9, conf.int = TRUE) %>% mutate(model = "BRIEF2 IRCG"),
    tidy(mods$mod_VitC10, conf.int = TRUE) %>% mutate(model = "BRIEF2 IGE"),
    tidy(mods$mod_VitC20, conf.int = TRUE) %>% mutate(model = "QI Code"),
    tidy(mods$mod_VitC21, conf.int = TRUE) %>% mutate(model = "QI Matrice"),
    tidy(mods$mod_VitC22, conf.int = TRUE) %>% mutate(model = "QI Barrage"),
    tidy(mods$mod_VitC23, conf.int = TRUE) %>% mutate(model = "QI Labyrinthe"),
    tidy(mods$mod_VitC24, conf.int = TRUE) %>% mutate(model = "MD Z"),
    tidy(mods$mod_VitC25, conf.int = TRUE) %>% mutate(model = "MND Z"),
    tidy(mods$mod_VitC26, conf.int = TRUE) %>% mutate(model = "Coordination Z"),
    tidy(mods$mod_VitC27, conf.int = TRUE) %>% mutate(model = "Assemblage_Z"),
  ) %>% mutate(Ville_eval = altitude)
})

coef_data <- coef_data %>%
  filter(term != "(Intercept)") %>%
  mutate(significant = ifelse(conf.low > 0 | conf.high < 0, "Yes", "No"))
coef_data$term[coef_data$term == "Inhibicion_Nota_T"] <- "Inhibition"
coef_data$term[coef_data$term == "Supervision_Si_Mismo_Nota_T"] <- "Supervision"
coef_data$term[coef_data$term == "Flexibilidad_Nota_T"] <- "Flexibility"
coef_data$term[coef_data$term == "Control_Emocional_Nota_T"] <- "Emotional Control"
coef_data$term[coef_data$term == "Iniciativa_Nota_T"] <- "Initiative"
coef_data$term[coef_data$term == "Memoria_Trabajo_Nota_T"] <- "Memory-Work"
coef_data$term[coef_data$term == "Planificacion_Organizacion_Nota_T"] <- "Planification"
coef_data$term[coef_data$term == "Supervision_Tarea_Nota_T"] <- "Supervision"
coef_data$term[coef_data$term == "Organizacion_Materiales_Nota_T"] <- "Organization"
coef_data$term[coef_data$term == "BRIEF_IAI_Nota_T"] <- "BRIEF IAI"
coef_data$term[coef_data$term == "BRIEF_IFL_Nota_T"] <- "BRIEF IFL"
coef_data$term[coef_data$term == "BRIEF_IME_Nota_T"] <- "BRIEF IME"
coef_data$term[coef_data$term == "BRIEF_IGFE_Nota_T"] <- "BRIEF IFGE"
coef_data$term[coef_data$term == "BRIEF2_IRCN_Nota_T"] <- "BRIEF2 IRCN"
coef_data$term[coef_data$term == "BRIEF2_IREM_Nota_T"] <- "BRIEF2 IREM"
coef_data$term[coef_data$term == "BRIEF2_IRCG_Nota_T"] <- "BRIEF2 IRCG"
coef_data$term[coef_data$term == "BRIEF2_IGE_Nota_T"] <- "BRIEF2 IGE"
coef_data$term[coef_data$term == "QI_Matrice"] <- "QI Matrice"
coef_data$term[coef_data$term == "QI_Code"] <- "QI Code"
coef_data$term[coef_data$term == "QI_Barrage"] <- "QI Barrage"
coef_data$term[coef_data$term == "QI_Labyrinthe"] <- "QI Labyrinthe"
coef_data$term[coef_data$term == "MD_Z"] <- "MD Z"
coef_data$term[coef_data$term == "MND_Z"] <- "MND Z"
coef_data$term[coef_data$term == "Coordination_Z"] <- "Coordination Z"
coef_data$term[coef_data$term == "Assemblage_Z"] <- "Assemblage Z"

ggplot(coef_data, aes(x = estimate, y = term, color = significant, shape = significant, alpha = significant)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  scale_color_manual(values = c(
    "Yes" = "#1b9e77",
    "No" = "#b0241a"
  ), guide = "none") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, position = position_dodge(width = 0.6)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") + 
  labs(x = "Estimated coefficient", y = "Explanatory variable",
       color = "Explained variable", shape = "Significant ?", title = "PV (ml/kg) - Simple linear regressions (neurotests) by city") +
  scale_shape_manual(values = c("No" = 4, "Yes" = 15)) +
  scale_alpha_manual(values = c("Yes" = 1, "No" = 0.2), guide = "none")+
  facet_wrap(~ Ville_eval) +
  theme_minimal() +
  theme(legend.position = "bottom")
```


```{r}
mes_vars <- c("kCalHors.fibres", "Pr..g.", "L.g.", "G.g.", "Fibres", 
              "Calcium..mg.", "Fer..mg.100.g.", "Zinc..mg.100.g.", "Vitamine.C..mg.")
categorie_age <- "0-3 ans"

# === CHARGEMENT ET FILTRAGE ===
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == categorie_age, ]

# === LONG FORMAT ===
data_long <- data %>%
  select(all_of(mes_vars), Ville_eval) %>%
  pivot_longer(cols = all_of(mes_vars), names_to = "Variable", values_to = "Valeur")

# === TESTS GLOBAUX ===
global_tests <- data_long %>%
  split(.$Variable) %>%
  map_df(function(df) {
    variable <- unique(df$Variable)
    
    normal <- df %>%
      group_by(Ville_eval) %>%
      summarise(p_shapiro = shapiro_test(Valeur)$p.value[1], .groups = "drop") %>%
      summarise(all(p_shapiro > 0.05)) %>%
      pull()

    bartlett_ok <- tryCatch({
      bartlett.test(Valeur ~ Ville_eval, data = df)$p.value > 0.05
    }, error = function(e) FALSE)

    pval <- if (isTRUE(normal) && bartlett_ok) {
      anova_test(data = df, dv = Valeur, between = Ville_eval)$p
    } else {
      kruskal_test(data = df, formula = Valeur ~ Ville_eval)$p
    }

    tibble(Variable = variable, p_global = pval)
  })

# === TESTS POST-HOC ===
comparaisons <- data_long %>%
  group_by(Variable) %>%
  pairwise_wilcox_test(
    Valeur ~ Ville_eval,
    p.adjust.method = "BH"
  ) %>%
  filter(p.adj < 0.1) %>%
  mutate(p.signif = case_when(
    p.adj < 0.01 ~ "***",
    p.adj < 0.05 ~ "**",
    p.adj < 0.1  ~ "*",
    TRUE         ~ "ns"
  ))

# === POSITIONS DES P-VALUES ===
positions_max <- data_long %>%
  group_by(Variable) %>%
  summarise(base_y = max(Valeur, na.rm = TRUE), .groups = "drop")

comparaisons <- comparaisons %>%
  left_join(positions_max, by = "Variable") %>%
  group_by(Variable) %>%
  mutate(
    y.position = base_y + 0.1 * base_y + 0.05 * base_y * row_number()
  ) %>%
  ungroup()

# === GRAPHIQUE BARPLOT SEULEMENT ===
ggplot(data_long, aes(x = Ville_eval, y = Valeur, fill = Ville_eval)) +
  facet_wrap(~Variable, scales = "free_y") +
  stat_summary(fun = mean, geom = "bar", width = 0.7, position = position_dodge()) +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2, position = position_dodge()) +
  stat_pvalue_manual(
    data = comparaisons,
    label = "p.signif",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  scale_fill_manual(values = c(
    "Lima (150m)" = "#1b9e77",
    "Cusco (3400m)" = "#d95f02",
    "Juliaca (3800m)" = "#7570b3",
    "La Rinconada (5100m)" = "#e7298a"
  )) +
  labs(
    title = paste("Comparaison par ville pour chaque variable (âge :", categorie_age, ")"),
    x = "Ville",
    y = "Valeur moyenne ± SE",
    fill = "Ville",
    caption = "* p < 0.1   ** p < 0.05   *** p < 0.01"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
mes_vars <- c("kCalHors.fibres", "Pr..g.", "L.g.", "G.g.", "Fibres", 
              "Calcium..mg.", "Fer..mg.100.g.", "Zinc..mg.100.g.", "Vitamine.C..mg.")
categorie_age <- "8-12 ans"

# === CHARGEMENT ET FILTRAGE ===
data <- read.csv("data.csv")
data <- data[data$Age_categorie_binaire == categorie_age, ]
data$Ville_eval <- factor(data$Ville_eval, levels = c("Lima (150m)", "Cusco (3400m)", "Juliaca (3800m)", "La Rinconada (5100m)"))

# === LONG FORMAT ===
data_long <- data %>%
  select(all_of(mes_vars), Ville_eval) %>%
  pivot_longer(cols = all_of(mes_vars), names_to = "Variable", values_to = "Valeur")

data_long <- data_long %>%
  mutate(Variable = case_when(
    Variable == "kCalHors.fibres"     ~ "Énergie (kcal)",
    Variable == "Pr..g."              ~ "Protéines (g)",
    Variable == "L.g."                ~ "Lipides (g)",
    Variable == "G.g."                ~ "Glucides (g)",
    Variable == "Fibres"              ~ "Fibres (g)",
    Variable == "Calcium..mg."        ~ "Calcium (mg)",
    Variable == "Fer..mg.100.g."      ~ "Fer (mg/100g)",
    Variable == "Zinc..mg.100.g."     ~ "Zinc (mg/100g)",
    Variable == "Vitamine.C..mg."     ~ "Vitamine C (mg)",
    TRUE ~ Variable
  ))

# === TESTS GLOBAUX ===
global_tests <- data_long %>%
  split(.$Variable) %>%
  map_df(function(df) {
    variable <- unique(df$Variable)
    
    normal <- df %>%
      group_by(Ville_eval) %>%
      summarise(p_shapiro = shapiro_test(Valeur)$p.value[1], .groups = "drop") %>%
      summarise(all(p_shapiro > 0.05)) %>%
      pull()

    bartlett_ok <- tryCatch({
      bartlett.test(Valeur ~ Ville_eval, data = df)$p.value > 0.05
    }, error = function(e) FALSE)

    pval <- if (isTRUE(normal) && bartlett_ok) {
      anova_test(data = df, dv = Valeur, between = Ville_eval)$p
    } else {
      kruskal_test(data = df, formula = Valeur ~ Ville_eval)$p
    }

    tibble(Variable = variable, p_global = pval)
  })

# === TESTS POST-HOC ===
comparaisons <- data_long %>%
  group_by(Variable) %>%
  pairwise_wilcox_test(
    Valeur ~ Ville_eval,
    p.adjust.method = "BH"
  ) %>%
  filter(p.adj < 0.1) %>%
  mutate(p.signif = case_when(
    p.adj < 0.01 ~ "***",
    p.adj < 0.05 ~ "**",
    p.adj < 0.1  ~ "*",
    TRUE         ~ "ns"
  ))

# === POSITIONS DES P-VALUES ===
positions_max <- data_long %>%
  group_by(Variable) %>%
  summarise(base_y = max(Valeur, na.rm = TRUE), .groups = "drop")

comparaisons <- comparaisons %>%
  left_join(positions_max, by = "Variable") %>%
  group_by(Variable) %>%
  mutate(
    y.position = base_y + 0.1 * base_y + 0.05 * base_y * row_number()
  ) %>%
  ungroup()

# === GRAPHIQUE BARPLOT SEULEMENT ===
ggplot(data_long, aes(x = Ville_eval, y = Valeur, fill = Ville_eval)) +
  facet_wrap(~Variable, scales = "free_y") +
  stat_summary(fun = mean, geom = "bar", width = 0.7, position = position_dodge()) +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2, position = position_dodge()) +
  stat_pvalue_manual(
    data = comparaisons,
    label = "p.signif",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  scale_fill_manual(values = c(
    "Lima (150m)" = "#1b9e77",
    "Cusco (3400m)" = "#d95f02",
    "Juliaca (3800m)" = "#7570b3",
    "La Rinconada (5100m)" = "#e7298a"
  )) +
  labs(
    title = paste("Comparaison par ville pour chaque variable (âge :", categorie_age, ")"),
    x = "Ville",
    y = "Valeur moyenne ± SE",
    fill = "Ville",
    caption = "* p < 0.1   ** p < 0.05   *** p < 0.01"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(data_long, aes(x = Ville_eval, y = Valeur, fill = Ville_eval)) +
  facet_wrap(~Variable, scales = "free_y") +
  geom_boxplot(alpha = 0.7, outlier.size = 0.5) +
  stat_pvalue_manual(
    data = comparaisons,
    label = "p.signif",
    y.position = "y.position",
    xmin = "group1",
    xmax = "group2",
    tip.length = 0.01,
    bracket.size = 0.6,
    inherit.aes = FALSE
  ) +
  scale_fill_manual(values = c(
    "Lima (150m)" = "#1b9e77",
    "Cusco (3400m)" = "#d95f02",
    "Juliaca (3800m)" = "#7570b3",
    "La Rinconada (5100m)" = "#e7298a"
  )) +
  labs(
    title = paste("Comparaison des distributions nutritionnelles par ville (âge :", categorie_age, ")"),
    x = "Ville",
    y = "Valeur",
    fill = "Ville"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

